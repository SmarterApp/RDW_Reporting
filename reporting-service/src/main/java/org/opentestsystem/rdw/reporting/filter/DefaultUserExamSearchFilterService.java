package org.opentestsystem.rdw.reporting.filter;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMap;
import org.opentestsystem.rdw.reporting.common.model.ImmutableStudentFilter;
import org.opentestsystem.rdw.reporting.common.model.StudentFieldType;
import org.opentestsystem.rdw.reporting.common.model.StudentFilter;
import org.opentestsystem.rdw.reporting.common.security.User;
import org.opentestsystem.rdw.reporting.common.service.UserStudentFieldService;
import org.opentestsystem.rdw.reporting.elas.ElasService;
import org.opentestsystem.rdw.reporting.ethnicity.EthnicityService;
import org.opentestsystem.rdw.reporting.gender.GenderService;
import org.opentestsystem.rdw.reporting.language.LanguageService;
import org.opentestsystem.rdw.reporting.militaryconnected.MilitaryConnectedService;
import org.opentestsystem.rdw.reporting.schoolyear.SchoolYearService;
import org.opentestsystem.rdw.reporting.subject.SubjectService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.validation.constraints.NotNull;
import java.util.List;
import java.util.Map;
import java.util.function.Supplier;

import static java.util.stream.Collectors.toList;
import static org.opentestsystem.rdw.reporting.common.model.StudentFieldType.*;

/**
 * Default implementation of the {@link UserExamSearchFilterService}
 * This service filters student filters based on the reporting system configuration and user permissions
 */
@Service
class DefaultUserExamSearchFilterService implements UserExamSearchFilterService {

    private static final List<String> StrictBooleans = ImmutableList.of("yes", "no");
    private final SchoolYearService schoolYearService;
    private final SubjectService subjectService;
    private final UserStudentFieldService userStudentFieldService;
    private final Map<StudentFieldType, Supplier<List<String>>> valueSuppliersByStudentFilterType;

    @Autowired
    DefaultUserExamSearchFilterService(
            @NotNull final SchoolYearService schoolYearService,
            @NotNull final EthnicityService ethnicityService,
            @NotNull final GenderService genderService,
            @NotNull final ElasService elasService,
            @NotNull final LanguageService languageService,
            @NotNull final MilitaryConnectedService militaryConnectedService,
            @NotNull final SubjectService subjectService,
            @NotNull final UserStudentFieldService userStudentFieldService) {

        final Supplier<List<String>> getStrictBooleans = () -> StrictBooleans;
        this.valueSuppliersByStudentFilterType = ImmutableMap.<StudentFieldType, Supplier<List<String>>>builder()
                .put(EconomicDisadvantage, getStrictBooleans)
                .put(EnglishLanguageAcquisitionStatus, elasService::getElasCodes)
                .put(Ethnicity, ethnicityService::getEthnicityCodes)
                .put(Gender, genderService::getGenderCodes)
                .put(IndividualEducationPlan, getStrictBooleans)
                .put(LimitedEnglishProficiency, getStrictBooleans)
                .put(MigrantStatus, getStrictBooleans)
                .put(MilitaryStudentIdentifier, militaryConnectedService::getMilitaryConnectedCodes)
                .put(PrimaryLanguage, languageService::getLanguageCodes)
                .put(Section504, getStrictBooleans)
                .build();

        this.schoolYearService = schoolYearService;
        this.subjectService = subjectService;
        this.userStudentFieldService = userStudentFieldService;
    }

    @Override
    public ExamSearchFilters get(final User user) {
        return ExamSearchFilters.builder()
                .schoolYears(schoolYearService.getSchoolYears())
                .studentFilters(createStudentFilters(user))
                .subjects(subjectService.getSubjectCodes())
                .build();
    }

    private List<StudentFilter> createStudentFilters(final User user) {
        return userStudentFieldService.get(user).stream()
                .map(field ->
                        ImmutableStudentFilter.builder()
                                .id(field)
                                .values(valueSuppliersByStudentFilterType.get(field).get())
                                .build()
                )
                .collect(toList());
    }

}
