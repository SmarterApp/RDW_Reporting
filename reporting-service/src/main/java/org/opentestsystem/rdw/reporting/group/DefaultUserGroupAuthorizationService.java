package org.opentestsystem.rdw.reporting.group;


import org.opentestsystem.rdw.reporting.common.security.PermissionSource;
import org.opentestsystem.rdw.reporting.common.security.ReportingPermission;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.stereotype.Service;

/**
 * Grants access to users with only school-level PII and Group PII access
 */
@Service("userGroupAuthorizationService")
class DefaultUserGroupAuthorizationService implements UserGroupAuthorizationService {

    @Override
    public boolean isAuthorized(final PermissionSource permissionSource) {
        return hasPermissionWithSchoolLevelAccess(permissionSource, ReportingPermission.IndividualPiiRead)
                || hasPermissionWithSchoolLevelAccess(permissionSource, ReportingPermission.GroupPiiRead);
    }

    /**
     * True if the permission source has the permission and it has only school level access
     *
     * @param permissionSource the permission source to check
     * @param permissionId the permission to check for
     * @return <code>true</code> if the permission source has the permission and it has only school level access
     */
    private boolean hasPermissionWithSchoolLevelAccess(final PermissionSource permissionSource, final String permissionId) {
        final Permission permission = permissionSource.getPermissionsById().get(permissionId);
        return permission != null && isSchoolLevel(permission.getScope());
    }

    /**
     * Checks if the provided permission scope is limited to school level access
     *
     * @param permissionScope the permission scope to check
     * @return <code>true</code> if the permission scope is limited to schools
     */
    boolean isSchoolLevel(final PermissionScope permissionScope) {
        return !permissionScope.isStatewide()
                && permissionScope.getDistrictGroupIds().isEmpty()
                && permissionScope.getDistrictIds().isEmpty()
                && permissionScope.getInstitutionGroupIds().isEmpty()
                && !permissionScope.getInstitutionIds().isEmpty();
    }

}
