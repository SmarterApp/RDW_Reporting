package org.opentestsystem.rdw.reporting.exam;

import com.google.common.collect.ImmutableMap;
import org.opentestsystem.rdw.reporting.common.jdbc.Exams;
import org.opentestsystem.rdw.reporting.common.jdbc.SecurityParameterProvider;
import org.opentestsystem.rdw.reporting.common.jdbc.StudentContexts;
import org.opentestsystem.rdw.reporting.common.model.Exam;
import org.opentestsystem.rdw.reporting.common.model.Student;
import org.opentestsystem.rdw.reporting.common.model.StudentContext;
import org.opentestsystem.rdw.reporting.common.security.PermissionSource;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;

import javax.validation.constraints.NotNull;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.Set;

import static com.google.common.collect.Lists.newArrayList;
import static com.google.common.collect.Maps.newHashMap;
import static com.google.common.collect.Sets.newHashSet;

public abstract class AbstractExamRepository<T extends AbstractExamSearch> implements ExamRepository<T> {

    private final NamedParameterJdbcTemplate template;
    private final SecurityParameterProvider securityParameterProvider;
    private final String findAllForAssessmentQuery;

    @Value("${sql.ethnicity.findEthnicityCodesByStudentIds}")
    private String findEthnicityCodesByStudentIdsQuery;

    protected AbstractExamRepository(
            @NotNull final NamedParameterJdbcTemplate template,
            @NotNull final SecurityParameterProvider securityParameterProvider,
            @NotNull final String findAllForAssessmentQuery) {
        this.template = template;
        this.securityParameterProvider = securityParameterProvider;
        this.findAllForAssessmentQuery = findAllForAssessmentQuery;
    }

    abstract protected Map<String, Object> getParameters(final T search);

    public List<Exam> findAllForAssessment(@NotNull final PermissionSource permissionSource, @NotNull final T search) {
        return template.query(
                findAllForAssessmentQuery,
                ImmutableMap.<String, Object>builder()
                        .putAll(securityParameterProvider.getSecurityParameters(permissionSource))
                        .put("school_year", search.getSchoolYear())
                        .put("assessment_id", search.getAssessmentId())
                        .putAll(getParameters(search))
                        .build(),
                (resultSet) -> {
                    return buildExams(resultSet, permissionSource);
                }
        );
    }

    private List<Exam> buildExams(final ResultSet resultSet, final PermissionSource permissionSource) throws SQLException {

        final List<Exam> exams = newArrayList();
        final List<Exam.Builder> examBuilders = newArrayList();
        final Set<Long> studentIds = newHashSet();

        while (resultSet.next()) {
            final Exam.Builder examBuilder = Exam.builder()
                    .studentContext(StudentContexts.map(resultSet, StudentContext.builder()).build());

            examBuilders.add(Exams.map(resultSet, examBuilder, permissionSource.getPermissionsById()));
            studentIds.add(resultSet.getLong("student_id"));
        }

        final Map<Long, Set<String>> ethnicityCodesByStudentId = findEthnicityCodesForStudentIds(studentIds);

        resultSet.beforeFirst();
        for (int i = 0; resultSet.next(); i++) {
            final Exam.Builder examBuilder = examBuilders.get(i);
            final long studentId = resultSet.getLong("student_id");
            final Set<String> ethnicityCodes = ethnicityCodesByStudentId.get(studentId);
            examBuilder.student(Student.builder()
                    .id(studentId)
                    .ssid(resultSet.getString("student_ssid"))
                    .firstName(resultSet.getString("student_first_name"))
                    .lastName(resultSet.getString("student_last_name"))
                    .genderCode(resultSet.getString("student_gender_code"))
                    .ethnicityCodes(ethnicityCodes)
                    .build()
            );
            exams.add(examBuilder.build());
        }

        return exams;
    }

    private Map<Long, Set<String>> findEthnicityCodesForStudentIds(final Collection<Long> studentIds) {
        if (studentIds == null || studentIds.isEmpty()) {
            return ImmutableMap.of();
        }
        final Map<Long, Set<String>> ethnicityCodesByStudentId = newHashMap();
        template.query(
                findEthnicityCodesByStudentIdsQuery,
                new MapSqlParameterSource("student_ids", studentIds),
                row -> {
                    final long studentId = row.getLong("student_id");
                    final String ethnicityCode = row.getString("ethnicity_code");

                    final Set<String> studentEthnicityCodes = ethnicityCodesByStudentId.get(studentId);
                    if (studentEthnicityCodes == null) {
                        ethnicityCodesByStudentId.put(studentId, newHashSet(ethnicityCode));
                    } else {
                        studentEthnicityCodes.add(ethnicityCode);
                    }
                });
        return ethnicityCodesByStudentId;
    }
}
