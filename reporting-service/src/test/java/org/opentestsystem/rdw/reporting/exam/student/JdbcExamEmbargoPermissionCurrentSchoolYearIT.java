package org.opentestsystem.rdw.reporting.exam.student;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.common.model.AssessmentType;
import org.opentestsystem.rdw.reporting.JdbcRepositoryWithPermissionIT;
import org.opentestsystem.rdw.reporting.common.model.Assessment;
import org.opentestsystem.rdw.reporting.common.model.Exam;
import org.opentestsystem.rdw.reporting.common.model.ScaleScore;
import org.opentestsystem.rdw.reporting.common.model.School;
import org.opentestsystem.rdw.reporting.common.model.StudentHistoryExamWrapper;
import org.opentestsystem.rdw.reporting.common.test.support.Instants;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Import;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.jdbc.SqlGroup;

import static com.google.common.collect.Lists.newArrayList;
import static java.util.stream.Collectors.toList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.common.model.AssessmentType.SUMMATIVE;
import static org.opentestsystem.rdw.reporting.TestData.MATH;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.getEmbargoPermissions;


/**
 * Test the embargo related SQL clause of the permissions.
 */
@SuppressWarnings({"SqlNoDataSourceInspection", "SqlResolve"})
@Import(JdbcStudentExamRepository.class)
@ActiveProfiles({"test"})
@SqlGroup({
        @Sql(scripts = {"classpath:reporting-permissions-integration-test-data.sql"}),
        @Sql(statements = {"update district_embargo set individual = 2 where district_id <> -20",
                //add an interim exam for student -1 and 1997
                "insert into exam (id, type_id, grade_id, grade_code, student_id, school_id, opportunity, iep, lep, section504, economic_disadvantage," +
                        "  school_year, asmt_id, asmt_version, completeness_code, administration_condition_code, session_id," +
                        "  scale_score, scale_score_std_err, performance_level, completed_at," +
                        "  claim1_category, claim1_scale_score, claim1_scale_score_std_err," +
                        "  claim2_category, claim2_scale_score, claim2_scale_score_std_err," +
                        "  claim3_category, claim3_scale_score, claim3_scale_score_std_err," +
                        "  claim4_category, claim4_scale_score, claim4_scale_score_std_err," +
                        "  update_import_id, updated, migrate_id) values" +
                        " (-99, 1, -1, 'g1', -1, -30, 0, 0, 0, 0, 0, 1997, -1, 'v1', 'Complete', 'Valid', 'session1', 2000, 20, 1, '1997-01-01 00:00:00.000000', 1, 100, 10, 2, 200, 20, 3, 300, 30, 4, 400, 40, -1, '1997-07-18 20:14:34.000000', -1)"
        })
})
public class JdbcExamEmbargoPermissionCurrentSchoolYearIT extends JdbcRepositoryWithPermissionIT {

    @Autowired
    private StudentExamRepository repository;

    @Autowired
    JdbcTemplate template;

    private int examCount;
    private int sumExamSchool30Count;

    @Before
    public void setUp() {
        sumExamSchool30Count = template.queryForObject("SELECT count(*) FROM exam e " +
                "JOIN asmt a ON a.id = e.asmt_id " +
                "JOIN school s ON s.id = e.school_id" +
                " WHERE e.student_id = -1 AND s.id = -30 AND a.type_id =3 ", Integer.class);

        examCount = template.queryForObject("SELECT count(*) FROM exam e WHERE e.student_id = -1", Integer.class);
    }

    @Test
    public void isShouldReturnSummativeExamsForSchoolsWithReleasedEmbargo() {
        assertThat(repository.findAllForStudent(userBuilder.permissionsById(individualStatewide).build(), -1L)
                .stream()
                .filter(e -> (e.getExam().getSchool().getId() != -30))
                .filter(e -> (e.getAssessment().getType() == SUMMATIVE)))
                .usingRecursiveFieldByFieldElementComparator()
                .containsExactlyInAnyOrder(
                        new StudentHistoryExamWrapper.Builder().exam(exam3().build()).assessment(assessmentBuilder3().build()).build()
                );
    }

    @Test
    public void isShouldNotReturnSummativeExamsForSchoolsWithEmbargoedData() {
        assertThat(repository.findAllForStudent(userBuilder.permissionsById(individualStatewide).build(), -1L)
                .stream()
                .filter(e -> (e.getExam().getSchool().getId() == -30))
                .filter(e -> (e.getAssessment().getType() == SUMMATIVE))
                .count())
                .isZero();
    }

    @Test
    public void isShouldReturnInterimExamsForSchoolsWithEmbargoedExams() {
        assertThat(repository.findAllForStudent(userBuilder.permissionsById(individualStatewide).build(), -1L)
                .stream()
                .filter(e -> (e.getExam().getSchool().getId() == -30))
                .filter(e -> (e.getAssessment().getType() != SUMMATIVE))
                .map(e -> (e.getExam().getId()))
                .collect(toList())).containsExactly(-99L);
    }

    @Test
    public void isShouldNotReturnResultsIfEmbargoAdminIsFromDifferentDistrict() {
        assertThat(repository.findAllForStudent(userBuilder.permissionsById(getEmbargoPermissions(false, -10L)).build(), -1L).size())
                .isEqualTo(examCount - sumExamSchool30Count);
    }

    @Test
    public void isShouldReturnResultsForDistrictAdmin() {
        assertThat(repository.findAllForStudent(userBuilder.permissionsById(getEmbargoPermissions(false, -20L)).build(), -1L).size())
                .isEqualTo(examCount);
    }

    @Test
    public void isShouldReturnResultsForStateAdmin() {
        assertThat(repository.findAllForStudent(userBuilder.permissionsById(getEmbargoPermissions(true, null)).build(), -1L).size())
                .isEqualTo(examCount);
    }

    public static Exam.Builder exam3() {
        return Exam.builder()
                .gradeCode("g1")
                .administrativeConditionCode("Valid")
                .completenessCode("Complete")
                .id(-3)
                .schoolYear(1997)
                .sessionId("session3")
                .dateTime(Instants.from("1997-01-01"))
                .gradeCode("g3")
                .scaleScore(
                        ScaleScore.builder().level(3).value(2200).standardError(22.0).build()
                )
                .claimScaleScores(newArrayList(
                        ScaleScore.builder().level(1).value(1000).standardError(100.0).build(),
                        ScaleScore.builder().level(2).value(2000).standardError(200.0).build(),
                        ScaleScore.builder().level(3).value(3000).standardError(300.0).build()
                ))
                .school(School.builder().id(-20L).districtId(-10).name("school2").schoolGroupId(-10L).build());
    }

    public static Assessment.Builder assessmentBuilder3() {
        return Assessment.builder()
                .id(-3)
                .type(AssessmentType.SUMMATIVE)
                .label("sum1")
                .gradeCode("g1")
                .schoolYear(1997)
                .subjectCode(MATH)
                .claimCodes(newArrayList("sum_claim1", "sum_claim2", "sum_claim3"));
    }
}
