package org.opentestsystem.rdw.reporting.embargo;

import com.google.common.collect.ImmutableMap;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.reporting.JdbcRepositoryWithPermissionIT;
import org.opentestsystem.rdw.reporting.common.model.EmbargoStatus;
import org.opentestsystem.rdw.reporting.common.security.User;
import org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.jdbc.Sql;

import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.reporting.common.model.EmbargoStatus.Loading;
import static org.opentestsystem.rdw.reporting.common.model.EmbargoStatus.Reviewing;
import static org.opentestsystem.rdw.reporting.common.security.ReportingPermission.TestDataLoadingRead;
import static org.opentestsystem.rdw.reporting.common.security.ReportingPermission.TestDataReviewingRead;

@Import(JdbcEmbargoRepository.class)
@Sql(scripts = {
        "classpath:integration-test-data.sql",
        "classpath:embargo-test-data.sql"
})
public class JdbcEmbargoRepositoryIT extends JdbcRepositoryWithPermissionIT {

    private static final long LOADING_DISTRICT = -100L;
    private static final long REVIEWING_DISTRICT = -101L;
    private static final long RELEASED_DISTRICT = -102L;

    @Autowired
    private JdbcEmbargoRepository repository;

    private User loadingUser;
    private User reviewingUser;
    private User normalUser;

    @Before
    public void setup() {
        final PermissionScope loadingScope = PermissionScopes.statewide();
        Permission loadingPermission = new Permission(TestDataLoadingRead, loadingScope);

        loadingUser = userBuilder()
            .permissionsById(ImmutableMap.<String, Permission>builder()
                .put(TestDataLoadingRead, loadingPermission)
                .build())
            .build();

        final PermissionScope reviewingScope =
            PermissionScopes.districts(LOADING_DISTRICT, REVIEWING_DISTRICT, RELEASED_DISTRICT);
        Permission reviewingPermission = new Permission(TestDataReviewingRead, reviewingScope);

        reviewingUser = userBuilder()
            .permissionsById(ImmutableMap.<String, Permission>builder()
                .put(TestDataReviewingRead, reviewingPermission)
                .build())
            .build();

        normalUser = userBuilder().build();

    }

    private EmbargoIndividualSearch createQuery(int year, long districtId) {
        return EmbargoIndividualSearch.builder()
            .schoolYear(year)
            .districtId(districtId)
            .build();
    }

    private Map<EmbargoStatus, Boolean> searchFor(User user, int year, long districtId) {
        return repository.hasEmbargoAccess(user, createQuery(year, districtId));
    }

    @Test
    public void aUserWithoutTestDataReviewingReadShouldNeverBeEmbargoed() {
        assertThat(searchFor(normalUser, 1997, LOADING_DISTRICT).get(Loading)).isFalse();
        assertThat(searchFor(normalUser, 1997, LOADING_DISTRICT).get(Reviewing)).isFalse();
        assertThat(searchFor(normalUser, 1997, REVIEWING_DISTRICT).get(Loading)).isFalse();
        assertThat(searchFor(normalUser, 1997, REVIEWING_DISTRICT).get(Reviewing)).isFalse();
        assertThat(searchFor(normalUser, 1997, RELEASED_DISTRICT).get(Loading)).isFalse();
        assertThat(searchFor(normalUser, 1997, RELEASED_DISTRICT).get(Reviewing)).isFalse();
    }

    @Test
    public void aUserWithTestDataReviewingReadForAReviewingDistrictShouldBeEmbargoed() {
        assertThat(searchFor(reviewingUser, 1997, REVIEWING_DISTRICT).get(Loading)).isFalse();
        assertThat(searchFor(reviewingUser, 1997, REVIEWING_DISTRICT).get(Reviewing)).isTrue();
    }

    @Test
    public void aUserWithTestDataReviewingReadForALoadingDistrictShouldNotBeEmbargoed() {
        assertThat(searchFor(reviewingUser, 1997, LOADING_DISTRICT).get(Loading)).isFalse();
        assertThat(searchFor(reviewingUser, 1997, LOADING_DISTRICT).get(Reviewing)).isFalse();
    }

    @Test
    public void aUserWithTestDataLoadingReadForAReviewingDistrictShouldBeEmbargoed() {
        assertThat(searchFor(loadingUser, 1997, REVIEWING_DISTRICT).get(Loading)).isFalse();
        assertThat(searchFor(loadingUser, 1997, REVIEWING_DISTRICT).get(Reviewing)).isTrue();
    }

    @Test
    public void aUserWithTestDataLoadingReadForALoadingDistrictShouldBeEmbargoed() {
        assertThat(searchFor(loadingUser, 1997, LOADING_DISTRICT).get(Loading)).isTrue();
        assertThat(searchFor(loadingUser, 1997, LOADING_DISTRICT).get(Reviewing)).isFalse();
    }

    @Test
    public void allUsersForAReleasedDistrictShouldNotBeEmbargoed() {
        assertThat(searchFor(loadingUser, 1997, RELEASED_DISTRICT).get(Loading)).isFalse();
        assertThat(searchFor(loadingUser, 1997, RELEASED_DISTRICT).get(Reviewing)).isFalse();
        assertThat(searchFor(reviewingUser, 1997, RELEASED_DISTRICT).get(Loading)).isFalse();
        assertThat(searchFor(reviewingUser, 1997, RELEASED_DISTRICT).get(Reviewing)).isFalse();
        assertThat(searchFor(normalUser, 1997, RELEASED_DISTRICT).get(Loading)).isFalse();
        assertThat(searchFor(normalUser, 1997, RELEASED_DISTRICT).get(Reviewing)).isFalse();
    }
}
