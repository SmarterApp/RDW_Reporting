package org.opentestsystem.rdw.olap.repository.impl;

import org.junit.Ignore;
import org.junit.Test;
import org.opentestsystem.rdw.olap.repository.EmbargoRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.jdbc.Sql;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Embargo;

@Import(JdbcEmbargoRepository.class)
public class JdbcEmbargoRepositoryRST extends CachedRepositoryBackedIT {
    @Autowired
    private EmbargoRepository repository;

    @Test
    @Ignore
    public void itShouldReturnFalseWhenStateIsNotEmbargoed() {
        assertThat(repository.isStateEmbargoed()).isFalse();
    }

    @Sql(statements = {"INSERT INTO state_embargo (aggregate, migrate_id) VALUES (1, -10)"})
    @Test
    @Ignore
    public void itShouldReturnTrueWhenStateIsEmbargoed() {
        assertThat(getCachedValue(Embargo, "isStateEmbargoed")).isNull();

        assertThat(repository.isStateEmbargoed()).isTrue();
        assertThat(getCachedValue(Embargo, "isStateEmbargoed")).isNotNull();

        cacheConfiguration.clearRepositoryCache();
        assertThat(getCachedValue(Embargo, "isStateEmbargoed")).isNull();
    }

    @Sql(statements = {"INSERT INTO school (id, district_group_id, district_id, school_group_id, name, natural_id, external_id, embargo_enabled, updated, update_import_id, migrate_id) VALUES " +
            "  (-7, -1, -17, -1, 'School-7', 'id-7', 'externalId-7', 1, '2016-08-14 19:05:33.000000', -1, -1), " +
            "  (-8, -1, -18, -1, 'School-8', 'id-8', 'externalId-8', 1, '2016-08-14 19:05:33.000000', -1, -1), " +
            "  (-9, -1, -19, -1, 'School-9', 'id-9', 'externalId-9', 0, '2016-08-14 19:05:33.000000', -1, -1), " +
            "  (-10, -1, -19, -1, 'School-10','id-10', 'externalId-10', 0, '2016-08-14 19:05:33.000000', -1, -1); ",
            "INSERT INTO district (id, name, natural_id, external_id, migrate_id) VALUES " +
                    "  (-17, 'District-7', 'id-7', 'externalId-7', -1), " +
                    "  (-18, 'District-8', 'id-8', 'externalId-8', -1), " +
                    "  (-19, 'District-9', 'id-9', 'externalId-9', -1);"})
    @Test
    @Ignore
    public void itShouldReturnEmbargoedDistrictIds() {
        assertThat(getCachedValue(Embargo, "findAllEmbargoedDistrictIds")).isNull();

        assertThat(repository.findAllEmbargoedDistrictIds()).containsExactlyInAnyOrder(-17L, -18L);
        assertThat(getCachedValue(Embargo, "findAllEmbargoedDistrictIds")).isNotNull();

        cacheConfiguration.clearRepositoryCache();
        assertThat(getCachedValue(Embargo, "findAllEmbargoedDistrictIds")).isNull();
    }
}
