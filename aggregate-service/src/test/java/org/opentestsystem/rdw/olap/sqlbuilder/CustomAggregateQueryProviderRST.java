package org.opentestsystem.rdw.olap.sqlbuilder;


import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.common.model.AssessmentType;
import org.opentestsystem.rdw.olap.model.AggregateReportQuery;
import org.opentestsystem.rdw.olap.repository.impl.RepositoryBackedIT;
import org.opentestsystem.rdw.reporting.common.configuration.ReportingSystemSettings;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.OrganizationType;
import org.opentestsystem.rdw.reporting.common.sqlbuilder.QueryProvider;
import org.opentestsystem.rdw.reporting.common.sqlbuilder.SqlBuilderConfig;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.UUID;
import java.util.stream.Collectors;

import static com.google.common.collect.ImmutableSet.of;
import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.common.model.AssessmentType.IAB;
import static org.opentestsystem.rdw.common.model.AssessmentType.ICA;
import static org.opentestsystem.rdw.common.model.AssessmentType.SUMMATIVE;
import static org.opentestsystem.rdw.common.model.Subject.MATH;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Overall;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Section504;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.individualOf;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.permissions;

@RunWith(SpringRunner.class)
@ComponentScan({"org.opentestsystem.rdw.olap.repository", "org.opentestsystem.rdw.olap.repository.impl", "org.opentestsystem.rdw.olap.sqlbuilder"})
@Import({
        SqlBuilderConfig.class,
        QueryProvider.class,
        ReportingSystemSettings.class
})
public class CustomAggregateQueryProviderRST extends RepositoryBackedIT {

    @Autowired
    private QueryProviderRepositoryHelper reportQueryRepositoryHelper;

    @Autowired
    private QueryProvider queryProvider;

    @Value("${reporting.state.name}")
    private String stateName;

    @Value("${app.aggregate-reports.custom-aggregate-report-repository.organization-partition-size}")
    private int organizationPartitionSize;

    private User user = User.builder()
            .id(UUID.randomUUID().toString())
            .username("someone-10@somewhere.com")
            .password("redacted")
            .permissionsById(permissions(individualOf(PermissionScope.STATEWIDE)))
            .build();

    @Test
    public void testSQLForSummative() {
        testSQL(SUMMATIVE);
    }

    @Test
    public void testSQLForICA() {
        testSQL(ICA);
    }

    @Test
    public void testSQLForIAB() {
        testSQL(IAB);
    }

    public void testSQL(final AssessmentType assessmentType) {
        final Organization state = Organization.builder().name(stateName).organizationType(OrganizationType.State).build();
        final CustomAggregateQueryWithReportTemplateProvider aggregateQueryProvider = new CustomAggregateQueryWithReportTemplateProvider(state, organizationPartitionSize, queryProvider, reportQueryRepositoryHelper, user);
        final AggregateReportQuery.Builder builder = AggregateReportQuery.builder()
                .assessmentGradeCodes(of("-4"))
                .schoolYears(of(1999))
                .subjectCodes(of(MATH.code()))
                .assessmentTypeCode(assessmentType.code())
                .includeState(true)
                .includeAllDistricts(true)
                .schoolIds(of(1L))
                .dimensionTypes(of(Overall, Section504));

        assertThat(newArrayList(aggregateQueryProvider.toQuery(builder.build())).stream().map(QueryWithReportTemplate::getSqlQuery).collect(Collectors.toList()))
                .containsExactlyInAnyOrder(school504Sql(assessmentType), allDistricts504Sql(assessmentType), state504Sql(assessmentType), stateOverallSql(assessmentType), allDistrictsOverallSql(assessmentType), schoolOverallSql(assessmentType));

        assertThat(newArrayList(aggregateQueryProvider.toQuery(builder.includeAllDistricts(false).build())).stream().map(QueryWithReportTemplate::getSqlQuery).collect(Collectors.toList()))
                .containsExactlyInAnyOrder(state504Sql(assessmentType), school504Sql(assessmentType), stateOverallSql(assessmentType), schoolOverallSql(assessmentType));

        assertThat(newArrayList(aggregateQueryProvider.toQuery(builder.includeState(false).build())).stream().map(QueryWithReportTemplate::getSqlQuery).collect(Collectors.toList()))
                .containsExactlyInAnyOrder(school504Sql(assessmentType), schoolOverallSql(assessmentType));

        assertThat(newArrayList(aggregateQueryProvider.toQuery(builder.schoolIds(null).districtIds(of(1L)).includeAllSchoolsOfDistricts(false).build())).stream().map(QueryWithReportTemplate::getSqlQuery).collect(Collectors.toList()))
                .containsExactlyInAnyOrder(district504Sql(assessmentType), districtOverallSql(assessmentType));

        assertThat(newArrayList(aggregateQueryProvider.toQuery(builder.schoolIds(null).districtIds(of(1L)).includeAllSchoolsOfDistricts(true).build())).stream().map(QueryWithReportTemplate::getSqlQuery).collect(Collectors.toList()))
                .containsExactlyInAnyOrder(district504Sql(assessmentType), districtOverallSql(assessmentType), allSchoolsInDistrictOverallSql(assessmentType), allSchoolsInDistrict504Sql(assessmentType));
    }

    private static String assessmentBasedLevelAndFrom(final AssessmentType assessmentType) {
        return assessmentType.equals(IAB) ?
                " FROM fact_student_iab_exam fe "
                : ", sum(CASE WHEN performance_level = 4 THEN 1 ELSE 0 END) AS level4 FROM fact_student_exam fe ";
    }

    private static String state504Sql(final AssessmentType assessmentType) {
        return "SELECT  round(avg(scale_score)) AS score, " +
                "round(stddev_samp(scale_score)/sqrt(count(*))) as std_err, " +
                "sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1, " +
                "sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2, " +
                "sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3, " +
                "fe.school_year, " +
                "fe.asmt_id, " +
                "'State' AS organization_type, " +
                "NULL AS organization_id, " +
                "'Section504' AS dimension, " +
                "fe.section504 AS dimension_id, " +
                "CASE WHEN fe.section504 = 1 THEN 'yes' WHEN fe.section504 = 0 THEN 'no' ELSE 'undefined' END AS dimension_code" +
                assessmentBasedLevelAndFrom(assessmentType) +
                "JOIN asmt a ON a.id = fe.asmt_id " +
                "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                (assessmentType == SUMMATIVE ? "AND ( fe.school_year < 2018 OR EXISTS (SELECT 1 FROM state_embargo WHERE aggregate = 0) OR 1 = :state_embargo_admin) " : "") +
                "AND ( ( true = :all_section504s OR fe.section504 in (:section504_ids) ))) " +
                "GROUP BY  fe.school_year, fe.asmt_id, fe.section504";
    }

    private static String allDistricts504Sql(final AssessmentType assessmentType) {
        return "SELECT  round(avg(scale_score)) AS score, " +
                "round(stddev_samp(scale_score)/sqrt(count(*))) as std_err, " +
                "sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1, " +
                "sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2, " +
                "sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3, " +
                "fe.school_year, " +
                "fe.asmt_id, " +
                "'District' AS organization_type, " +
                "d.id AS organization_id, " +
                "'Section504' AS dimension, " +
                "fe.section504 AS dimension_id, " +
                "CASE WHEN fe.section504 = 1 THEN 'yes' WHEN fe.section504 = 0 THEN 'no' ELSE 'undefined' END AS dimension_code" +
                assessmentBasedLevelAndFrom(assessmentType) +
                "JOIN asmt a ON a.id = fe.asmt_id " +
                "JOIN school sch ON sch.id = fe.school_id " +
                "JOIN district d ON d.id = sch.district_id " +
                "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                (assessmentType == SUMMATIVE ? "AND ( fe.school_year < 2018 OR sch.embargo_enabled = 0 OR 1 = :state_embargo_admin OR sch.district_id IN (:district_embargo_admin_ids)) " : "") +
                "AND ( ( true = :all_section504s OR fe.section504 in (:section504_ids) ))) " +
                "GROUP BY  fe.school_year, fe.asmt_id, d.id, fe.section504";
    }

    private static String school504Sql(final AssessmentType assessmentType) {
        return "SELECT  round(avg(scale_score)) AS score, " +
                "round(stddev_samp(scale_score)/sqrt(count(*))) as std_err, " +
                "sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1, " +
                "sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2, " +
                "sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3, " +
                "fe.school_year, " +
                "fe.asmt_id, " +
                "'School' AS organization_type, " +
                "fe.school_id AS organization_id, " +
                "'Section504' AS dimension, " +
                "fe.section504 AS dimension_id, C" +
                "ASE WHEN fe.section504 = 1 THEN 'yes' WHEN fe.section504 = 0 THEN 'no' ELSE 'undefined' END AS dimension_code" +
                assessmentBasedLevelAndFrom(assessmentType) +
                "JOIN asmt a ON a.id = fe.asmt_id " +
                "JOIN school sch ON sch.id = fe.school_id " +
                "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                "AND ( fe.school_id in (:school_ids)) " +
                (assessmentType == SUMMATIVE ? "AND ( fe.school_year < 2018 OR sch.embargo_enabled = 0 OR 1 = :state_embargo_admin OR sch.district_id IN (:district_embargo_admin_ids)) " : "") +
                "AND ( ( true = :all_section504s OR fe.section504 in (:section504_ids) ))) " +
                "GROUP BY  fe.school_year, fe.asmt_id, fe.school_id, fe.section504";
    }

    private static String district504Sql(final AssessmentType assessmentType) {
        return "SELECT  round(avg(scale_score)) AS score, " +
                "round(stddev_samp(scale_score)/sqrt(count(*))) as std_err, " +
                "sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1, " +
                "sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2, " +
                "sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3, " +
                "fe.school_year, " +
                "fe.asmt_id, " +
                "'District' AS organization_type, " +
                "d.id AS organization_id, " +
                "'Section504' AS dimension, " +
                "fe.section504 AS dimension_id, " +
                "CASE WHEN fe.section504 = 1 THEN 'yes' WHEN fe.section504 = 0 THEN 'no' ELSE 'undefined' END AS dimension_code" +
                assessmentBasedLevelAndFrom(assessmentType) +
                "JOIN asmt a ON a.id = fe.asmt_id " +
                "JOIN school sch ON sch.id = fe.school_id " +
                "JOIN district d ON d.id = sch.district_id " +
                "WHERE (( fe.school_year IN (:school_years) " +
                "AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                "AND ( d.id in (:district_ids)) " +
                (assessmentType == SUMMATIVE ? "AND ( fe.school_year < 2018 OR sch.embargo_enabled = 0 OR 1 = :state_embargo_admin OR sch.district_id IN (:district_embargo_admin_ids)) " : "") +
                "AND ( ( true = :all_section504s OR fe.section504 in (:section504_ids) ))) " +
                "GROUP BY  fe.school_year, fe.asmt_id, d.id, fe.section504";
    }

    private static String allSchoolsInDistrict504Sql(final AssessmentType assessmentType) {
        return "SELECT  round(avg(scale_score)) AS score, " +
                "round(stddev_samp(scale_score)/sqrt(count(*))) as std_err, " +
                "sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1, " +
                "sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2, " +
                "sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3, " +
                "fe.school_year, " +
                "fe.asmt_id, " +
                "'School' AS organization_type, " +
                "fe.school_id AS organization_id, " +
                "'Section504' AS dimension, " +
                "fe.section504 AS dimension_id, " +
                "CASE WHEN fe.section504 = 1 THEN 'yes' WHEN fe.section504 = 0 THEN 'no' ELSE 'undefined' END AS dimension_code" +
                assessmentBasedLevelAndFrom(assessmentType) +
                "JOIN asmt a ON a.id = fe.asmt_id " +
                "JOIN school sch ON sch.id = fe.school_id " +
                "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                "AND ( sch.district_id in (:school_district_ids)) " +
                (assessmentType == SUMMATIVE ? "AND ( fe.school_year < 2018 OR sch.embargo_enabled = 0 OR 1 = :state_embargo_admin OR sch.district_id IN (:district_embargo_admin_ids)) " : "") +
                "AND ( ( true = :all_section504s OR fe.section504 in (:section504_ids) ))) " +
                "GROUP BY  fe.school_year, fe.asmt_id, fe.school_id, fe.section504";
    }

    private static String stateOverallSql(final AssessmentType assessmentType) {
        return "SELECT  round(avg(scale_score)) AS score, " +
                "round(stddev_samp(scale_score)/sqrt(count(*))) as std_err, " +
                "sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1, " +
                "sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2, " +
                "sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3, " +
                "fe.school_year, " +
                "fe.asmt_id, " +
                "'State' AS organization_type, " +
                "NULL AS organization_id, " +
                "'Overall' AS dimension, " +
                "null  AS dimension_id, " +
                "null AS dimension_code" +
                assessmentBasedLevelAndFrom(assessmentType) +
                "JOIN asmt a ON a.id = fe.asmt_id " +
                (assessmentType == SUMMATIVE ?
                        "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                                "AND ( fe.school_year < 2018 OR EXISTS (SELECT 1 FROM state_embargo WHERE aggregate = 0) OR 1 = :state_embargo_admin)) "
                        : "WHERE ( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) ") +
                "GROUP BY  fe.school_year, fe.asmt_id";
    }

    private static String allDistrictsOverallSql(final AssessmentType assessmentType) {
        return "SELECT  round(avg(scale_score)) AS score, " +
                "round(stddev_samp(scale_score)/sqrt(count(*))) as std_err, " +
                "sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1, " +
                "sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2, " +
                "sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3, " +
                "fe.school_year, " +
                "fe.asmt_id, " +
                "'District' AS organization_type, " +
                "d.id AS organization_id, " +
                "'Overall' AS dimension, " +
                "null  AS dimension_id, " +
                "null AS dimension_code" +
                assessmentBasedLevelAndFrom(assessmentType) +
                "JOIN asmt a ON a.id = fe.asmt_id " +
                "JOIN school sch ON sch.id = fe.school_id " +
                "JOIN district d ON d.id = sch.district_id " +
                (assessmentType == SUMMATIVE ?
                        "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                                "AND ( fe.school_year < 2018 OR sch.embargo_enabled = 0 OR 1 = :state_embargo_admin OR sch.district_id IN (:district_embargo_admin_ids))) "
                        : "WHERE ( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) ") +
                "GROUP BY  fe.school_year, fe.asmt_id, d.id";
    }

    private static String districtOverallSql(final AssessmentType assessmentType) {
        return "SELECT  round(avg(scale_score)) AS score, " +
                "round(stddev_samp(scale_score)/sqrt(count(*))) as std_err, " +
                "sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1, " +
                "sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2, " +
                "sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3, " +
                "fe.school_year, " +
                "fe.asmt_id, " +
                "'District' AS organization_type, " +
                "d.id AS organization_id, " +
                "'Overall' AS dimension, " +
                "null  AS dimension_id, " +
                "null AS dimension_code" +
                assessmentBasedLevelAndFrom(assessmentType) +
                "JOIN asmt a ON a.id = fe.asmt_id " +
                "JOIN school sch ON sch.id = fe.school_id " +
                "JOIN district d ON d.id = sch.district_id " +
                (assessmentType == SUMMATIVE ?
                        "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                                "AND ( d.id in (:district_ids)) " +
                                "AND ( fe.school_year < 2018 OR sch.embargo_enabled = 0 OR 1 = :state_embargo_admin OR sch.district_id IN (:district_embargo_admin_ids))) "
                        : "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                        "AND ( d.id in (:district_ids))) ") +
                "GROUP BY  fe.school_year, fe.asmt_id, d.id";
    }

    private static String schoolOverallSql(final AssessmentType assessmentType) {
        return "SELECT  round(avg(scale_score)) AS score, " +
                "round(stddev_samp(scale_score)/sqrt(count(*))) as std_err, " +
                "sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1, " +
                "sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2, " +
                "sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3, " +
                "fe.school_year, " +
                "fe.asmt_id, " +
                "'School' AS organization_type, " +
                "fe.school_id AS organization_id, " +
                "'Overall' AS dimension, " +
                "null  AS dimension_id, " +
                "null AS dimension_code" +
                assessmentBasedLevelAndFrom(assessmentType) +
                "JOIN asmt a ON a.id = fe.asmt_id " +
                "JOIN school sch ON sch.id = fe.school_id " +
                (assessmentType == SUMMATIVE ?
                        "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                                "AND ( fe.school_id in (:school_ids)) " +
                                "AND ( fe.school_year < 2018 OR sch.embargo_enabled = 0 OR 1 = :state_embargo_admin OR sch.district_id IN (:district_embargo_admin_ids))) "
                        : "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                        "AND ( fe.school_id in (:school_ids))) ") +
                "GROUP BY  fe.school_year, fe.asmt_id, fe.school_id";
    }

    private static String allSchoolsInDistrictOverallSql(final AssessmentType assessmentType) {
        return "SELECT  round(avg(scale_score)) AS score, " +
                "round(stddev_samp(scale_score)/sqrt(count(*))) as std_err, " +
                "sum(CASE WHEN performance_level = 1 THEN 1 ELSE 0 END) AS level1, " +
                "sum(CASE WHEN performance_level = 2 THEN 1 ELSE 0 END) AS level2, " +
                "sum(CASE WHEN performance_level = 3 THEN 1 ELSE 0 END) AS level3, " +
                "fe.school_year, " +
                "fe.asmt_id, " +
                "'School' AS organization_type, " +
                "fe.school_id AS organization_id, " +
                "'Overall' AS dimension, " +
                "null  AS dimension_id, " +
                "null AS dimension_code" +
                assessmentBasedLevelAndFrom(assessmentType) +
                "JOIN asmt a ON a.id = fe.asmt_id " +
                "JOIN school sch ON sch.id = fe.school_id " +
                (assessmentType == SUMMATIVE ?
                        "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                                "AND ( sch.district_id in (:school_district_ids)) " +
                                "AND ( fe.school_year < 2018 OR sch.embargo_enabled = 0 OR 1 = :state_embargo_admin OR sch.district_id IN (:district_embargo_admin_ids))) "
                        : "WHERE (( fe.school_year IN (:school_years) AND a.grade_id IN (:asmt_grade_ids) AND a.subject_id in (:subject_ids) AND a.type_id = :asmt_type_id) " +
                        "AND ( sch.district_id in (:school_district_ids))) ") +
                "GROUP BY  fe.school_year, fe.asmt_id, fe.school_id";
    }
}