package org.opentestsystem.rdw.olap.sqlbuilder.impl.query;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.ImmutableSet;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.olap.model.ClaimOrganizationQuery;
import org.opentestsystem.rdw.olap.repository.impl.RepositoryBackedIT;
import org.opentestsystem.rdw.olap.sqlbuilder.impl.QueryProviderRepositoryHelper;
import org.opentestsystem.rdw.reporting.common.configuration.ReportingSystemProperties;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.sqlbuilder.QueryProvider;
import org.opentestsystem.rdw.reporting.common.sqlbuilder.SqlBuilderConfig;
import org.opentestsystem.rdw.reporting.common.security.User;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.junit4.SpringRunner;

import static com.google.common.collect.ImmutableSet.of;
import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.common.model.AssessmentType.SUMMATIVE;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Overall;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.State;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.individualOf;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.permissions;

@RunWith(SpringRunner.class)
@ComponentScan({"org.opentestsystem.rdw.olap.repository", "org.opentestsystem.rdw.olap.repository.impl", "org.opentestsystem.rdw.olap.sqlbuilder"})
@Import({
        SqlBuilderConfig.class,
        QueryProvider.class
})
public class ClaimReportQueryTemplateProviderRST extends RepositoryBackedIT {

    @Autowired
    @Qualifier("reportingSystemSettings")
    private ReportingSystemProperties reportingSystemProperties;

    @Autowired
    private QueryProviderRepositoryHelper reportQueryRepositoryHelper;

    @Autowired
    private QueryProvider queryProvider;

    @Value("${reporting.state.name}")
    private String stateName;

    @Value("${app.aggregate-reports.custom-aggregate-report-repository.organization-partition-size}")
    private int organizationPartitionSize;

    private ClaimSqlQueryWithReportTemplateProvider claimReportQueryTemplateProvider;
    private ClaimOrganizationQuery.Builder builder;

    private User user = User.builderExt()
            .id("userId")
            .username("someone-10@somewhere.com")
            .password("redacted")
            .permissionsById(permissions(individualOf(PermissionScope.STATEWIDE)))
            .build();

    @Before
    public void setUp() {
        final Organization state = Organization.builder().name(stateName).organizationType(State).build();
        claimReportQueryTemplateProvider = new ClaimSqlQueryWithReportTemplateProvider(state, organizationPartitionSize, queryProvider, reportQueryRepositoryHelper, user, reportingSystemProperties);
        builder = ClaimOrganizationQuery.builder()
                .assessmentGradeCodes(of("-4"))
                .schoolYears(of(1999))
                .claimCodesBySubject(ImmutableMap.of("Math", ImmutableSet.of("1")))
                .assessmentTypeCode(SUMMATIVE.code())
                .dimensionType(Overall)
                .organizationType(State);
    }

    private static final String stateOverallSql = "SELECT  " +
            "sum(CASE WHEN ecs.category = 1 THEN 1 ELSE 0 END) AS level1, " +
            "sum(CASE WHEN ecs.category = 2 THEN 1 ELSE 0 END) AS level2, " +
            "sum(CASE WHEN ecs.category = 3 THEN 1 ELSE 0 END) AS level3, " +
            "sum(CASE WHEN ecs.category = 4 THEN 1 ELSE 0 END) AS level4, " +
            "sum(CASE WHEN ecs.category = 5 THEN 1 ELSE 0 END) AS level5, " +
            "sum(CASE WHEN ecs.category = 6 THEN 1 ELSE 0 END) AS level6, " +
            "e.school_year, " +
            "e.asmt_id, " +
            "ecs.subject_claim_score_id, " +
            "ss.code as claim_code, " +
            "'State' AS organization_type, " +
            "NULL AS organization_id, " +
            "'Overall' AS dimension, " +
            "null  AS dimension_id, " +
            "null AS dimension_code " +
            "FROM exam_claim_score ecs " +
            "JOIN exam e on e.id = ecs.exam_id " +
            "JOIN subject_score ss ON ss.id = ecs.subject_claim_score_id " +
            "JOIN asmt a ON a.id = e.asmt_id" +
            " WHERE (( e.school_year IN (:school_years) " +
            "AND a.grade_id IN (:asmt_grade_ids) " +
            "AND a.subject_id in (:subject_ids) " +
            "AND a.type_id = :asmt_type_id " +
            "AND ss.code in (:subject_claim_score_codes)) " +
            "AND ( e.school_year < 2018 OR EXISTS (SELECT 1 FROM state_embargo WHERE aggregate = 0) OR 1 = :state_embargo_admin)) " +
            "GROUP BY  e.school_year, e.asmt_id, ecs.subject_claim_score_id, ss.code";

    @Test
    public void testSqlBuilderGroupByStateWithDimensionOverall() {
        assertThat(claimReportQueryTemplateProvider.toQuery(builder.build(), State).getSqlQuery()).isEqualTo(stateOverallSql);
    }

}
