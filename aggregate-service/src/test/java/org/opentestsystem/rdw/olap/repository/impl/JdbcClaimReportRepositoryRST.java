package org.opentestsystem.rdw.olap.repository.impl;


import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.olap.model.CustomAggregateOrganizationQuery;
import org.opentestsystem.rdw.olap.repository.CustomAggregateReportRepository;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.jdbc.Sql;

import java.util.UUID;

import static com.google.common.collect.ImmutableSet.of;
import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.common.model.AssessmentType.ICA;
import static org.opentestsystem.rdw.common.model.Subject.ELA;
import static org.opentestsystem.rdw.common.model.Subject.MATH;
import static org.opentestsystem.rdw.olap.model.AggregateServicePermission.AggregateRead;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Overall;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.State;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.permissions;

@SuppressWarnings({"SqlNoDataSourceInspection", "SqlResolve"})
@Sql(scripts = {"classpath:ClaimEntitiesSetup.sql"})
@ActiveProfiles("redshift")
public class JdbcClaimReportRepositoryRST extends RepositoryBackedIT {

    @Autowired
    @Qualifier("claimAggregate")
    private CustomAggregateReportRepository repository;

    @Value("${reporting.state.name}")
    private String stateName;

    private CustomAggregateOrganizationQuery.Builder queryBuilder;

    // this test is for a user without embargo permissions
    private static final User user = User.builder()
            .id(UUID.randomUUID().toString())
            .username("someone-10@somewhere.com")
            .password("redacted")
            //only invalid district and school ids; repository should ignore them
            .permissionsById(permissions(new Permission(AggregateRead, PermissionScope.builder()
                    .statewide(false)
                    .addDistrictIds(of(-100L))
                    .addSchoolIds(of(-100L))
                    .build())))
            .build();

    @Before
    public void setUp() {
        queryBuilder = CustomAggregateOrganizationQuery.builder()
                .assessmentGradeCodes(of("-4"))
                .organizationType(State)
                .schoolYears(of(1999))
                .subjectCodes(of(MATH.code()))
                .assessmentTypeCode(ICA.code())
                .dimensionType(Overall);
    }

    @Test
    public void itShouldRunQuery() {
        assertThat(repository.findByOrganizationType(user, queryBuilder.subjectCodes(of(ELA.code())).build(), State).getPayload()).isEmpty();
    }
}