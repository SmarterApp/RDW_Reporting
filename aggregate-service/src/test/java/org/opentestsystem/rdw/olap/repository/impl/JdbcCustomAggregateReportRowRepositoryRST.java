package org.opentestsystem.rdw.olap.repository.impl;


import com.google.common.collect.ImmutableSet;
import org.apache.commons.math3.stat.descriptive.DescriptiveStatistics;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.olap.model.AggregateReport;
import org.opentestsystem.rdw.olap.model.OrganizationTypeQuery;
import org.opentestsystem.rdw.olap.repository.CustomAggregateReportRepository;
import org.opentestsystem.rdw.reporting.common.model.ActiveAssessment;
import org.opentestsystem.rdw.reporting.common.model.Dimension;
import org.opentestsystem.rdw.reporting.common.model.Measures;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.ReportRow;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.jdbc.SqlGroup;

import java.util.List;
import java.util.Objects;
import java.util.UUID;
import java.util.stream.Collectors;

import static com.google.common.collect.ImmutableSet.of;
import static java.util.stream.Collectors.toList;
import static java.util.stream.Collectors.toSet;
import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.common.model.AssessmentType.IAB;
import static org.opentestsystem.rdw.common.model.AssessmentType.ICA;
import static org.opentestsystem.rdw.common.model.AssessmentType.SUMMATIVE;
import static org.opentestsystem.rdw.common.model.Subject.ELA;
import static org.opentestsystem.rdw.common.model.Subject.MATH;
import static org.opentestsystem.rdw.olap.TestUtils.verifyStateStudentCount;
import static org.opentestsystem.rdw.olap.model.AggregateServicePermission.AggregateRead;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.EconomicDisadvantage;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Ethnicity;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Gender;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.IEP;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.LEP;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.MigrantStatus;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Overall;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Section504;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.StudentEnrolledGrade;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.District;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.School;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.State;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.permissions;
import static org.springframework.test.context.jdbc.Sql.ExecutionPhase.AFTER_TEST_METHOD;
import static org.springframework.test.context.jdbc.Sql.ExecutionPhase.BEFORE_TEST_METHOD;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTable;

@SuppressWarnings({"SqlNoDataSourceInspection", "SqlResolve"})
@SqlGroup({
        @Sql(executionPhase = BEFORE_TEST_METHOD, scripts = {"classpath:OlapEntitiesSetup.sql"}),
        @Sql(executionPhase = AFTER_TEST_METHOD, scripts = {"classpath:OlapEntitiesTeardown.sql"})
})
@ActiveProfiles("redshift")
public class JdbcCustomAggregateReportRowRepositoryRST extends RepositoryBackedIT {

    @Autowired
    private CustomAggregateReportRepository repository;

    @Autowired
    private JdbcTemplate template;

    @Value("${reporting.state.name}")
    private String stateName;

    private ReportRow stateOverall;
    private OrganizationTypeQuery.Builder queryBuilder;
    private int ethnicityCount;
    private int genderCount;
    private int districtsCount;

    // this test is for a user without embargo permissions
    private static final User user = User.builder()
            .id(UUID.randomUUID().toString())
            .username("someone-10@somewhere.com")
            .password("redacted")
            //only invalid district and school ids; repository should ignore them
            .permissionsById(permissions(new Permission(AggregateRead, PermissionScope.builder()
                    .statewide(false)
                    .addDistrictIds(of(-100L))
                    .addSchoolIds(of(-100L))
                    .build())))
            .build();

    @Before
    public void setUp() {
        ethnicityCount = countRowsInTable(template, "ethnicity");
        genderCount = countRowsInTable(template, "gender");
        districtsCount = countRowsInTable(template, "district");

        queryBuilder = OrganizationTypeQuery.builder()
                .assessmentGradeCodes(of("-4"))
                .organizationType(State)
                .schoolYears(of(1999))
                .subjectCodes(of(MATH.code()))
                .assessmentTypeCode(ICA.code())
                .dimensionType(Overall);

        final ImmutableSet<Double> scaleScores = of(2500.0, 2400.0, 2300.0, 2100.0, 2000.0);
        final DescriptiveStatistics stats = new DescriptiveStatistics();
        for (final Double scaleScore : scaleScores) {
            stats.addValue(scaleScore);
        }
        stateOverall = ReportRow.builder()
                .assessment(ActiveAssessment.builder().id(-8).gradeCode("-4").subjectCode("Math").label("asmt-8").examSchoolYear(1999).build())
                .organization(Organization.builder().name(stateName).organizationType(State).build())
                .dimension(Dimension.builder().type(Overall).build())
                .measures(Measures.builder()
                        .avgScaleScore((int) Math.round(stats.getMean()))
                        .avgStdErr((int) Math.round(stats.getStandardDeviation() / Math.sqrt(scaleScores.size())))
                        .level1Count(2)
                        .level2Count(1)
                        .level3Count(1)
                        .level4Count(1)
                        .build())
                .build();
    }

    @Test
    public void itShouldFindByQueryWithIAB() {
        final AggregateReport report = repository.findByOrganizationType(user, OrganizationTypeQuery.builder()
                .assessmentGradeCodes(of("-3"))
                .organizationType(State)
                .schoolYears(of(1999))
                .subjectCodes(of(ELA.code()))
                .assessmentTypeCode(IAB.code())
                .dimensionType(Overall).build(), State);

        assertThat(report.getRows().size()).isEqualTo(1);

        final Measures measures = report.getRows().get(0).getMeasures();
        assertThat(measures.getLevel1Count()).isEqualTo(3);
        assertThat(measures.getLevel2Count()).isEqualTo(1);
        assertThat(measures.getLevel3Count()).isEqualTo(1);
        assertThat(measures.getLevel4Count()).isNull();
    }

    @Test
    public void itShouldFindByQuery() {
        assertThat(repository.findByOrganizationType(user, queryBuilder.subjectCodes(of(ELA.code())).build(), State).getRows()).isEmpty();

        verifyStateStudentCount(repository.findByOrganizationType(user, OrganizationTypeQuery.builder()
                .assessmentGradeCodes(of("-3"))
                .schoolYears(of(1999))
                .organizationType(State)
                .subjectCodes(of(ELA.code()))
                .assessmentTypeCode(SUMMATIVE.code())
                .dimensionType(Overall)
                .build(), State).getRows(), 6);
    }

    @Test
    public void itShouldReturnState() {
        final AggregateReport report = repository.findByOrganizationType(user, queryBuilder.build(), State);

        assertThat(report.isCreatedWhileDataEmbargoed()).isFalse();
        assertThat(report.getRows()).usingFieldByFieldElementComparator().containsExactly(stateOverall);
    }

    @Test
    public void itShouldReturnAllDistrictsInState() {
        final AggregateReport report = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .build(), District);

        assertThat(report.isCreatedWhileDataEmbargoed()).isFalse();
        assertThat(report.getRows().size()).isEqualTo(districtsCount);
    }

    @Test
    public void itShouldReturnDistricts() {
        final AggregateReport report = repository.findByOrganizationType(user, queryBuilder
                .organizationType(District)
                .organizationIds(of(-17L, -18L, -19L, -99L))
                .build(), District);

        assertThat(report.isCreatedWhileDataEmbargoed()).isFalse();
        assertThat(report.getRows().size()).isEqualTo(districtsCount);
    }


    @Test
    public void itShouldReturnAllSchoolsInDistrict() {
        final AggregateReport report = repository.findByOrganizationType(user, queryBuilder
                .organizationType(District)
                .organizationIds(of(-19L, -99L))
                .build(), School);

        assertThat(report.isCreatedWhileDataEmbargoed()).isFalse();
        assertThat(report.getRows().size()).isEqualTo(2);
    }

    @Test
    public void itShouldReturnSchools() {
        final AggregateReport report = repository.findByOrganizationType(user, queryBuilder
                .organizationType(School)
                .organizationIds(of(-9L, -10L, -99L))
                .build(), School);

        assertThat(report.isCreatedWhileDataEmbargoed()).isFalse();
        assertThat(report.getRows().size()).isEqualTo(2);
    }

    @Test
    public void itShouldFindByQueryWithIEPDimension() {
        final AggregateReport report = repository.findByOrganizationType(user, queryBuilder
                .organizationType(School)
                .organizationIds(of(-9L))
                .dimensionType(IEP)
                .build(), School);

        assertThat(report.isCreatedWhileDataEmbargoed()).isFalse();
        List<ReportRow> rows = report.getRows();
        assertThat(rows.size()).isEqualTo(2);
        for (final ReportRow row : rows) {
            if (row.getDimension().getCode().equalsIgnoreCase("no")) assertThat(row.getMeasures().getStudentCount()).isEqualTo(1);
            else assertThat(row.getMeasures().getStudentCount()).isEqualTo(0);
        }

        rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(IEP)
                .organizationIds(null)
                .build(), District).getRows();
        assertThat(rows.size()).isEqualTo((districtsCount) * 2);

        rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(IEP)
                .build(), State).getRows();
        verifyStateStudentCount(rows, 5);
    }

    @Test
    public void itShouldFindByQueryWithIEPDimensionAndGenderFilters() {
        final List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(IEP)
                .genderCodes(of("gender-18"))
                .build(), State).getRows();

        verifyStateStudentCount(rows, 2);
    }

    @Test
    public void itShouldFindByQueryWithIEPDimensionAndFilter() {
        final List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(IEP)
                .iepCodes(of("yes"))
                .build(), State).getRows();

        verifyStateStudentCount(rows, 3);
    }

    @Test
    public void itShouldFindByQueryWithLEPDimension() {
        List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(School)
                .organizationIds(of(-9L))
                .dimensionType(LEP)
                .build(), School).getRows();

        assertThat(rows.size()).isEqualTo(2);
        for (final ReportRow row : rows) {
            if (row.getDimension().getCode().equalsIgnoreCase("no")) assertThat(row.getMeasures().getStudentCount()).isEqualTo(0);
            else assertThat(row.getMeasures().getStudentCount()).isEqualTo(1);
        }

        rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .organizationIds(null)
                .dimensionType(LEP)
                .build(), District).getRows();
        assertThat(rows.size()).isEqualTo((districtsCount) * 2);
    }

    @Test
    public void itShouldFindByQueryWithLEPDimensionAndEthnicityFilter() {
        final List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(LEP)
                .ethnicityCodes(of("ethnicity-28", "ethnicity-29"))
                .build(), State).getRows();

        assertThat(rows.stream()
                .filter(r -> (r.getDimension().getCode().equals("yes")))
                .mapToInt(r -> (r.getMeasures().getStudentCount()))
                .sum()).isEqualTo(3);
    }

    @Test
    public void itShouldFindByQueryWithLEPDimensionAndFilter() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(LEP)
                .lepCodes(of("no"))
                .build(), District).getRows().size()).isEqualTo((districtsCount));

        verifyStateStudentCount(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(LEP)
                .lepCodes(of("no"))
                .build(), State).getRows(), 0);

        verifyStateStudentCount(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(LEP)
                .lepCodes(of("no", "yes"))
                .build(), State).getRows(), 5);
    }

    @Test
    public void itShouldFindByQueryWithEconomicDisadvantageDimension() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(EconomicDisadvantage)
                .build(), District).getRows().size()).isEqualTo((districtsCount) * 2);

        final List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(School)
                .organizationIds(of(-9L))
                .dimensionType(EconomicDisadvantage)
                .build(), School).getRows();

        assertThat(rows.size()).isEqualTo(2);
        for (final ReportRow row : rows) {
            if (row.getDimension().getCode().equalsIgnoreCase("no")) assertThat(row.getMeasures().getStudentCount()).isEqualTo(1);
            else assertThat(row.getMeasures().getStudentCount()).isEqualTo(0);
        }
    }

    @Test
    public void itShouldFindByQueryWithEconomicDisadvantageDimensionAndFilter() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(EconomicDisadvantage)
                .economicDisadvantageCodes(of("yes"))
                .build(), District).getRows().size()).isEqualTo(districtsCount);
    }

    @Test
    public void itShouldFindByQueryWithEconomicDisadvantageDimensionAndGenderFilter() {
        final List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(EconomicDisadvantage)
                .genderCodes(of("gender-18"))
                .build(), State).getRows();

        assertThat(rows.stream()
                .filter(r -> (r.getDimension().getCode().equals("no")))
                .mapToInt(r -> (r.getMeasures().getStudentCount()))
                .sum()).isEqualTo(2);
    }

    @Test
    public void itShouldFindByQueryWithSection504Dimension() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Section504)
                .build(), District).getRows().size()).isEqualTo((districtsCount) * 3);

        final List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(School)
                .organizationIds(of(-9L))
                .dimensionType(Section504)
                .build(), School).getRows();

        assertThat(rows.size()).isEqualTo(3);
        verifyBooleanDimensionStudentCodeCount(rows, 0, 0, 1);
    }

    @Test
    public void itShouldFindByQueryWithSection504DimensionAndFilter() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Section504)
                .section504Codes(of("undefined", "yes"))
                .build(), District).getRows().size()).isEqualTo((districtsCount) * 2);
    }

    @Test
    public void itShouldFindByQueryWithSection504DimensionAndEconomicDisadvantageFilter() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Section504)
                .economicDisadvantageCodes(of("no"))
                .build(), District).getRows().size()).isEqualTo((districtsCount) * 3);

        List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Section504)
                .economicDisadvantageCodes(of("no"))
                .build(), State).getRows();

        assertThat(rows.size()).isEqualTo(3);
        verifyBooleanDimensionStudentCodeCount(rows, 0, 4, 1);
    }

    @Test
    public void itShouldFindByQueryWithMigrantStatusDimension() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(MigrantStatus)
                .build(), District).getRows().size()).isEqualTo((districtsCount) * 3);

        List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(School)
                .dimensionType(MigrantStatus)
                .organizationIds(of(-9L))
                .administrativeConditionCodes(of("IN"))
                .completenessCodes(of("Complete"))
                .build(), School).getRows();

        assertThat(rows.size()).isEqualTo(3);
        verifyBooleanDimensionStudentCodeCount(rows, 1, 0, 0);

        rows = repository.findByOrganizationType(user, queryBuilder.genderCodes(of("gender-18")).build(), School).getRows();
        verifyBooleanDimensionStudentCodeCount(rows, 0, 0, 0);
    }

    @Test
    public void itShouldFindByQueryWithMigrantStatusDimensionAndFilter() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(MigrantStatus)
                .migrantStatusCodes(of("yes"))
                .build(), District).getRows().size()).isEqualTo(districtsCount);

        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(MigrantStatus)
                .migrantStatusCodes(of("yes"))
                .build(), State).getRows().stream().
                filter(r -> (r.getDimension().getCode().equals("yes")))
                .mapToInt(r -> (r.getMeasures().getStudentCount()))
                .sum()).isEqualTo(5);
    }

    @Test
    public void itShouldFindByQueryWithMigrantStatusDimensionAndLEPFilter() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(MigrantStatus)
                .lepCodes(of("no"))
                .build(), District).getRows().size()).isEqualTo(districtsCount * 3);

        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(MigrantStatus)
                .lepCodes(of("no"))
                .build(), State).getRows().stream()
                .filter(r -> (r.getDimension().getCode().equals("no")))
                .mapToInt(r -> (r.getMeasures().getStudentCount()))
                .sum()).isEqualTo(0);
    }

    @Test
    public void itShouldFindByQueryWithGenderDimension() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(School)
                .organizationIds(of(-9L))
                .dimensionType(Gender)
                .build(), School).getRows().size()).isEqualTo(countRowsInTable(template, "gender"));
    }

    @Test
    public void itShouldFindByQueryWithGenderDimensionAndFilter() {
        final List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(School)
                .organizationIds(of(-8L))
                .dimensionType(Gender)
                .genderCodes(of("gender-19"))
                .build(), School).getRows();

        assertThat(rows.size()).isEqualTo(1);
        assertThat(rows.stream().filter(r -> (r.getDimension().getCode().equals("gender-19"))).mapToInt(r -> (r.getMeasures().getStudentCount())).sum()).isEqualTo(1);
    }

    @Test
    public void itShouldFindByQueryWithGenderDimensionAndMigrantStatusFilter() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Gender)
                .migrantStatusCodes(of("no"))
                .build(), District).getRows().size()).isEqualTo((districtsCount) * genderCount);

        List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Gender)
                .migrantStatusCodes(of("no"))
                .build(), State).getRows();

        assertThat(rows.stream().filter(r -> (r.getDimension().getCode().equals("gender-18"))).mapToInt(r -> (r.getMeasures().getStudentCount())).sum()).isEqualTo(0);
        assertThat(rows.stream().filter(r -> (r.getDimension().getCode().equals("gender-19"))).mapToInt(r -> (r.getMeasures().getStudentCount())).sum()).isEqualTo(0);

        rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Gender)
                .migrantStatusCodes(of("yes"))
                .build(), State).getRows();

        assertThat(rows.stream().filter(r -> (r.getDimension().getCode().equals("gender-18"))).mapToInt(r -> (r.getMeasures().getStudentCount())).sum()).isEqualTo(2);
        assertThat(rows.stream().filter(r -> (r.getDimension().getCode().equals("gender-19"))).mapToInt(r -> (r.getMeasures().getStudentCount())).sum()).isEqualTo(3);
    }

    @Test
    public void itShouldFindByQueryWithEthnicityDimension() {
        final List<ReportRow> reportRows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(District)
                .organizationIds(of(-19L))
                .dimensionType(Ethnicity)
                .build(), District).getRows();

        assertThat(reportRows.size()).isEqualTo(ethnicityCount);
        assertThat(reportRows.stream().filter(r -> (r.getMeasures().getAvgScaleScore() != null)).collect(toList()).size()).isEqualTo(1);

        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .organizationIds(null)
                .dimensionType(Ethnicity)
                .build(), District).getRows().size()).isEqualTo((districtsCount) * ethnicityCount);
    }

    @Test
    public void itShouldFindByQueryWithEthnicityDimensionAndFilter() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(District)
                .organizationIds(of(-19L))
                .dimensionType(Ethnicity)
                .ethnicityCodes(of("ethnicity-28"))
                .build(), District).getRows().size()).isEqualTo(1);
    }

    @Test
    public void itShouldFindByQueryWithEthnicityDimensionAndIepFilter() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Ethnicity)
                .iepCodes(of("no"))
                .build(), District).getRows().size()).isEqualTo((districtsCount) * ethnicityCount);

        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Ethnicity)
                .iepCodes(of("no"))
                .build(), District).getRows().stream()
                .filter(r -> (r.getDimension().getCode().equals("ethnicity-29")))
                .mapToInt(r -> (r.getMeasures().getStudentCount()))
                .sum()).isEqualTo(1);

        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Ethnicity)
                .iepCodes(of("yes"))
                .build(), State).getRows().stream()
                .filter(r -> (r.getDimension().getCode().equals("ethnicity-29")))
                .mapToInt(r -> (r.getMeasures().getStudentCount()))
                .sum()).isEqualTo(2);
    }

    @Test
    public void itShouldFindByQueryWithEthnicityDimensionAndSection504Filter() {
        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Ethnicity)
                .section504Codes(of("undefined"))
                .build(), District).getRows().size()).isEqualTo((districtsCount) * ethnicityCount);

        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Ethnicity)
                .section504Codes(of("undefined"))
                .build(), State).getRows().stream()
                .filter(r -> (r.getDimension().getCode().equals("ethnicity-29")))
                .mapToInt(r -> (r.getMeasures().getStudentCount()))
                .sum()).isEqualTo(1);

        assertThat(repository.findByOrganizationType(user, queryBuilder
                .organizationType(State)
                .dimensionType(Ethnicity)
                .section504Codes(of("no"))
                .build(), State).getRows().stream()
                .filter(r -> (r.getDimension().getCode().equals("ethnicity-29")))
                .mapToInt(r -> (r.getMeasures().getStudentCount()))
                .sum()).isEqualTo(2);
    }

    @Test
    public void itShouldFindByQueryWithEnrolledGradeDimension() {
        List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(School)
                .organizationIds(of(-8L))
                .dimensionType(StudentEnrolledGrade)
                .build(), School).getRows();

        assertThat(rows.size()).isEqualTo(2);
        for (final ReportRow row : rows) {
            if (row.getDimension().getCode().equals("-5")) assertThat(row.getMeasures().getStudentCount()).isEqualTo(1);
            else assertThat(row.getMeasures().getStudentCount()).isEqualTo(2);
        }
    }

    @Test
    public void itShouldFindByQueryWithEnrolledGradeDimensionAndDifferentFilters() {
        List<ReportRow> rows = repository.findByOrganizationType(user, queryBuilder
                .organizationType(School)
                .organizationIds(of(-8L))
                .dimensionType(StudentEnrolledGrade)
                .genderCodes(of("gender-18"))
                .build(), School).getRows();

        assertThat(rows.size()).isEqualTo(1);
        assertThat(rows.get(0).getDimension().getCode()).isEqualTo("-4");
        assertThat(rows.get(0).getMeasures().getStudentCount()).isEqualTo(2);

        rows = repository.findByOrganizationType(user, queryBuilder.completenessCodes(of("Complete")).build(), School).getRows();
        assertThat(rows.size()).isEqualTo(1);
        assertThat(rows.get(0).getDimension().getCode()).isEqualTo("-4");
        assertThat(rows.get(0).getMeasures().getStudentCount()).isEqualTo(1);

        rows = repository.findByOrganizationType(user, queryBuilder.administrativeConditionCodes(of("IN")).build(), School).getRows();
        assertThat(rows.size()).isEqualTo(0);

        rows = repository.findByOrganizationType(user, queryBuilder.genderCodes(of("gender-19")).build(), School).getRows();
        assertThat(rows.size()).isEqualTo(1);
        assertThat(rows.get(0).getDimension().getCode()).isEqualTo("-5");
        assertThat(rows.get(0).getMeasures().getStudentCount()).isEqualTo(1);

        rows = repository.findByOrganizationType(user, queryBuilder.administrativeConditionCodes(of("SD")).build(), School).getRows();
        assertThat(rows.size()).isEqualTo(0);
    }

    @Test
    public void itShouldBackFillMissingDataForAllDimensionsButStudentEnrolledGrade() {
        final Integer asmtCount = template.queryForObject("SELECT count(*) AS count FROM asmt_active_year ay LEFT JOIN asmt a ON a.id = ay.asmt_id" +
                "  WHERE a.grade_id IN (-5) AND a.subject_id IN (2) AND a.type_id = 1 AND ay.school_year IN (1888)", Integer.class);
        queryBuilder
                .assessmentTypeCode(ICA.code())
                .organizationType(State)
                .schoolYears(of(1888))
                .subjectCodes(of(ELA.code()))
                .assessmentGradeCodes(of("-5"))
                .dimensionType(Overall)
                // the below two filters do not change the back-filling rules
                .administrativeConditionCodes(of("IN"))
                .completenessCodes(of("Complete"));

        //we do not back-fill the data for the StudentEnrolledGrade
        assertThat(repository.findByOrganizationType(user, queryBuilder.dimensionType(StudentEnrolledGrade).build(), District).getRows().size()).isEqualTo(0);

        final List<ReportRow> reportRows = repository.findByOrganizationType(user, queryBuilder.dimensionType(Overall).build(), District).getRows();
        assertThat(reportRows.size()).isEqualTo(asmtCount * districtsCount);

        //make sure assessment label and subject codes are populated in back-filled data
        assertThat(reportRows.stream().map(r -> r.getAssessment().getLabel()).filter(Objects::nonNull).collect(toList()).size()).isEqualTo(asmtCount * districtsCount);
        assertThat(reportRows.stream().map(r -> r.getAssessment().getSubjectCode()).filter(Objects::nonNull).collect(toList()).size()).isEqualTo(asmtCount * districtsCount);

        assertThat(repository.findByOrganizationType(user, queryBuilder.dimensionType(Gender).genderCodes(of("gender-18")).build(), District).getRows().size())
                .isEqualTo(asmtCount * districtsCount);

        assertThat(repository.findByOrganizationType(user, queryBuilder.dimensionType(Gender).genderCodes(null).build(), District).getRows().size())
                .isEqualTo(asmtCount * districtsCount * genderCount);

        assertThat(repository.findByOrganizationType(user, queryBuilder.dimensionType(Ethnicity).build(), District).getRows().size())
                .isEqualTo(asmtCount * districtsCount * ethnicityCount);

        assertThat(repository.findByOrganizationType(user, queryBuilder.dimensionType(Ethnicity).ethnicityCodes(of("ethnicity-28")).build(), District).getRows().size())
                .isEqualTo(asmtCount * districtsCount);

        assertThat(repository.findByOrganizationType(user, queryBuilder.dimensionType(MigrantStatus).ethnicityCodes(null).build(), District).getRows().size())
                .isEqualTo(asmtCount * districtsCount * 3);

        assertThat(repository.findByOrganizationType(user, queryBuilder.dimensionType(Section504).build(), District).getRows().size())
                .isEqualTo(asmtCount * districtsCount * 3);

        assertThat(repository.findByOrganizationType(user, queryBuilder.dimensionType(LEP).build(), District).getRows().size())
                .isEqualTo(asmtCount * districtsCount * 2);

        assertThat(repository.findByOrganizationType(user, queryBuilder.dimensionType(IEP).build(), District).getRows().size())
                .isEqualTo(asmtCount * districtsCount * 2);

        assertThat(repository.findByOrganizationType(user, queryBuilder.dimensionType(EconomicDisadvantage).build(), District).getRows().size())
                .isEqualTo(asmtCount * districtsCount * 2);
    }

    @Test
    public void itShouldEstimateReportRowCount() {
        final Integer asmtCount = template.queryForObject("SELECT count(*) AS count FROM asmt_active_year ay JOIN asmt a ON a.id = ay.asmt_id" +
                "  WHERE a.grade_id IN (-5, -3) AND a.subject_id IN (1, 2) AND a.type_id = 1 AND ay.school_year IN (1888, 1999)", Integer.class);
        queryBuilder
                .assessmentTypeCode(ICA.code())
                .organizationType(State)
                .schoolYears(of(1888, 1999))
                .subjectCodes(of(MATH.code(), ELA.code()))
                .assessmentGradeCodes(of("-5", "-3"))
                // the below two filters do not change the counting rules
                .administrativeConditionCodes(of("IN"))
                .completenessCodes(of("Complete"));

        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Overall).build(), District)).isEqualTo(asmtCount * districtsCount);
        //for the StudentEnrolledGrade we always assume that there is one entry found
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(StudentEnrolledGrade).build(), District)).isEqualTo(asmtCount * districtsCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Gender).build(), District)).isEqualTo(asmtCount * districtsCount * genderCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Ethnicity).build(), District)).isEqualTo(asmtCount * districtsCount * ethnicityCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(MigrantStatus).build(), District)).isEqualTo(asmtCount * districtsCount * 3);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Section504).build(), District)).isEqualTo(asmtCount * districtsCount * 3);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(LEP).build(), District)).isEqualTo(asmtCount * districtsCount * 2);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(IEP).build(), District)).isEqualTo(asmtCount * districtsCount * 2);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(EconomicDisadvantage).build(), District)).isEqualTo(asmtCount * districtsCount * 2);

        //test with filters
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Gender).genderCodes(of("gender-19")).build(), District)).isEqualTo(asmtCount * districtsCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Ethnicity).genderCodes(of("gender-19")).ethnicityCodes(of("ethnicity-28")).build(), District)).isEqualTo(asmtCount * districtsCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(MigrantStatus).genderCodes(null).ethnicityCodes(null).migrantStatusCodes(of("yes")).build(), District)).isEqualTo(asmtCount * districtsCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Section504).genderCodes(null).ethnicityCodes(null).section504Codes(of("undefined")).build(), District)).isEqualTo(asmtCount * districtsCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(LEP).section504Codes(null).lepCodes(of("yes")).build(), District)).isEqualTo(asmtCount * districtsCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(IEP).lepCodes(null).iepCodes(of("yes")).build(), District)).isEqualTo(asmtCount * districtsCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(EconomicDisadvantage).iepCodes(null).economicDisadvantageCodes(of("yes")).build(), District)).isEqualTo(asmtCount * districtsCount);

        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Overall).organizationType(State).build(), State)).isEqualTo(asmtCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Overall).organizationType(District).organizationIds(of(-19L, -17L, -99L)).build(), District)).isEqualTo(asmtCount * 2);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Overall).organizationType(School).organizationIds(of(-9L, -10L, -99L)).build(), School)).isEqualTo(asmtCount * 2);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Overall).organizationType(State).organizationIds(null).build(), District)).isEqualTo(asmtCount * districtsCount);
        assertThat(repository.estimateReportRowCountByOrganizationType(queryBuilder.dimensionType(Overall).organizationType(District).organizationIds(of(-19L)).build(), School)).isEqualTo(asmtCount * 2);
    }

    @Test
    public void itShouldFindByQueryWithMultipleValuesOfDiffParams() {
        final Integer asmtCount = template.queryForObject("SELECT count(*) AS count FROM asmt_active_year ay LEFT JOIN asmt a ON a.id = ay.asmt_id" +
                "  WHERE a.grade_id IN (-4,-3) AND a.subject_id IN (1,2) AND a.type_id = 1 AND ay.school_year IN (1999, 2000)", Integer.class);

        final List<ReportRow> reportRows = repository.findByOrganizationType(user, queryBuilder
                .assessmentTypeCode(ICA.code())
                .organizationType(State)
                .assessmentGradeCodes(of("-4", "-3"))
                .subjectCodes(of(MATH.code(), ELA.code()))
                .schoolYears(of(1999, 2000))
                .dimensionType(Overall)
                .build(), State).getRows();

        assertThat(reportRows.size()).isEqualTo(asmtCount);

        final List<ReportRow> rowsWithNonZeroValues = reportRows.stream().filter(r -> (r.getMeasures().getAvgScaleScore() != null)).collect(Collectors.toList());
        assertThat(rowsWithNonZeroValues.size()).isEqualTo(3);
        assertThat(rowsWithNonZeroValues.stream().map(ReportRow::getOrganization).distinct().collect(toSet()))
                .usingFieldByFieldElementComparator()
                .containsOnly(Organization.builder().name(stateName).organizationType(State).build());

        // This verifies that the data is grouped by asmt_id to support a use case when there are two assessments for
        // the same subject/grade/type and exam school year.
        assertThat(rowsWithNonZeroValues.stream().map(ReportRow::getAssessment).distinct().collect(toSet()))
                .usingFieldByFieldElementComparator().containsExactlyInAnyOrder(
                ActiveAssessment.builder().id(-8).gradeCode("-4").subjectCode("Math").label("asmt-8").examSchoolYear(1999).build(),
                ActiveAssessment.builder().id(-9).gradeCode("-3").subjectCode("ELA").examSchoolYear(2000).label("asmt-9").build(),
                ActiveAssessment.builder().id(-9).gradeCode("-3").subjectCode("ELA").examSchoolYear(1999).label("asmt-9").build());

        assertThat(rowsWithNonZeroValues.stream().map(ReportRow::getAssessment).filter(a -> (a.getExamSchoolYear() == 1999)).count()).isEqualTo(2);
        assertThat(rowsWithNonZeroValues.stream().map(ReportRow::getAssessment).filter(a -> (a.getExamSchoolYear() == 2000)).count()).isEqualTo(1);
        assertThat(rowsWithNonZeroValues.stream().map(ReportRow::getAssessment).filter(a -> (a.getSubjectCode().equals("Math"))).count()).isEqualTo(1);
        assertThat(rowsWithNonZeroValues.stream().map(ReportRow::getAssessment).filter(a -> (a.getSubjectCode().equals("ELA"))).count()).isEqualTo(2);
    }

    @Test
    @SqlGroup({
            @Sql(executionPhase = BEFORE_TEST_METHOD, scripts = {"classpath:OlapEntitiesSetup.sql"},
                    statements = {"INSERT INTO  fact_student_exam (id, school_year, asmt_id, elas_id, completeness_id," +
                            "                                    administration_condition_id, performance_level," +
                            "                                    scale_score, grade_id, student_id, school_id," +
                            "                                    iep, lep, section504, economic_disadvantage, migrant_status," +
                            "                                    completed_at, updated, update_import_id, migrate_id) VALUES " +
                            "(-34, 2000 , -10, -11, -9, -99, 1, 2500, -4, -9, -9, true, true, false, false, true, '2016-08-14 19:05:33.000000', '2016-09-14 19:05:33.000000', -1, -1)",
                            "INSERT INTO asmt_active_year (asmt_id, school_year) VALUES (-10, 2000)"}),
            @Sql(executionPhase = AFTER_TEST_METHOD, scripts = {"classpath:OlapEntitiesTeardown.sql"}
            )
    })
    public void itShouldGroupByAssessmentId() {

        //if two different ICAs are administered at the same school year, we should group the data by the asmt id
        final List<ReportRow> reportRows = repository.findByOrganizationType(user, queryBuilder
                .assessmentGradeCodes(of("-3"))
                .subjectCodes(of(ELA.code()))
                .schoolYears(of(2000))
                .dimensionType(Overall)
                .build(), State).getRows();
        assertThat(reportRows.stream().map(ReportRow::getAssessment).distinct().collect(toSet()))
                .usingFieldByFieldElementComparator().containsExactlyInAnyOrder(
                ActiveAssessment.builder().id(-10).gradeCode("-3").subjectCode("ELA").label("asmt-9-again").examSchoolYear(2000).build(),
                ActiveAssessment.builder().id(-9).gradeCode("-3").subjectCode("ELA").label("asmt-9").examSchoolYear(2000).build());
    }

    private static void verifyBooleanDimensionStudentCodeCount(final List<ReportRow> rows, final int yesCount, final int noCount, final int unknownCount) {
        for (final ReportRow row : rows) {
            if (row.getDimension().getCode().equalsIgnoreCase("no")) assertThat(row.getMeasures().getStudentCount()).isEqualTo(noCount);
            else if (row.getDimension().getCode().equalsIgnoreCase("yes")) assertThat(row.getMeasures().getStudentCount()).isEqualTo(yesCount);
            else assertThat(row.getMeasures().getStudentCount()).isEqualTo(unknownCount);
        }
    }
}