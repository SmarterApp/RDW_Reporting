package org.opentestsystem.rdw.olap.service.impl;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableSet;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.olap.model.CodedEntity;
import org.opentestsystem.rdw.olap.service.AuthorizationService;
import org.opentestsystem.rdw.olap.service.UserAssessmentTypeService;
import org.opentestsystem.rdw.olap.service.UserOrganizationService;
import org.opentestsystem.rdw.reporting.common.model.BasicAggregateReportQuery;
import org.opentestsystem.rdw.reporting.common.model.District;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.School;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;

import java.util.List;
import java.util.Set;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;
import static org.opentestsystem.rdw.common.model.AssessmentType.ICA;
import static org.opentestsystem.rdw.olap.model.AggregateServicePermission.AggregateRead;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.permissions;

public class DefaultAuthorizationServiceTest {

    private UserAssessmentTypeService userAssessmentTypeService;
    private AuthorizationService service;

    private final Set<Organization> organizations = ImmutableSet.of(
            School.builder().id(1L).districtId(1).build(),
            School.builder().id(2L).districtId(2).build(),
            District.builder().id(1L).build(),
            District.builder().id(2L).build()
    );

    private final List<CodedEntity> assessmentTypes = ImmutableList.of(
            CodedEntity.builder().id(1).code("ica").build(),
            CodedEntity.builder().id(2).code("iab").build(),
            CodedEntity.builder().id(3).code("sum").build()
    );

    private User user(final boolean statewide) {
        final PermissionScope scope = statewide
                ? PermissionScope.STATEWIDE
                : PermissionScope.builder().addSchoolId(1L).build();

        return User.builder()
                .id("id")
                .username("username")
                .password("password")
                .permissionsById(permissions(new Permission(AggregateRead, scope)))
                .build();
    }

    @Before
    public void before() {
        final UserOrganizationService userOrganizationService = mock(UserOrganizationService.class);
        when(userOrganizationService.getOrganizations(any(User.class))).thenReturn(organizations);

        userAssessmentTypeService = mock(UserAssessmentTypeService.class);
        when(userAssessmentTypeService.getAssessmentTypes(any(User.class))).thenReturn(assessmentTypes);

        service = new DefaultAuthorizationService(userOrganizationService, userAssessmentTypeService);
    }

    @Test(expected = Exception.class)
    public void checkAuthorizationShouldThrowExceptionWhenTheRequestedAssessmentTypeIsNotAllowed() {
        when(userAssessmentTypeService.getAssessmentTypes(any(User.class))).thenReturn(ImmutableList.of());
        service.checkAuthorization(user(true), BasicAggregateReportQuery.builder().assessmentTypeCode(ICA.code()).build());
    }

    @Test(expected = Exception.class)
    public void checkAuthorizationShouldThrowExceptionWhenUserDoesNotHaveTheRequestedSchool() {
        final BasicAggregateReportQuery query = BasicAggregateReportQuery.builder()
                .assessmentTypeCode(ICA.code())
                .schoolIds(ImmutableSet.of(3L))
                .build();
        service.checkAuthorization(user(false), query);
    }

    @Test(expected = Exception.class)
    public void checkAuthorizationShouldThrowExceptionWhenUserDoesNotHaveTheRequestedDistrict() {
        final BasicAggregateReportQuery query = BasicAggregateReportQuery.builder()
                .assessmentTypeCode(ICA.code())
                .districtIds(ImmutableSet.of(3L))
                .includeAllSchoolsOfDistricts(false)
                .build();
        service.checkAuthorization(user(false), query);
    }

    @Test
    public void checkAuthorizationShouldNotThrowExceptionWhenUserHasTheRequestedSchool() {
        final BasicAggregateReportQuery query = BasicAggregateReportQuery.builder()
                .assessmentTypeCode(ICA.code())
                .schoolIds(ImmutableSet.of(1L))
                .build();
        service.checkAuthorization(user(false), query);
    }

    @Test
    public void checkAuthorizationShouldNotThrowExceptionWhenUserHasTheRequestedDistrict() {
        final BasicAggregateReportQuery query = BasicAggregateReportQuery.builder()
                .assessmentTypeCode(ICA.code())
                .districtIds(ImmutableSet.of(1L))
                .includeAllSchoolsOfDistricts(false)
                .build();
        service.checkAuthorization(user(false), query);
    }

}
