package org.opentestsystem.rdw.olap.repository.impl;

import org.opentestsystem.rdw.olap.CacheConfiguration;
import org.opentestsystem.rdw.reporting.common.multitenant.StaticTenantIdUtil;
import org.opentestsystem.rdw.reporting.common.test.CachingTest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cache.Cache;
import org.springframework.cache.CacheManager;
import org.springframework.test.context.ContextConfiguration;

@ContextConfiguration(classes = {CacheConfiguration.class})
@CachingTest
public abstract class CachedRepositoryBackedIT extends RepositoryBackedIT {

    @Autowired
    protected CacheManager cacheManager;

    @Autowired
    protected CacheConfiguration cacheConfiguration;

    /**
     * Helper to get the tenant-qualified cached value.
     *
     * @param cache cache name from AggregateServiceCache, e.g. "elases"
     * @param key cache key, e.g. "findAll"
     * @return cache value
     */
    protected Cache.ValueWrapper getCachedValue(final String cache, final String key) {
        // tenant-qualified key name (matches key expression in the Cacheable annotation)
        final String tenantKey = StaticTenantIdUtil.tenantIdKey() + "-" + key;
        return cacheManager.getCache(cache).get(tenantKey);
    }
}
