package org.opentestsystem.rdw.olap.service.impl;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.olap.sqlbuilder.impl.QueryProviderRepositoryHelper;
import org.opentestsystem.rdw.reporting.common.model.DimensionType;
import org.opentestsystem.rdw.reporting.common.model.TargetReportQuery;
import org.opentestsystem.rdw.reporting.common.model.TargetReportQuery.Builder;

import static com.google.common.collect.ImmutableSet.of;
import static org.mockito.Mockito.mock;
import static org.opentestsystem.rdw.common.model.AssessmentType.SUMMATIVE;

// TODO expand tests
public class TargetQueryConverterTest {
    private TargetQueryConverter queryConverter;

    protected TargetQueryConverter createQueryConverterUnderTest(final QueryProviderRepositoryHelper repositoryHelper) {
        queryConverter = new TargetQueryConverter(repositoryHelper);
        return queryConverter;
    }

    protected Builder getAggregateReportQueryBuilder() {
        return TargetReportQuery.builder()
                .dimensionType(DimensionType.Overall)
                .assessmentGradeCodes(of("-8"))
                .schoolIds(of(123L))
                .schoolYear(1999)
                .subjectCode("Math")
                .assessmentTypeCode(SUMMATIVE.code());
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldFailForQueryWithMultipleGrades() {
        final TargetReportQuery query = getAggregateReportQueryBuilder()
                .assessmentGradeCodes(of("-8", "-7"))
                .build();

        queryConverter.getOrganizationTypeQueryBuilder(query, query.getStudentFilters());
    }

    // TODO copy pasted from AbstractQueryConverterTest but adjusted to remove subgroups - note this is an intermediate fix

    private QueryProviderRepositoryHelper repositoryHelper;

    @Before
    public void setUp() {
        repositoryHelper = mock(QueryProviderRepositoryHelper.class);
        queryConverter = createQueryConverterUnderTest(repositoryHelper);
    }

}