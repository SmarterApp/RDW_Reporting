package org.opentestsystem.rdw.olap.repository.impl;

import org.junit.Test;
import org.opentestsystem.rdw.olap.repository.OrganizationRepository;
import org.opentestsystem.rdw.reporting.common.model.District;
import org.opentestsystem.rdw.reporting.common.model.School;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.jdbc.Sql;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Organizations;

@Import(JdbcOrganizationRepository.class)
@Sql(scripts = {"classpath:OlapEntitiesSetup.sql"})
public class JdbcOrganizationRepositoryRST extends CachedRepositoryBackedIT {

    @Autowired
    private OrganizationRepository repository;

    @Test
    public void itShouldFindAllDistricts() {
        assertThat(repository.findMapOfDistrictsByIds().values())
                .usingFieldByFieldElementComparator()
                .containsExactlyInAnyOrder(
                        District.builder().id(-17L).name("District-7").naturalId("id-7").build(),
                        District.builder().id(-18L).name("District-8").naturalId("id-8").build(),
                        District.builder().id(-19L).name("District-9").naturalId("id-9").build()
                );
    }

    @Test
    public void findMapOfDistrictsByIdsShouldBeCached() {
        assertThat(this.cacheManager.getCache(Organizations).get("findMapOfDistrictsByIds")).isNull();

        repository.findMapOfDistrictsByIds();
        assertThat(this.cacheManager.getCache(Organizations).get("findMapOfDistrictsByIds")).isNotNull();

        cacheConfiguration.clearRepositoryCache();
        assertThat(this.cacheManager.getCache(Organizations).get("findMapOfDistrictsByIds")).isNull();
    }

    @Test
    public void itShouldFindAllSchools() {
        assertThat(repository.findMapOfSchoolsById().values())
                .usingFieldByFieldElementComparator()
                .containsExactlyInAnyOrder(
                        School.builder().districtId(-17).id(-7L).name("School-7").naturalId("id-7").build(),
                        School.builder().districtId(-18).id(-8L).name("School-8").naturalId("id-8").build(),
                        School.builder().districtId(-19).id(-9L).name("School-9").naturalId("id-9").build(),
                        School.builder().districtId(-19).id(-10L).name("School-10").naturalId("id-10").build()
                );
    }

    @Test
    public void itShouldFindAllSchoolsShouldBeCached() {
        assertThat(this.cacheManager.getCache(Organizations).get("findMapOfSchoolsById")).isNull();

        repository.findMapOfSchoolsById();
        assertThat(this.cacheManager.getCache(Organizations).get("findMapOfSchoolsById")).isNotNull();

        cacheConfiguration.clearRepositoryCache();
        assertThat(this.cacheManager.getCache(Organizations).get("findMapOfSchoolsById")).isNull();
    }
}
