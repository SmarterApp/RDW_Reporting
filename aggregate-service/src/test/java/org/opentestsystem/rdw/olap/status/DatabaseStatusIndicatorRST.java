package org.opentestsystem.rdw.olap.status;

import org.junit.Test;
import org.opentestsystem.rdw.common.status.DiagnosticLevel;
import org.opentestsystem.rdw.common.status.Status;
import org.opentestsystem.rdw.olap.repository.impl.RepositoryBackedIT;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.ActiveProfiles;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import static org.assertj.core.api.Assertions.assertThat;

@ActiveProfiles("redshift")
@Import(DatabaseStatusIndicator.class)
public class DatabaseStatusIndicatorRST extends RepositoryBackedIT {

    @Autowired
    private DatabaseStatusIndicator indicator;

    @Test
    public void itShouldProvideStatus() {
        final Status.Builder builder = Status.builder();
        indicator.doStatusCheck(builder, DiagnosticLevel.WriteDatabase.ordinal());

        final Status status = builder.build();
        assertThat(status.getDetails()).hasSize(1);

        final List<Status> databaseOperationsStatuses = (List<Status>) status.getDetails().get("databaseOperations");
        assertThat(databaseOperationsStatuses).hasSize(2);

        final Map<String, Status> detailsByType = databaseOperationsStatuses.stream()
                .collect(Collectors.toMap(
                        typeStatus -> (String) typeStatus.getDetails().get("type"),
                        typeStatus -> typeStatus
                ));
        assertThat(detailsByType.get("READ").getDetails().get("responseTime")).isNotNull();
        assertThat(detailsByType.get("WRITE").getDetails().get("responseTime")).isNotNull();
    }
}