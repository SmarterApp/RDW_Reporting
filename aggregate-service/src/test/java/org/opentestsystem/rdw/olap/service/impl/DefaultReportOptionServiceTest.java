package org.opentestsystem.rdw.olap.service.impl;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableSet;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.opentestsystem.rdw.olap.model.Claim;
import org.opentestsystem.rdw.olap.model.ReportOptions;
import org.opentestsystem.rdw.olap.repository.BooleanRepository;
import org.opentestsystem.rdw.olap.repository.StrictBooleanRepository;
import org.opentestsystem.rdw.olap.service.AdministrationConditionService;
import org.opentestsystem.rdw.olap.service.AssessmentGradeService;
import org.opentestsystem.rdw.olap.service.ClaimService;
import org.opentestsystem.rdw.olap.service.CompletenessService;
import org.opentestsystem.rdw.olap.service.ElasService;
import org.opentestsystem.rdw.olap.service.EthnicityService;
import org.opentestsystem.rdw.olap.service.GenderService;
import org.opentestsystem.rdw.olap.service.SchoolYearService;
import org.opentestsystem.rdw.olap.service.SubjectService;
import org.opentestsystem.rdw.reporting.common.model.CodedEntity;
import org.opentestsystem.rdw.reporting.common.model.DimensionType;
import org.opentestsystem.rdw.reporting.common.model.Grade;

import java.util.Arrays;
import java.util.List;

import static com.google.common.collect.Lists.newArrayList;
import static java.util.stream.Collectors.toList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.when;
import static org.opentestsystem.rdw.olap.model.CodedEntities.codesOf;

@RunWith(MockitoJUnitRunner.class)
public class DefaultReportOptionServiceTest {


    private DefaultReportOptionService service;

    @Mock
    private AdministrationConditionService administrationConditionService;

    @Mock
    private AssessmentGradeService assessmentGradeService;

    @Mock
    private BooleanRepository booleanRepository;

    @Mock
    private CompletenessService completenessService;

    @Mock
    private EthnicityService ethnicityService;

    @Mock
    private ElasService elasService;

    @Mock
    private GenderService genderService;

    @Mock
    private SchoolYearService schoolYearService;

    @Mock
    private StrictBooleanRepository strictBooleanRepository;

    @Mock
    private SubjectService subjectService;

    @Mock
    private ClaimService claimService;

    @Before
    public void setup() {
        service = new DefaultReportOptionService(
                administrationConditionService,
                assessmentGradeService,
                booleanRepository,
                completenessService,
                ethnicityService,
                elasService,
                genderService,
                schoolYearService,
                strictBooleanRepository,
                subjectService,
                claimService
        );
    }

    @Test
    public void isShouldMapServiceResponsesToFieldsCorrectly() {

        int id = 0;
        final List<CodedEntity> booleanEntities = entities(100, 200, 300);
        final List<CodedEntity> strictBooleanEntities = entities(100, 200);
        final List<Grade> assessmentGrades = grades(id++);
        final List<CodedEntity> completeness = entities(id++);
        final List<CodedEntity> ethnicities = entities(id++);
        final List<CodedEntity> interimAdministrationConditions = entities(id++);
        final List<CodedEntity> genders = entities(id++);
        final List<CodedEntity> subjects = entities(id++);
        final List<CodedEntity> summativeAdministrationConditions = entities(id++);
        final int claimCodeId = id++;
        final List<CodedEntity> claimCodes = entities(claimCodeId);


        final ReportOptions expected = ReportOptions.builder()
                .assessmentTypes(null)
                .assessmentGrades(codesOf(assessmentGrades))
                .completenesses(codesOf(completeness))
                .dimensionTypes(DimensionType.orderedDisplayValues())
                .economicDisadvantages(codesOf(strictBooleanEntities))
                .ethnicities(codesOf(ethnicities))
                .individualEducationPlans(codesOf(strictBooleanEntities))
                .interimAdministrationConditions(codesOf(interimAdministrationConditions))
                .limitedEnglishProficiencies(codesOf(strictBooleanEntities))
                .migrantStatuses(codesOf(booleanEntities))
                .genders(codesOf(genders))
                .section504s(codesOf(booleanEntities))
                .schoolYears(newArrayList(1, 2, 3))
                .statewideReporter(false)
                .subjects(codesOf(subjects))
                .claimCodes(ImmutableSet.copyOf(codesOf(claimCodes)))
                .summativeAdministrationConditions(codesOf(summativeAdministrationConditions))
                .build();

        when(administrationConditionService.getInterimConditions()).thenReturn(interimAdministrationConditions);
        when(administrationConditionService.getSummativeConditions()).thenReturn(summativeAdministrationConditions);
        when(assessmentGradeService.getAssessmentGrades()).thenReturn(assessmentGrades);
        when(booleanRepository.findAll()).thenReturn(booleanEntities);
        when(completenessService.getCompletenesses()).thenReturn(completeness);
        when(ethnicityService.getEthnicities()).thenReturn(ethnicities);
        when(genderService.getGenders()).thenReturn(genders);
        when(schoolYearService.getSchoolYears()).thenReturn(expected.getSchoolYears());
        when(strictBooleanRepository.findAll()).thenReturn(strictBooleanEntities);
        when(subjectService.getSubjects()).thenReturn(subjects);
        when(claimService.findAll()).thenReturn(ImmutableList.of(Claim.builder().code(String.valueOf(claimCodeId)).build()));


        assertThat(service.getReportOptions()).isEqualToComparingFieldByFieldRecursively(expected);

    }

    private List<CodedEntity> entities(final int... ids) {
        return Arrays.stream(ids)
                .mapToObj(id -> CodedEntity.builder().id(id).code(String.valueOf(id)).build())
                .collect(toList());
    }

    private List<Grade> grades(final int... ids) {
        return Arrays.stream(ids)
                .mapToObj(id -> Grade.builder().id(id).code(String.valueOf(id)).sequence(id).build())
                .collect(toList());
    }

}