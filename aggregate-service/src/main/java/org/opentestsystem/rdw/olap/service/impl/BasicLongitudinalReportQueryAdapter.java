package org.opentestsystem.rdw.olap.service.impl;

import org.opentestsystem.rdw.olap.model.LongitudinalOrganizationQuery;
import org.opentestsystem.rdw.olap.service.LongitudinalYearGradeService;
import org.opentestsystem.rdw.olap.sqlbuilder.QueryProviderRepositoryHelper;
import org.opentestsystem.rdw.reporting.common.model.LongitudinalReportQuery;
import org.opentestsystem.rdw.reporting.common.model.StudentFilters;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component
class BasicLongitudinalReportQueryAdapter extends AbstractBasicQueryAdapter<LongitudinalReportQuery, LongitudinalOrganizationQuery, LongitudinalOrganizationQuery.Builder> {

    private final LongitudinalYearGradeService longitudinalYearGradeService;

    @Autowired
    BasicLongitudinalReportQueryAdapter(final QueryProviderRepositoryHelper repositoryHelper, final LongitudinalYearGradeService longitudinalYearGradeService) {
        super(repositoryHelper);
        this.longitudinalYearGradeService = longitudinalYearGradeService;
    }

    @Override
    protected LongitudinalOrganizationQuery.Builder getOrganizationTypeQueryBuilder(final LongitudinalReportQuery reportQuery, final StudentFilters filters) {
        if (reportQuery.getSubjectCodes().size() != 1) throw new IllegalArgumentException("supports only one subject for longitudinal report queries");

        return LongitudinalOrganizationQuery.builder()
                .subjectCode(reportQuery.getSubjectCodes().iterator().next())
                .gradeYearPairs(longitudinalYearGradeService.toYearGradePairs(reportQuery.getToSchoolYear(), reportQuery.getAssessmentGradeCodes()));
    }

    @Override
    protected boolean isSupportMultipleSubjects() {
        return false;
    }
}