package org.opentestsystem.rdw.olap.repository;

import org.opentestsystem.rdw.multitenant.TenantKeyResolver;
import org.opentestsystem.rdw.multitenant.datasource.DataSourceElements;
import org.opentestsystem.rdw.multitenant.datasource.DataSourceElementsProperties;
import org.opentestsystem.rdw.multitenant.datasource.DataSourceElementsResolver;
import org.opentestsystem.rdw.multitenant.datasource.TenantDynamicRoutingDataSource;
import org.opentestsystem.rdw.reporting.common.multitenant.ReportingTenantIdResolver;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;

import javax.sql.DataSource;

/**
 * Configuration for DataSources.
 */
@Configuration
public class DataSourceConfiguration {

    /**
     * DataSourceElements for OLAP
     *
     * @return OLAP DataSourceElements
     */
    @Primary
    @Bean(name = "olapDataSourceElementsProperties")
    @ConfigurationProperties("spring.olap_datasource")
    @RefreshScope
    public DataSourceElementsProperties dataSourceElementsProperties() {
        return new DataSourceElementsProperties();
    }

    /**
     * olap DataSourceElementsResolver
     *
     * @param tenantKeyResolver            id resolver
     * @param dataSourceElementsProperties config properties
     * @return DataSourceElementsResolver
     */
    @Bean(name = "olapDataSourceElementsResolver")
    @RefreshScope
    public DataSourceElementsResolver dataSourceElementsResolver(TenantKeyResolver tenantKeyResolver,
                                                                 @Qualifier("olapDataSourceElementsProperties") DataSourceElementsProperties dataSourceElementsProperties) {
        return new DataSourceElementsResolver(tenantKeyResolver, dataSourceElementsProperties);
    }

    @Bean
    public ReportingTenantIdResolver reportingTenantIdResolver() {
        return new ReportingTenantIdResolver();
    }

    /**
     * Data source for the olap reporting data mart with no transaction manager.
     *
     * @param dataSourceElementsResolver olap DataSourceElementsResolver
     * @param tenantKeyResolver          TenantKeyResolver
     * @return DataSource
     */
    @Bean(name = "olapDatasource")
    @RefreshScope
    public DataSource olapDatasource(@Qualifier("olapDataSourceElementsResolver") DataSourceElements dataSourceElementsResolver,
                                     TenantKeyResolver tenantKeyResolver) {
        return new TenantDynamicRoutingDataSource(dataSourceElementsResolver, tenantKeyResolver);
    }

    /**
     * The jdbc template used for for the olap reporting data mart.
     *
     * @return DataSource
     */
    @Bean(name = "olapJdbcTemplate")
    public NamedParameterJdbcTemplate olapJdbcTemplate(@Qualifier("olapDatasource") final DataSource dataSource) {
        return new NamedParameterJdbcTemplate(dataSource);
    }

}