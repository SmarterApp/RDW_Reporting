package org.opentestsystem.rdw.olap.sqlbuilder;

import org.opentestsystem.rdw.olap.model.OrganizationTypeQuery;
import org.opentestsystem.rdw.reporting.common.model.DimensionType;
import org.opentestsystem.rdw.reporting.common.model.Organization;

import java.util.Set;

import static org.opentestsystem.rdw.reporting.common.model.DimensionType.StudentEnrolledGrade;


/**
 * This implementation is responsible for converting an instance of an {@link OrganizationTypeQuery} into a {@link ReportTemplate}
 */
@SuppressWarnings("unchecked")
public class SimpleReportTemplateProvider<B extends ReportTemplate.Builder, T extends ReportTemplate, Q extends OrganizationTypeQuery>
        extends AbstractReportTemplateProvider<B, T, Q> {

    private final Organization state;
    private final QueryProviderRepositoryHelper repositoryHelper;

    public SimpleReportTemplateProvider(final Organization state,
                                        final QueryProviderRepositoryHelper repositoryHelper) {
        this.repositoryHelper = repositoryHelper;
        this.state = state;
    }

    QueryProviderRepositoryHelper getRepositoryHelper() {
        return repositoryHelper;
    }

    @Override
    public B createBuilderWithCommonAttributes(final Q query) {
        final B builder = createBuilderInstance();

        final DimensionType dimensionType = query.getDimensionType();
        builder.assessments(repositoryHelper.findAssessmentsForQuery(query));
        //we do not back-fill data for this dimension type
        if (dimensionType.equals(StudentEnrolledGrade)) return (B) builder.includeStudentEnrolledGradeDimension(true);

        return (B) builder.dimensions(repositoryHelper.findDimensionsByTypeAndQueryFilters(dimensionType, query));
    }

    @Override
    public B createBuilderWithState(final String assessmentTypeCode) {
        return (B) createBuilderInstance().state(state);
    }

    @Override
    public B createBuilderWithAllDistricts(final String assessmentTypeCode) {
        return (B) createBuilderInstance().districts(repositoryHelper.findAllDistricts());
    }

    @Override
    public B createBuilderWithDistrictIds(final String assessmentTypeCode, final Set<Long> districtIds) {
        return (B) createBuilderInstance().districts(repositoryHelper.findDistrictsByIds(districtIds));
    }

    @Override
    public B createBuilderWithAllSchoolsOfDistricts(final String assessmentTypeCode, final Set<Long> districtIds) {
        return (B) createBuilderInstance().schools(repositoryHelper.findSchoolsByDistrictIds(districtIds));
    }

    @Override
    public B createBuilderWithSchoolIds(final String assessmentTypeCode, final Set<Long> schoolIds) {
        return (B) createBuilderInstance().schools(repositoryHelper.findSchoolsByIds(schoolIds));
    }

    @Override
    protected T build(final B builder) {
        return (T) builder.build();
    }

    @Override
    protected B createBuilderInstance() {
        return (B) ReportTemplate.builder();
    }
}