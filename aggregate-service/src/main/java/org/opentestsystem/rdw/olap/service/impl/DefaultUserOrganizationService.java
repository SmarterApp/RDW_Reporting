package org.opentestsystem.rdw.olap.service.impl;

import com.google.common.collect.ImmutableSet;
import org.opentestsystem.rdw.olap.repository.EmbargoRepository;
import org.opentestsystem.rdw.olap.service.OrganizationService;
import org.opentestsystem.rdw.olap.service.UserOrganizationService;
import org.opentestsystem.rdw.reporting.common.model.District;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.OrganizationQuery;
import org.opentestsystem.rdw.reporting.common.model.OrganizationType;
import org.opentestsystem.rdw.reporting.common.model.School;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.function.Predicate;
import java.util.stream.Stream;

import static com.google.common.collect.ImmutableSet.toImmutableSet;
import static com.google.common.collect.Lists.newArrayList;
import static org.apache.commons.lang.StringUtils.isBlank;
import static org.opentestsystem.rdw.olap.model.AggregateServicePermission.AggregateRead;
import static org.opentestsystem.rdw.reporting.common.security.ReportingPermission.EmbargoRead;

@Service
class DefaultUserOrganizationService implements UserOrganizationService {

    private static final Predicate<Organization> AlwaysTrue = organization -> true;
    private static final Predicate<Organization> AlwaysFalse = organization -> false;
    private final OrganizationService service;
    private final EmbargoRepository embargoRepository;

    @Autowired
    DefaultUserOrganizationService(
            final OrganizationService service,
            final EmbargoRepository embargoRepository) {
        this.service = service;
        this.embargoRepository = embargoRepository;
    }

    @Override
    public Set<Organization> getOrganizations(final User user) {
        return getUserOrganizationsAsStream(user.getPermissionScopeByPermissionId(AggregateRead))
                .collect(toImmutableSet());
    }

    @Override
    public Set<Organization> getOrganizations(final User user, final OrganizationQuery query) {
        return getUserOrganizationsAsStream(user.getPermissionScopeByPermissionId(AggregateRead))
                .filter(toNamePredicate(query))
                .filter(toTypePredicate(query))
                .filter(toIdPredicate(query))
                .collect(toImmutableSet());
    }

    @Override
    public Optional<Organization> getDefaultOrganization(final User user) {
        final PermissionScope permissionScope = user.getPermissionScopeByPermissionId(AggregateRead);
        if (permissionScope.isStatewide()) {
            return Optional.empty();
        }
        final List<Organization> districts = newArrayList();
        final List<Organization> schools = newArrayList();
        getUserOrganizationsAsStream(permissionScope).forEach(organization -> {
            switch (organization.getOrganizationType()) {
                case District:
                    districts.add(organization);
                    break;
                case School:
                    schools.add(organization);
                    break;
            }
        });
        if (districts.size() == 1) {
            return Optional.of(districts.get(0));
        }
        if (schools.size() == 1) {
            return Optional.of(schools.get(0));
        }
        return Optional.empty();
    }

    @Override
    public boolean hasEmbargoedOrganizations(final User user) {
        // we can short-circuit if the user is statewide and state embargo is in place
        final PermissionScope permissionScope = user.getPermissionScopeByPermissionId(EmbargoRead);
        if (permissionScope.isStatewide() && embargoRepository.isStateEmbargoed()) {
            return true;
        }

        // return true if 1+ user organization is embargoed
        final Set<Long> embargoedDistrictIds = ImmutableSet.copyOf(embargoRepository.findAllEmbargoedDistrictIds());
        return getUserOrganizationsAsStream(permissionScope).anyMatch(organization -> {
            final OrganizationType type = organization.getOrganizationType();
            if (type == OrganizationType.District
                    && embargoedDistrictIds.contains(organization.getId())) {
                return true;
            }
            if (type == OrganizationType.School
                    && embargoedDistrictIds.contains(((School) organization).getDistrictId())) {
                return true;
            }
            return false;
        });
    }

    private Stream<Organization> getUserOrganizationsAsStream(final PermissionScope permissionScope) {
        final Predicate<Organization> securityFilter = permissionScope.isStatewide()
                ? AlwaysTrue
                : permissionScopeContainsOrganization(permissionScope);

        return service.getSchoolsAndDistricts().stream()
                .filter(securityFilter);
    }

    /**
     * @param permissionScope the permission scope to test containership with
     * @return predicate that evaluates true when the tested organization is contained within the organization IDs of the permission scope
     */
    private Predicate<Organization> permissionScopeContainsOrganization(final PermissionScope permissionScope) {
        return organization -> {

            // If it's a district make sure the district is in the permission scope
            if (organization.getOrganizationType() == OrganizationType.District) {
                final District district = (District) organization;
                return permissionScope.getDistrictIds().contains(district.getId())
                        || permissionScope.getDistrictGroupIds().contains(district.getDistrictGroupId());
            }

            // If it's a school make sure the school or school's district is in the permission scope
            if (organization.getOrganizationType() == OrganizationType.School) {
                final School school = (School) organization;
                return permissionScope.getInstitutionIds().contains(school.getId())
                        || permissionScope.getInstitutionGroupIds().contains(school.getSchoolGroupId())
                        || permissionScope.getDistrictIds().contains(school.getDistrictId())
                        || permissionScope.getDistrictGroupIds().contains(school.getDistrictGroupId());
            }

            // If the org is not a school or district we are not interested in providing it
            return false;
        };
    }

    private Predicate<Organization> toNamePredicate(final OrganizationQuery query) {
        // If we're not querying on name, include all results
        if (query.getName() == null) {
            return AlwaysTrue;
        }

        // If we're querying on name, but have no value, do not include any results
        if (isBlank(query.getName())) {
            return AlwaysFalse;
        }

        // Filter organizations by name
        return organization -> organization.getName().toLowerCase().contains(query.getName().toLowerCase());
    }

    private Predicate<Organization> toTypePredicate(final OrganizationQuery query) {
        if (query.getTypes().isEmpty()) {
            return AlwaysTrue;
        }
        return organization -> query.getTypes().contains(organization.getOrganizationType());
    }

    private Predicate<Organization> toIdPredicate(final OrganizationQuery query) {
        if (query.getIds().isEmpty()) {
            return AlwaysTrue;
        }
        return organization -> query.getIds().contains(organization.getId());
    }

}
