package org.opentestsystem.rdw.olap.sqlbuilder;

import org.opentestsystem.rdw.olap.model.AggregateReportQuery;
import org.opentestsystem.rdw.olap.sqlbuilder.QueryReportTemplate.Builder;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.security.PermissionSource;
import org.opentestsystem.rdw.reporting.common.sqlbuilder.QueryProvider;

import static org.opentestsystem.rdw.reporting.common.jdbc.QueryUtils.padIntToSize;

/**
 * This implementation is responsible for converting {@link AggregateReportQuery} for claim report into a {@link QueryReportTemplate}
 */
public class ClaimQueryReportTemplateProvider extends BaseQueryReportTemplateProvider<AggregateReportQuery> {

    private static final String claimAggregateTemplateSql = "claimAggregate";

    public ClaimQueryReportTemplateProvider(final Organization state,
                                            final int organizationPartitionSize,
                                            final QueryProvider queryProvider,
                                            final QueryProviderRepositoryHelper repositoryHelper,
                                            final PermissionSource permissionSource) {
        super(state, organizationPartitionSize, queryProvider, repositoryHelper, permissionSource);
    }

    @Override
    protected String getTemplateSql() {
        return claimAggregateTemplateSql;
    }

    @Override
    public Builder createBuilderWithCommonAttributes(final AggregateReportQuery query) {
        return addFiltersAndDimension(super.createBuilderWithCommonAttributes(query), query)
                .parameter("school_years", padIntToSize(query.getSchoolYears(), getRepositoryHelper().maxSchoolYears()))
                .parameter("asmt_grade_ids", padIntToSize(getRepositoryHelper().toGradeIds(query.getAssessmentGradeCodes()), getRepositoryHelper().maxAssessmentGrades()))
                .parameter("subject_ids", padIntToSize(getRepositoryHelper().toSubjectIds(query.getSubjectCodes()), getRepositoryHelper().maxSubjects()))
                .parameter("asmt_type_id", getRepositoryHelper().toAssessmentTypeId(query.getAssessmentTypeCode()))
                //TODO:convert to ids
                .parameter("claim_codes", query.getClaimCodes());
    }
}