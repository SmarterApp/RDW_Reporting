package org.opentestsystem.rdw.olap.model;

import com.google.common.collect.ImmutableList;
import org.opentestsystem.rdw.reporting.common.model.AggregateRow;

import java.util.Collection;
import java.util.List;

import static com.google.common.collect.ImmutableList.builder;


/**
 * This class represents common functionality for the implementations of {@link AggregateReportResult}
 */
@SuppressWarnings("unchecked")
public abstract class AggregateRowReportResult<T extends AggregateRow> extends AggregateReportResult<List<T>> {

    /**
     * Returns a builder of this class pre-loaded with the data
     **/
    public abstract <B extends Builder> B copy();

    public static abstract class Builder<T extends AggregateRow, B extends Builder, R extends AggregateRowReportResult<T>>
            extends AggregateReportResult.Builder<B, AggregateRowReportResult<T>, List<T>> {
        private final ImmutableList.Builder<T> rowsBuilder = builder();

        @Override
        public R build() {
            final ImmutableList<T> rows = rowsBuilder.build();
            super.payload(rows);
            super.resultCount(rows.size());
            return (R) super.build();
        }

        public B merge(final AggregateRowReportResult<T> report) {
            rows(report.getPayload());
            createdWhileDataEmbargoed(this.isCreatedWhileDataEmbargoed() || report.isCreatedWhileDataEmbargoed());
            hasResults(this.isHasResults() || report.isHasResults());
            return (B) this;
        }

        public B rows(final Collection<T> rows) {
            this.rowsBuilder.addAll(rows);
            return (B) this;
        }

        public B row(final T row) {
            this.rowsBuilder.add(row);
            return (B) this;
        }
    }
}