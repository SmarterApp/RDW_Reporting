package org.opentestsystem.rdw.olap;

import org.opentestsystem.rdw.common.model.AssessmentType;
import org.opentestsystem.rdw.olap.repository.ActiveAssessmentRepository;
import org.opentestsystem.rdw.olap.repository.AdministrationConditionRepository;
import org.opentestsystem.rdw.olap.repository.AssessmentGradeRepository;
import org.opentestsystem.rdw.olap.repository.AssessmentRepository;
import org.opentestsystem.rdw.olap.repository.BooleanRepository;
import org.opentestsystem.rdw.olap.repository.ClaimRepository;
import org.opentestsystem.rdw.olap.repository.CompletenessRepository;
import org.opentestsystem.rdw.olap.repository.ElasRepository;
import org.opentestsystem.rdw.olap.repository.EmbargoRepository;
import org.opentestsystem.rdw.olap.repository.EthnicityRepository;
import org.opentestsystem.rdw.olap.repository.GenderRepository;
import org.opentestsystem.rdw.olap.repository.OrganizationRepository;
import org.opentestsystem.rdw.olap.repository.SchoolYearRepository;
import org.opentestsystem.rdw.olap.repository.StrictBooleanRepository;
import org.opentestsystem.rdw.olap.repository.SubjectRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;

import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.AdministrationConditions;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Assessments;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.AssessmentGrades;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.AssessmentTypes;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Booleans;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Claims;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.CompletenessCodes;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Elases;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Embargo;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Ethnicities;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Genders;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Organizations;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.SchoolYears;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.StrictBooleans;
import static org.opentestsystem.rdw.olap.model.AggregateServiceCache.Subjects;

@Configuration
@EnableCaching
@EnableScheduling
public class CacheConfiguration {

    @Autowired
    private ActiveAssessmentRepository activeAssessmentRepository;

    @Autowired
    private AdministrationConditionRepository administrationConditionRepository;

    @Autowired
    private AssessmentRepository assessmentRepository;

    @Autowired
    private AssessmentGradeRepository assessmentGradeRepository;

    @Autowired
    private BooleanRepository booleanRepository;

    @Autowired
    private CompletenessRepository completenessRepository;
    
    @Autowired
    private ClaimRepository claimRepository;
    
    @Autowired
    private ElasRepository elasRepository;

    @Autowired
    private EmbargoRepository embargoRepository;

    @Autowired
    private EthnicityRepository ethnicityRepository;

    @Autowired
    private GenderRepository genderRepository;

    @Autowired
    private OrganizationRepository organizationRepository;

    @Autowired
    private SchoolYearRepository schoolYearRepository;

    @Autowired
    private StrictBooleanRepository strictBooleanRepository;

    @Autowired
    private SubjectRepository subjectRepository;

    /**
     * Refreshes the contents of the report organizations cache
     */
    @Scheduled(cron = "${app.cache.repository.refresh-cron}", zone = "GMT")
    @CacheEvict(cacheNames = {
            Organizations,
            AdministrationConditions,
            Assessments,
            AssessmentGrades,
            AssessmentTypes,
            Booleans,
            StrictBooleans,
            Organizations,
            Claims,
            CompletenessCodes,
            Elases,
            Ethnicities,
            Genders,
            SchoolYears,
            Subjects,
            Embargo
    }, beforeInvocation = true, allEntries = true)
    public void refreshRepositoryCache() {
        for (final AssessmentType assessmentType : AssessmentType.values()) {
            activeAssessmentRepository.findAllByTypeCode(assessmentType.code());
        }
        administrationConditionRepository.findAll();
        assessmentRepository.findAll();
        assessmentGradeRepository.findAll();
        booleanRepository.findAll();
        claimRepository.findAll();
        completenessRepository.findAll();
        elasRepository.findAll();
        embargoRepository.isStateEmbargoed();
        embargoRepository.findAllEmbargoedDistrictIds();
        ethnicityRepository.findAll();
        genderRepository.findAll();
        organizationRepository.findMapOfDistrictsByIds();
        organizationRepository.findMapOfSchoolsById();
        organizationRepository.findAllSchoolsByDistrictId();
        schoolYearRepository.findAll();
        strictBooleanRepository.findAll();
        subjectRepository.findAll();
    }
}
