package org.opentestsystem.rdw.olap.sqlbuilder.impl.query;

import org.opentestsystem.rdw.olap.model.OrganizationTypeQuery;
import org.opentestsystem.rdw.olap.model.SqlQueryWithReportTemplate;
import org.opentestsystem.rdw.olap.model.SqlQueryWithReportTemplate.Builder;
import org.opentestsystem.rdw.olap.sqlbuilder.AbstractReportTemplateProvider;
import org.opentestsystem.rdw.olap.sqlbuilder.impl.QueryProviderRepositoryHelper;
import org.opentestsystem.rdw.olap.sqlbuilder.impl.template.SimpleReportTemplateProvider;
import org.opentestsystem.rdw.reporting.common.configuration.ReportingSystemProperties;
import org.opentestsystem.rdw.reporting.common.model.DimensionType;
import org.opentestsystem.rdw.reporting.common.security.PermissionSource;
import org.opentestsystem.rdw.reporting.common.sqlbuilder.QueryProvider;
import org.opentestsystem.rdw.security.PermissionScope;

import java.util.Collection;
import java.util.Set;

import static org.opentestsystem.rdw.common.model.AssessmentType.SUMMATIVE;
import static org.opentestsystem.rdw.reporting.common.jdbc.QueryUtils.padIntToSize;
import static org.opentestsystem.rdw.reporting.common.jdbc.QueryUtils.padLongToSize;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.ELAS;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.EconomicDisadvantage;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Ethnicity;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Gender;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.IEP;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.LEP;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Language;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.MigrantStatus;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.MilitaryConnectedCode;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Section504;
import static org.opentestsystem.rdw.reporting.common.security.ReportingPermission.TestDataLoadingRead;
import static org.opentestsystem.rdw.reporting.common.security.ReportingPermission.TestDataReviewingRead;
import static org.opentestsystem.rdw.security.PermissionScope.getScopeOrEmpty;

/**
 * Represents common functionality for converting an instance of {@link OrganizationTypeQuery}
 * into a {@link SqlQueryWithReportTemplate}
 */
public abstract class AbstractSqlQueryWithReportTemplateProvider<Q extends OrganizationTypeQuery, T extends SimpleReportTemplateProvider>
        extends AbstractReportTemplateProvider<Builder, SqlQueryWithReportTemplate, Q> {

    private static final String stateAddOn = "state";
    private static final String districtsAddOn = "districts";
    private static final String allDistrictsAddOn = "allDistricts";
    private static final String schoolsAddOn = "schools";
    private static final String allSchoolsInDistrictsAddOn = "allSchoolsInDistricts";
    private static final String districtEmbargoAddOn = "districtEmbargo";
    private static final String stateEmbargoAddOn = "stateEmbargo";

    private final QueryProvider queryProvider;
    private final PermissionSource permissionSource;
    private final QueryProviderRepositoryHelper repositoryHelper;
    private final ReportingSystemProperties reportingSystemProperties;
    private final int organizationPartitionSize;

    protected final T templateProvider;

    AbstractSqlQueryWithReportTemplateProvider(final T templateProvider,
                                               final int organizationPartitionSize,
                                               final QueryProvider queryProvider,
                                               final QueryProviderRepositoryHelper repositoryHelper,
                                               final PermissionSource permissionSource,
                                               final ReportingSystemProperties reportingSystemProperties) {
        this.queryProvider = queryProvider;
        this.organizationPartitionSize = organizationPartitionSize;
        this.permissionSource = permissionSource;
        this.repositoryHelper = repositoryHelper;
        this.templateProvider = templateProvider;
        this.reportingSystemProperties = reportingSystemProperties;
    }

    QueryProviderRepositoryHelper getRepositoryHelper() {
        return repositoryHelper;
    }

    /**
     * @return a name of the sql template defined in the corresponding *.sql.yml file
     */
    protected abstract String getTemplateSql();

    @Override
    public Builder createBuilderWithState(final String assessmentTypeCode) {
        final Builder builder = createBuilderInstance()
                .addOn(stateAddOn)
                .reportTemplate(templateProvider.createBuilderWithState(assessmentTypeCode).build());

        // apply embargo add-on for summatives
        if (assessmentTypeCode.equalsIgnoreCase(SUMMATIVE.code())) {
            PermissionScope loadingScope = getScopeOrEmpty(permissionSource.getPermissionsById(), TestDataLoadingRead);
            PermissionScope reviewingScope = getScopeOrEmpty(permissionSource.getPermissionsById(), TestDataReviewingRead);

            builder.addOn(stateEmbargoAddOn)
                    .parameter("state_embargo_admin", loadingScope.isStatewide() || reviewingScope.isStatewide())
                     // TODO: remove when safe
                    .parameter("system_school_year", reportingSystemProperties.getSchoolYear());
        }
        return builder;
    }

    @Override
    public Builder createBuilderWithAllDistricts(final String assessmentTypeCode) {
        final Builder builder = createBuilderInstance()
                .addOn(allDistrictsAddOn)
                .reportTemplate(templateProvider.createBuilderWithAllDistricts(assessmentTypeCode).build());

        // apply embargo add-on for summatives
        if (assessmentTypeCode.equalsIgnoreCase(SUMMATIVE.code())) {
            addEmbargo(builder);
        }
        return builder;
    }

    @Override
    public Builder createBuilderWithDistrictIds(final String assessmentTypeCode, final Set<Long> districtIds) {
        final Builder builder = createBuilderInstance()
                .addOn(districtsAddOn)
                .parameter("district_ids", padLongToSize(districtIds, organizationPartitionSize))
                .reportTemplate(templateProvider.createBuilderWithDistrictIds(assessmentTypeCode, districtIds).build());

        // apply embargo add-on for summatives
        if (assessmentTypeCode.equalsIgnoreCase(SUMMATIVE.code())) {
            addEmbargo(builder);
        }
        return builder;
    }

    @Override
    public Builder createBuilderWithAllSchoolsOfDistricts(final String assessmentTypeCode, final Set<Long> districtIds) {
        final Builder builder = createBuilderInstance()
                .addOn(allSchoolsInDistrictsAddOn)
                .parameter("school_district_ids", padLongToSize(districtIds, organizationPartitionSize))
                .reportTemplate(templateProvider.createBuilderWithAllSchoolsOfDistricts(assessmentTypeCode, districtIds).build());

        // apply embargo add-on for summatives
        if (assessmentTypeCode.equalsIgnoreCase(SUMMATIVE.code())) {
            addEmbargo(builder);
        }
        return builder;
    }

    @Override
    public Builder createBuilderWithSchoolIds(final String assessmentTypeCode, final Set<Long> schoolIds) {
        final Builder builder = createBuilderInstance()
                .addOn(schoolsAddOn)
                .parameter("school_ids", padLongToSize(schoolIds, organizationPartitionSize))
                .reportTemplate(templateProvider.createBuilderWithSchoolIds(assessmentTypeCode, schoolIds).build());

        // apply embargo add-on for summatives
        if (assessmentTypeCode.equalsIgnoreCase(SUMMATIVE.code())) {
            addEmbargo(builder);
        }
        return builder;
    }

    private void addEmbargo(final Builder builder) {
        final PermissionScope loadingScope = getScopeOrEmpty(permissionSource.getPermissionsById(), TestDataLoadingRead);
        final PermissionScope reviewingScope = getScopeOrEmpty(permissionSource.getPermissionsById(), TestDataReviewingRead);

        builder
                .addOn(districtEmbargoAddOn)
                .parameter("state_embargo_admin", loadingScope.isStatewide() || reviewingScope.isStatewide())
                .parameter("district_embargo_admin_ids", padLongToSize(reviewingScope.getDistrictIds(), organizationPartitionSize))
                // TODO: remove when safe. System school year no longer relevant to embargo.
                .parameter("system_school_year", reportingSystemProperties.getSchoolYear());
    }

    @Override
    public SqlQueryWithReportTemplate build(final Builder builder) {
        return builder.build(queryProvider, getTemplateSql());
    }

    @Override
    public Builder createBuilderInstance() {
        return SqlQueryWithReportTemplate.builder();
    }

    Builder addFiltersAndDimension(final Builder queryBuilder, final Q query) {
        final DimensionType dimensionType = query.getDimensionType();
        queryBuilder.addOn(dimensionType.name());

        if (!query.getCompletenessCodes().isEmpty()) {
            queryBuilder
                    .addOn("Completeness_filter")
                    .parameter("completeness_ids",
                            padIntToSize(repositoryHelper.toCompletenessIds(query.getCompletenessCodes()),
                                    repositoryHelper.maxCompletenessCodes()));
        }

        if (!query.getAdministrativeConditionCodes().isEmpty()) {
            queryBuilder
                    .addOn("AdministrationCondition_filter")
                    .parameter("administration_condition_ids",
                            padIntToSize(repositoryHelper.toAdministrativeConditionIds(query.getAdministrativeConditionCodes()),
                                    repositoryHelper.maxAdministrativeConditions()));
        }

        final Set<Integer> genderIds = repositoryHelper.toGenderIds(query.getGenderCodes());
        final Set<Integer> ethnicityIds = repositoryHelper.toEthnicityIds(query.getEthnicityCodes());
        final Set<Integer> lepIds = repositoryHelper.toStrictBooleanIds(query.getLepCodes());
        final Set<Integer> elasIds = repositoryHelper.toElasIds(query.getElasCodes());
        final Set<Integer> languageIds = repositoryHelper.toLanguageIds(query.getLanguageCodes());
        final Set<Integer> migrantStatusIds = repositoryHelper.toBooleanIds(query.getMigrantStatusCodes());
        final Set<Integer> section504Ids = repositoryHelper.toBooleanIds(query.getSection504Codes());
        final Set<Integer> iepIds = repositoryHelper.toStrictBooleanIds(query.getIepCodes());
        final Set<Integer> economicDisadvantageIds = repositoryHelper.toStrictBooleanIds(query.getEconomicDisadvantageCodes());
        final Set<Integer> militaryConnectedIds = repositoryHelper.toMilitaryConnectedCodeIds(query.getMilitaryConnectedCodes());

        addFilter(queryBuilder, Gender, genderIds, dimensionType == Gender);
        addFilter(queryBuilder, Ethnicity, ethnicityIds, dimensionType == Ethnicity);
        addFilter(queryBuilder, LEP, lepIds, dimensionType == LEP);
        addFilter(queryBuilder, ELAS, elasIds, dimensionType == ELAS);
        addFilter(queryBuilder, Language, languageIds, dimensionType == Language);
        addFilter(queryBuilder, MilitaryConnectedCode, militaryConnectedIds, dimensionType == MilitaryConnectedCode);
        addFilter(queryBuilder, MigrantStatus, migrantStatusIds, dimensionType == MigrantStatus);
        addFilter(queryBuilder, Section504, section504Ids, dimensionType == Section504);
        addFilter(queryBuilder, IEP, iepIds, dimensionType == IEP);
        addFilter(queryBuilder, EconomicDisadvantage, economicDisadvantageIds, dimensionType == EconomicDisadvantage);

        switch (dimensionType) {
            case Gender:
                addFilterParams(queryBuilder, dimensionType, genderIds);
                break;
            case Ethnicity:
                addFilterParams(queryBuilder, dimensionType, ethnicityIds);
                break;
            case LEP:
                addFilterParams(queryBuilder, dimensionType, lepIds);
                break;
            case ELAS:
                addFilterParams(queryBuilder, dimensionType, elasIds);
                break;
            case Language:
                addFilterParams(queryBuilder, dimensionType, languageIds);
                break;
            case MilitaryConnectedCode:
                addFilterParams(queryBuilder, dimensionType, militaryConnectedIds);
                break;
            case MigrantStatus:
                addFilterParams(queryBuilder, dimensionType, migrantStatusIds);
                break;
            case Section504:
                addFilterParams(queryBuilder, dimensionType, section504Ids);
                break;
            case IEP:
                addFilterParams(queryBuilder, dimensionType, iepIds);
                break;
            case EconomicDisadvantage:
                addFilterParams(queryBuilder, dimensionType, economicDisadvantageIds);
                break;
        }
        return queryBuilder;
    }

    private void addFilter(final Builder queryBuilder,
                           final DimensionType dimensionType,
                           final Collection<Integer> dimensionFilters,
                           boolean isFilterSameAsDimension) {
        if (!isFilterSameAsDimension && !dimensionFilters.isEmpty()) {
            queryBuilder.addOn(dimensionType.name() + "_filter");
            addFilterParams(queryBuilder, dimensionType, dimensionFilters);
        }
    }

    private void addFilterParams(final Builder queryBuilder,
                                 final DimensionType dimensionType,
                                 final Collection<Integer> dimensionFilters) {

        switch (dimensionType) {
            case Gender:
                queryBuilder.parameter("all_genders", dimensionFilters.isEmpty())
                        .parameter("gender_ids", padIntToSize(dimensionFilters, repositoryHelper.maxSize(dimensionType)));
                break;
            case Ethnicity:
                queryBuilder.parameter("all_ethnicities", dimensionFilters.isEmpty())
                        .parameter("ethnicity_ids", padIntToSize(dimensionFilters, repositoryHelper.maxSize(dimensionType)));
                break;

            case LEP:
                queryBuilder.parameter("all_leps", dimensionFilters.isEmpty())
                        .parameter("lep_ids", padIntToSize(dimensionFilters, repositoryHelper.maxSize(dimensionType)));
                break;

            case ELAS:
                queryBuilder.parameter("all_elas", dimensionFilters.isEmpty())
                        .parameter("elas_ids", padIntToSize(dimensionFilters, repositoryHelper.maxSize(dimensionType)));
                break;

            case Language:
                queryBuilder.parameter("all_languages", dimensionFilters.isEmpty())
                        .parameter("language_ids", padIntToSize(dimensionFilters, 8));
                break;

            case MilitaryConnectedCode:
                queryBuilder.parameter("all_military_connected", dimensionFilters.isEmpty())
                        .parameter("military_connected_ids", padIntToSize(dimensionFilters, repositoryHelper.maxSize(dimensionType)));

            case MigrantStatus:
                queryBuilder.parameter("all_migrant_statuses", dimensionFilters.isEmpty())
                        .parameter("migrant_status_ids", padIntToSize(dimensionFilters, repositoryHelper.maxSize(dimensionType)));
                break;
            case Section504:
                queryBuilder.parameter("all_section504s", dimensionFilters.isEmpty())
                        .parameter("section504_ids", padIntToSize(dimensionFilters, repositoryHelper.maxSize(dimensionType)));
                break;

            case IEP:
                queryBuilder.parameter("all_ieps", dimensionFilters.isEmpty())
                        .parameter("iep_ids", padIntToSize(dimensionFilters, repositoryHelper.maxSize(dimensionType)));
                break;

            case EconomicDisadvantage:
                queryBuilder.parameter("all_economic_disadvantages", dimensionFilters.isEmpty())
                        .parameter("economic_disadvantage_ids", padIntToSize(dimensionFilters, repositoryHelper.maxSize(dimensionType)));
                break;
        }
    }
}
