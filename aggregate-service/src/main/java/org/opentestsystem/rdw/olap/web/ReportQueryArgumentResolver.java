package org.opentestsystem.rdw.olap.web;

import org.opentestsystem.rdw.common.model.AssessmentType;
import org.opentestsystem.rdw.reporting.common.model.DimensionType;
import org.opentestsystem.rdw.reporting.common.model.ReportQuery;
import org.springframework.core.MethodParameter;
import org.springframework.web.bind.support.WebDataBinderFactory;
import org.springframework.web.context.request.NativeWebRequest;
import org.springframework.web.method.support.HandlerMethodArgumentResolver;
import org.springframework.web.method.support.ModelAndViewContainer;

import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.collect.Maps.newHashMap;
import static com.google.common.collect.Sets.newHashSet;

/**
 * Argument resolver for {@link ReportQuery} instances.
 * <p>
 * Rules for submitting organizations from the {@link ReportQuery} in the URL GET are:
 * <p>
 * State: state=TF - optional, must be two character long; the first char represents 'True/False' for including state, and the second for including all children (districts).
 * District: districts=100F,200T - optional, a comma separated list of district ids and 'True/False' for including all children (schools).
 * School Ids: schoolIds=99,300 - optional, a comma separated list of school ids
 * <p>
 * Example URL: ...?assessmentType=ICA&subjectIds=1,2&schoolYears=2017,2018&asmtGradeIds=4,5&state=FF&districts=15F,17F&dimensionTypes=gender,ethnicity&schoolIds=265,266
 * </p>
 */
public class ReportQueryArgumentResolver implements HandlerMethodArgumentResolver {

    @Override
    public boolean supportsParameter(final MethodParameter parameter) {
        return parameter.getParameterType().equals(ReportQuery.class);
    }

    @Override
    public Object resolveArgument(final MethodParameter parameter,
                                  final ModelAndViewContainer mavContainer,
                                  final NativeWebRequest webRequest,
                                  final WebDataBinderFactory binderFactory) throws Exception {


        final String state = webRequest.getParameter("state");
        checkArgument(state == null || state.length() == 2, "invalid state parameter for report query");

        final String dimensions = webRequest.getParameter("dimensionTypes");
        final String districtsRaw = webRequest.getParameter("districts");

        final Map<Integer, Boolean> districts = newHashMap();
        if (districtsRaw != null) {
            for (final String district : districtsRaw.split(",")) {
                checkArgument(district.length() > 1, "invalid district request");
                districts.put(Integer.parseInt(district.substring(0, district.length() - 1)), (district.endsWith("T") || district.endsWith("t")));
            }
        }

        return ReportQuery.builder()
                .includeState(state != null && (state.startsWith("T") || state.startsWith("t")))
                .includeAllDistricts(state != null && (state.endsWith("T") || state.endsWith("t")))
                .subjectIds(toSet(checkMandatory(webRequest.getParameter("subjectIds"), "missing subject id")))
                .schoolYears(toSet(checkMandatory(webRequest.getParameter("schoolYears"), "missing school years")))
                .asmtGradeIds(toSet(checkMandatory(webRequest.getParameter("asmtGradeIds"), "missing assessment grade ids")))
                .schoolIds(toSet(webRequest.getParameter("schoolIds")))
                .districts(districts)
                .dimensionTypes(dimensions == null ? null : Stream.of(dimensions.split(",")).map(type -> {
                    try {
                        return DimensionType.caseInsensitiveValue(type);
                    } catch (final IllegalArgumentException exception) {
                        return null;
                    }
                }).filter(Objects::nonNull).collect(Collectors.toSet()))
                .assessmentType(AssessmentType.valueOf(checkMandatory(webRequest.getParameter("assessmentType"), "missing assessment type")))
                .genderIds(toSet(webRequest.getParameter("genderIds")))
                .completenessIds(toSet(webRequest.getParameter("completenessIds")))
                .administrativeConditionIds(toSet(webRequest.getParameter("administrativeConditionIds")))
                .build();
    }

    private Set<Integer> toSet(final String value) {
        return value == null ? newHashSet() : Stream.of(value.split(",")).map(Integer::valueOf).filter(Objects::nonNull).collect(Collectors.toSet());
    }

    private <T> T checkMandatory(final T value, final String msg) {
        checkArgument(value != null, msg);
        return value;
    }
}
