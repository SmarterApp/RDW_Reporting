package org.opentestsystem.rdw.olap.service.impl;

import org.opentestsystem.rdw.common.model.AssessmentType;
import org.opentestsystem.rdw.olap.AggregateReportSettings;
import org.opentestsystem.rdw.olap.model.AggregateOrganizationQuery;
import org.opentestsystem.rdw.olap.model.ClaimReportResult;
import org.opentestsystem.rdw.olap.model.ClaimReportResult.Builder;
import org.opentestsystem.rdw.olap.repository.ClaimReportRepository;
import org.opentestsystem.rdw.olap.repository.ClaimRepository;
import org.opentestsystem.rdw.olap.service.AuthorizationService;
import org.opentestsystem.rdw.reporting.common.model.AggregateQuery;
import org.opentestsystem.rdw.reporting.common.model.ClaimAggregateReportQuery;
import org.opentestsystem.rdw.reporting.common.model.ClaimRow;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.task.TaskExecutor;
import org.springframework.stereotype.Service;

import java.util.Set;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.collect.Sets.newHashSet;
import static org.opentestsystem.rdw.reporting.common.model.AggregateReportType.Claim;

/**
 * Responsible for handling {@link ClaimAggregateReportQuery}
 */
@Service
class ClaimReportQueryHandler extends AbstractAggregateQueryHandler<ClaimRow,
        ClaimReportResult,
        ClaimAggregateReportQuery,
        Builder,
        AggregateOrganizationQuery,
        AggregateOrganizationQuery.Builder> {

    private final ClaimRepository claimRepository;

    @Autowired
    ClaimReportQueryHandler(
            final ClaimReportRepository repository,
            final AuthorizationService authorizationService,
            final AggregateReportSettings settings,
            final ClaimQueryConverter queryAdapter,
            final TaskExecutor threadPoolTaskExecutor,
            final ClaimRepository claimRepository) {
        super(repository, queryAdapter, authorizationService, settings, threadPoolTaskExecutor);
        this.claimRepository = claimRepository;
    }

    @Override
    public boolean handles(final AggregateQuery query) {
        return Claim.equals(query.getReportType());
    }

    @Override
    protected ClaimReportResult.Builder getReportResultBuilder() {
        return ClaimReportResult.builder();
    }

    @Override
    protected ClaimAggregateReportQuery preProcess(final ClaimAggregateReportQuery query) {
        checkArgument(!AssessmentType.IAB.code().equals(query.getAssessmentTypeCode()), "Claim report is not supported for IABs");

        return super.preProcess(!query.getClaimCodes().isEmpty() ? query :
                query.copy().claimCodes(findAllClaimCodes(query.getAssessmentTypeCode(), query.getSubjectCodes())).build());
    }

    @Override
    public ClaimRepository getClaimRepository() {
        return this.claimRepository;
    }

    private Set<String> findAllClaimCodes(final String assessmentTypeCode, final Set<String> subjectCodes) {
        final Set<String> claimCodes = newHashSet();
        for (final org.opentestsystem.rdw.olap.model.Claim claim : claimRepository.findAll()) {
            if (claim.getAssessmentTypeCode().equals(assessmentTypeCode) && subjectCodes.contains(claim.getSubjectCode())) {
                claimCodes.add(claim.getCode());
            }
        }
        return claimCodes;
    }
}