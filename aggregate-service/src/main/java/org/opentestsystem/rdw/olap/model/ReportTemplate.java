package org.opentestsystem.rdw.olap.model;

import org.opentestsystem.rdw.reporting.common.model.ActiveAssessment;
import org.opentestsystem.rdw.reporting.common.model.Dimension;
import org.opentestsystem.rdw.reporting.common.model.District;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.School;
import org.opentestsystem.rdw.reporting.common.model.Target;

import java.util.Collection;
import java.util.Map;
import java.util.Set;

import static com.google.common.collect.Maps.newHashMap;
import static com.google.common.collect.Sets.newHashSet;

/**
 * An implementation of {@link BuildableTemplate} to hold the data entities represented by
 * an instance of {@link OrganizationTypeQuery}.
 * <p>
 * It is a helper class that is used to either back-fill empty report rows or derive an estimated row count.
 * </p>
 * TODO - this is a superset, can some of the fields be moved into child classes?
 */
@SuppressWarnings("unchecked")
public class ReportTemplate extends BuildableTemplate {
    private Set<Organization> organizations;
    private Set<ActiveAssessment> assessments;
    private Set<Dimension> dimensions;
    private Map<String, Set<String>> claimCodesBySubject;
    private Map<String, Set<String>> altScoreCodesBySubject;
    private Map<Integer, Set<Target>> targetsByAssessmentId;

    public Set<Organization> getOrganizations() {
        return organizations;
    }

    public Set<ActiveAssessment> getAssessments() {
        return assessments;
    }

    public Set<Dimension> getDimensions() {
        return dimensions;
    }

    public Map<String, Set<String>> getClaimCodesBySubject() {
        return claimCodesBySubject;
    }

    public Map<String, Set<String>> getAltScoreCodesBySubject() {
        return altScoreCodesBySubject;
    }

    public Map<Integer, Set<Target>> getTargetsByAssessmentId() {
        return targetsByAssessmentId;
    }

    public static Builder builder() {
        return new Builder();
    }

    public Builder copy() {
        return builder().copy(this);
    }

    /**
     * Helper to visit all combinations of Organization, Assessment, Dimension.
     * Only backfilled dimensions are visited; this is because all current uses
     * of this method want it that way.
     *
     * @param visitor visitor to invoke with each combination
     */
    public void combinations(final CombinationVisitor visitor) {
        for (final Organization organization : organizations) {
            for (final ActiveAssessment assessment : assessments) {
                for (final Dimension dimension : dimensions) {
                    if (!dimension.getType().isBackfilled()) continue;
                    visitor.visit(organization, assessment, dimension);
                }
            }
        }
    }

    public interface CombinationVisitor {
        void visit(Organization organization, ActiveAssessment assessment, Dimension dimension);
    }

    public static class Builder<B extends Builder> extends BuildableTemplate.Builder<B> {
        Set<Organization> organizations = newHashSet();
        Set<ActiveAssessment> assessments = newHashSet();
        Set<Dimension> dimensions = newHashSet();
        Map<String, Set<String>> claimCodesBySubject = newHashMap();
        Map<String, Set<String>> altScoreCodesBySubject = newHashMap();
        Map<Integer, Set<Target>> targetsByAssessmentId = newHashMap();

        public ReportTemplate build() {
            final ReportTemplate reportTemplate = new ReportTemplate();
            reportTemplate.assessments = assessments;
            reportTemplate.organizations = organizations;
            reportTemplate.dimensions = dimensions;
            reportTemplate.claimCodesBySubject = claimCodesBySubject;
            reportTemplate.altScoreCodesBySubject = altScoreCodesBySubject;
            reportTemplate.targetsByAssessmentId = targetsByAssessmentId;
            return reportTemplate;
        }

        @Override
        public Builder merge(final Builder another) {
            organizations.addAll(another.organizations);
            assessments.addAll(another.assessments);
            dimensions.addAll(another.dimensions);
            claimCodesBySubject.putAll(another.claimCodesBySubject);
            altScoreCodesBySubject.putAll(another.altScoreCodesBySubject);
            targetsByAssessmentId.putAll(another.targetsByAssessmentId);
            return this;
        }

        public Builder merge(final ReportTemplate another) {
            organizations.addAll(another.getOrganizations());
            assessments.addAll(another.getAssessments());
            dimensions.addAll(another.getDimensions());
            claimCodesBySubject.putAll(another.getClaimCodesBySubject());
            altScoreCodesBySubject.putAll(another.getAltScoreCodesBySubject());
            targetsByAssessmentId.putAll(another.getTargetsByAssessmentId());
            return this;
        }

        public Builder copy(final ReportTemplate another) {
            organizations = another.getOrganizations();
            assessments = another.getAssessments();
            dimensions = another.getDimensions();
            claimCodesBySubject = another.getClaimCodesBySubject();
            altScoreCodesBySubject = another.getAltScoreCodesBySubject();
            targetsByAssessmentId = another.getTargetsByAssessmentId();
            return this;
        }

        public Builder assessments(final Collection<ActiveAssessment> assessments) {
            this.assessments.addAll(assessments);
            return this;
        }

        public Builder districts(final Collection<District> districts) {
            this.organizations.addAll(districts);
            return this;
        }

        public Builder schools(final Collection<School> schools) {
            this.organizations.addAll(schools);
            return this;
        }

        public Builder state(final Organization state) {
            this.organizations.add(state);
            return this;
        }

        public Builder dimension(final Dimension dimension) {
            this.dimensions.add(dimension);
            return this;
        }

        public Builder dimensions(final Collection<Dimension> dimensions) {
            this.dimensions.addAll(dimensions);
            return this;
        }

        public Builder claimCodesBySubject(final Map<String, Set<String>> claimCodesBySubject) {
            this.claimCodesBySubject = claimCodesBySubject;
            return this;
        }

        public Builder altScoreCodesBySubject(final Map<String, Set<String>> altScoreCodesBySubject) {
            this.altScoreCodesBySubject = altScoreCodesBySubject;
            return this;
        }

        public Builder targetsByAssessmentId(final Map<Integer, Set<Target>> targetsByAssessmentId) {
            this.targetsByAssessmentId = targetsByAssessmentId;
            return this;
        }
    }
}
