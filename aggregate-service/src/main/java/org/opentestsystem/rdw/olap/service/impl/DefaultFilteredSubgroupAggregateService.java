package org.opentestsystem.rdw.olap.service.impl;

import org.opentestsystem.rdw.olap.AggregateReportSettings;
import org.opentestsystem.rdw.olap.model.CustomAggregateOrganizationQuery;
import org.opentestsystem.rdw.olap.model.CustomAggregateReportResult;
import org.opentestsystem.rdw.olap.model.CustomAggregateReportResult.Builder;
import org.opentestsystem.rdw.olap.repository.CustomAggregateReportRepository;
import org.opentestsystem.rdw.olap.service.AuthorizationService;
import org.opentestsystem.rdw.olap.service.CustomAggregateService;
import org.opentestsystem.rdw.reporting.common.model.AggregateQuery;
import org.opentestsystem.rdw.reporting.common.model.AggregateRow;
import org.opentestsystem.rdw.reporting.common.model.CustomAggregateReportQuery;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.core.task.TaskExecutor;
import org.springframework.stereotype.Service;

import static org.opentestsystem.rdw.reporting.common.model.AggregateReportType.CustomAggregate;

/**
 * Default implementation of an {@link CustomAggregateService} backed by a repository
 */
@Service
class DefaultFilteredSubgroupAggregateService extends AbstractFilteredSubgroupAggregateService<AggregateRow,
        CustomAggregateReportResult,
        CustomAggregateReportQuery,
        CustomAggregateReportResult.Builder,
        CustomAggregateOrganizationQuery,
        CustomAggregateOrganizationQuery.Builder>
        implements CustomAggregateService {

    @Autowired
    DefaultFilteredSubgroupAggregateService(
            @Qualifier("customAggregate") final CustomAggregateReportRepository repository,
            final AuthorizationService authorizationService,
            final AggregateReportSettings settings,
            final FilteredSubgroupQueryAdapter queryAdapter,
            final TaskExecutor threadPoolTaskExecutor) {
        super(repository, authorizationService, settings, queryAdapter, threadPoolTaskExecutor);
    }

    @Override
    public boolean handles(final AggregateQuery query) {
        return CustomAggregate.equals(query.getReportType()) && query.isFilteredSubgroupQuery();
    }

    @Override
    protected Builder getReportResultBuilder() {
        return CustomAggregateReportResult.builder();
    }
}