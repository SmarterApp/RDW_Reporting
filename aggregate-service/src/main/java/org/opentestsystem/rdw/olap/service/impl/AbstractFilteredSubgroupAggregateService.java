package org.opentestsystem.rdw.olap.service.impl;

import org.opentestsystem.rdw.olap.AggregateReportSettings;
import org.opentestsystem.rdw.olap.model.AggregateRowReportResult;
import org.opentestsystem.rdw.olap.model.OrganizationTypeQuery;
import org.opentestsystem.rdw.olap.repository.ReportRepository;
import org.opentestsystem.rdw.olap.service.AuthorizationService;
import org.opentestsystem.rdw.reporting.common.model.AbstractAggregateReportQuery;
import org.opentestsystem.rdw.reporting.common.model.AggregateRow;
import org.opentestsystem.rdw.reporting.common.model.StudentFilters;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.task.TaskExecutor;

import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Overall;

/**
 * Common functionality for implementations of {@link AbstractCustomAggregateService} for {@link AbstractAggregateReportQuery}
 */
@SuppressWarnings("unchecked")
abstract class AbstractFilteredSubgroupAggregateService<T extends AggregateRow,
        R extends AggregateRowReportResult<T>,
        Q extends AbstractAggregateReportQuery,
        B extends AggregateRowReportResult.Builder,
        O extends OrganizationTypeQuery,
        V extends OrganizationTypeQuery.Builder>
        extends AbstractCustomAggregateService<T, R, Q, B, O, V> {

    @Autowired
    AbstractFilteredSubgroupAggregateService(
            final ReportRepository<T, R, O> repository,
            final AuthorizationService authorizationService,
            final AggregateReportSettings settings,
            final AbstractFilteredSubgroupQueryAdapter<Q, O, V> queryAdapter,
            final TaskExecutor threadPoolTaskExecutor) {
        super(repository, queryAdapter, authorizationService, settings, threadPoolTaskExecutor);
    }

    private Q ensureOverallSubgroup(final Q query) {
        return query.getSubgroups().keySet().contains(Overall.name()) ? query : (Q) (query.copy()).subgroup(Overall.name(), StudentFilters.builder().build()).build();
    }

    @Override
    protected Q checkIsValid(final Q query) {
        return super.checkIsValid(ensureOverallSubgroup(query));
    }
}