package org.opentestsystem.rdw.olap.sqlbuilder;

import org.opentestsystem.rdw.olap.model.OrganizationTypeQuery;
import org.opentestsystem.rdw.reporting.common.model.ActiveAssessment;
import org.opentestsystem.rdw.reporting.common.model.Dimension;
import org.opentestsystem.rdw.reporting.common.model.District;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.School;

import java.util.Collection;
import java.util.Set;

import static com.google.common.collect.Sets.newHashSet;

/**
 * A helper that contains all data needed to build en empty template version of the report: all rows with empty measures.
 * <p>
 * It is used during conversion of the {@link OrganizationTypeQuery} to sql to back-fill missing
 * report rows or deriving an estimated row count.
 */
@SuppressWarnings("unchecked")
public class ReportTemplate {
    private Set<Organization> organizations;
    private Set<ActiveAssessment> assessments;
    private Set<Dimension> dimensions;
    private Set<String> claimCodes;
    private boolean includeStudentEnrolledGradeDimension = false;

    public int getEstimatedRowCount() {
        // since we do not back-fill student enrolled grades it is missing from the dimensions.
        // we assume only one grade per asmt/school year
        return (claimCodes.isEmpty() ? 1 : claimCodes.size()) *
                organizations.size() *
                assessments.size() *
                (dimensions.size() + (includeStudentEnrolledGradeDimension ? 1 : 0));
    }

    public Set<Organization> getOrganizations() {
        return organizations;
    }

    public Set<ActiveAssessment> getAssessments() {
        return assessments;
    }

    public Set<Dimension> getDimensions() {
        return dimensions;
    }

    public Set<String> getClaimCodes() {
        return claimCodes;
    }

    public static Builder builder() {
        return new Builder();
    }

    public static class Builder<B extends Builder, T extends ReportTemplate> {
        Set<Organization> organizations = newHashSet();
        Set<ActiveAssessment> assessments = newHashSet();
        Set<Dimension> dimensions = newHashSet();
        Set<String> claimCodes = newHashSet();
        boolean includeStudentEnrolledGradeDimension = false;

        protected T createInstance() {
            return (T) new ReportTemplate();
        }

        public T build() {
            final ReportTemplate reportTemplate = createInstance();
            reportTemplate.assessments = assessments;
            reportTemplate.organizations = organizations;
            reportTemplate.dimensions = dimensions;
            reportTemplate.includeStudentEnrolledGradeDimension = includeStudentEnrolledGradeDimension;
            reportTemplate.claimCodes = claimCodes;
            return (T) reportTemplate;
        }

        B merge(final B another) {
            organizations.addAll(another.organizations);
            assessments.addAll(another.assessments);
            dimensions.addAll(another.dimensions);
            claimCodes.addAll(another.claimCodes);
            includeStudentEnrolledGradeDimension = (includeStudentEnrolledGradeDimension || another.includeStudentEnrolledGradeDimension);
            return (B) this;
        }

        B assessments(final Collection<ActiveAssessment> assessments) {
            this.assessments.addAll(assessments);
            return (B) this;
        }

        B districts(final Collection<District> districts) {
            this.organizations.addAll(districts);
            return (B) this;
        }

        B schools(final Collection<School> schools) {
            this.organizations.addAll(schools);
            return (B) this;
        }

        B state(final Organization state) {
            this.organizations.add(state);
            return (B) this;
        }

        B dimensions(final Collection<Dimension> dimensions) {
            this.dimensions.addAll(dimensions);
            return (B) this;
        }

        B claimCodes(final Collection<String> claimCodes) {
            if (claimCodes != null) this.claimCodes.addAll(claimCodes);
            return (B) this;
        }

        B includeStudentEnrolledGradeDimension(final boolean includeStudentEnrolledGradeDimension) {
            this.includeStudentEnrolledGradeDimension = includeStudentEnrolledGradeDimension;
            return (B) this;
        }
    }
}