package org.opentestsystem.rdw.olap.sqlbuilder;

import org.opentestsystem.rdw.olap.model.ReportRowIdentity;
import org.opentestsystem.rdw.reporting.common.model.ActiveAssessment;
import org.opentestsystem.rdw.reporting.common.model.Dimension;
import org.opentestsystem.rdw.reporting.common.model.Measures;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.ReportQuery;
import org.opentestsystem.rdw.reporting.common.model.ReportRow;
import org.opentestsystem.rdw.reporting.common.sqlbuilder.QueryProvider;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;

import java.util.List;
import java.util.Map;

import static com.google.common.collect.Lists.newArrayList;
import static com.google.common.collect.Maps.newHashMap;

/**
 * This is a helper class that is used during conversion of the {@link ReportQuery} to a sql string, its parameters and a template version of the report.
 * The template version represents all {@link ReportRow}s with an 'empty' measure. It is used to backfill the missing data when the final report is created.
 */
public class QueryWithReportTemplate extends ReportContext {
    private String sqlQuery;
    private MapSqlParameterSource parameterSource;
    private Map<ReportRowIdentity, ReportRow> reportTemplate;

    public String getSqlQuery() {
        return sqlQuery;
    }

    public MapSqlParameterSource getParameterSource() {
        return parameterSource;
    }

    public Map<ReportRowIdentity, ReportRow> getReportTemplate() {
        return newHashMap(reportTemplate);
    }

    public static Builder builder() {
        return new Builder();
    }

    public static class Builder extends ReportContext.Builder<Builder, QueryWithReportTemplate> {
        private static final Measures emptyMeasure = Measures.builder().build();
        private final MapSqlParameterSource parameterSource = new MapSqlParameterSource();
        private final List<String> addOns = newArrayList();

        public QueryWithReportTemplate build(final QueryProvider queryProvider, final String templateSql) {
            final QueryWithReportTemplate queryWithReportTemplate = super.build();
            queryWithReportTemplate.sqlQuery = queryProvider.newQuery(templateSql, addOns).toString();
            queryWithReportTemplate.parameterSource = parameterSource;
            queryWithReportTemplate.reportTemplate = newHashMap();

            for (final Organization organization : organizations) {
                for (final ActiveAssessment assessment : assessments) {
                    for (final Dimension dimension : dimensions) {
                        final ReportRow row = ReportRow.builder()
                                .assessment(assessment)
                                .organization(organization)
                                .dimension(dimension)
                                .measures(emptyMeasure)
                                .build();
                        queryWithReportTemplate.reportTemplate.put(new ReportRowIdentity(row), row);
                    }
                }
            }
            return queryWithReportTemplate;
        }

        @Override
        protected QueryWithReportTemplate createInstance() {
            return new QueryWithReportTemplate();
        }

        Builder merge(final Builder another) {
            super.merge(another);
            parameterSource.addValues(another.parameterSource.getValues());
            addOns.addAll(another.addOns);
            return this;
        }

        Builder addOn(final String addOn) {
            addOns.add(addOn);
            return this;
        }

        Builder parameter(final String paramName, final Object value) {
            parameterSource.addValue(paramName, value);
            return this;
        }
    }
}
