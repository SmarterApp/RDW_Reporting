package org.opentestsystem.rdw.admin.multitenant.database.impl;

import com.google.common.collect.ImmutableMap;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.admin.model.ApplicationTenantConfiguration;
import org.opentestsystem.rdw.admin.model.TenantConfiguration;
import org.opentestsystem.rdw.admin.multitenant.database.TenantDatabaseCreationService;
import org.opentestsystem.rdw.admin.repository.RepositoryIT;
import org.opentestsystem.rdw.multitenant.Tenant;
import org.opentestsystem.rdw.multitenant.datasource.DataSourceElementsTenant;
import org.opentestsystem.rdw.multitenant.datasource.DataSourceUrlParts;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.test.annotation.IfProfileValue;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringRunner;

import javax.sql.DataSource;
import java.util.Map;

/**
 * This test will only run against Aurora and S3
 *
 * <p>
 * This test will run only if the system property test-archive.root is set to s3://rdw-ci-archive
 * <p>
 * Additionally, AWS and Aurora credentials must be set:<ul>
 * <li>archive.s3-access-key</li>
 * <li>archive.s3-secret-key</li>
 * <li>spring.admin_datasource.username</li>
 * <li>spring.admin_datasource.password</li>
 * <li>spring.admin_olap_datasource.username</li>
 * <li>spring.admin_olap_datasource.password</li>
 * </ul>
 * For example,<pre>
 * java -Darchive.uri-root=s3://rdw-ci-archive
 *      -Darchive.s3-access-key=#####################
 *      -Darchive.s3-secret-key=#####################
 *      -Dspring.admin_reporting_datasource.url-parts.hosts=rdw-aurora-ci.cugsexobhx8t.us-west-2.rds.amazonaws.com:3306
 *      -Dspring.admin_reporting_datasource.url-parts.database=sandbox_it_warehouse_test
 *      -Dspring.admin_reporting_datasource.username=#####################
 *      -Dspring.admin_reporting_datasource.password=#####################
 *      -Dspring.admin_reporting_datasource.query-timeout=240
 *      -Dspring.admin_warehouse_datasource.url-parts.hosts=rdw-aurora-ci.cugsexobhx8t.us-west-2.rds.amazonaws.com:3306
 *      -Dspring.admin_warehouse_datasource.url-parts.database=sandbox_it_warehouse_test
 *      -Dspring.admin_warehouse_datasource.username=#####################
 *      -Dspring.admin_warehouse_datasource.password=#####################
 *      -Dspring.admin_warehouse_datasource.query-timeout=240
 *      -Dspring.admin_olap_datasource.url-parts.hosts=rdw-qa.cibkulpjrgtr.us-west-2.redshift.amazonaws.com:5439
 *      -Dspring.admin_olap_datasource.url-parts.database=ci
 *      -Dspring.admin_olap_datasource.username=###################
 *      -Dspring.admin_olap_datasource.password=###################
 *      -Dspring.admin_olap_datasource.query-timeout=240
 * </pre>
 */
@RunWith(SpringRunner.class)
@IfProfileValue(name = "archive.uri-root", value = "s3://rdw-ci-archive")
@RepositoryIT
@ContextConfiguration(classes = {
        JdbcMultitenantDatabaseAdmin.class,
        DefaultTenantDatabaseCreationService.class
})
public class DefaultTenantDatabaseCreationServiceIT {

    @Autowired
    TenantDatabaseCreationService tenantDatabaseCreationService;

    @Autowired
    private JdbcMultitenantDatabaseAdmin jdbcMultitenantDatabaseAdmin;

    @Autowired
    @Qualifier("adminReportingDataSource")
    private DataSource adminReportingDataSource;

    @Autowired
    @Qualifier("adminWarehouseDataSource")
    private DataSource adminWarehouseDataSource;

    @Autowired
    @Qualifier("adminReportingJdbcTemplate")
    private NamedParameterJdbcTemplate adminReportingJdbcTemplate;

    @Autowired
    @Qualifier("adminWarehouseJdbcTemplate")
    private NamedParameterJdbcTemplate adminWarehouseJdbcTemplate;

    @Autowired
    @Qualifier("adminOlapJdbcTemplate")
    private NamedParameterJdbcTemplate adminOlapJdbcTemplate;


    private TenantConfiguration sbxTenantConfiguration;
    private ApplicationTenantConfiguration sbxApplicationTenantConfiguration;
    private DataSourceElementsTenant olapRoSbx;
    private DataSourceElementsTenant olapRwSbx;
    private DataSourceElementsTenant reportingRoSbx;
    private DataSourceElementsTenant reportingRwSbx;
    private DataSourceElementsTenant warehouseRwSbx;
    private DataSourceElementsTenant warehouseRoSbx;
    private DataSourceElementsTenant migrateRwSbx;

    @Before
    public void setUp() throws Exception {

        //set up sandbox test
        olapRoSbx = generateDataSourceElementsTenant("ituxx01", "ItUXX01pwd", "reporting_sbx_xx", null);
        olapRwSbx = generateDataSourceElementsTenant("ituxx01", "ItUXX01pwd", "reporting_sbx_xx", null);

        reportingRoSbx = generateDataSourceElementsTenant("ItUXX02", "ItUXX02pwd", null, "reporting_SBX_XX");
        reportingRwSbx = generateDataSourceElementsTenant("ItUXX02", "ItUXX02pwd", null, "reporting_SBX_XX");
        migrateRwSbx = generateDataSourceElementsTenant("ItUXX02", "ItUXX02pwd", null, "migrate_SBX_XX");

        warehouseRoSbx = generateDataSourceElementsTenant("ItUXX03", "ItUXX03pwd", null, "warehouse_SBX_XX");
        warehouseRwSbx = generateDataSourceElementsTenant("ItUXX03", "ItUXX03pwd", null, "warehouse_SBX_XX");

        sbxTenantConfiguration = new TenantConfiguration();
        sbxApplicationTenantConfiguration = new ApplicationTenantConfiguration();
        sbxTenantConfiguration.setApplicationTenantConfiguration(sbxApplicationTenantConfiguration);
        sbxTenantConfiguration.setTenant(
                Tenant.builder()
                        .id("SBX_XX")
                        .key("SBX_XX")
                        .name("IT Sandbox Test")
                        .sandboxDataset("test-dataset")
                        .build());

        Map<String, DataSourceElementsTenant> datasources =
                new ImmutableMap.Builder<String, DataSourceElementsTenant>()
                        .put("olap_ro", olapRoSbx)
                        .put("olap_rw", olapRwSbx)
                        .put("reporting_ro", reportingRoSbx)
                        .put("reporting_rw", reportingRwSbx)
                        .put("warehouse_ro", warehouseRoSbx)
                        .put("warehouse_rw", warehouseRwSbx)
                        .put("migrate_rw", migrateRwSbx)
                        .build();

        sbxApplicationTenantConfiguration.setDataSources(datasources);

        //setup
        if (jdbcMultitenantDatabaseAdmin.isOlapDatabaseUserExists(olapRoSbx.getUsername())) {
            adminOlapJdbcTemplate.getJdbcOperations()
                    .execute("REVOKE ALL ON SCHEMA " + olapRoSbx.getSchemaSearchPath() + " FROM " + olapRoSbx.getUsername());
            adminOlapJdbcTemplate.getJdbcOperations()
                    .execute("DROP USER IF EXISTS " + olapRoSbx.getUsername());
        }

        adminOlapJdbcTemplate.getJdbcOperations()
                .execute("DROP SCHEMA IF EXISTS " + olapRoSbx.getSchemaSearchPath() + " CASCADE");

        try {
            adminOlapJdbcTemplate.getJdbcOperations()
                    .execute("DROP USER IF EXISTS " + olapRoSbx.getUsername());
        } catch (Exception e) {
            //do nothing
        }

        adminReportingJdbcTemplate.getJdbcOperations()
                .execute("DROP DATABASE IF EXISTS " + reportingRoSbx.getUrlParts().getDatabase());

        adminReportingJdbcTemplate.getJdbcOperations()
                .execute("DROP DATABASE IF EXISTS " + migrateRwSbx.getUrlParts().getDatabase());

        if (jdbcMultitenantDatabaseAdmin.isDatabaseUserExists(reportingRoSbx.getUsername(), RdwDatabaseType.REPORTING)) {
            adminReportingJdbcTemplate.getJdbcOperations()
                    .execute("DROP USER " + reportingRoSbx.getUsername());
        }

        adminWarehouseJdbcTemplate.getJdbcOperations()
                .execute("DROP DATABASE IF EXISTS " + warehouseRoSbx.getUrlParts().getDatabase());

        if (jdbcMultitenantDatabaseAdmin.isDatabaseUserExists(warehouseRoSbx.getUsername(), RdwDatabaseType.WAREHOUSE)) {
            adminWarehouseJdbcTemplate.getJdbcOperations()
                    .execute("DROP USER " + warehouseRoSbx.getUsername());
        }

    }

    private DataSourceElementsTenant generateDataSourceElementsTenant(String username,
                                                                      String password,
                                                                      String schemaSearchPath,
                                                                      String databaseName) {
        DataSourceElementsTenant dataSourceElementsTenant = new DataSourceElementsTenant();
        dataSourceElementsTenant.setUsername(username);
        dataSourceElementsTenant.setPassword(password);
        dataSourceElementsTenant.setSchemaSearchPath(schemaSearchPath);
        DataSourceUrlParts dataSourceUrlParts = new DataSourceUrlParts();
        dataSourceUrlParts.setDatabase(databaseName);
        dataSourceElementsTenant.setUrlParts(dataSourceUrlParts);
        return dataSourceElementsTenant;
    }


    @Test
    public void createSandboxDatabases() {
        tenantDatabaseCreationService.createSandboxDatabases(sbxTenantConfiguration);
    }

}
