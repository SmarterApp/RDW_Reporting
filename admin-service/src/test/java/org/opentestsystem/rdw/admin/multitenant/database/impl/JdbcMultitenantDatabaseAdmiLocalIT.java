package org.opentestsystem.rdw.admin.multitenant.database.impl;

import org.apache.commons.lang3.RandomStringUtils;
import org.junit.Before;
import org.junit.Ignore;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.admin.repository.RepositoryIT;
import org.opentestsystem.rdw.schema.SchemaMigration;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.test.annotation.IfProfileValue;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.jdbc.SqlConfig;
import org.springframework.test.context.junit4.SpringRunner;

import javax.sql.DataSource;
import java.sql.Array;
import java.util.Arrays;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.schema.SchemaMigration.Migration;

/**
 * This test will only run locally, and requires dataset files in file://tmp/sandbox-datasets
 *
 */
@RunWith(SpringRunner.class)
@IfProfileValue(name = "archive.uri-root", value = "file://tmp/")
@RepositoryIT
@ContextConfiguration(classes = {
        JdbcMultitenantDatabaseAdmin.class
})
public class JdbcMultitenantDatabaseAdmiLocalIT {

    private final String targetDatabase = "sandbox_it_warehouse_test";
    private final String importDatabase = "warehouse";
    private final String datasetName = "demo-dataset";
    private final String createTargetDatabase = targetDatabase + "_create_test";
    private final String createDatabaseUserUsername = "it_creat_u_test";

    @Autowired
    private JdbcMultitenantDatabaseAdmin jdbcMultitenantDatabaseAdmin;

    @Autowired
    @Qualifier("adminReportingDataSource")
    private DataSource adminReportingDataSource;

    @Autowired
    @Qualifier("adminWarehouseDataSource")
    private DataSource adminWarehouseDataSource;

    @Autowired
    @Qualifier("adminReportingJdbcTemplate")
    private NamedParameterJdbcTemplate adminReportingJdbcTemplate;

    @Autowired
    @Qualifier("adminWarehouseJdbcTemplate")
    private NamedParameterJdbcTemplate adminWarehouseJdbcTemplate;

    @Autowired
    @Qualifier("adminOlapJdbcTemplate")
    private NamedParameterJdbcTemplate adminOlapJdbcTemplate;


    private SchemaMigration warehouseMigration;

    @Before
    public void setUp() {
        warehouseMigration = new SchemaMigration(adminReportingDataSource, targetDatabase, Migration.Warehouse);
    }

    @Test
    public void testLoad() throws Exception {
        warehouseMigration.clean();
        warehouseMigration.migrate();
        assertThat(jdbcMultitenantDatabaseAdmin.isDatabaseEmpty(targetDatabase, importDatabase, RdwDatabaseType.WAREHOUSE)).isTrue();
        jdbcMultitenantDatabaseAdmin.loadDataset(targetDatabase, datasetName, importDatabase, RdwDatabaseType.WAREHOUSE);
        assertThat(jdbcMultitenantDatabaseAdmin.isDatabaseEmpty(targetDatabase, importDatabase, RdwDatabaseType.WAREHOUSE)).isFalse();
    }

    @Test
    public void manifestShouldLoadFromS3() {
        List<String> tables = jdbcMultitenantDatabaseAdmin.manifest(datasetName, importDatabase);
        assertThat(tables.size()).isGreaterThan(0);
        assertThat(tables.stream().filter(f -> f.contains("exam.txt")).findFirst())
                .isNotEmpty();
    }

    @Test
    public void isDatabaseExistsShouldReturnValidResult() {
        boolean isReporting = jdbcMultitenantDatabaseAdmin.isDatabaseExists("reporting", RdwDatabaseType.REPORTING);
        assertThat(isReporting).isTrue();
        boolean isFoo = jdbcMultitenantDatabaseAdmin.isDatabaseExists("foo", RdwDatabaseType.REPORTING);
        assertThat(isFoo).isFalse();
    }


    @Test
    @Sql(statements = "DROP DATABASE IF EXISTS " + createTargetDatabase,
            config = @SqlConfig(dataSource = "adminWarehouseDataSource"))
    public void createDatabaseShouldCreateADatabase() {
        jdbcMultitenantDatabaseAdmin.createDatabase(createTargetDatabase, RdwDatabaseType.WAREHOUSE);
        boolean isWarehouseCreateTest = jdbcMultitenantDatabaseAdmin.isDatabaseExists(createTargetDatabase, RdwDatabaseType.WAREHOUSE);
        assertThat(isWarehouseCreateTest).isTrue();
    }

    @Test
    public void isDatabaseUserExistsShouldBeValid() {
        assertThat(jdbcMultitenantDatabaseAdmin.isDatabaseUserExists("root", RdwDatabaseType.WAREHOUSE)).isTrue();
        assertThat(jdbcMultitenantDatabaseAdmin.isDatabaseUserExists("foo", RdwDatabaseType.WAREHOUSE)).isFalse();
    }

    @Test
    @Sql(statements = {"GRANT USAGE ON *.* TO " + createDatabaseUserUsername + "@'%' IDENTIFIED BY 'verytmppwd1'",
            "DROP USER " + createDatabaseUserUsername},
            config = @SqlConfig(dataSource = "adminWarehouseDataSource"))
    public void createDatabaseUserShouldCreateADatabaseUser() {
        jdbcMultitenantDatabaseAdmin.createDatabaseUser(createDatabaseUserUsername,
                RandomStringUtils.random(8, true, true), RdwDatabaseType.WAREHOUSE);
        assertThat(jdbcMultitenantDatabaseAdmin.isDatabaseUserExists(createDatabaseUserUsername, RdwDatabaseType.WAREHOUSE)).isTrue();
    }

    @Test
    @Sql(statements = {"DROP DATABASE IF EXISTS " + createTargetDatabase,
            "GRANT USAGE ON *.* TO " + createDatabaseUserUsername + "@'%' IDENTIFIED BY 'verytmppwd1'",
            "DROP USER " + createDatabaseUserUsername},
            config = @SqlConfig(dataSource = "adminWarehouseDataSource"))
    public void grantsShouldBeAppliedToUser() {
        jdbcMultitenantDatabaseAdmin.createDatabase(createTargetDatabase, RdwDatabaseType.WAREHOUSE);
        jdbcMultitenantDatabaseAdmin.createDatabaseUser(createDatabaseUserUsername,
                RandomStringUtils.random(8, true, true), RdwDatabaseType.WAREHOUSE);

        jdbcMultitenantDatabaseAdmin.grantBasicPermissions(
                createDatabaseUserUsername, createTargetDatabase, RdwDatabaseType.WAREHOUSE);

        List<String> grants = adminWarehouseJdbcTemplate.queryForList("SHOW GRANTS FOR :username",
                new MapSqlParameterSource()
                        .addValue("username", createDatabaseUserUsername),
                String.class);

        assertThat(grants.stream()
                .filter(g -> g.contains(createTargetDatabase)).findFirst())
                .isNotEmpty();

        assertThat(grants.stream()
                .filter(g -> g.contains("`mysql`.`proc`")).findFirst())
                .isNotEmpty();

        assertThat(grants.stream()
                .filter(g -> g.contains("FILE ON *")).findFirst())
                .isNotEmpty();
    }

    private String createRandomPassword() {
        final String letters = RandomStringUtils.random(1, true, false).toUpperCase() +
                RandomStringUtils.random(5, true, false).toLowerCase();
        final String numbers = RandomStringUtils.random(2, false, true);
        return letters + numbers;
    }
}
