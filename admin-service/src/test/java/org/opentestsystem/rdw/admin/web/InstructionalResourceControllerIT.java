package org.opentestsystem.rdw.admin.web;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMap;
import com.google.common.collect.ImmutableSet;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Captor;
import org.opentestsystem.rdw.admin.model.InstructionalResource;
import org.opentestsystem.rdw.admin.service.InstructionalResourceService;
import org.opentestsystem.rdw.common.model.AssessmentType;
import org.opentestsystem.rdw.reporting.common.model.OrganizationType;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.Permission;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.servlet.MockMvc;

import java.net.URL;

import static org.assertj.core.api.Assertions.assertThat;
import static org.hamcrest.Matchers.hasSize;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;
import static org.opentestsystem.rdw.admin.security.AdminPermission.InstructionalResourceWrite;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.statewide;
import static org.springframework.security.test.web.servlet.request.SecurityMockMvcRequestPostProcessors.user;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@RunWith(SpringRunner.class)
@WebMvcTest(InstructionalResourceController.class)
public class InstructionalResourceControllerIT {

    private final User user = User.builder()
            .id("user")
            .username("username")
            .password("password")
            .authorities(ImmutableSet.of(new SimpleGrantedAuthority("ROLE_USER")))
            .permissionsById(
                    ImmutableMap.of(
                            InstructionalResourceWrite, new Permission(InstructionalResourceWrite, statewide())
                    )
            )
            .build();

    @Autowired
    private MockMvc mvc;

    @Autowired
    private ObjectMapper objectMapper;

    @MockBean
    private InstructionalResourceService service;

    @Captor
    private ArgumentCaptor<InstructionalResource> resourceCaptor;

    @Test
    public void itShouldRetrieveInstructionalResources() throws Exception {
        final InstructionalResource resourceA = instructionalResource("A");
        final InstructionalResource resourceB = instructionalResource("B");
        when(service.findAll(any(User.class))).thenReturn(ImmutableList.of(
                resourceA,
                resourceB
        ));

        mvc.perform(get("/instructional-resources")
                .with(user(user)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.*", hasSize(2)))
                .andExpect(jsonPath("$[0].assessmentName").value(resourceA.getAssessmentName()))
                .andExpect(jsonPath("$[0].assessmentLabel").value(resourceA.getAssessmentLabel()))
                .andExpect(jsonPath("$[0].assessmentTypeCode").value(resourceA.getAssessmentTypeCode()))
                .andExpect(jsonPath("$[0].organizationId").value(resourceA.getOrganizationId()))
                .andExpect(jsonPath("$[0].organizationName").value(resourceA.getOrganizationName()))
                .andExpect(jsonPath("$[0].organizationType").value(resourceA.getOrganizationType().name()))
                .andExpect(jsonPath("$[0].performanceLevel").value(resourceA.getPerformanceLevel()))
                .andExpect(jsonPath("$[0].resource").value(resourceA.getResource().toString()))
                .andExpect(jsonPath("$[1].assessmentName").value(resourceB.getAssessmentName()));
    }

    @Test
    public void itShouldReturnAnEmptyArrayForNoResults() throws Exception {
        when(service.findAll(any(User.class))).thenReturn(ImmutableList.of());

        mvc.perform(get("/instructional-resources")
                .with(user(user)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.*", hasSize(0)));
    }

    @Test
    public void itShouldCreateAnInstructionalResource() throws Exception {
        when(service.create(any(User.class), any(InstructionalResource.class)))
                .thenAnswer(invocation -> invocation.getArgument(1));

        final InstructionalResource resource = instructionalResource("A");

        mvc.perform(post("/instructional-resources")
                .with(user(user))
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(resource)))
                .andExpect(status().isCreated())
                .andExpect(jsonPath("$.assessmentName").value(resource.getAssessmentName()))
                .andExpect(jsonPath("$.assessmentLabel").value(resource.getAssessmentLabel()))
                .andExpect(jsonPath("$.assessmentTypeCode").value(resource.getAssessmentTypeCode()))
                .andExpect(jsonPath("$.organizationId").value(resource.getOrganizationId()))
                .andExpect(jsonPath("$.organizationName").value(resource.getOrganizationName()))
                .andExpect(jsonPath("$.organizationType").value(resource.getOrganizationType().name()))
                .andExpect(jsonPath("$.performanceLevel").value(resource.getPerformanceLevel()))
                .andExpect(jsonPath("$.resource").value(resource.getResource().toString()));
    }

    @Test
    public void itShouldUpdateAnInstructionalResource() throws Exception {
        when(service.update(any(User.class), any(InstructionalResource.class)))
                .thenAnswer(invocation -> invocation.getArgument(1));

        final InstructionalResource resource = instructionalResource("A");

        mvc.perform(put("/instructional-resources")
                .with(user(user))
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(resource)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.assessmentName").value(resource.getAssessmentName()))
                .andExpect(jsonPath("$.assessmentLabel").value(resource.getAssessmentLabel()))
                .andExpect(jsonPath("$.assessmentTypeCode").value(resource.getAssessmentTypeCode()))
                .andExpect(jsonPath("$.organizationId").value(resource.getOrganizationId()))
                .andExpect(jsonPath("$.organizationName").value(resource.getOrganizationName()))
                .andExpect(jsonPath("$.organizationType").value(resource.getOrganizationType().name()))
                .andExpect(jsonPath("$.performanceLevel").value(resource.getPerformanceLevel()))
                .andExpect(jsonPath("$.resource").value(resource.getResource().toString()));
    }

    @Test
    public void itShouldDeleteAnInstructionalResource() throws Exception {
        mvc.perform(delete("/instructional-resources?assessmentName=AssessmentA&organizationId=234&organizationType=District&performanceLevel=1")
                .with(user(user)))
                .andExpect(status().isNoContent());

        verify(service).delete(any(User.class), resourceCaptor.capture());
        final InstructionalResource deleted = resourceCaptor.getValue();
        assertThat(deleted.getAssessmentName()).isEqualTo("AssessmentA");
        assertThat(deleted.getOrganizationId()).isEqualTo(234);
        assertThat(deleted.getOrganizationType()).isEqualTo(OrganizationType.District);
        assertThat(deleted.getPerformanceLevel()).isEqualTo(1);
    }

    @Test
    public void itShouldDeleteAnInstructionalResourceWithoutAnOrganizationId() throws Exception {
        mvc.perform(delete("/instructional-resources?assessmentName=AssessmentA&organizationType=State&performanceLevel=1")
                .with(user(user)))
                .andExpect(status().isNoContent());

        verify(service).delete(any(User.class), resourceCaptor.capture());
        final InstructionalResource deleted = resourceCaptor.getValue();
        assertThat(deleted.getAssessmentName()).isEqualTo("AssessmentA");
        assertThat(deleted.getOrganizationType()).isEqualTo(OrganizationType.State);
        assertThat(deleted.getPerformanceLevel()).isEqualTo(1);
        assertThat(deleted.getOrganizationId()).isNull();
    }

    private InstructionalResource instructionalResource(final String id) throws Exception {
        return InstructionalResource.builder()
                .assessmentName("Assessment " + id)
                .assessmentLabel("Assessment Label " + id)
                .assessmentType(AssessmentType.IAB)
                .organizationId(234)
                .organizationName("Organization " + id)
                .organizationType(OrganizationType.District)
                .performanceLevel(0)
                .resource(new URL("http://somewhere-" + id))
                .build();
    }
}