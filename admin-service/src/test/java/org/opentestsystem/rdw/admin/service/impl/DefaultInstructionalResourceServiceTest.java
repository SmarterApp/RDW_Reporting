package org.opentestsystem.rdw.admin.service.impl;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Captor;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.opentestsystem.rdw.admin.model.InstructionalResource;
import org.opentestsystem.rdw.admin.repository.InstructionalResourceRepository;
import org.opentestsystem.rdw.reporting.common.configuration.ReportingSystemSettings;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.OrganizationType;
import org.opentestsystem.rdw.reporting.common.repository.OrganizationRepository;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;

import java.net.URL;
import java.util.Collections;
import java.util.List;
import java.util.NoSuchElementException;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.any;
import static org.mockito.Mockito.anyInt;
import static org.mockito.Mockito.eq;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.never;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.verifyZeroInteractions;
import static org.mockito.Mockito.when;
import static org.opentestsystem.rdw.admin.security.AdminPermission.InstructionalResourceWrite;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.District;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.DistrictGroup;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.School;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.SchoolGroup;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.State;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.districts;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.permissions;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.statewide;

@RunWith(MockitoJUnitRunner.class)
public class DefaultInstructionalResourceServiceTest {

    @Mock
    private OrganizationRepository organizationRepository;

    @Mock
    private InstructionalResourceRepository repository;

    @Captor
    private ArgumentCaptor<InstructionalResource> resourceCaptor;

    private InstructionalResource districtResource;
    private InstructionalResource stateResource;
    private InstructionalResource stateResourceWithName;
    private User user;
    private DefaultInstructionalResourceService service;

    @Before
    public void setup() throws Exception {
        final ReportingSystemSettings systemSettings = new ReportingSystemSettings();
        systemSettings.getState().setName("State Name");

        districtResource = InstructionalResource.builder()
                .assessmentName("Assesssment A")
                .performanceLevel(0)
                .organizationType(District)
                .organizationId(2)
                .resource(new URL("http://some-resource/"))
                .build();

        stateResource = InstructionalResource.builder()
                .assessmentName("Assessment A")
                .performanceLevel(0)
                .organizationType(State)
                .resource(new URL("http://some-state-resource/"))
                .build();

        stateResourceWithName = InstructionalResource.builder()
                .assessmentName("Assessment A")
                .performanceLevel(0)
                .organizationType(State)
                .organizationName(systemSettings.getState().getName())
                .resource(new URL("http://some-state-resource/"))
                .build();

        user = User.builderExt()
                .id("aUser")
                .username("user")
                .password("pass")
                .permissionsById(permissions(new Permission(InstructionalResourceWrite, statewide())))
                .build();

        when(organizationRepository.findOneByTypeAndId(any(PermissionScope.class), any(OrganizationType.class), anyInt()))
                .thenReturn(mock(Organization.class));

        service = new DefaultInstructionalResourceService(repository, organizationRepository, systemSettings);
    }

    @Test
    public void itShouldCreateAResource() {
        when(repository.findOne(eq(statewide()), eq(districtResource)))
                .thenReturn(districtResource);

        final InstructionalResource response = service.create(user, districtResource);
        assertThat(response).isEqualToComparingFieldByFieldRecursively(districtResource);

        verify(repository).create(eq(districtResource));
        verify(organizationRepository).findOneByTypeAndId(eq(statewide()), eq(District), eq(districtResource.getOrganizationId()));
    }

    @Test
    public void itShouldCreateAStateResource() {
        when(repository.findOne(eq(statewide()), eq(stateResource)))
                .thenReturn(stateResource);

        final InstructionalResource response = service.create(user, stateResource);
        assertThat(response).isEqualToComparingFieldByFieldRecursively(stateResourceWithName);

        verify(repository).create(eq(stateResource));
        verifyZeroInteractions(organizationRepository);
    }

    @Test(expected = NoSuchElementException.class)
    public void itShouldNotCreateAResourceIfOrganizationIsNotFound() {
        when(organizationRepository.findOneByTypeAndId(any(PermissionScope.class), any(OrganizationType.class), anyInt()))
                .thenReturn(null);

        service.create(user, districtResource);
    }

    @Test(expected = NoSuchElementException.class)
    public void itShouldNotCreateAStateResourceIfUserDoesNotHaveStatePermissions() {
        user = User.builderExt()
                .id("aUser")
                .username("user")
                .password("pass")
                .permissionsById(permissions(new Permission(InstructionalResourceWrite, districts(1L))))
                .build();

        service.create(user, stateResource);
    }

    @Test
    public void itShouldUpdateAResource() throws Exception {
        final InstructionalResource updated = InstructionalResource.builder()
                .copy(districtResource)
                .resource(new URL("http://updated-resource/"))
                .build();

        when(repository.findOne(eq(statewide()), eq(updated)))
                .thenReturn(districtResource);

        assertThat(service.update(user, updated))
                .isEqualToComparingFieldByFieldRecursively(updated);

        verify(repository).update(resourceCaptor.capture());
        assertThat(resourceCaptor.getValue())
                .isEqualToComparingFieldByFieldRecursively(updated);
    }

    @Test
    public void itShouldDeleteAResource() {
        when(repository.findOne(any(PermissionScope.class), eq(districtResource))).thenReturn(districtResource);
        service.delete(user, districtResource);
        verify(repository).findOne(eq(statewide()), eq(districtResource));
        verify(repository).delete(districtResource);
    }

    @Test
    public void itShouldNotDeleteAResourceThatIsNotFound() {
        service.delete(user, districtResource);
        verify(repository).findOne(eq(statewide()), eq(districtResource));
        verify(repository, never()).delete(districtResource);
    }

    @Test
    public void itShouldOrderFoundResources() {
        final List<InstructionalResource> orderedResources = newArrayList();
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(State).performanceLevel(0).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(State).performanceLevel(1).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(State).performanceLevel(2).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(State).performanceLevel(3).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(DistrictGroup).organizationName("District Group A").performanceLevel(0).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(DistrictGroup).organizationName("District Group B").performanceLevel(0).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(District).organizationName("District A").performanceLevel(0).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(District).organizationName("District B").performanceLevel(0).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(SchoolGroup).organizationName("School Group A").performanceLevel(0).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(SchoolGroup).organizationName("School Group B").performanceLevel(0).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(School).organizationName("School A").performanceLevel(0).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment A").organizationType(School).organizationName("School B").performanceLevel(0).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment B").organizationType(State).performanceLevel(0).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment B").organizationType(State).performanceLevel(1).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment B").organizationType(State).performanceLevel(2).build());
        orderedResources.add(InstructionalResource.builder().assessmentName("Assessment B").organizationType(State).performanceLevel(3).build());

        final List<InstructionalResource> randomizedResources = newArrayList(orderedResources);
        Collections.shuffle(randomizedResources);

        when(repository.findAll(eq(statewide()))).thenReturn(randomizedResources);

        assertThat(service.findAll(user))
                .usingRecursiveFieldByFieldElementComparator()
                .containsExactlyElementsOf(service.setStateName(orderedResources));
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldNotValidateANullObject() throws Exception {
        service.create(user, null);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldNotValidateABlankAssessmentName() throws Exception {
        final InstructionalResource badResource = InstructionalResource.builder()
                .copy(districtResource)
                .assessmentName(" ")
                .build();
        service.create(user, badResource);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldNotValidateANullOrganizationType() throws Exception {
        final InstructionalResource badResource = InstructionalResource.builder()
                .copy(districtResource)
                .organizationType(null)
                .build();
        service.create(user, badResource);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldNotValidateAnInvalidOrganizationType() throws Exception {
        final InstructionalResource badResource = InstructionalResource.builder()
                .copy(districtResource)
                .organizationType(School)
                .build();
        service.create(user, badResource);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldNotValidateANullResourceUrl() throws Exception {
        final InstructionalResource badResource = InstructionalResource.builder()
                .copy(districtResource)
                .resource(null)
                .build();
        service.create(user, badResource);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldNotValidateAnInvalidResourceUrl() throws Exception {
        final InstructionalResource badResource = InstructionalResource.builder()
                .copy(districtResource)
                .resource(new URL("http://(@(&$&()@#*$)*@#)$*@#$"))
                .build();
        service.create(user, badResource);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldNotValidateANegativePerformanceLevel() throws Exception {
        final InstructionalResource badResource = InstructionalResource.builder()
                .copy(districtResource)
                .performanceLevel(-1)
                .build();
        service.create(user, badResource);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldValidateOnUpdate() throws Exception {
        final InstructionalResource badResource = InstructionalResource.builder()
                .copy(districtResource)
                .resource(new URL("http://(@(&$&()@#*$)*@#)$*@#$"))
                .build();
        service.update(user, badResource);
    }

}
