package org.opentestsystem.rdw.admin.service.impl;

import org.apache.commons.io.IOUtils;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;

import java.io.IOException;
import org.opentestsystem.rdw.admin.model.Pipeline;
import org.opentestsystem.rdw.admin.model.PipelineScript;
import org.opentestsystem.rdw.admin.repository.PipelineRepository;
import org.opentestsystem.rdw.admin.repository.PipelineScriptRepository;
import org.opentestsystem.rdw.script.PipelineDefinition;
import org.opentestsystem.rdw.script.PipelineScriptDefinition;
import org.opentestsystem.rdw.script.PipelineScriptType;
import org.opentestsystem.rdw.script.publishing.PublishedPipelineRepository;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.when;

@RunWith(MockitoJUnitRunner.class)
public class DefaultPipelineScriptServiceTest {

    @Mock
    private PipelineScriptRepository scriptRepository;

    @Mock
    private PipelineRepository pipelineRepository;

    @Mock
    private PublishedPipelineRepository publishedPipelineRepository;

    private DefaultPipelineScriptService service;

    private static final PipelineScript script = PipelineScript.builder()
            .pipelineId(1)
            .id(2)
            .body("body")
            .updatedBy("updater")
            .build();

    @Before
    public void before() {
        this.service = new DefaultPipelineScriptService(
                scriptRepository,
                pipelineRepository,
                publishedPipelineRepository
        );
    }

    @Test
    public void getShouldReturnTheSavedScriptIfPresent() {
        when(scriptRepository.findById(script.getId()))
                .thenReturn(script);

        assertThat(service.get(script.getPipelineId(), script.getId()))
                .isEqualToComparingFieldByFieldRecursively(script);
    }

    @Test
    public void getShouldReturnThePipelineDefinitionsScriptIfPresent() {

        final Pipeline pipeline = Pipeline.builder()
                .id(1)
                .code("code")
                .inputType("xml")
                .activeVersion("3")
                .build();

        final PipelineScriptDefinition publishedScript = PipelineScriptDefinition.builder()
                .type(PipelineScriptType.User)
                .version("3")
                .body(script.getBody())
                .build();

        final PipelineDefinition published = PipelineDefinition.builder()
                .pipelineCode("code")
                .version("3")
                .publishedBy("updater")
                .scripts(newArrayList(
                        publishedScript
                ))
                .build();

        when(scriptRepository.findById(script.getId()))
                .thenReturn(null);

        when(pipelineRepository.findById(pipeline.getId()))
                .thenReturn(pipeline);

        when(publishedPipelineRepository.findByCodeAndVersion(pipeline.getCode(), pipeline.getActiveVersion()))
                .thenReturn(published);

        assertThat(service.get(script.getPipelineId(), script.getId()))
                .isEqualToComparingFieldByFieldRecursively(
                        PipelineScript.builder()
                                .pipelineId(pipeline.getId())
                                .created(published.getPublished())
                                .updated(published.getPublished())
                                .updatedBy(published.getPublishedBy())
                                .body(publishedScript.getBody())
                                .build()
                );
    }

    @Test
    public void getShouldFallbackOnSampleScript() throws IOException {
        getShouldFallbackOnSampleScriptOfType(
                "xml", resourceAsString("pipeline-script-samples/xml.groovy"));
        getShouldFallbackOnSampleScriptOfType(
                "csv", resourceAsString("pipeline-script-samples/csv.groovy"));
    }

    @Test
    public void getShouldFallbackToEmptyScriptWhenSampleOfInputTypeIsAbsent() {
        getShouldFallbackOnSampleScriptOfType("unknown", "");
    }

    private String resourceAsString(final String path) throws IOException {
        return IOUtils.toString(
                getClass().getClassLoader().getResourceAsStream(path),
                "UTF-8"
        );
    }

    private void getShouldFallbackOnSampleScriptOfType(final String inputType, final String body) {
        final Pipeline pipeline = Pipeline.builder()
                .id(2)
                .code("code")
                .inputType(inputType)
                .build();

        when(pipelineRepository.findById(pipeline.getId()))
                .thenReturn(pipeline);

        assertThat(service.get(pipeline.getId(), script.getId()))
                .isNotNull()
                .isEqualToComparingFieldByFieldRecursively(
                        PipelineScript.builder()
                                .pipelineId(pipeline.getId())
                                .body(body)
                                .updatedBy("System")
                                .build()
                );
    }

}
