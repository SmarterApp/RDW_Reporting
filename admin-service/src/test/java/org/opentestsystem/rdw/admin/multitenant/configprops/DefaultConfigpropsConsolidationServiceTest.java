package org.opentestsystem.rdw.admin.multitenant.configprops;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.Before;
import org.junit.Test;

import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

public class DefaultConfigpropsConsolidationServiceTest {


    private TestFileBasedConfigpropsClient configpropsClient;
    private ObjectMapper objectMapper;
    private DefaultConfigpropsConsolidationService defaultConfigpropsService;

    @Before
    public void setUp() throws Exception {
        configpropsClient = new TestFileBasedConfigpropsClient();

        objectMapper = new ObjectMapper();
        defaultConfigpropsService = new DefaultConfigpropsConsolidationService(objectMapper, configpropsClient);
    }

    @Test
    public void extractPrefixPropertiesForAdmin() throws Exception {
        String json = configpropsClient.getRawServiceConfigurations().get("admin-service");
        Map<String, JsonNode> map = defaultConfigpropsService.extractPrefixProperties(json);
        assertThat(map.size()).isGreaterThan(0);
        assertThat(map).containsKey("datasources.reporting_ro");
        assertThat(map).containsKey("datasources.warehouse_rw");
        assertThat(map).containsKey("archive");
        assertThat(map).containsKey("reporting");
        assertThat(map).containsKey("tenantProperties");
    }

    @Test
    public void extractServicePrefixPropertiesForAll() throws Exception {
        Map<String, Map<String, JsonNode>> result = defaultConfigpropsService.extractServicePrefixProperties();
        assertThat(result.size()).isGreaterThan(0);
        assertThat(result).containsKey("admin-service");
        assertThat(result.get("admin-service")).containsKey("archive");
        assertThat(result).containsKey("aggregate-service");
        assertThat(result.get("aggregate-service")).containsKey("datasources.olap_ro");
        assertThat(result).containsKey("report-processor");
        assertThat(result).containsKey("reporting-service");
        assertThat(result).containsKey("reporting-webapp");
    }
}