package org.opentestsystem.rdw.admin.web;

import com.google.common.collect.ImmutableList;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.admin.configuration.multitenant.ConfigurationProperties;
import org.opentestsystem.rdw.admin.configuration.multitenant.TenantConfiguration;
import org.opentestsystem.rdw.admin.service.TenantService;
import org.opentestsystem.rdw.multitenant.TenantProperties;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.servlet.MockMvc;

import static org.mockito.Mockito.when;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;

@RunWith(SpringRunner.class)
@WebMvcTest(controllers = {TenantController.class}, secure = false)
public class TenantControllerTest {
    @Autowired
    private MockMvc mvc;

    @MockBean
    private TenantService service;

    private static final TenantConfiguration tenantConfiguration = TenantConfiguration.builder()
            .configurationProperties(createTestConfigurationProperties(), createTestTeantProperties()).build();

    @Test
    public void getAllTenantsShouldReturnResults()  throws Exception  {
        when(service.getAll()).thenReturn(ImmutableList.of(
                createTestTenantFromJson(tenantJson),
                createTestTenantFromJson(tenantJson1)));

        mvc.perform(
                get("/tenants/getall")
                .contentType(MediaType.APPLICATION_JSON)
                .accept(MediaType.APPLICATION_JSON))
                .andExpect(status().isOk());
    }

    @Test
    public void createTenantShouldReturnOK() throws Exception {

        when(service.createTenant(tenantConfiguration.getTenantOverride())).thenReturn(tenantConfiguration);
        String tenantId = tenantConfiguration.getTenant().getId();
        mvc.perform( post("/tenants/create")
                .contentType(MediaType.APPLICATION_JSON).content(tenantJson1))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$tenant.id").value(tenantId));

    }

    @Test
    public void createTenantShouldThrowException() throws Exception {

        when(service.createTenant(tenantConfiguration.getTenantOverride())).thenThrow(new IllegalArgumentException());

        mvc.perform( post("/tenants/create")
                .contentType(MediaType.APPLICATION_JSON).content(tenantJson1))
                .andExpect(status().isBadRequest());
    }


   // @Test
    public void deleteTenant() throws Exception{
        //when(service.deleteTenant(tenantConfiguration.getTenantIdFromServiceProperties())).;

        mvc.perform( delete("/tenants/delete")
                .contentType(MediaType.APPLICATION_JSON).content(tenantConfiguration.getTenant().getId()))
                .andExpect(status().isOk());
    }

    @Test
    public void saveTenant() throws Exception {
        when(service.updateTenant(tenantConfiguration.getTenantOverride())).thenReturn(tenantConfiguration);

        mvc.perform( put("/tenants/save")
                .contentType(MediaType.APPLICATION_JSON).content(tenantJson1))
                .andExpect(status().isOk());
    }

    private static ConfigurationProperties createTestConfigurationProperties() {
        return  getTestConfigurationProperties(tenantJsonFull);
    }

    private static TenantProperties.Tenant  createTestTeantProperties() {
        return  getTestTenantProperties(tenantJsonFull);
    }

    private static TenantConfiguration createTestTenantFromJson(String tenantJson) {
        return getTestTenantConfiguration(tenantJson);
    }

    private static ConfigurationProperties getTestConfigurationProperties(String testServices) {
        Gson gson = new GsonBuilder().create();
        return gson.fromJson(testServices, ConfigurationProperties.class);
    }


    private static TenantConfiguration getTestTenantConfiguration(String testServices) {
        Gson gson = new GsonBuilder().create();
        return gson.fromJson(testServices, TenantConfiguration.class);
    }

    private static TenantProperties.Tenant getTestTenantProperties(String testServices) {
        Gson gson = new GsonBuilder().create();
        return gson.fromJson(testServices, TenantProperties.Tenant.class);
    }

    private String tenantJson = "{" +
            "     \"tenant\": {" +
            "        \"id\": \"NV\"," +
            "        \"key\": \"NV\"," +
            "        \"displayName\": \"Nevada\"," +
            "        \"description\": \"This is a Nevada's Tenant\"" +
            "      },"+
            "   \"configurationProperties\":{ " +
            "      \"datasources\":{ " +
            "         \"reporting_ro\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\", " +
            "            \"initialSize\":\"1\", " +
            "            \"maxActive\":\"2\" " +
            "         } " +
            "      }," +
            "      \"reporting\":{ " +
            "         \"school-year\":\"2018\", " +
            "         \"transfer-access-enabled\":\"true\", " +
            "         \"translation-location\":\"binary-\", " +
            "      }" +
            "   }," +
            "   \"tenantOverrides\":{ " +
            "      \"tenant\":{ " +
            "         \"id\":\"CA\", " +
            "         \"key\":\"CA\", " +
            "         \"name\":\"California\", " +
            "         \"description\":\"Updated description\" " +
            "      }, " +
            "      \"configurationProperties\":{ " +
            "         \"datasources\":{ " +
            "            \"reporting_ro\":{ " +
            "               \"maxActive\":\"3\" " +
            "            } " +
            "         } " +
            "      }," +
            "      \"reporting\":{ " +
            "         \"transfer-access-enabled\":\"false\", " +
            "         \"student-fields\":{ " +
            "            \"EconomicDisadvantage\":\"enabled\" " +
            "         }, " +
            "      }" +
            "   }" +
            "}";

    private String tenantJson1 = "{ " +
            "   \"tenant\":{ " +
            "      \"id\":\"CA\", " +
            "      \"key\":\"CA\", " +
            "      \"name\":\"California\", " +
            "      \"description\":\"This is a description\" " +
            "   }, " +
            "   \"configurationProperties\":{ " +
            "      \"datasources\":{ " +
            "         \"reporting_ro\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\", " +
            "            \"initialSize\":\"1\", " +
            "            \"maxActive\":\"2\" " +
            "         }, " +
            "         \"warehouse_rw\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\" " +
            "            \"initialSize\":\"1\",, " +
            "            \"maxActive\":\"2\" " +
            "         }, " +
            "         \"olap_ro\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\", " +
            "            \"initialSize\":\"1\", " +
            "            \"maxActive\":\"2\" " +
            "         }, " +
            "         \"reporting_rw\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\", " +
            "            \"initialSize\":\"1\", " +
            "            \"maxActive\":\"2\" " +
            "         } " +
            "      }, " +
            "      \"reporting\":{ " +
            "         \"school-year\":\"2018\", " +
            "         \"transfer-access-enabled\":\"true\", " +
            "         \"translation-location\":\"binary-\", " +
            "         \"analytics-tracking-id\":\"UA-102446884-4\", " +
            "         \"interpretive-guide-url\":\"https://portal.smarterbalanced.org/library/en/reporting-system-interpretive-guide.pdf\", " +
            "         \"user-guide-url\":\"https://portal.smarterbalanced.org/library/en/reporting-system-user-guide.pdf\", " +
            "         \"access-denied-url\":\"forward:/assets/public/access-denied.html\", " +
            "         \"landing-page-url\":\"forward:/landing.html\", " +
            "         \"percentile-display-enabled\":\"true\", " +
            "         \"report-languages\":\"es\", " +
            "         \"ui-languages\":\"es\", " +
            "         \"student-fields\":{ " +
            "            \"EconomicDisadvantage\":\"disabled\", " +
            "            \"LimitedEnglishProficiency\":\"disabled\", " +
            "            \"MigrantStatus\":\"enabled\", " +
            "            \"EnglishLanguageAcquisitionStatus\":\"enabled\", " +
            "            \"PrimaryLanguage\":\"enabled\", " +
            "            \"Ethnicity\":\"enabled\", " +
            "            \"Gender\":\"admin\", " +
            "            \"IndividualEducationPlan\":\"admin\", " +
            "            \"Section504\":\"admin\" " +
            "         }, " +
            "         \"state\":{ " +
            "            \"code\":\"CA\", " +
            "            \"name\":\"California\" " +
            "         } " +
            "      }, " +
            "      \"task\":{ " +
            "         \"remove-stale-reports\":{ " +
            "            \"cron\":\"0 0 8 * * *\", " +
            "            \"max-report-lifetime-days\":\"30\", " +
            "            \"max-random-minutes\":\"20\" " +
            "         } " +
            "      } " +
            "   }, " +
            "   \"tenantOverrides\":{ " +
            "      \"tenant\":{ " +
            "         \"id\":\"CA\", " +
            "         \"key\":\"CA\", " +
            "         \"name\":\"California\", " +
            "         \"description\":\"This is a description\" " +
            "      }, " +
            "      \"configurationProperties\":{ " +
            "         \"datasources\":{ " +
            "            \"reporting_ro\":{ " +
            "               \"initialSize\":\"1\", " +
            "               \"maxActive\":\"2\" " +
            "            }, " +
            "            \"reporting_rw\":{ " +
            "               \"initialSize\":\"1\", " +
            "               \"maxActive\":\"2\" " +
            "            } " +
            "         }, " +
            "         \"reporting\":{ " +
            "            \"percentile-display-enabled\":\"false\", " +
            "            \"student-fields\":{ " +
            "               \"EconomicDisadvantage\":\"enabled\" " +
            "            }, " +
            "            \"state\":{ " +
            "               \"code\":\"CA\", " +
            "               \"name\":\"California\" " +
            "            } " +
            "         } " +
            "      } " +
            "   } " +
            "}";

    private static String tenantJsonFull = "{" +
            "   \"tenant\":{ " +
            "      \"id\":\"CA\", " +
            "      \"key\":\"CA\", " +
            "      \"name\":\"California\", " +
            "      \"description\":\"This is a description\" " +
            "   }, " +
            "   \"configurationProperties\":{ " +
            "      \"datasources\":{ " +
            "         \"reporting_ro\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\", " +
            "            \"initialSize\":\"1\", " +
            "            \"maxActive\":\"2\" " +
            "         }, " +
            "         \"warehouse_rw\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\" " +
            "            \"initialSize\":\"1\",, " +
            "            \"maxActive\":\"2\" " +
            "         }, " +
            "         \"olap_ro\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\", " +
            "            \"initialSize\":\"1\", " +
            "            \"maxActive\":\"2\" " +
            "         }, " +
            "         \"reporting_rw\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\", " +
            "            \"initialSize\":\"1\", " +
            "            \"maxActive\":\"2\" " +
            "         } " +
            "      }, " +
            "      \"reporting\":{ " +
            "         \"school-year\":\"2018\", " +
            "         \"transfer-access-enabled\":\"true\", " +
            "         \"translation-location\":\"binary-\", " +
            "         \"analytics-tracking-id\":\"UA-102446884-4\", " +
            "         \"interpretive-guide-url\":\"https://portal.smarterbalanced.org/library/en/reporting-system-interpretive-guide.pdf\", " +
            "         \"user-guide-url\":\"https://portal.smarterbalanced.org/library/en/reporting-system-user-guide.pdf\", " +
            "         \"access-denied-url\":\"forward:/assets/public/access-denied.html\", " +
            "         \"landing-page-url\":\"forward:/landing.html\", " +
            "         \"percentile-display-enabled\":\"true\", " +
            "         \"report-languages\":\"es\", " +
            "         \"ui-languages\":\"es\", " +
            "         \"student-fields\":{ " +
            "            \"EconomicDisadvantage\":\"disabled\", " +
            "            \"LimitedEnglishProficiency\":\"disabled\", " +
            "            \"MigrantStatus\":\"enabled\", " +
            "            \"EnglishLanguageAcquisitionStatus\":\"enabled\", " +
            "            \"PrimaryLanguage\":\"enabled\", " +
            "            \"Ethnicity\":\"enabled\", " +
            "            \"Gender\":\"admin\", " +
            "            \"IndividualEducationPlan\":\"admin\", " +
            "            \"Section504\":\"admin\" " +
            "         }, " +
            "         \"state\":{ " +
            "            \"code\":\"CA\", " +
            "            \"name\":\"California\" " +
            "         } " +
            "      }, " +
            "      \"task\":{ " +
            "         \"remove-stale-reports\":{ " +
            "            \"cron\":\"0 0 8 * * *\", " +
            "            \"max-report-lifetime-days\":\"30\", " +
            "            \"max-random-minutes\":\"20\" " +
            "         } " +
            "      } " +
            "   }, " +
            "   \"tenantOverrides\":{ " +
            "      \"tenant\":{ " +
            "         \"id\":\"CA\", " +
            "         \"key\":\"CA\", " +
            "         \"name\":\"California\", " +
            "         \"description\":\"This is a description\" " +
            "      }, " +
            "      \"configurationProperties\":{ " +
            "         \"datasources\":{ " +
            "            \"reporting_ro\":{ " +
            "               \"initialSize\":\"1\", " +
            "               \"maxActive\":\"2\" " +
            "            }, " +
            "            \"reporting_rw\":{ " +
            "               \"initialSize\":\"1\", " +
            "               \"maxActive\":\"2\" " +
            "            } " +
            "         }, " +
            "         \"reporting\":{ " +
            "            \"percentile-display-enabled\":\"false\", " +
            "            \"student-fields\":{ " +
            "               \"EconomicDisadvantage\":\"enabled\" " +
            "            }, " +
            "            \"state\":{ " +
            "               \"code\":\"CA\", " +
            "               \"name\":\"California\" " +
            "            } " +
            "         } " +
            "      } " +
            "   } " +
            "}";
}