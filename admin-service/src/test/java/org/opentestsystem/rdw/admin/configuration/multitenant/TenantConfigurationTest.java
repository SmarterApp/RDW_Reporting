package org.opentestsystem.rdw.admin.configuration.multitenant;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonElement;
import org.junit.Test;
import org.opentestsystem.rdw.multitenant.TenantProperties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;


public class TenantConfigurationTest {
    private static final Logger logger = LoggerFactory.getLogger(TenantConfigurationTest.class);

    @Test
    public void testTenant() {
        logger.info("testTenant");

        TenantProperties.Tenant tenant = getTestTenant(tenantJson);
        assertThat(tenant).isNotNull();
        assertThat(tenant.getId()).isEqualTo("CA");
        assertThat(tenant.getKey()).isEqualTo("CA");
        assertThat(tenant.getName()).isEqualTo("California");
        assertThat(tenant.getDescription()).isEqualTo("This is a California's Tenant.");
    }

    @Test
    public void testTenantOverride() {
        logger.info("testTenantOverride");

        TenantOverride tenantOverride = getTestTenantOverride(tenantCfgPropJson);
        assertThat(tenantOverride).isNotNull();
        TenantProperties.Tenant tenant = tenantOverride.getTenant();
        assertThat(tenant).isNotNull();
        assertThat(tenant.getId()).isEqualTo("NV");
        logger.info("tenant if= {}", tenant.getId());


        logger.info("Now look at configurationProperties ");
        ObjectMapper mapper = new ObjectMapper();

        ConfigurationProperties configurationProperties = tenantOverride.getConfigurationProperties();
        assertThat(configurationProperties).isNotNull();
        Task task = mapper.convertValue(configurationProperties.getTask(), Task.class);
        assertThat(task).isNotNull();
        logger.info("Cfg Prop's Task = ", task.getRemoveStaleReports());

    }

    //@Test
    public void testTenantSrv() {
        logger.info("testTenantSrv");
        ObjectMapper mapper = new ObjectMapper();

        TenantConfiguration tenantConfiguration = getTestTenantConfig(tenantConfigurationJson);
        assertThat(tenantConfiguration).isNotNull();
        logger.info("tenantConfiguration = {}", tenantConfiguration);
        assertThat(tenantConfiguration.getTenant()).isNotNull();
        logger.info("tenantConfiguration.getTenant() = {}", tenantConfiguration.getTenant());
        logger.info("tenantConfiguration.getTenant().getId() = {}", tenantConfiguration.getTenant().getId());
        assertThat(tenantConfiguration.getConfigurationProperties()).isNotNull();
        logger.info("tenantConfiguration.getTenant().getId() = {}", tenantConfiguration.getTenant().getId());


//        ConfigurationProperties configurationProperties = tenantConfiguration.getConfigurationProperties();
//        // use new tenantProperties
//        assertThat(serviceProperties.get("tenant")).isNotNull();
//        Tenant tenant = mapper.convertValue(serviceProperties.get("tenant"), Tenant.class);
//        logger.info("tenant.id={}",tenant.getId());
//        assertThat(tenant.getId()).isEqualTo("CA");
//        assertThat(tenant.getKey()).isEqualTo("CA");
//        assertThat(tenant.getName()).isEqualTo("California");
//        assertThat(tenant.getDescription()).isEqualTo("This is a California's Tenant.");
//        serviceProperties.forEach((k,v) -> {
//            logger.info("services={} and value = {}", k, v);
//            System.out.println("Key : " + k + " Value : " + v);
//
//        });

    }

    private TenantOverride getTestTenantOverride(String testTenantOverride) {
        Gson gson = new GsonBuilder().serializeNulls().create();
        return gson.fromJson(testTenantOverride, TenantOverride.class);
    }

    private TenantProperties.Tenant getTestTenant(String testTenant) {
        Gson gson = new GsonBuilder().serializeNulls().create();
        return gson.fromJson(testTenant, TenantProperties.Tenant.class);
    }

    private ConfigurationProperties getTenantCfgProps(String testTenant) {
        Gson gson = new GsonBuilder().serializeNulls().create();
        return gson.fromJson(testTenant, ConfigurationProperties.class);
    }

    private TenantConfiguration getTestTenantConfig(String tenantConfig) {
        Gson gson = new GsonBuilder().serializeNulls().create();
        return gson.fromJson(tenantConfig, TenantConfiguration.class);
    }

    private String tenantJson =
            " { \"id\": \"CA\", \"key\": \"CA\", \"name\": \"California\", \"description\": \"This is a California's Tenant.\" }";

    private String tenantCfgPropJson =  "{ " +
            "     \"tenant\": {" +
            "        \"id\": \"NV\"," +
            "        \"key\": \"NV\"," +
            "        \"name\": \"Nevada\"," +
            "        \"description\": \"This is a Nevada's Tenant\"" +
            "      },"+
            "   \"configurationProperties\":{ " +
            "      \"datasources\":{ " +
            "         \"reporting_ro_datasource\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\" " +
            "         } " +
            "      }, " +
            "      \"reporting\":{ " +
            "         \"school-year\":\"2018\", " +
            "         \"transfer-access-enabled\":\"true\", " +
            "         \"translation-location\":\"binary-\", " +
            "         \"analytics-tracking-id\":\"UA-102446884-4\", " +
            "         \"interpretive-guide-url\":\"https://portal.smarterbalanced.org/library/en/reporting-system-interpretive-guide.pdf\", " +
            "         \"user-guide-url\":\"https://portal.smarterbalanced.org/library/en/reporting-system-user-guide.pdf\", " +
            "         \"access-denied-url\":\"forward:/assets/public/access-denied.html\", " +
            "         \"landing-page-url\":\"forward:/landing.html\", " +
            "         \"percentile-display-enabled\":\"true\", " +
            "         \"report-languages\":\"es\", " +
            "         \"ui-languages\":\"es\", " +
            "         \"student-fields\":{ " +
            "            \"EconomicDisadvantage\":\"disabled\", " +
            "            \"LimitedEnglishProficiency\":\"disabled\", " +
            "            \"MigrantStatus\":\"enabled\", " +
            "            \"EnglishLanguageAcquisitionStatus\":\"enabled\", " +
            "            \"PrimaryLanguage\":\"enabled\", " +
            "            \"Ethnicity\":\"enabled\", " +
            "            \"Gender\":\"admin\", " +
            "            \"IndividualEducationPlan\":\"admin\", " +
            "            \"Section504\":\"admin\" " +
            "         }, " +
            "         \"state\":{ " +
            "            \"code\":\"CA\", " +
            "            \"name\":\"California\" " +
            "         } " +
            "      }, " +
            "      \"task\":{ " +
            "         \"remove-stale-reports\":{ " +
            "            \"cron\":\"0 0 8 * * *\", " +
            "            \"max-report-lifetime-days\":\"30\", " +
            "            \"max-random-minutes\":\"20\" " +
            "         } " +
            "      } " +
            "   }," +
            "  \"localizationProperties\" : { " +
            "     \"common.ethnicity.HispanicOrLatinoEthnicity\": \"Hispanic or Latino\", " +
            "     \"common.ethnicity.Asian\": \"Asian\", " +
            "     \"common.ethnicity.BlackOrAfricanAmerican\": \"Black or African American\", " +
            "     \"common.ethnicity.AmericanIndianOrAlaskaNative\": \"American Indian or Alaska Native\", " +
            "     \"common.ethnicity.White\": \"White\", " +
            "     \"common.ethnicity.NativeHawaiianOrOtherPacificIslander\": \"Native Hawaiian or Other Pacific Islander\", " +
            "     \"common.ethnicity.DemographicRaceTwoOrMoreRaces\": \"Two or More Races\", " +
            "     \"gender.Male\": \"Male\", " +
            "     \"gender.Female\": \"Female\", " +
            "     \"gender.Nonbinary\": \"Neutral\" " +
            "   }" +
            "}"   ;

    // update with ReportingSystemSettings * TenantProperties
    private  String tenantConfigurationJson = " {" +
            "     \"tenant\": {" +
            "        \"id\": \"NV\"," +
            "        \"key\": \"NV\"," +
            "        \"name\": \"Nevada\"," +
            "        \"description\": \"This is a Nevada's Tenant\"" +
            "      },"+
            "   \"configurationProperties\":{ " +
            "      \"datasources\":{ " +
            "         \"reporting_ro\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\", " +
            "            \"initialSize\":\"1\", " +
            "            \"maxActive\":\"2\" " +
            "         } " +
            "      }," +
            "      \"reporting\":{ " +
            "         \"school-year\":\"2018\", " +
            "         \"transfer-access-enabled\":\"true\", " +
            "         \"translation-location\":\"binary-\", " +
            "      }," +
            "      \"task\":{ " +
            "         \"remove-stale-reports\":{ " +
            "            \"cron\":\"0 0 8 * * *\", " +
            "            \"max-report-lifetime-days\":\"30\", " +
            "            \"max-random-minutes\":\"20\" " +
            "         } " +
            "      } " +
            "   }," +
            "   \"tenantOverrides\":{ " +
            "      \"tenant\":{ " +
            "         \"id\":\"CA\", " +
            "         \"key\":\"CA\", " +
            "         \"name\":\"California\", " +
            "         \"description\":\"Updated description\" " +
            "      }, " +
            "      \"configurationProperties\":{ " +
            "         \"datasources\":{ " +
            "            \"reporting_ro\":{ " +
            "               \"maxActive\":\"3\" " +
            "            } " +
            "         } " +
            "      }," +
            "      \"reporting\":{ " +
            "         \"transfer-access-enabled\":\"false\", " +
            "         \"student-fields\":{ " +
            "            \"EconomicDisadvantage\":\"enabled\" " +
            "         }, " +
            "      }" +
            "   }" +
            "}";

}