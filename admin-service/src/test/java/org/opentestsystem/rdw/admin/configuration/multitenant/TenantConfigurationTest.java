package org.opentestsystem.rdw.admin.configuration.multitenant;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import org.junit.Test;
import org.opentestsystem.rdw.multitenant.TenantProperties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;


public class TenantConfigurationTest {
    private static final Logger logger = LoggerFactory.getLogger(TenantConfigurationTest.class);

    @Test
    public void testTenant() {
        logger.info("testTenant");

        TenantProperties.Tenant tenant = getTestTenant(tenantJson);
        assertThat(tenant).isNotNull();
        assertThat(tenant.getId()).isEqualTo("CA");
        assertThat(tenant.getKey()).isEqualTo("CA");
        //assertThat(tenant.getDisplayName()).isEqualTo("California");
        assertThat(tenant.getDescription()).isEqualTo("This is a California's Tenant.");
    }

    @Test
    public void testTenantSrv() {
        logger.info("testTenantSrv");
        ObjectMapper mapper = new ObjectMapper();

        TenantConfiguration tenantConfiguration = getTestTenantConfig(tenantConfigurationJson);
        assertThat(tenantConfiguration).isNotNull();
        logger.info("tenantConfiguration = {}", tenantConfiguration);
        assertThat(tenantConfiguration.getTenant()).isNotNull();
        logger.info("tenantConfiguration.getTenant() = {}", tenantConfiguration.getTenant());
        logger.info("tenantConfiguration.getTenant().getId() = {}", tenantConfiguration.getTenant().getId());
        assertThat(tenantConfiguration.getConfigurationProperties()).isNotNull();
        logger.info("tenantConfiguration.getTenant().getId() = {}", tenantConfiguration.getTenant().getId());


//        ConfigurationProperties configurationProperties = tenantConfiguration.getConfigurationProperties();
//        // use new tenantProperties
//        assertThat(serviceProperties.get("tenant")).isNotNull();
//        Tenant tenant = mapper.convertValue(serviceProperties.get("tenant"), Tenant.class);
//        logger.info("tenant.id={}",tenant.getId());
//        assertThat(tenant.getId()).isEqualTo("CA");
//        assertThat(tenant.getKey()).isEqualTo("CA");
//        assertThat(tenant.getName()).isEqualTo("California");
//        assertThat(tenant.getDescription()).isEqualTo("This is a California's Tenant.");
//        serviceProperties.forEach((k,v) -> {
//            logger.info("services={} and value = {}", k, v);
//            System.out.println("Key : " + k + " Value : " + v);
//
//        });

    }

    private TenantProperties.Tenant getTestTenant(String testTenant) {
        Gson gson = new GsonBuilder().create();
        return gson.fromJson(testTenant, TenantProperties.Tenant.class);
    }

    private TenantConfiguration getTestTenantConfig(String tenantConfig) {
        Gson gson = new GsonBuilder().create();
        return gson.fromJson(tenantConfig, TenantConfiguration.class);
    }

    private String tenantJson =
            " { \"id\": \"CA\", \"key\": \"CA\", \"displayName\": \"California\", \"description\": \"This is a California's Tenant.\" }";

    // update with ReportingSystemSettings * TenantProperties
    private  String tenantConfigurationJson = " {" +
            "     \"tenant\": {" +
            "        \"id\": \"NV\"," +
            "        \"key\": \"NV\"," +
            "        \"displayName\": \"Nevada\"," +
            "        \"description\": \"This is a Nevada's Tenant\"" +
            "      },"+
            "   \"configurationProperties\":{ " +
            "      \"datasources\":{ " +
            "         \"reporting_ro\":{ " +
            "            \"url-server\":\"rdw-aurora-\", " +
            "            \"username\":\"sbac\", " +
            "            \"password\":\"****\", " +
            "            \"initialSize\":\"1\", " +
            "            \"maxActive\":\"2\" " +
            "         } " +
            "      }," +
            "      \"reporting\":{ " +
            "         \"school-year\":\"2018\", " +
            "         \"transfer-access-enabled\":\"true\", " +
            "         \"translation-location\":\"binary-\", " +
            "      }" +
            "   }," +
            "   \"tenantOverrides\":{ " +
            "      \"tenant\":{ " +
            "         \"id\":\"CA\", " +
            "         \"key\":\"CA\", " +
            "         \"name\":\"California\", " +
            "         \"description\":\"Updated description\" " +
            "      }, " +
            "      \"configurationProperties\":{ " +
            "         \"datasources\":{ " +
            "            \"reporting_ro\":{ " +
            "               \"maxActive\":\"3\" " +
            "            } " +
            "         } " +
            "      }," +
            "      \"reporting\":{ " +
            "         \"transfer-access-enabled\":\"false\", " +
            "         \"student-fields\":{ " +
            "            \"EconomicDisadvantage\":\"enabled\" " +
            "         }, " +
            "      }" +
            "   }" +
            "}";

}