package org.opentestsystem.rdw.admin.multitenant.database.impl;

import org.apache.commons.lang.RandomStringUtils;
import org.junit.Before;
import org.junit.Ignore;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.admin.repository.RepositoryIT;
import org.opentestsystem.rdw.schema.SchemaMigration;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.test.annotation.IfProfileValue;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.jdbc.SqlConfig;
import org.springframework.test.context.junit4.SpringRunner;

import javax.sql.DataSource;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.schema.SchemaMigration.Migration;

/**
 * This test will only run against Aurora and S3
 *
 * <p>
 * This test will run only if the system property test-archive.root is set to s3://rdw-ci-archive
 * <p>
 * Additionally, AWS and Aurora credentials must be set:<ul>
 * <li>archive.s3-access-key</li>
 * <li>archive.s3-secret-key</li>
 * <li>spring.admin_datasource.username</li>
 * <li>spring.admin_datasource.password</li>
 * </ul>
 * For example,<pre>
 * java -Darchive.uri-root=s3://rdw-ci-archive
 *      -Darchive.s3-access-key=#####################
 *      -Darchive.s3-secret-key=#####################
 *      -Dspring.admin_datasource.url-parts.hosts=rdw-aurora-ci.cugsexobhx8t.us-west-2.rds.amazonaws.com:3306
 *      -Dspring.admin_datasource.url-parts.database=sandbox_it_warehouse_test
 *      -Dspring.admin_datasource.username=###################
 *      -Dspring.admin_datasource.password=###################
 * </pre>
 */
@RunWith(SpringRunner.class)
@IfProfileValue(name = "archive.uri-root", value = "s3://rdw-ci-archive")
@RepositoryIT
@ContextConfiguration(classes = {
        JdbcMultitenantDatabaseAdmin.class
})
public class JdbcMultitenantDatabaseAdminIT {

    private final String targetDatabase = "sandbox_it_warehouse_test";
    private final String importDatabase = "warehouse";
    private final String datasetName = "test-dataset";
    private final String createTargetDatabase = targetDatabase + "_create_test";
    private final String createDatabaseUserUsername = "it_creat_u_test";
    private final String testCreateOlapUser = "sbx_it_user";
    private final String targetOlapSchema = "sbx_reporting_it_test";

    @Autowired
    private JdbcMultitenantDatabaseAdmin jdbcMultitenantDatabaseAdmin;

    @Autowired
    @Qualifier("adminDataSource")
    private DataSource adminDataSource;

    @Autowired
    @Qualifier("adminJdbcTemplate")
    NamedParameterJdbcTemplate adminJdbcTemplate;

    private SchemaMigration warehouseMigration;

    @Before
    public void setUp() {
        warehouseMigration = new SchemaMigration(adminDataSource, targetDatabase, Migration.Warehouse);
    }

    @Ignore //TODO: temporary
    @Test
    public void testLoad() {
        warehouseMigration.clean();
        warehouseMigration.migrate();
        assertThat(jdbcMultitenantDatabaseAdmin.isDatabaseEmpty(targetDatabase, importDatabase)).isTrue();
        jdbcMultitenantDatabaseAdmin.loadDataset(targetDatabase, datasetName, importDatabase);
        assertThat(jdbcMultitenantDatabaseAdmin.isDatabaseEmpty(targetDatabase, importDatabase)).isFalse();
    }

    @Ignore //TODO: temporary
    @Test
    public void manifestShouldLoadFromS3() {
        List<String> tables = jdbcMultitenantDatabaseAdmin.manifest(datasetName, importDatabase);
        assertThat(tables.size()).isGreaterThan(0);
        assertThat(tables.stream().filter(f -> f.contains("exam.txt")).findFirst())
                .isNotEmpty();
    }

    @Ignore
    @Test
    public void isDatabaseExistsShouldReturnValidResult() {
        boolean isReporting = jdbcMultitenantDatabaseAdmin.isDatabaseExists("reporting");
        assertThat(isReporting).isTrue();
        boolean isFoo = jdbcMultitenantDatabaseAdmin.isDatabaseExists("foo");
        assertThat(isFoo).isFalse();
    }


    @Ignore
    @Test
    @Sql(statements = "DROP DATABASE IF EXISTS " + createTargetDatabase,
            config = @SqlConfig(dataSource = "adminDataSource"))
    public void createDatabaseShouldCreateADatabase() {
        jdbcMultitenantDatabaseAdmin.createDatabase(createTargetDatabase);
        boolean isWarehouseCreateTest = jdbcMultitenantDatabaseAdmin.isDatabaseExists(createTargetDatabase);
        assertThat(isWarehouseCreateTest).isTrue();
    }

    @Ignore
    @Test
    public void isDatabaseUserExistsShouldBeValid() {
        assertThat(jdbcMultitenantDatabaseAdmin.isDatabaseUserExists("sbac")).isTrue();
        assertThat(jdbcMultitenantDatabaseAdmin.isDatabaseUserExists("foo")).isFalse();
    }

    @Ignore
    @Test
    @Sql(statements = {"GRANT USAGE ON *.* TO " + createDatabaseUserUsername + "@'%' IDENTIFIED BY 'verytmppwd1'",
            "DROP USER " + createDatabaseUserUsername},
            config = @SqlConfig(dataSource = "adminDataSource"))
    public void createDatabaseUserShouldCreateADatabaseUser() {
        jdbcMultitenantDatabaseAdmin.createDatabaseUser(createDatabaseUserUsername,
                RandomStringUtils.random(8, true, true));
        assertThat(jdbcMultitenantDatabaseAdmin.isDatabaseUserExists(createDatabaseUserUsername)).isTrue();
    }

    @Ignore
    @Test
    @Sql(statements = {"DROP DATABASE IF EXISTS " + createTargetDatabase,
            "GRANT USAGE ON *.* TO " + createDatabaseUserUsername + "@'%' IDENTIFIED BY 'verytmppwd1'",
            "DROP USER " + createDatabaseUserUsername},
            config = @SqlConfig(dataSource = "adminDataSource"))
    public void grantsShouldBeAppliedToUser() {
        jdbcMultitenantDatabaseAdmin.createDatabase(createTargetDatabase);
        jdbcMultitenantDatabaseAdmin.createDatabaseUser(createDatabaseUserUsername,
                RandomStringUtils.random(8, true, true));

        jdbcMultitenantDatabaseAdmin.grantUserToDatabase(createDatabaseUserUsername, createTargetDatabase);
        jdbcMultitenantDatabaseAdmin.grantUserOnSelectProc(createDatabaseUserUsername);
        jdbcMultitenantDatabaseAdmin.grantUserLoadFromS3(createDatabaseUserUsername);
        jdbcMultitenantDatabaseAdmin.grantUserSelectIntoS3(createDatabaseUserUsername);

        List<String> grants = adminJdbcTemplate.queryForList("SHOW GRANTS FOR :username",
                new MapSqlParameterSource()
                        .addValue("username", createDatabaseUserUsername),
                String.class);

        assertThat(grants.stream()
                .filter(g -> g.contains(createTargetDatabase)).findFirst())
                .isNotEmpty();

        assertThat(grants.stream()
                .filter(g -> g.contains("`mysql`.`proc`")).findFirst())
                .isNotEmpty();

        assertThat(grants.stream()
                .filter(g -> g.contains("LOAD FROM S3")).findFirst())
                .isNotEmpty();

        assertThat(grants.stream()
                .filter(g -> g.contains("SELECT INTO S3")).findFirst())
                .isNotEmpty();
    }

    @Test
    public void isOlapDatabaseUserExistsShouldBeValid() {
        assertThat(jdbcMultitenantDatabaseAdmin.isOlapDatabaseUserExists("sbac")).isTrue();
        assertThat(jdbcMultitenantDatabaseAdmin.isOlapDatabaseUserExists("foo")).isFalse();
    }

    @Test
    @Sql(statements = {"DROP USER IF EXISTS " + testCreateOlapUser},
            config = @SqlConfig(dataSource = "adminOlapDataSource"))
    public void createOlapDatabaseUserShouldCreateADatabaseUser() {
        jdbcMultitenantDatabaseAdmin.createOlapDatabaseUser(createDatabaseUserUsername,
                RandomStringUtils.random(6, true, false) + RandomStringUtils.random(2, false, true));
        assertThat(jdbcMultitenantDatabaseAdmin.isOlapDatabaseUserExists(createDatabaseUserUsername)).isTrue();
    }

}
