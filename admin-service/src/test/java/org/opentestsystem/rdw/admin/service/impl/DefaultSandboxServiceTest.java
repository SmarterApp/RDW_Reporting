package org.opentestsystem.rdw.admin.service.impl;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.ImmutableSet;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.admin.model.ApplicationSandboxConfigurations;
import org.opentestsystem.rdw.admin.model.SandboxConfiguration;
import org.opentestsystem.rdw.admin.model.SandboxConfigurationStubs;
import org.opentestsystem.rdw.admin.model.TenantConfigurationStubs;
import org.opentestsystem.rdw.admin.multitenant.SandboxDataSets;
import org.opentestsystem.rdw.admin.multitenant.TenantAdministrationRequestHandler;
import org.opentestsystem.rdw.admin.multitenant.TenantAdministrationStatusService;
import org.opentestsystem.rdw.admin.repository.impl.InMemorySandboxConfigurationRepository;
import org.opentestsystem.rdw.multitenant.Tenant;
import org.opentestsystem.rdw.multitenant.TenantProperties;
import org.opentestsystem.rdw.reporting.common.configuration.AggregateReportingPropertiesTenant;
import org.opentestsystem.rdw.reporting.common.configuration.ReportingSystemProperties;
import org.opentestsystem.rdw.reporting.common.multitenant.ReportingTenantIdResolver;

import java.util.ArrayList;
import java.util.Map;
import java.util.NoSuchElementException;
import java.util.Optional;
import java.util.Set;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

public class DefaultSandboxServiceTest {
    private DefaultSandboxService service;

    private InMemorySandboxConfigurationRepository inMemorySandboxConfigurationRepository;
    private ReportingTenantIdResolver reportingTenantIdResolver;
    private DefaultTenantConfigPropsService defaultTenantConfigPropsService;
    private TenantProperties tenantProperties;
    private SandboxDataSets sandboxDataSets;
    private TenantAdministrationRequestHandler tenantAdministrationRequestHandler;
    private TenantAdministrationStatusService tenantAdministrationStatusService;

    @Before
    public void setup() {
        inMemorySandboxConfigurationRepository = mock(InMemorySandboxConfigurationRepository.class);
        reportingTenantIdResolver = mock(ReportingTenantIdResolver.class);
        defaultTenantConfigPropsService = mock(DefaultTenantConfigPropsService.class);
        tenantProperties = mock(TenantProperties.class);
        sandboxDataSets = mock(SandboxDataSets.class); //
        tenantAdministrationRequestHandler = mock(TenantAdministrationRequestHandler.class);
        tenantAdministrationStatusService = mock(TenantAdministrationStatusService.class);

        when(sandboxDataSets.getSandboxDatasets()).thenReturn(new ArrayList<>(SandboxConfigurationStubs.getDataSets()));
        when(reportingTenantIdResolver.getTenantId()).thenReturn(
                Optional.of(SandboxConfigurationStubs.getSandboxCAInfo().getKey()));
        service = new DefaultSandboxService(inMemorySandboxConfigurationRepository, reportingTenantIdResolver, defaultTenantConfigPropsService, tenantProperties, sandboxDataSets, tenantAdministrationRequestHandler, tenantAdministrationStatusService);
    }

    @Test
    public void itShouldRetrieveAllSandboxes() {
        SandboxConfiguration sandboxConfigurationCa = SandboxConfigurationStubs.getCaInterimSandboxConfiguration();
        SandboxConfiguration sandboxConfigurationMi = SandboxConfigurationStubs.getMiInterimSandboxConfiguration();
        Set<SandboxConfiguration> sandboxConfigurations = ImmutableSet.of(sandboxConfigurationCa, sandboxConfigurationMi);
        when(inMemorySandboxConfigurationRepository.getAll()).thenReturn(sandboxConfigurations);

        when(defaultTenantConfigPropsService.getDefaultApplicationSandboxConfiguration())
                .thenReturn(SandboxConfigurationStubs.getApplicationSandboxConfigurationDefault().getApplicationSandboxConfiguration());
        when(tenantProperties.findTenantById(any())).thenReturn(Optional.of(TenantConfigurationStubs.getTenantCA()));

        ApplicationSandboxConfigurations applicationSandboxConfigurations = service.getAll();

        verify(inMemorySandboxConfigurationRepository).getAll();
        verify(defaultTenantConfigPropsService).getDefaultApplicationSandboxConfiguration();
        verify(tenantProperties).findTenantById(any());
        verify(sandboxDataSets).getSandboxDatasets();

        assertThat(applicationSandboxConfigurations).isNotNull();
        assertThat(applicationSandboxConfigurations.getSandboxConfigurationPackage()).isNotNull();
        assertThat(applicationSandboxConfigurations.getSandboxes()).isNotEmpty();
        assertThat(applicationSandboxConfigurations.getSandboxes().size()).isEqualTo(2);
        assertThat(applicationSandboxConfigurations.getSandboxConfigurationPackage().getDataSets().size()).isEqualTo(SandboxConfigurationStubs.getDataSets().size());

        Optional<SandboxConfiguration> sandboxCa = getSandboxConfigurationFromKey(applicationSandboxConfigurations, sandboxConfigurationCa.getSandbox().getKey());
        assertThat(sandboxCa).isPresent();
        if (sandboxCa.isPresent()) {
            verifySandboxes(sandboxCa.get(), sandboxConfigurationCa);
        }

        Optional<SandboxConfiguration> sandboxMi = getSandboxConfigurationFromKey(applicationSandboxConfigurations, sandboxConfigurationMi.getSandbox().getKey());
        assertThat(sandboxMi).isPresent();
        if (sandboxMi.isPresent()) {
            verifySandboxes(sandboxMi.get(), sandboxConfigurationMi);
        }
    }

    @Test
    public void itShouldCreateSandbox() {
        SandboxConfiguration sandboxConfigurationCa = SandboxConfigurationStubs.getCaInterimSandboxConfiguration();
        when(inMemorySandboxConfigurationRepository.create(sandboxConfigurationCa)).thenReturn(sandboxConfigurationCa);
        SandboxConfiguration sandboxConfiguration = service.create(sandboxConfigurationCa);

        verify(inMemorySandboxConfigurationRepository).create(sandboxConfigurationCa);
        assertThat(sandboxConfiguration).isNotNull();
        assertThat(sandboxConfiguration.getSandbox()).isNotNull();
        verifySandboxes(sandboxConfiguration, sandboxConfigurationCa);
    }

    @Test
    public void itShouldUpdateSandbox() {
        String expectedDescription = "Sandbox's New description for Testing";
        SandboxConfiguration sandboxConfigurationCa = SandboxConfigurationStubs.getCaInterimSandboxConfiguration();
        SandboxConfiguration updatedSandboxConfiguration = SandboxConfigurationStubs.getCaInterimSandboxConfiguration();
        updatedSandboxConfiguration.getSandbox().setDescription(expectedDescription);
        when(inMemorySandboxConfigurationRepository.update(sandboxConfigurationCa)).thenReturn(updatedSandboxConfiguration);
        when(inMemorySandboxConfigurationRepository.exists(sandboxConfigurationCa.getSandbox().getKey())).thenReturn(true);

        SandboxConfiguration sandboxCfg = service.update(sandboxConfigurationCa);

        verify(inMemorySandboxConfigurationRepository).update(sandboxConfigurationCa);
        verifySandboxes(sandboxCfg, updatedSandboxConfiguration);
    }

    @Test
    public void itShouldDeleteSandbox() {
        String key = SandboxConfigurationStubs.getCaInterimSandboxConfiguration().getSandbox().getKey();
        service.delete(key);
        verify(inMemorySandboxConfigurationRepository).delete(key);
    }

    @Test
    public void itShouldResetSandbox() {
        String key = SandboxConfigurationStubs.getCaInterimSandboxConfiguration().getSandbox().getKey();
        service.resetDataSet(key);
        verify(inMemorySandboxConfigurationRepository).reset(key);
    }

    @Test(expected = IllegalArgumentException.class)
    public void itShouldNotCreateSandbox() {
        SandboxConfiguration sandboxConfigurationCa = SandboxConfigurationStubs.getCaInterimSandboxConfiguration();
        when(inMemorySandboxConfigurationRepository.create(sandboxConfigurationCa)).thenReturn(sandboxConfigurationCa);
        when(inMemorySandboxConfigurationRepository.exists(any())).thenReturn(true);
        service.create(sandboxConfigurationCa);
    }

    @Test(expected = NoSuchElementException.class)
    public void itShouldNotUpdateSandbox() {
        SandboxConfiguration sandboxConfigurationCa = SandboxConfigurationStubs.getCaInterimSandboxConfiguration();
        when(inMemorySandboxConfigurationRepository.create(sandboxConfigurationCa)).thenReturn(sandboxConfigurationCa);
        when(inMemorySandboxConfigurationRepository.exists(sandboxConfigurationCa.getSandbox().getKey())).thenReturn(false);
        service.update(sandboxConfigurationCa);
    }

    @Test
    public void itShouldGenerateAValidKey() {
        Map<String, Tenant> tenantMap = ImmutableMap.of(
                "NV", Tenant.builder().sandbox(false).id("NV").key("NV").build(),
                "CA", Tenant.builder().sandbox(false).id("CA").key("CA").build(),
                "CA_S001", Tenant.builder().sandbox(true).id("CA_S001").key("CA_S001").build(),
                "CA_S002", Tenant.builder().sandbox(true).id("CA_S002").key("CA_S002").build(),
                "OR", Tenant.builder().sandbox(false).id("OR").key("OR").build());
        when(tenantProperties.getTenants()).thenReturn(tenantMap);

        Set<String> statusSet = ImmutableSet.of("OR_S001");
        when(tenantAdministrationStatusService.allTenantKeys()).thenReturn(statusSet);

        //no sandbox case
        String nvKey = service.generateKey("NV");
        assertThat(nvKey).isEqualTo("NV_S001");

        //existing sandboxes, non in process of build
        String caKey = service.generateKey("CA");
        assertThat(caKey).isEqualTo("CA_S003");

        //no configured sandboxes, but one in process
        String orKey = service.generateKey("OR");
        assertThat(orKey).isEqualTo("OR_S002");
    }

    private void verifySandboxes(final SandboxConfiguration sandboxConfiguration, final SandboxConfiguration expectedSandboxConfiguration) {
        assertThat(sandboxConfiguration.getSandbox().getKey()).isEqualTo(expectedSandboxConfiguration.getSandbox().getKey());
        assertThat(sandboxConfiguration.getSandbox().getId()).isEqualTo(expectedSandboxConfiguration.getSandbox().getId());
        assertThat(sandboxConfiguration.getSandbox().getDataSetId()).isEqualTo(expectedSandboxConfiguration.getSandbox().getDataSetId());
        assertThat(sandboxConfiguration.getSandbox().getTenantKey()).isEqualTo(expectedSandboxConfiguration.getSandbox().getTenantKey());
        assertThat(sandboxConfiguration.getSandbox().getDescription()).isEqualTo(expectedSandboxConfiguration.getSandbox().getDescription());
        assertThat(sandboxConfiguration.getSandbox().getName()).isEqualTo(expectedSandboxConfiguration.getSandbox().getName());

        verifyReporting(sandboxConfiguration.getApplicationSandboxConfiguration().getReporting(), expectedSandboxConfiguration.getApplicationSandboxConfiguration().getReporting());
        verifyLocalization(sandboxConfiguration.getLocalization(), expectedSandboxConfiguration.getLocalization());

        verifyAggregatorProperties(sandboxConfiguration.getApplicationSandboxConfiguration().getAggregateReportingPropertiesTenant(),
                expectedSandboxConfiguration.getApplicationSandboxConfiguration().getAggregateReportingPropertiesTenant());
    }

    /**
     * the aggregator property lists can be null
     *
     * @param aggregateProperties         retrieved properties
     * @param expectedAggregateProperties expected properties
     */
    private void verifyAggregatorProperties(AggregateReportingPropertiesTenant aggregateProperties, AggregateReportingPropertiesTenant expectedAggregateProperties) {
        assertThat(aggregateProperties.getAssessmentTypes().size()).isEqualTo(expectedAggregateProperties.getAssessmentTypes().size());
        assertThat(aggregateProperties.getStateAggregateAssessmentTypes().size()).isEqualTo(expectedAggregateProperties.getStateAggregateAssessmentTypes().size());
        assertThat(aggregateProperties.getStatewideUserAssessmentTypes().size()).isEqualTo(expectedAggregateProperties.getStatewideUserAssessmentTypes().size());
    }

    private void verifyLocalization(final String localization, final String expectedLocalization) {
        assertThat(localization).isEqualTo(expectedLocalization);
    }

    private void verifyReporting(final ReportingSystemProperties reportingSystemSettings, final ReportingSystemProperties expectedReportingSystemSettings) {
        assertThat(reportingSystemSettings.getAccessDeniedUrl()).isEqualTo(expectedReportingSystemSettings.getAccessDeniedUrl());
        assertThat(reportingSystemSettings.getAnalyticsTrackingId()).isEqualTo(expectedReportingSystemSettings.getAnalyticsTrackingId());
        assertThat(reportingSystemSettings.getInterpretiveGuideUrl()).isEqualTo(expectedReportingSystemSettings.getInterpretiveGuideUrl());
        assertThat(reportingSystemSettings.getIrisVendorId()).isEqualTo(expectedReportingSystemSettings.getIrisVendorId());
        assertThat(reportingSystemSettings.getLandingPageUrl()).isEqualTo(expectedReportingSystemSettings.getLandingPageUrl());
        assertThat(reportingSystemSettings.getMinItemDataYear()).isEqualTo(expectedReportingSystemSettings.getMinItemDataYear());
        assertThat(reportingSystemSettings.getSchoolYear()).isEqualTo(expectedReportingSystemSettings.getSchoolYear());
        assertThat(reportingSystemSettings.getUserGuideUrl()).isEqualTo(expectedReportingSystemSettings.getUserGuideUrl());
        assertThat(reportingSystemSettings.getTargetReport()).isEqualTo(expectedReportingSystemSettings.getTargetReport());
        assertThat(reportingSystemSettings.getTranslationLocation()).isEqualTo(expectedReportingSystemSettings.getTranslationLocation());
        assertThat(reportingSystemSettings.isPercentileDisplayEnabled()).isEqualTo(expectedReportingSystemSettings.isPercentileDisplayEnabled());
        assertThat(reportingSystemSettings.isTransferAccessEnabled()).isEqualTo(expectedReportingSystemSettings.isTransferAccessEnabled());
        assertThat(reportingSystemSettings.getState()).isNotNull();
        assertThat(reportingSystemSettings.getState().getCode()).isEqualTo(expectedReportingSystemSettings.getState().getCode());
        assertThat(reportingSystemSettings.getState().getName()).isEqualTo(expectedReportingSystemSettings.getState().getName());

        assertThat(reportingSystemSettings.getReportLanguages().size()).isEqualTo(expectedReportingSystemSettings.getReportLanguages().size());
        assertThat(reportingSystemSettings.getUiLanguages().size()).isEqualTo(expectedReportingSystemSettings.getUiLanguages().size());
        assertThat(reportingSystemSettings.getEffectiveReportLanguages().size()).isEqualTo(expectedReportingSystemSettings.getEffectiveReportLanguages().size());

    }

    /**
     * Lookup the given key in the ApplicationSandboxConfigurations sandbox list
     *
     * @param applicationSandboxConfigurations contains the list of sandboxes to look through
     * @param key                              The key of the sandbox to find
     * @return SandboxConfiguration if key is found
     */
    private Optional<SandboxConfiguration> getSandboxConfigurationFromKey(final ApplicationSandboxConfigurations applicationSandboxConfigurations, String key) {
        return applicationSandboxConfigurations.getSandboxes().stream()
                .filter(sandbox ->
                        sandbox.getSandbox().getKey().equals(key)
                ).findFirst();
    }

}
