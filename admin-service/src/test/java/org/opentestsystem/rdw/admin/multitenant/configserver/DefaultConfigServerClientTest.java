package org.opentestsystem.rdw.admin.multitenant.configserver;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.admin.multitenant.model.ApplicationTenantConfigurationPersistence;
import org.opentestsystem.rdw.archive.ArchivePropertiesTenant;
import org.opentestsystem.rdw.multitenant.Tenant;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.annotation.IfProfileValue;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.web.client.RestTemplate;

import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;


// TODO RP-394 Move some integration test (IT) to End to End tests (ETE) and configure to run in CI
//this test only runs against a local docker instance
// set this property to run this test (or temporarily comment out this annotation)
// java -Dtenant-client.docker-it-enable=true
//@Ignore
@IfProfileValue(name = "tenant-client.docker-it-enable", value = "true")
@RunWith(SpringRunner.class)
@SpringBootTest
@ActiveProfiles({"spring.cloud.config"})
@EnableConfigurationProperties
public class DefaultConfigServerClientTest {

    private RestTemplate restTemplate = new RestTemplate();
    private DefaultConfigServerClient defaultConfigServerClient;
    @Value("${spring.cloud.config.uri}")
    private String configServerUri;
    private String password = "thepassword";

    @Before
    public void setup() {
        defaultConfigServerClient = new DefaultConfigServerClient(configServerUri);
    }

    //    @Ignore
    @Test
    public void itShouldLoadConfig() {
        assertThat(configServerUri).isNotNull();
    }

    //    @Ignore
    @Test
    public void itShouldEncryptPasswordAndSuccessfullyDecryptIt() {
        // the encryption returns a different cipher on each request - all decrypt to the expected password
        final String encrypted = defaultConfigServerClient.encryptPassword(password);
        assertThat(encrypted).isNotNull();
        final String decryptedPassword = defaultConfigServerClient.decryptPassword(encrypted);
        assertThat(decryptedPassword).isNotNull().isEqualTo(password);
    }

    //    @Ignore
    @Test
    public void itShouldPostMonitor() {
        defaultConfigServerClient.postMonitor();
    }

    //    @Ignore
    @Test
    public void itShouldCallConfigServerEndpointForRealPassword() {
        final String reporting_ro_json = defaultConfigServerClient.getActualServicePassword(RDWServices.RDW_REPORTING_REPORT_PROCESSOR.getName());
        assertThat(reporting_ro_json).isNotNull();

        final String reporting_rw_json = defaultConfigServerClient.getActualServicePassword(RDWServices.RDW_REPORTING_SERVICE.getName());
        assertThat(reporting_rw_json).isNotNull();
        final String olap_ro_json = defaultConfigServerClient.getActualServicePassword(RDWServices.RDW_REPORTING_REPORT_AGGREGATE.getName());
        assertThat(olap_ro_json).isNotNull();
    }


    //    @Ignore
    @Test
    public void itShouldRetrieveLocationFile() {

        Optional<String> caLocalization = defaultConfigServerClient.getLocalization("binary-${spring.cloud.config.uri}/*/*/master/tenant-CA/", "en");
        assertThat(caLocalization).isPresent();
        assertThat(caLocalization.get().contains("aggregate")).isTrue();
    }

    @Test
    public void itShouldRetrieveApplicationTenantConfigurationPersistence() {
        Optional<ApplicationTenantConfigurationPersistence> configurationPersistenceOpt =
                defaultConfigServerClient.findApplicationTenantConfigurationPersistence("CA_S001");
        assertThat(configurationPersistenceOpt).isPresent();
        ApplicationTenantConfigurationPersistence configurationPersistence = configurationPersistenceOpt.get();

        Tenant tenant = configurationPersistence.getTenantProperties().get("tenants").get("CA_S001");
        assertThat(tenant).isNotNull();
        assertThat(tenant.isSandbox()).isTrue();
        assertThat(tenant.getKey()).isEqualTo("CA_S001");

        ArchivePropertiesTenant archivePropertiesTenant = configurationPersistence.getArchive().get("tenants").get("CA_S001");
        assertThat(archivePropertiesTenant).isNotNull();
        assertThat(archivePropertiesTenant).isNotNull();
        assertThat(archivePropertiesTenant.getPathPrefix()).isEqualTo("ca_s001");
    }

}