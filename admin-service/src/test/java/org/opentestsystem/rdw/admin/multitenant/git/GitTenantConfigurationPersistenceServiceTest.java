package org.opentestsystem.rdw.admin.multitenant.git;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.ImmutableSet;
import org.apache.commons.io.FileUtils;
import org.eclipse.jgit.api.Git;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.admin.multitenant.configserver.ConfigServerClient;
import org.opentestsystem.rdw.admin.multitenant.model.TenantConfiguration;
import org.opentestsystem.rdw.admin.service.impl.RDWDataSourceNames;
import org.opentestsystem.rdw.archive.ArchivePropertiesTenant;
import org.opentestsystem.rdw.multitenant.Tenant;
import org.opentestsystem.rdw.multitenant.datasource.DataSourceElementsTenant;
import org.opentestsystem.rdw.multitenant.datasource.DataSourceUrlParts;
import org.opentestsystem.rdw.multitenant.validation.ExamProcessorValidationPropertiesTenant;
import org.opentestsystem.rdw.reporting.common.configuration.AggregateReportingPropertiesTenant;
import org.opentestsystem.rdw.reporting.common.configuration.ReportingSystemPropertiesImpl;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.yaml.snakeyaml.Yaml;

import java.io.File;
import java.net.URL;
import java.util.Arrays;
import java.util.Collections;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

public class GitTenantConfigurationPersistenceServiceTest {

    private static final Logger logger = LoggerFactory.getLogger(GitTenantConfigurationPersistenceServiceTest.class);

    //class under test
    private GitTenantConfigurationPersistenceService tenantConfigurationPersistenceService;

    private TenantConfigurationPersistenceProperties tenantConfigurationPersistenceProperties;
    private ConfigServerClient configServerClient;
    private Yaml applicationTenantConfigurationPersistenceYaml;

    private File localRepositoryDirectory;
    private File remoteRepositoryDirectoryBare;
    private File remoteRepositoryDirectoryWorking;
    private final String encryptedPassword = "{cipher}AE0983AZJD0019";
    private final String testPassword = "testPassword1";

    @Before
    public void setup() throws Exception {
        tenantConfigurationPersistenceProperties = new TenantConfigurationPersistenceProperties();
        tenantConfigurationPersistenceProperties.setLocalRepositoryUri("file:///tmp/rdw_config_local_test");
        tenantConfigurationPersistenceProperties.setRemoteRepositoryUri("file:///tmp/rdw_config_remote_test");
        tenantConfigurationPersistenceProperties.setGitUsername("test");
        tenantConfigurationPersistenceProperties.setGitPassword("test");
        tenantConfigurationPersistenceProperties.setAuthor("test");
        tenantConfigurationPersistenceProperties.setAuthorEmail("test@example.com");

        configServerClient = mock(ConfigServerClient.class);
        when(configServerClient.encryptPassword(testPassword)).thenReturn(encryptedPassword);

        tenantConfigurationPersistenceService = new GitTenantConfigurationPersistenceService(tenantConfigurationPersistenceProperties, configServerClient);

        URL remoteRepositoryURL = new URL(tenantConfigurationPersistenceProperties.getRemoteRepositoryUri());
        remoteRepositoryDirectoryBare = FileUtils.toFile(remoteRepositoryURL);
        remoteRepositoryDirectoryWorking = FileUtils.getFile(remoteRepositoryDirectoryBare.getPath() + "_working");

        //set up bare empty repository to simulate remote
        FileUtils.deleteDirectory(remoteRepositoryDirectoryBare);
        Git.init().setDirectory(remoteRepositoryDirectoryBare).setBare(true).call();

        URL localRepositoryUrl = new URL(tenantConfigurationPersistenceProperties.getLocalRepositoryUri());
        localRepositoryDirectory = FileUtils.toFile(localRepositoryUrl);
        FileUtils.deleteDirectory(localRepositoryDirectory);
    }

    @Test
    public void getWorkingShouldCreateDirectoryIfNoneExists() throws Exception {
        FileUtils.deleteDirectory(localRepositoryDirectory);
        File workingDirectory = tenantConfigurationPersistenceService.getWorkingDirectory();
        assertThat(workingDirectory.getPath()).isEqualTo(localRepositoryDirectory.getPath());
        assertThat(localRepositoryDirectory.exists()).isTrue();
    }

    @Test
    public void getWorkingShouldReturnDirectoryIfItExists() throws Exception {
        FileUtils.forceMkdir(localRepositoryDirectory);
        File workingDirectory = tenantConfigurationPersistenceService.getWorkingDirectory();
        assertThat(workingDirectory.getPath()).isEqualTo(localRepositoryDirectory.getPath());
        assertThat(localRepositoryDirectory.exists()).isTrue();
    }

    @Test
    public void getLocalRepositoryToCleanStateShouldWorkWithMissingDirectory() throws Exception {
        FileUtils.deleteDirectory(localRepositoryDirectory);
        tenantConfigurationPersistenceService.forceLocalRepositoryToCleanState();
        assertThat(localRepositoryDirectory.exists()).isTrue();
    }

    @Test
    public void getLocalRepositoryToCleanStateShouldWipeExistingDirectory() throws Exception {
        FileUtils.forceMkdir(localRepositoryDirectory);
        tenantConfigurationPersistenceService.forceLocalRepositoryToCleanState();
        //try a clone second time, should not error
        tenantConfigurationPersistenceService.forceLocalRepositoryToCleanState();
    }

    @Test
    public void saveTenantConfigurationShouldPersistResults() throws Exception {
        ReportingSystemPropertiesImpl reporting = new ReportingSystemPropertiesImpl();
        reporting.setReportLanguages(Collections.singletonList("en"));
        reporting.setSchoolYear(2019);

        AggregateReportingPropertiesTenant aggregateReportingPropertiesTenant = new AggregateReportingPropertiesTenant();
        aggregateReportingPropertiesTenant.setStatewideUserAssessmentTypes(ImmutableSet.of("sum", "iab"));
        aggregateReportingPropertiesTenant.setAssessmentTypes(ImmutableSet.of("sum"));
        aggregateReportingPropertiesTenant.setStateAggregateAssessmentTypes(ImmutableSet.of("sum", "ica"));

        DataSourceElementsTenant dataSourceElements = new DataSourceElementsTenant();
        DataSourceUrlParts urlParts = new DataSourceUrlParts();
        urlParts.setHosts("catesthost");
        urlParts.setDatabase("catestdb");
        dataSourceElements.setUrlParts(urlParts);
        dataSourceElements.setPassword(testPassword);

        ArchivePropertiesTenant archivePropertiesTenant = new ArchivePropertiesTenant();
        archivePropertiesTenant.setPathPrefix("/CA");
        archivePropertiesTenant.setUriRoot("s3://ca-archive");

        Tenant tenant = Tenant.builder()
                .id("CAX")
                .key("CAX")
                .name("California Test")
                .build();


        ExamProcessorValidationPropertiesTenant validation = new ExamProcessorValidationPropertiesTenant();
        validation.setRequiredDataElements(Arrays.asList("FirstName", "LastOrSurname"));

        TenantConfiguration.Builder tenantConfigurationBuilder = TenantConfiguration.builder();
        tenantConfigurationBuilder.tenant(tenant);
        tenantConfigurationBuilder.reporting(reporting);
        tenantConfigurationBuilder.validation(validation);
        tenantConfigurationBuilder.aggregateReportingProperties(aggregateReportingPropertiesTenant);
        tenantConfigurationBuilder.dataSources(ImmutableMap.of(RDWDataSourceNames.REPORTING_RO.getName(), dataSourceElements));
        tenantConfigurationBuilder.archiveProperties(archivePropertiesTenant);
        tenantConfigurationBuilder.localizaton("{\"test\":\"value\"}");

        logger.debug("localRepositoryDirectory {}", localRepositoryDirectory.getPath());
        tenantConfigurationPersistenceService.saveTenantConfiguration(tenantConfigurationBuilder.build());
        cloneRemoteStateToWorking();

        File expectedApplicationYml = new File(remoteRepositoryDirectoryWorking.getPath() +
                File.separator +
                "tenant-" + tenant.getKey() +
                File.separator +
                "application.yml");

        File expectedLocalization = new File(remoteRepositoryDirectoryWorking.getPath() +
                File.separator +
                "tenant-" + tenant.getKey() +
                File.separator +
                "en.json");

        assertThat(expectedApplicationYml.exists()).isTrue();
        String appYmlExpected = FileUtils.readFileToString(expectedApplicationYml, "UTF-8");
        assertThat(appYmlExpected).contains("California Test");
        assertThat(appYmlExpected).contains("iab");
        assertThat(appYmlExpected).contains("FirstName");
        assertThat(appYmlExpected).contains(encryptedPassword); // no config server will return same password

        assertThat(expectedLocalization.exists()).isTrue();
        String localizationExpected = FileUtils.readFileToString(expectedLocalization, "UTF-8");
        assertThat(localizationExpected).contains("value");

    }

    @Test
    public void deleteSandboxShouldRemoveConfiguration() throws Exception {
        ReportingSystemPropertiesImpl reporting = new ReportingSystemPropertiesImpl();
        reporting.setReportLanguages(Collections.singletonList("en"));
        reporting.setSchoolYear(2019);

        DataSourceElementsTenant dataSourceElements = new DataSourceElementsTenant();
        DataSourceUrlParts urlParts = new DataSourceUrlParts();
        urlParts.setHosts("catesthost");
        urlParts.setDatabase("catestdb");
        dataSourceElements.setUrlParts(urlParts);

        ArchivePropertiesTenant archivePropertiesTenant = new ArchivePropertiesTenant();
        archivePropertiesTenant.setPathPrefix("/CA");
        archivePropertiesTenant.setUriRoot("s3://ca-archive");

        Tenant tenant = Tenant.builder()
                .id("XX_S001")
                .key("XX_S001")
                .name("XX Test")
                .build();


        ExamProcessorValidationPropertiesTenant validation = new ExamProcessorValidationPropertiesTenant();
        validation.setRequiredDataElements(Arrays.asList("FirstName", "LastOrSurname"));

        TenantConfiguration tenantConfiguration = TenantConfiguration.builder()
                .tenant(tenant)
                .reporting(reporting)
                .validation(validation)
                .dataSources(ImmutableMap.of(RDWDataSourceNames.REPORTING_RO.getName(), dataSourceElements))
                .archiveProperties(archivePropertiesTenant)
                .localizaton("{\"test\":\"value\"}")
                .build();

        logger.debug("localRepositoryDirectory {}", localRepositoryDirectory.getPath());
        tenantConfigurationPersistenceService.saveTenantConfiguration(tenantConfiguration);
        cloneRemoteStateToWorking();

        final String applicationYmlWorkingFilePath = remoteRepositoryDirectoryWorking.getPath() +
                File.separator +
                "tenant-" + tenant.getKey() +
                File.separator +
                "application.yml";

        File expectedApplicationYml = new File(applicationYmlWorkingFilePath);

        final String localizationWorkingFilePath = remoteRepositoryDirectoryWorking.getPath() +
                File.separator +
                "tenant-" + tenant.getKey() +
                File.separator +
                "en.json";
        File expectedLocalization = new File(localizationWorkingFilePath);

        assertThat(expectedApplicationYml.exists()).isTrue();
        String appYmlExpected = FileUtils.readFileToString(expectedApplicationYml, "UTF-8");
        assertThat(appYmlExpected).contains("XX Test");

        assertThat(expectedLocalization.exists()).isTrue();
        String localizationExpected = FileUtils.readFileToString(expectedLocalization, "UTF-8");
        assertThat(localizationExpected).contains("value");

        tenantConfigurationPersistenceService.deleteSandbox("XX_S001");
        pullFromRemoteToWorking();

        assertThat(FileUtils.getFile(applicationYmlWorkingFilePath).exists()).isFalse();
        assertThat(FileUtils.getFile(localizationWorkingFilePath).exists()).isFalse();
    }

    @Test
    public void deleteTenantShouldRenameConfigurationDirectory() throws Exception {
        Tenant tenant = Tenant.builder()
                .id("CAX")
                .key("CAX")
                .name("CAX Test")
                .build();

        ExamProcessorValidationPropertiesTenant validation = new ExamProcessorValidationPropertiesTenant();
        validation.setRequiredDataElements(Arrays.asList("FirstName", "LastOrSurname"));

        TenantConfiguration tenantConfiguration = TenantConfiguration.builder()
                .tenant(tenant)
                .archiveProperties(new ArchivePropertiesTenant()) // needed for saveTenantConfiguration()
                .build();

        logger.debug("localRepositoryDirectory {}", localRepositoryDirectory.getPath());

        tenantConfigurationPersistenceService.saveTenantConfiguration(tenantConfiguration);
        cloneRemoteStateToWorking();

        final File tenantFolder = new File(remoteRepositoryDirectoryWorking, "tenant-" + tenant.getKey());
        final File archiveFolder = new File(remoteRepositoryDirectoryWorking, "archive-" + tenant.getKey());

        assertThat(FileUtils.getFile(tenantFolder).exists()).isTrue();
        assertThat(FileUtils.getFile(archiveFolder).exists()).isFalse();

        tenantConfigurationPersistenceService.deleteTenant("CAX");
        pullFromRemoteToWorking();

        assertThat(FileUtils.getFile(tenantFolder).exists()).isFalse();
        assertThat(FileUtils.getFile(archiveFolder).exists()).isTrue();
    }

    @Test
    public void writeLocalizationFileShouldWriteAFile() throws Exception {
        FileUtils.deleteDirectory(localRepositoryDirectory);
        FileUtils.forceMkdir(localRepositoryDirectory);
        Tenant tenant = Tenant.builder()
                .id("CAX")
                .key("CAX")
                .name("California Test")
                .build();
        tenantConfigurationPersistenceService.writeLocalization("{\"test\":\"value\"}", tenant.getKey());
        File expectedFile = new File(localRepositoryDirectory.getPath() +
                File.separator +
                "tenant-" + tenant.getKey() +
                File.separator +
                "en.json");
        assertThat(expectedFile.exists()).isTrue();
        String readExpected = FileUtils.readFileToString(expectedFile, "UTF-8");
        assertThat(readExpected).contains("value");
    }

    private void cloneRemoteStateToWorking() throws Exception {
        FileUtils.forceMkdir(remoteRepositoryDirectoryWorking);
        FileUtils.cleanDirectory(remoteRepositoryDirectoryWorking);
        Git.cloneRepository()
                .setURI(tenantConfigurationPersistenceProperties.getRemoteRepositoryUri())
                .setDirectory(remoteRepositoryDirectoryWorking)
                .call();
    }

    private void pullFromRemoteToWorking() throws Exception {
        Git.open(remoteRepositoryDirectoryWorking)
                .pull()
                .call();
    }

}
