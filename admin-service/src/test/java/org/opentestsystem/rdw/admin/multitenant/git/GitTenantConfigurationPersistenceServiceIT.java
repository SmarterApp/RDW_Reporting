package org.opentestsystem.rdw.admin.multitenant.git;

import com.google.common.collect.ImmutableMap;
import org.apache.commons.io.FileUtils;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.admin.model.ApplicationTenantConfiguration;
import org.opentestsystem.rdw.admin.model.TenantConfiguration;
import org.opentestsystem.rdw.admin.service.impl.RDWDataSourceNames;
import org.opentestsystem.rdw.archive.ArchivePropertiesTenant;
import org.opentestsystem.rdw.multitenant.Tenant;
import org.opentestsystem.rdw.multitenant.datasource.DataSourceElementsTenant;
import org.opentestsystem.rdw.multitenant.datasource.DataSourceUrlParts;
import org.opentestsystem.rdw.reporting.common.configuration.ReportingSystemPropertiesImpl;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.annotation.IfProfileValue;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.junit4.SpringRunner;

import java.io.File;
import java.util.Collections;

import static org.assertj.core.api.Assertions.assertThat;

// we don't currently have a git integration test server setup
// to run this test set tenant-configuration-persistence.enable=true
// also need to set remote repository uri, username, and password
//  java -Dtenant-configuration-persistence.enable=true \
//       -Dtenant-configuration-persistence.remote-repository-uri=https://github.com/example/rdw_config.git
//       -Dtenant-configuration-persistence.git-username=exampleuser
//       -Dtenant-configuration-persistence.git-password=examplepwd
@IfProfileValue(name = "tenant-configuration-persistence.enable", value = "true")
@RunWith(SpringRunner.class)
@SpringBootTest
@ActiveProfiles("git")
public class GitTenantConfigurationPersistenceServiceIT {

    private static final Logger logger = LoggerFactory.getLogger(GitTenantConfigurationPersistenceServiceIT.class);

    @Autowired
    private TenantConfigurationPersistenceProperties tenantConfigurationPersistenceProperties;

    @Autowired
    private GitTenantConfigurationPersistenceService tenantConfigurationPersistenceService;

    private File localRepositoryDirectory;

    @Before
    public void setup() {
        localRepositoryDirectory = new File(tenantConfigurationPersistenceProperties.getLocalRepositoryPath());
    }

    @Test
    public void getWorkingShouldCreateDirectoryIfNoneExists() throws Exception {
        FileUtils.deleteDirectory(localRepositoryDirectory);
        File workingDirectory = tenantConfigurationPersistenceService.getWorkingDirectory();
        assertThat(workingDirectory.getPath()).isEqualTo(tenantConfigurationPersistenceProperties.getLocalRepositoryPath());
        assertThat(localRepositoryDirectory.exists()).isTrue();
    }

    @Test
    public void getWorkingShouldReturnDirectoryIfItExists() throws Exception {
        FileUtils.forceMkdir(localRepositoryDirectory);
        File workingDirectory = tenantConfigurationPersistenceService.getWorkingDirectory();
        assertThat(workingDirectory.getPath()).isEqualTo(tenantConfigurationPersistenceProperties.getLocalRepositoryPath());
        assertThat(localRepositoryDirectory.exists()).isTrue();
    }

    @Test
    public void getLocalRepositoryToCleanStateShouldWorkWithMissingDirectory() throws Exception {
        FileUtils.deleteDirectory(localRepositoryDirectory);
        tenantConfigurationPersistenceService.forceLocalRepositoryToCleanState();
        assertThat(localRepositoryDirectory.exists()).isTrue();
    }

    @Test
    public void getLocalRepositoryToCleanStateShouldWipeExistingDirectory() throws Exception {
        FileUtils.forceMkdir(localRepositoryDirectory);
        tenantConfigurationPersistenceService.forceLocalRepositoryToCleanState();
        //try a clone second time, should not error
        tenantConfigurationPersistenceService.forceLocalRepositoryToCleanState();
    }

    @Test
    public void testSaveFile() throws Exception {
        ReportingSystemPropertiesImpl reporting = new ReportingSystemPropertiesImpl();
        reporting.setReportLanguages(Collections.singletonList("en"));
        reporting.setSchoolYear(2019);

        DataSourceElementsTenant dataSourceElements = new DataSourceElementsTenant();
        DataSourceUrlParts urlParts = new DataSourceUrlParts();
        urlParts.setHosts("catesthost");
        urlParts.setDatabase("catestdb");
        dataSourceElements.setUrlParts(urlParts);

        ArchivePropertiesTenant archivePropertiesTenant = new ArchivePropertiesTenant();
        archivePropertiesTenant.setPathPrefix("/CA");
        archivePropertiesTenant.setUriRoot("s3://ca-archive");

        ApplicationTenantConfiguration applicationTenantConfiguration = new ApplicationTenantConfiguration();
        applicationTenantConfiguration.setReporting(reporting);
        applicationTenantConfiguration.setDataSources(ImmutableMap.of(RDWDataSourceNames.REPORTING_RO.getName(), dataSourceElements));
        applicationTenantConfiguration.setArchiveProperties(archivePropertiesTenant);

        Tenant tenant = Tenant.builder()
                .id("CAX")
                .key("CAX")
                .name("California Test")
                .build();

        TenantConfiguration tenantConfiguration = new TenantConfiguration();
        tenantConfiguration.setApplicationTenantConfiguration(applicationTenantConfiguration);
        tenantConfiguration.setTenant(tenant);

        logger.debug("localRepositoryDirectory {}", localRepositoryDirectory.getPath());
        tenantConfigurationPersistenceService.saveTenantConfiguration(tenantConfiguration);
    }

    @Test
    public void writeLocalizationFileShouldWriteAFile() throws Exception {
        FileUtils.deleteDirectory(localRepositoryDirectory);
        FileUtils.forceMkdir(localRepositoryDirectory);
        Tenant tenant = Tenant.builder()
                .id("CAX")
                .key("CAX")
                .name("California Test")
                .build();
        tenantConfigurationPersistenceService.writeLocalization("{\"test\":\"value\"}", tenant);
        File expectedFile = new File(localRepositoryDirectory.getPath() +
                File.separator +
                "tenant-" + tenant.getKey() +
                File.separator +
                "en.json");
        System.out.println(expectedFile.getPath());
        assertThat(expectedFile.exists()).isTrue();
        String readExpected = FileUtils.readFileToString(expectedFile, "UTF-8");
        assertThat(readExpected).contains("value");
    }
}
