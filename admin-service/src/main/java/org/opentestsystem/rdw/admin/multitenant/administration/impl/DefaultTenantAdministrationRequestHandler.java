package org.opentestsystem.rdw.admin.multitenant.administration.impl;

import com.google.common.annotations.VisibleForTesting;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationProcessor;
import org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationRequestHandler;
import org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatusService;
import org.opentestsystem.rdw.admin.multitenant.configserver.ConfigServerClient;
import org.opentestsystem.rdw.admin.multitenant.database.TenantDatabaseAdminOrchestrationService;
import org.opentestsystem.rdw.admin.multitenant.git.TenantConfigurationPersistenceService;
import org.opentestsystem.rdw.admin.multitenant.model.TenantConfiguration;
import org.opentestsystem.rdw.reporting.common.security.User;
import org.opentestsystem.rdw.reporting.common.security.Users;
import org.opentestsystem.rdw.reporting.common.stream.MessageSecurityService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.cloud.stream.annotation.StreamListener;
import org.springframework.messaging.Message;
import org.springframework.messaging.MessageHeaders;
import org.springframework.messaging.support.MessageBuilder;

import java.util.HashMap;

import static org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationProcessor.SandboxCreationRequest;
import static org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationProcessor.TenantCreationRequest;
import static org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatus.CREATING_DATABASES;
import static org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatus.FAILED;
import static org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatus.NOTIFYING_CONFIG_SERVER;
import static org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatus.PERSISTING_CONFIGURATION;
import static org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatus.STARTED;

public class DefaultTenantAdministrationRequestHandler implements TenantAdministrationRequestHandler {

    private static final Logger logger = LoggerFactory.getLogger(DefaultTenantAdministrationRequestHandler.class);

    private final MessageSecurityService messageSecurityService;
    private final TenantAdministrationProcessor tenantAdministrationProcessor;
    private final TenantDatabaseAdminOrchestrationService tenantDatabaseAdminOrchestrationService;
    private final TenantConfigurationPersistenceService tenantConfigurationPersistenceService;
    private final ConfigServerClient configServerClient;
    private final TenantAdministrationStatusService tenantAdministrationStatusService;

    public DefaultTenantAdministrationRequestHandler(MessageSecurityService messageSecurityService,
                                                     TenantAdministrationProcessor tenantAdministrationProcessor,
                                                     TenantDatabaseAdminOrchestrationService tenantDatabaseAdminOrchestrationService,
                                                     TenantConfigurationPersistenceService tenantConfigurationPersistenceService,
                                                     ConfigServerClient configServerClient,
                                                     TenantAdministrationStatusService tenantAdministrationStatusService) {
        this.messageSecurityService = messageSecurityService;
        this.tenantAdministrationProcessor = tenantAdministrationProcessor;
        this.tenantDatabaseAdminOrchestrationService = tenantDatabaseAdminOrchestrationService;
        this.tenantConfigurationPersistenceService = tenantConfigurationPersistenceService;
        this.configServerClient = configServerClient;
        this.tenantAdministrationStatusService = tenantAdministrationStatusService;
    }

    @Override
    public void createTenant(TenantConfiguration tenantConfiguration) {
        logger.debug("Sending TenantCreationRequest");
        User user = getCurrentUser();
        final Message<TenantConfiguration> createTenantMessage = messageSecurityService.withUser(
                MessageBuilder.createMessage(tenantConfiguration, new MessageHeaders(new HashMap<>())),
                user);
        tenantAdministrationProcessor.tenantCreationRequest().send(createTenantMessage);
    }

    @StreamListener(TenantCreationRequest)
    @VisibleForTesting
    void createTenantAsync(final Message<TenantConfiguration> createTenantMessage) {
        TenantConfiguration tenantConfiguration = createTenantMessage.getPayload();
        final String tenantKey = tenantConfiguration.getTenant().getKey();
        try {
            tenantAdministrationStatusService.putStatus(tenantKey, STARTED, tenantConfiguration);
            logger.debug("Processing TenantCreationRequest {} {}", tenantKey, tenantConfiguration);

            tenantAdministrationStatusService.updateStatus(tenantKey, CREATING_DATABASES);
            logger.debug("Processing TenantCreationRequest createTenantDatabases {}", tenantKey);
            tenantDatabaseAdminOrchestrationService.createTenantDatabases(tenantConfiguration);

            tenantAdministrationStatusService.updateStatus(tenantKey, PERSISTING_CONFIGURATION);
            logger.debug("Processing TenantCreationRequest saveTenantConfiguration {}", tenantKey);
            tenantConfigurationPersistenceService.saveTenantConfiguration(tenantConfiguration);

            tenantAdministrationStatusService.updateStatus(tenantKey, NOTIFYING_CONFIG_SERVER);
            logger.debug("Processing TenantCreationRequest postMonitor {}", tenantKey);
            configServerClient.postMonitor();
        } catch (Exception e) {
            //catch all / rethrow to update status
            String stackTrace = ExceptionUtils.getStackTrace(e);
            tenantAdministrationStatusService.updateStatus(tenantKey, FAILED, stackTrace);
            logger.warn("Error creating tenant tenantKey: {}", tenantKey, e);
            throw e;
        }
    }

    @Override
    public void createSandbox(TenantConfiguration tenantConfiguration) {
        User user = getCurrentUser();
        final Message<TenantConfiguration> createTenantMessage = messageSecurityService.withUser(
                MessageBuilder.createMessage(tenantConfiguration, new MessageHeaders(new HashMap<>())),
                user);
        tenantAdministrationProcessor.sandboxCreationRequest().send(createTenantMessage);
    }

    @StreamListener(SandboxCreationRequest)
    @VisibleForTesting
    void createSandboxAsync(final Message<TenantConfiguration> createSandboxMessage) {
        TenantConfiguration tenantConfiguration = createSandboxMessage.getPayload();
        final String tenantKey = tenantConfiguration.getTenant().getKey();
        try {
            tenantAdministrationStatusService.putStatus(tenantKey, STARTED, tenantConfiguration);
            logger.debug("Processing SandboxCreationRequest {} {}", tenantKey, tenantConfiguration);

            tenantAdministrationStatusService.updateStatus(tenantKey, CREATING_DATABASES);
            logger.debug("Processing SandboxCreationRequest createSandboxDatabases {}", tenantKey);
            tenantDatabaseAdminOrchestrationService.createSandboxDatabases(tenantConfiguration);

            tenantAdministrationStatusService.updateStatus(tenantKey, PERSISTING_CONFIGURATION);
            logger.debug("Processing SandboxCreationRequest saveTenantConfiguration {}", tenantKey);
            tenantConfigurationPersistenceService.saveTenantConfiguration(tenantConfiguration);

            tenantAdministrationStatusService.updateStatus(tenantKey, NOTIFYING_CONFIG_SERVER);
            logger.debug("Processing SandboxCreationRequest postMonitor {}", tenantKey);
            configServerClient.postMonitor();
        } catch (Exception e) {
            //catch all / rethrow to update status
            tenantAdministrationStatusService.updateStatus(tenantKey, FAILED);
            String stackTrace = ExceptionUtils.getStackTrace(e);
            tenantAdministrationStatusService.updateStatus(tenantKey, FAILED, stackTrace);
            logger.warn("Error creating tenant tenantKey: {}", tenantKey, e);
            throw e;
        }
    }

    @VisibleForTesting
    User getCurrentUser() {
        return Users.getCurrentUser();
    }
}
