package org.opentestsystem.rdw.admin.multitenant.administration.impl;


import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import org.opentestsystem.rdw.admin.multitenant.administration.SandboxArchiveRemovalService;
import org.opentestsystem.rdw.admin.multitenant.service.TenantConfigurationViewService;
import org.opentestsystem.rdw.archive.ArchiveProperties;
import org.opentestsystem.rdw.archive.ArchiveService;
import org.opentestsystem.rdw.archive.ArchiveServiceDecorator;

public class DefaultSandboxArchiveRemovalService implements SandboxArchiveRemovalService {
    private static final Logger logger = LoggerFactory.getLogger(DefaultSandboxArchiveRemovalService.class);

    private final TenantConfigurationViewService tenantConfigurationViewService;

    public DefaultSandboxArchiveRemovalService(final TenantConfigurationViewService tenantConfigurationViewService) {
        this.tenantConfigurationViewService = tenantConfigurationViewService;

    }

    @Override
    public void remove(final String tenantKey) {
        final ArchiveProperties rootArchiveProperties =
                tenantConfigurationViewService.defaultTenantConfiguration().getArchiveProperties();

        final ArchiveService rootArchiveService = new ArchiveServiceDecorator(rootArchiveProperties);

        final String folderName = tenantKey.toLowerCase();

        try {
            logger.info("s3 delete for folder {}: key {}, pw {}, region {}, sse {}, uri {}",
                    folderName,
                    rootArchiveProperties.getS3AccessKey(),
                    org.apache.commons.codec.digest.DigestUtils.md5Hex(rootArchiveProperties.getS3SecretKey()),
                    rootArchiveProperties.getS3RegionStatic(),
                    rootArchiveProperties.getS3Sse(),
                    rootArchiveProperties.getUriRoot());

            rootArchiveService.delete(folderName);
        } catch (final Exception e) {
            logger.info("Cannot remove archives for sandbox id {}: {}", tenantKey, e.getMessage());
        }
    }
}
