package org.opentestsystem.rdw.admin.configuration.multitenant;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.opentestsystem.rdw.admin.service.impl.DefaultTenantService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Configuration;

/**
 * This contains tenant configuration - properties and localization
 */
@Configuration
public class TenantConfiguration {
    private static final Logger logger = LoggerFactory.getLogger(DefaultTenantService.class);

    private ServiceProperties serviceProperties;

    public TenantConfiguration() { }

    public ServiceProperties getServiceProperties() {
        return serviceProperties;
    }

    public void setServiceProperties(ServiceProperties serviceProperties) {
        this.serviceProperties = serviceProperties;
    }

    public static TenantConfiguration.Builder builder() {
        return new TenantConfiguration.Builder();
    }

    public static class Builder {
        private ServiceProperties serviceProperties;

        public Builder serviceProperties(final ServiceProperties serviceProperties) {
            this.serviceProperties = serviceProperties;
            return this;
        }

        public TenantConfiguration build() {
            final TenantConfiguration tenantConfiguration = new TenantConfiguration();
            tenantConfiguration.serviceProperties = serviceProperties;
            return tenantConfiguration;
        }
    }


    // parse out the Json String into service specific properties
    /*  Sample Json expectations
    {

      "serviceProperties":
        {
          "tenant":{
            "id":"CA",
            "key":"CA",
            "displayName":"California",
            "description":"This is a description"
          },
          "rdw-reporting-webapp": {
            "datasource": {
              "url-server": "rdw-aurora-",
              "username": "sbac",
              "password": "****"
            },
            "reporting": {
              "school-year": "2018",
              "transfer-access-enabled": "true",
              "translation-location": "binary-",
              "analytics-tracking-id": "UA-102446884-4",
              "interpretive-guide-url": "https://portal.smarterbalanced.org/library/en/reporting-system-interpretive-guide.pdf",
              "user-guide-url": "https://portal.smarterbalanced.org/library/en/reporting-system-user-guide.pdf",
              "access-denied-url": "forward:/assets/public/access-denied.html",
              "landing-page-url": "forward:/landing.html",
              "percentile-display-enabled": "true",
              "report-languages": "es",
              "ui-languages": "es"
            },
            "tenantOverrides": {
              "datasource": {
                "initialSize": "1",
                "maxActive": "2"
              },
              "reporting": {
                "percentile-display-enabled": "false"
              }
            }
          },
          "rdw-reporting-admin-service": {
            "reporting_datasource": {
              "url-server": "rdw-aurora-",
              "username": "sbac",
              "password": "****"
            },
            "warehouse_datasource": {
              "url-server": "rdw-aurora-",
              "username": "sbac",
              "password": "****"
            },
            "reporting": {
              "school-year": "2018",
              "transfer-access-enabled": "true",
              "translation-location": "binary-",
              "state": {
                "code": "CA",
                "name": "California"
              }
            },
            "tenantOverrides": {
              "reporting_datasource": {
                "initialSize": "1",
                "maxActive": "2"
              },
              "warehouse_datasource": {
                "initialSize": "1",
                "maxActive": "2"
              },
              "reporting": {
                "code": "CA",
                "name": "California"
              }
            }
          },
          "rdw-reporting-service": {
            "datasource": {
              "url-server": "rdw-aurora-",
              "username": "sbac",
              "password": "****"
            },
            "writable_datasource": {
              "url-server": "rdw-aurora-",
              "username": "sbac",
              "password": "****"
            },
            "reporting": {
              "school-year": "2018",
              "transfer-access-enabled": "true",
              "translation-location": "binary-",
              "student-fields": {
                "EconomicDisadvantage": "disabled",
                "LimitedEnglishProficiency": "disabled",
                "MigrantStatus": "enabled",
                "EnglishLanguageAcquisitionStatus": "enabled",
                "PrimaryLanguage": "enabled",
                "Ethnicity": "enabled",
                "Gender": "admin",
                "IndividualEducationPlan": "admin",
                "Section504": "admin"
              }
            },
            "tenantProperties": {
              "datasource": {
                "initialSize": "1",
                "maxActive": "2"
              },
              "writable_datasource": {
                "initialSize": "1",
                "maxActive": "2"
              },
              "reporting": {
                "code": "CA",
                "name": "California",
                "student-fields": {
                  "EconomicDisadvantage": "enabled"
                }
              }
            }
          },
          "rdw-reporting-report-processor": {
            "datasource": {
              "url-server": "rdw-aurora-",
              "username": "sbac",
              "password": "****"
            },
            "task": {
              "remove-stale-reports": {
                "cron": "0 0 8 * * *",
                "max-report-lifetime-days": "30",
                "max-random-minutes": "20"
              }
            }
          },
          "tenantProperties": {
            "datasource": {
              "initialSize": "1",
              "maxActive": "2"
            },
            "reporting": {
              "code": "CA",
              "name": "California"
            }
          },
          "rdw-reporting-aggregate-service": {
            "olap_datasource": {
              "initialSize": "1",
              "maxActive": "2"
            },
            "tenantProperties": {
              "reporting": {
                "code": "CA",
                "name": "California"
              }
            }
          }
        }
    }
     */

    /**
     * retrieve the tentantId from the serviceProperties Map
     * - making name vey obvious to differentiating from resolver's getTenantId()
     * @return tenantId from the serviceProperties
     */
    public String getTenantIdFromServiceProperties() {
        ObjectMapper mapper = new ObjectMapper();
        ServiceProperties serviceProperties = getServiceProperties();

        Tenant tenant = mapper.convertValue(serviceProperties.getServiceProperties().get("tenant"), Tenant.class);
        return tenant.getId();
    }


}
