package org.opentestsystem.rdw.admin.configuration.multitenant;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.opentestsystem.rdw.admin.service.impl.DefaultTenantService;
import org.opentestsystem.rdw.multitenant.TenantProperties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Configuration;

import java.util.Map;

/**
 * This contains tenant configuration - the properties and localization for a tenant
 */
@Configuration
public class TenantConfiguration {
    private static final Logger logger = LoggerFactory.getLogger(DefaultTenantService.class);

    private TenantProperties.Tenant  tenant;
    private ConfigurationProperties configurationProperties;
    private LocalizationProperties localization;
    private TenantOverride tenantOverride;


    public TenantConfiguration() { }

    public TenantProperties.Tenant getTenant() {
        return tenant;
    }

    public void setTenant(TenantProperties.Tenant  tenant) {
        this.tenant = tenant;
    }

    public ConfigurationProperties getConfigurationProperties() {
        return configurationProperties;
    }

    public void setConfigurationProperties(ConfigurationProperties configurationProperties) {
        this.configurationProperties = configurationProperties;
    }

    public TenantOverride getTenantOverride() {
        return tenantOverride;
    }

    public void setTenantOverride(TenantOverride tenantOverride) {
        this.tenantOverride = tenantOverride;
    }

    public LocalizationProperties getLocalization() {
        return localization;
    }

    public void setLocalization(LocalizationProperties localization) {
        this.localization = localization;
    }


    public static TenantConfiguration.Builder builder() {
        return new TenantConfiguration.Builder();
    }

    public static class Builder {
        private ConfigurationProperties configurationProperties;
        private TenantProperties.Tenant tenant;
        private LocalizationProperties localization;
        private TenantOverride tenantOverride;

        public Builder tenant(final TenantProperties.Tenant tenant) {
            this.tenant = tenant;
            return this;
        }

        public Builder localization(final LocalizationProperties localization) {
            this.localization = localization;
            return this;
        }

        public Builder tenantOverride(final TenantOverride tenantOverride) {
            this.tenantOverride = tenantOverride;
            return this;
        }

        public Builder configurationProperties(final ConfigurationProperties configurationProperties) {
            this.configurationProperties = configurationProperties;
            return this;
        }

        public TenantConfiguration build() {
            final TenantConfiguration tenantConfiguration = new TenantConfiguration();
            tenantConfiguration.setTenant(tenant);
            tenantConfiguration.setConfigurationProperties(configurationProperties);
            tenantConfiguration.setLocalization(localization);
            tenantConfiguration.setTenantOverride(tenantOverride);
            return tenantConfiguration;
        }
    }


    // parse out the Json String into service specific properties
    /*  Sample Json expectations
        {
           "tenant":{
              "id":"CA",
              "key":"CA",
              "name":"California",
              "description":"This is a description"
           },
           "configurationProperties":{
              "datasources":{
                 "reporting_ro":{
                    "url-server":"rdw-aurora-",
                    "username":"sbac",
                    "password":"****",
                    "initialSize":"1",
                    "maxActive":"2"
                 },
                 "warehouse_rw":{
                    "url-server":"rdw-aurora-",
                    "username":"sbac",
                    "password":"****",
                    "initialSize":"1",
                    "maxActive":"2"
                 },
                 "olap_ro":{
                    "url-server":"rdw-aurora-",
                    "username":"sbac",
                    "password":"****",
                    "initialSize":"1",
                    "maxActive":"2"
                 },
                 "reporting_rw:{
                    "url-server":"rdw-aurora-",
                    "username":"sbac",
                    "password":"****",
                    "initialSize":"1",
                    "maxActive":"2"
                 }
              },
              "reporting":{
                 "school-year":"2018",
                 "transfer-access-enabled":"true",
                 "translation-location":"binary-",
                 "analytics-tracking-id":"UA-102446884-4",
                 "interpretive-guide-url":"https://portal.smarterbalanced.org/library/en/reporting-system-interpretive-guide.pdf",
                 "user-guide-url":"https://portal.smarterbalanced.org/library/en/reporting-system-user-guide.pdf",
                 "access-denied-url":"forward:/assets/public/access-denied.html",
                 "landing-page-url":"forward:/landing.html",
                 "percentile-display-enabled":"true",
                 "report-languages":"es",
                 "ui-languages":"es",
                 "student-fields":{
                    "EconomicDisadvantage":"disabled",
                    "LimitedEnglishProficiency":"disabled",
                    "MigrantStatus":"enabled",
                    "EnglishLanguageAcquisitionStatus":"enabled",
                    "PrimaryLanguage":"enabled",
                    "Ethnicity":"enabled",
                    "Gender":"admin",
                    "IndividualEducationPlan":"admin",
                    "Section504":"admin"
                 },
                 "state":{
                    "code":"CA",
                    "name":"California"
                 }
              },
              "task":{
                 "remove-stale-reports":{
                    "cron":"0 0 8 * * *",
                    "max-report-lifetime-days":"30",
                    "max-random-minutes":"20"
                 }
              }
           },
           "tenantOverrides":{
              "tenant":{
                 "id":"CA",
                 "key":"CA",
                 "name":"California",
                 "description":"This is a description"
              },
              "configurationProperties":{
                 "datasources":{
                    "reporting_ro_datasource":{
                       "initialSize":"1",
                       "maxActive":"2"
                    },
                    "warehouse_rw_datasource":{
                       "initialSize":"1",
                       "maxActive":"2"
                    },
                    "olap_ro_datasource":{
                       "initialSize":"1",
                       "maxActive":"2"
                    },
                    "reporting_rw_datasource":{
                       "initialSize":"1",
                       "maxActive":"2"
                    }
                 },
                 "reporting":{
                    "percentile-display-enabled":"false",
                    "student-fields":{
                       "EconomicDisadvantage":"enabled"
                    },
                    "state":{
                       "code":"CA",
                       "name":"California"
                    }
                 }
              }
           }
        }
    */

    /**
     * retrieve the tentantId from the serviceProperties Map
     * - making name vey obvious to differentiating from resolver's getTenantId()
     * @return tenantId from the serviceProperties
     */
    public String getTenantIdFromOverride() {
        return tenant.getId();
    }


}
