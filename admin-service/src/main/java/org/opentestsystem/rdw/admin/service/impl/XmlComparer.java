package org.opentestsystem.rdw.admin.service.impl;

import org.opentestsystem.rdw.admin.service.Comparer;
import org.xmlunit.builder.DiffBuilder;
import org.xmlunit.builder.Input;

import static org.opentestsystem.rdw.admin.support.Strings.normalizeLineEndings;

/**
 * Comparer responsible for comparing XML
 */
public class XmlComparer implements Comparer<String> {

    /**
     * Removes the <?xml> header
     *
     * @param value The input value to remove the header from
     * @return The input value without the header
     */
    private static String removeHeader(final String value) {
        return value.replaceAll("<\\?xml(.+?)\\?>", "");
    }

    private static String normalize(final String value) {
        return removeHeader(
                normalizeLineEndings(value)
        );
    }

    @Override
    public boolean equals(final String a, final String b) {
        final String normalA = normalize(a);
        final String normalB = normalize(b);
        return !DiffBuilder
                .compare(Input.fromString(normalA).build())
                .withTest(Input.fromString(normalB).build())
                .ignoreComments()
                .ignoreWhitespace()
                .build()
                .hasDifferences();
    }

}
