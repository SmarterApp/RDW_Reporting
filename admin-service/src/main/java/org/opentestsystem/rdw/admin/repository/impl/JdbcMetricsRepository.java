package org.opentestsystem.rdw.admin.repository.impl;

import org.opentestsystem.rdw.admin.model.TenantMetric;
import org.opentestsystem.rdw.admin.repository.MetricsRepository;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;

@Repository
public class JdbcMetricsRepository implements MetricsRepository {

    private final NamedParameterJdbcTemplate template;

    @Value("${sql.metrics.findAll}")
    private String findAllQuery;

    public JdbcMetricsRepository(@Qualifier("olapJdbcTemplate") NamedParameterJdbcTemplate template) {
        this.template = template;
    }

    @Override
    public List<TenantMetric> findAllMetrics() {
        return template.query(
                findAllQuery,
                (row, index) -> toTenantMetric(row)
        );
    }

    private static TenantMetric toTenantMetric(final ResultSet row) throws SQLException {
        return TenantMetric.builder()
                .type(row.getString("category"))
                .schoolYear(row.getInt("school_year"))
                .subjectCode(row.getString("subject_code"))
                .assessmentType(row.getString("asmt_type"))
                .count(row.getInt("cnt"))
                .build();
    }
}
