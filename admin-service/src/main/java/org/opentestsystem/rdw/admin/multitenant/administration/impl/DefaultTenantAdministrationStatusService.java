package org.opentestsystem.rdw.admin.multitenant.administration.impl;

import com.google.common.collect.ImmutableMap;
import org.apache.commons.lang3.StringUtils;
import org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatus;
import org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatusContext;
import org.opentestsystem.rdw.admin.multitenant.administration.TenantAdministrationStatusService;
import org.opentestsystem.rdw.multitenant.Tenant;

import java.time.Instant;
import java.util.Optional;
import java.util.concurrent.ConcurrentHashMap;

public class DefaultTenantAdministrationStatusService implements TenantAdministrationStatusService {

    private final ConcurrentHashMap<String, TenantAdministrationStatusContext> statusMap;

    public DefaultTenantAdministrationStatusService() {
        statusMap = new ConcurrentHashMap<>();
    }

    @Override
    public ImmutableMap<String, TenantAdministrationStatusContext> allTenantStatusAsMap() {
        return ImmutableMap.copyOf(statusMap);
    }

    @Override
    public void putStatus(String tenantKey, TenantAdministrationStatus status, Tenant tenant) {
        statusMap.put(tenantKey,
                TenantAdministrationStatusContext.builder()
                        .tenant(tenant)
                        .tenantAdministrationStatus(status)
                        .build());
    }

    @Override
    public void updateStatus(String tenantKey, TenantAdministrationStatus status) {
        // update entry for tenant with status
        // keep existing tenant and updated
        // clear error message and stack trace
        updateStatus(tenantKey, status, null, null, null, null);
    }

    @Override
    public void updateStatus(String tenantKey, TenantAdministrationStatus status, String message, String stackTrace) {
        // update entry for tenant with status
        // keep existing tenant and updated
        // set error message and stack trace
        updateStatus(tenantKey, status, null, message, stackTrace, null);
    }

    @Override
    public void updateStatus(String tenantKey, TenantAdministrationStatus status, Tenant tenant, Instant updated) {
        // update entry for tenant with status, tenant and updated
        // clear error message and stack trace
        updateStatus(tenantKey, status, tenant, null, null, updated);
    }

    @Override
    public Optional<TenantAdministrationStatusContext> findStatus(String tenantKey) {
        return Optional.ofNullable(statusMap.get(tenantKey));
    }

    @Override
    public Optional<TenantAdministrationStatusContext> findStatusById(final String tenantId) {
        return statusMap.values()
                .stream()
                .filter(s -> s != null && s.getTenant() != null &&
                        StringUtils.equalsIgnoreCase(tenantId, s.getTenant().getId()))
                .findAny();
    }

    @Override
    public void remove(String tenantKey) {
        statusMap.remove(tenantKey);
    }

    private void updateStatus(String tenantKey, TenantAdministrationStatus status, Tenant tenant, String message, String stackTrace, Instant updated) {
        Optional.ofNullable(statusMap.get(tenantKey)).ifPresent(currentContext -> {
                    TenantAdministrationStatusContext newContext = TenantAdministrationStatusContext
                            .builder()
                            .tenantAdministrationStatus(status)
                            .message(message)
                            .stackTrace(stackTrace)
                            .tenant(
                                    Optional.ofNullable(tenant)
                                            .orElse(currentContext.getTenant())
                            )
                            .updated(
                                    Optional.ofNullable(updated)
                                            .orElse(currentContext.getUpdated())
                            )
                            .build();
                    statusMap.put(tenantKey, newContext);
                }
        );
    }

}
