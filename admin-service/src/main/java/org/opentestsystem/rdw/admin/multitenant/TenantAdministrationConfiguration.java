package org.opentestsystem.rdw.admin.multitenant;

import org.opentestsystem.rdw.admin.client.ConfigServerClient;
import org.opentestsystem.rdw.admin.multitenant.database.MultitenantDatabaseAdmin;
import org.opentestsystem.rdw.admin.multitenant.database.TenantDatabaseCreationService;
import org.opentestsystem.rdw.admin.multitenant.database.impl.DefaultTenantDatabaseCreationService;
import org.opentestsystem.rdw.admin.multitenant.git.GitTenantConfigurationPersistenceService;
import org.opentestsystem.rdw.admin.multitenant.git.TenantConfigurationPersistenceProperties;
import org.opentestsystem.rdw.admin.multitenant.git.TenantConfigurationPersistenceService;
import org.opentestsystem.rdw.reporting.common.stream.MessageSecurityService;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.sql.DataSource;

@Configuration
public class TenantAdministrationConfiguration {

    @Value("${tenant.tenantAdministration.statusService.maximumSize:100}")
    Integer statusServiceMaximumSize;

    @Value("${tenant.tenantAdministration.statusService.expireAfterDays:4}")
    Integer statusServiceExpireAfterDays;

    @Bean
    public DefaultTenantDatabaseCreationService tenantDatabaseCreationService(final MultitenantDatabaseAdmin multitenantDatabaseAdmin,
                                                                              @Qualifier("adminReportingDataSource") final DataSource adminReportingDataSource,
                                                                              @Qualifier("adminWarehouseDataSource") final DataSource adminWarehouseDataSource,
                                                                              @Qualifier("adminOlapDataSource") final DataSource adminOlapDataSource) {
        return new DefaultTenantDatabaseCreationService(multitenantDatabaseAdmin,
                adminReportingDataSource,
                adminWarehouseDataSource,
                adminOlapDataSource);
    }

    @Bean
    public GitTenantConfigurationPersistenceService tenantConfigurationPersistenceService(TenantConfigurationPersistenceProperties tenantConfigurationPersistenceProperties) {
        return new GitTenantConfigurationPersistenceService(tenantConfigurationPersistenceProperties);
    }

    @Bean
    public DefaultTenantAdministrationRequestHandler tenantAdministrationRequestHandler(MessageSecurityService messageSecurityService,
                                                                                        TenantAdministrationProcessor tenantAdministrationProcessor,
                                                                                        TenantDatabaseCreationService tenantDatabaseCreationService,
                                                                                        TenantConfigurationPersistenceService tenantConfigurationPersistenceService,
                                                                                        ConfigServerClient configServerClient,
                                                                                        TenantAdministrationStatusService tenantAdministrationStatusService) {
        return new DefaultTenantAdministrationRequestHandler(messageSecurityService,
                tenantAdministrationProcessor,
                tenantDatabaseCreationService,
                tenantConfigurationPersistenceService,
                configServerClient,
                tenantAdministrationStatusService);
    }

    @Bean
    public TenantAdministrationStatusService tenantAdministrationStatusService() {
        return new GuavaCacheTenantAdministrationStatusService(statusServiceMaximumSize, statusServiceExpireAfterDays);
    }

}
