package org.opentestsystem.rdw.admin.repository.impl;

import org.opentestsystem.rdw.admin.model.PipelineScript;
import org.opentestsystem.rdw.admin.repository.PipelineScriptRepository;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.dao.EmptyResultDataAccessException;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.NoSuchElementException;

@Repository
class JdbcPipelineScriptRepository implements PipelineScriptRepository {

    private final NamedParameterJdbcTemplate template;

    @Value("${sql.pipeline-script.findAllByPipeline}")
    private String findAllByPipeline;

    @Value("${sql.pipeline-script.findById}")
    private String findById;

    @Value("${sql.pipeline-script.create}")
    private String create;

    @Value("${sql.pipeline-script.update}")
    private String update;

    JdbcPipelineScriptRepository(@Qualifier("warehouseJdbcTemplate") final NamedParameterJdbcTemplate template) {
        this.template = template;
    }

    @Override
    public List<PipelineScript> findAllByPipeline(final int pipelineId) {
        return template.query(
                findAllByPipeline,
                new MapSqlParameterSource("pipeline_id", pipelineId),
                (row, index) -> PipelineScript.builder()
                        .id(row.getInt("id"))
                        .pipelineId(row.getInt("pipeline_id"))
                        .created(row.getTimestamp("created").toInstant())
                        .updated(row.getTimestamp("updated").toInstant())
                        .updatedBy(row.getString("updated_by"))
                        .build()
        );
    }

    @Override
    public PipelineScript findById(final int id) {
        try {
            return template.queryForObject(
                    findById,
                    new MapSqlParameterSource("id", id),
                    (row, index) -> PipelineScript.builder()
                            .id(row.getInt("id"))
                            .pipelineId(row.getInt("pipeline_id"))
                            .body(row.getString("body"))
                            .created(row.getTimestamp("created").toInstant())
                            .updated(row.getTimestamp("updated").toInstant())
                            .updatedBy(row.getString("updated_by"))
                            .build()
            );
        } catch (final EmptyResultDataAccessException ignored) {
            return null;
        }
    }

    @Override
    public PipelineScript create(final PipelineScript script) {
        final GeneratedKeyHolder keyHolder = new GeneratedKeyHolder();
        final int insertCount = template.update(
                create,
                new MapSqlParameterSource()
                        .addValue("pipeline_id", script.getPipelineId())
                        .addValue("body", script.getBody())
                        .addValue("updated_by", script.getUpdatedBy()),
                keyHolder
        );
        if (insertCount != 1) {
            throw new IllegalStateException("Unable to create pipeline script");
        }
        return findById(keyHolder.getKey().intValue());
    }

    @Override
    @Transactional(transactionManager = "warehouseTxManager")
    public PipelineScript update(final PipelineScript script) {
        final int updateCount = template.update(
                update,
                new MapSqlParameterSource()
                        .addValue("id", script.getId())
                        .addValue("body", script.getBody())
                        .addValue("updated_by", script.getUpdatedBy())
        );

        if (updateCount != 1) {
            throw new NoSuchElementException(String.format(
                    "Unable to update pipeline script with id \"%s\" for user \"%s\"",
                    script.getId(), script.getUpdatedBy()
            ));
        }
        return findById(script.getId());
    }

}
