package org.opentestsystem.rdw.admin.multitenant.configserver;

import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.ByteArrayHttpMessageConverter;
import org.springframework.web.client.RestTemplate;

import java.io.FileOutputStream;
import java.util.Arrays;
import java.util.Optional;

/**
 * Client to retrieve the config server's uri to call the encrypt,decrypt, monitor (refresh) endpoints and to retrieve i18n localization files
 * And call a service to retrieve the datasource's unmasked password
 */
public class DefaultConfigServerClient implements ConfigServerClient {
    private static final Logger logger = LoggerFactory.getLogger(DefaultConfigServerClient.class);

    private String configServerUri;
    private RestTemplate restTemplate = new RestTemplate();

    @Autowired
    public DefaultConfigServerClient(@Value("${spring.cloud.config.uri}") final String configServerUri) {
        this.configServerUri = configServerUri;
    }

    @Override
    public void postMonitor() {
        final String configServerUriEndpoint = getConfigServerUriEndpoint("/monitor");
        try {
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
            HttpEntity<String> request = new HttpEntity<>("path=*", headers);
            ResponseEntity<String> responseEntity = restTemplate.postForEntity(configServerUriEndpoint, request, String.class);
            logger.debug("Successfully called {} returned {}.", configServerUriEndpoint, responseEntity.getStatusCode());
        } catch (Exception e) {
            String errorMsg = String.format("Cannot contact %s at this time, failed to refresh properties.", configServerUriEndpoint);
            logger.error(errorMsg, e);
            throw new IllegalArgumentException(errorMsg);
        }
    }

    @Override
    public String getActualServicePassword(final String service) {
        final String configServerUriEndpoint = getServiceEndpoint(service);
        try {
            ResponseEntity<String> responseEntity = restTemplate.getForEntity(configServerUriEndpoint, String.class);
            logger.debug("Successfully called {} returned {}.", configServerUriEndpoint, responseEntity.getStatusCode());
            return responseEntity.getBody();
        } catch (Exception e) {
            String errorMsg = String.format("Cannot contact %s at this time.", configServerUriEndpoint);
            logger.error(errorMsg, e);
            throw new IllegalArgumentException(errorMsg);
        }
    }

    @Override
    public String getActualReportingROPasswordProps() throws IllegalArgumentException {
        return getActualServicePassword(RDWServices.RDW_REPORTING_REPORT_PROCESSOR.getName());
    }

    @Override
    public String getActualOlapROPasswordProps() throws IllegalArgumentException {
        return getActualServicePassword(RDWServices.RDW_REPORTING_REPORT_AGGREGATE.getName());
    }

    @Override
    public String getActualWarehouseRWPasswordProps() throws IllegalArgumentException {
        return getActualServicePassword(RDWServices.RDW_REPORTING_SERVICE.getName());
    }

    @Override
    public String getActualReportingRWPasswordProps() {
        return getActualServicePassword(RDWServices.RDW_REPORTING_SERVICE.getName());
    }

    @Override
    public String encryptPassword(final String password) {
        return configPassword(getConfigServerUriEndpoint("/encrypt"), password);
    }

    @Override
    public String decryptPassword(final String password) {
        return configPassword(getConfigServerUriEndpoint("/decrypt"), password);
    }

    /**
     * @return httpHeaders for Text plain contentType
     */
    private HttpHeaders getHeaders() {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.TEXT_PLAIN);
        return headers;
    }

    /**
     * @param configServerUriEndpoint the encrypt or decrypt endpoint to call
     * @param password                the password to encrypt or decrypt
     * @return the encrypted or decrypted password
     */
    private String configPassword(final String configServerUriEndpoint, final String password) {
        try {
            HttpHeaders headers = getHeaders();
            HttpEntity<String> request = new HttpEntity<>(password, headers);
            ResponseEntity<String> responseEntity = restTemplate.postForEntity(configServerUriEndpoint, request, String.class);
            logger.debug("Successfully called {} returned {}.", configServerUriEndpoint, responseEntity.getStatusCode());
            return responseEntity.getBody();
        } catch (Exception e) {
            String errorMsg = String.format("Cannot contact %s at this time.", configServerUriEndpoint);
            logger.error(errorMsg, e);
            throw new IllegalArgumentException(errorMsg);
        }
    }

    @Override
    public Optional<String> getLocalization(String path, String languageCode) {
        // expect tenant location endpoint will look like the following:binary-{configServerUri}/*/*/master/i18n/tenant-CA/en.json
        if (path != null && !path.isEmpty() && languageCode != null && !languageCode.isEmpty()) {
            try {
                final String updatedPath = StringUtils.removeStart(path, "binary-${spring.cloud.config.uri}");
                final String templateForObject = restTemplate.getForObject(getLocalizationEndpoint(updatedPath, languageCode), String.class);
                logger.debug("Successfully called {} returned {}.", getLocalizationEndpoint(path, languageCode), templateForObject);
                return Optional.of(templateForObject);
            } catch (Exception e) {
                logger.error("Cannot contact {} at this time, failed to retrieve localization information.", getLocalizationEndpoint(path, languageCode), e);
                return Optional.empty();
            }
        }
        logger.debug("No specific i18n file exists ({}) at this time, using defaults.", getLocalizationEndpoint(path, languageCode));
        return Optional.empty();
    }

    /**
     * @param endpoint to query
     * @return the configServer's uri with the endpoint
     */
    private String getConfigServerUriEndpoint(final String endpoint) {
        return String.format("%s/%s", configServerUri, endpoint);
    }

    /**
     * @param serviceName to query
     * @return endpoint for service name
     */
    private String getServiceEndpoint(final String serviceName) {
        return getConfigServerUriEndpoint(String.format("%s/*", serviceName));
    }

    /**
     * @param path         of the i18n file, tenant and sandbox paths are expected to be set
     * @param languageCode is expected to be the name of the i18n file {languageCode}.json (with a json extension)
     * @return the endpoint to query to retrieve the location data
     */
    private String getLocalizationEndpoint(String path, String languageCode) {
        return String.format("%s/%s/%s.json", configServerUri, path, languageCode);
    }
}
