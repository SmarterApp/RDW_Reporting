package org.opentestsystem.rdw.admin.multitenant.configserver;

import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.dataformat.yaml.YAMLFactory;
import com.fasterxml.jackson.dataformat.yaml.YAMLGenerator;
import org.apache.commons.lang3.StringUtils;
import org.opentestsystem.rdw.admin.multitenant.model.ApplicationTenantConfigurationPersistence;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.util.PropertyPlaceholderHelper;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.RestTemplate;

import java.util.Optional;
import java.util.Properties;

/**
 * Client to retrieve the config server's uri to call the encrypt,decrypt, monitor (refresh) endpoints and to retrieve i18n localization files
 * And call a service to retrieve the datasource's unmasked password
 */
public class DefaultConfigServerClient implements ConfigServerClient {
    private static final Logger logger = LoggerFactory.getLogger(DefaultConfigServerClient.class);

    private final String configServerUri;
    private final RestTemplate restTemplate = new RestTemplate();
    private final ObjectMapper ymlMapper;
    private final PropertyPlaceholderHelper placeholderHelper;

    @Autowired
    public DefaultConfigServerClient(@Value("${spring.cloud.config.uri}") final String configServerUri) {
        this.configServerUri = configServerUri;
        ymlMapper = new ObjectMapper(new YAMLFactory().disable(YAMLGenerator.Feature.WRITE_DOC_START_MARKER));
        ymlMapper.findAndRegisterModules();
        ymlMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        placeholderHelper = new PropertyPlaceholderHelper("${", "}");
    }

    @Override
    public void postMonitor() {
        final String configServerUriEndpoint = getConfigServerUriEndpoint("/monitor");
        try {
            final HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
            final HttpEntity<String> request = new HttpEntity<>("path=*", headers);
            final ResponseEntity<String> responseEntity = restTemplate.postForEntity(configServerUriEndpoint, request, String.class);
            logger.debug("Successfully called {} returned {}.", configServerUriEndpoint, responseEntity.getStatusCode());
        } catch (final Exception e) {
            final String errorMsg = String.format("Cannot contact %s at this time, failed to refresh properties.", configServerUriEndpoint);
            throw new IllegalArgumentException(errorMsg, e);
        }
    }

    @Override
    public String encryptPassword(final String password) {
        return configPassword(getConfigServerUriEndpoint("/encrypt"), password);
    }

    @Override
    public String decryptPassword(final String password) {
        return configPassword(getConfigServerUriEndpoint("/decrypt"), password);
    }

    public Optional<ApplicationTenantConfigurationPersistence> findApplicationTenantConfigurationPersistence(String tenantKey) {
        final String tenantConfigEndpoint = configServerUri + "/*/*/master/tenant-" + tenantKey + "/application.yml";

        try {
            final ResponseEntity<String> responseEntity = restTemplate.getForEntity(tenantConfigEndpoint, String.class);
            logger.debug("Successfully called {} returned {}.", configServerUri, responseEntity.getStatusCode());
            return Optional.of(ymlMapper.readValue(responseEntity.getBody(), ApplicationTenantConfigurationPersistence.class));
        } catch (final HttpClientErrorException e) {
            //rethrow HTTP errors for everything except not found
            if (e.getStatusCode() == HttpStatus.NOT_FOUND) {
                return Optional.empty();
            }
            throw e;
        } catch (Exception e) {
            throw new IllegalStateException("Error processing request", e);
        }
    }

    /**
     * @return httpHeaders for Text plain contentType
     */
    private HttpHeaders getHeaders() {
        final HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.TEXT_PLAIN);
        return headers;
    }

    /**
     * @param configServerUriEndpoint the encrypt or decrypt endpoint to call
     * @param password                the password to encrypt or decrypt
     * @return the encrypted or decrypted password
     */
    private String configPassword(final String configServerUriEndpoint, final String password) {
        try {
            final HttpHeaders headers = getHeaders();
            final HttpEntity<String> request = new HttpEntity<>(password, headers);
            final ResponseEntity<String> responseEntity = restTemplate.postForEntity(configServerUriEndpoint, request, String.class);
            logger.debug("Successfully called {} returned {}.", configServerUriEndpoint, responseEntity.getStatusCode());
            return responseEntity.getBody();
        } catch (final Exception e) {
            final String errorMsg = String.format("Cannot contact %s at this time.", configServerUriEndpoint);
            throw new IllegalArgumentException(errorMsg, e);
        }
    }

    @Override
    public Optional<String> getLocalization(final String path, final String languageCode) {
        if (path != null && !path.isEmpty() && languageCode != null && !languageCode.isEmpty()) {
            // expect tenant location endpoint will look like the following:binary-{spring.cloud.config.uri}/*/*/master/i18n/tenant-CA/en.json
            // remove unneeded prefix - can use path as is
            final String updatedPath = StringUtils.removeStart(path, "binary-");

            //replace ${spring.cloud.config.uri} manually (only fully resolved in configprops)
            final Properties properties = new Properties();
            properties.put("spring.cloud.config.uri", configServerUri);
            final String placeholderPath = placeholderHelper.replacePlaceholders(updatedPath, properties);

            try {
                final String templateForObject = restTemplate.getForObject(getLocalizationFileEndpoint(placeholderPath, languageCode), String.class);
                logger.debug("Successfully called {} returned {}.", getLocalizationFileEndpoint(placeholderPath, languageCode), templateForObject);
                return Optional.of(templateForObject);
            } catch (final Exception e) {
                logger.error("Cannot contact {} at this time, failed to retrieve localization information.", getLocalizationFileEndpoint(placeholderPath, languageCode), e);
                return Optional.empty();
            }
        }
        logger.debug("No path exists for the tenant specific i18n file ({}.json), using defaults.", languageCode);
        return Optional.empty();
    }

    /**
     * @param endpoint to query
     * @return the configServer's uri with the endpoint
     */
    private String getConfigServerUriEndpoint(final String endpoint) {
        return String.format("%s/%s", configServerUri, endpoint);
    }

    /**
     * @param serviceName to query
     * @return endpoint for service name
     */
    private String getServiceEndpoint(final String serviceName) {
        return getConfigServerUriEndpoint(String.format("%s/*", serviceName));
    }

    /**
     * @param path         of the i18n file, tenant and sandbox paths are expected to be set
     * @param languageCode is expected to be the name of the i18n file {languageCode}.json (with a json extension)
     * @return the endpoint to query to retrieve the location data
     */
    private String getLocalizationFileEndpoint(final String path, final String languageCode) {
        return String.format("%s%s.json", path, languageCode);
    }
}
