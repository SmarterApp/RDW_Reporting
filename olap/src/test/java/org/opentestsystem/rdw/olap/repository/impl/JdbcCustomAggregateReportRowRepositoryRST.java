package org.opentestsystem.rdw.olap.repository.impl;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.olap.model.Assessment;
import org.opentestsystem.rdw.olap.model.Dimension;
import org.opentestsystem.rdw.olap.model.Measures;
import org.opentestsystem.rdw.olap.model.Organization;
import org.opentestsystem.rdw.olap.model.ReportQuery;
import org.opentestsystem.rdw.olap.model.ReportRow;
import org.opentestsystem.rdw.olap.repository.CustomAggregateReportRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Import;
import org.springframework.test.context.jdbc.Sql;

import java.util.List;

import static com.google.common.collect.ImmutableSet.of;
import static java.util.stream.Collectors.toSet;
import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.olap.model.DimensionType.Ethnicity;
import static org.opentestsystem.rdw.olap.model.DimensionType.Gender;
import static org.opentestsystem.rdw.olap.model.DimensionType.Overall;
import static org.opentestsystem.rdw.reporting.common.model.OrganizationType.State;

@Import(JdbcCustomAggregateReportRowRepository.class)
@Sql(scripts = {
        "classpath:OlapCodesSetup.sql",
        "classpath:OlapEntitiesSetup.sql"
})
public class JdbcCustomAggregateReportRowRepositoryRST extends RepositoryBackedIT {

    @Autowired
    private CustomAggregateReportRepository reportRepository;

    private ReportRow stateOverall;
    private ReportRow.Builder rowBuilder;
    private ReportQuery.Builder queryBuilder;

    @Before
    public void setUp() {
        queryBuilder = ReportQuery.builder()
                .asmtGrades(of(-8))
                .includeState(true)
                .schoolYears(of(1999))
                .subjectIds(of(1))
                .dimension(Overall);

        rowBuilder = ReportRow.builder()
                .assessment(new Assessment(-8, -8, 1))
                .examSchoolYear(1999);

        stateOverall = rowBuilder
                .organization(new Organization(null, null, State))
                .dimension(new Dimension(null, Overall))
                .measures(Measures.builder()
                        .avgScaleScore((int) Math.round(of(2500, 2400, 2300, 2100, 2000).stream().mapToDouble(a -> a).average().getAsDouble()))
                        .avgStdErr((int) Math.round(Math.sqrt(((25 * 25) + (24 * 24) + (23 * 23) + (21 * 21) + (20 * 20)) / 5)))
                        .level1Count(2)
                        .level2Count(1)
                        .level3Count(1)
                        .level4Count(1)
                        .build())
                .build();
    }

    @Test
    public void itShouldFindByQuery() {
        assertThat(reportRepository.findByQuery(queryBuilder.build())).usingFieldByFieldElementComparator().containsExactly(stateOverall);
        assertThat(reportRepository.findByQuery(queryBuilder.subjectIds(of(2)).build())).isEmpty();
    }

    @Test
    public void itShouldChooseAllOrganizationOverList() {
        assertThat(reportRepository.findByQuery(queryBuilder
                .includeState(false).schoolIds(of(-100))
                .includeAllSchools(true)
                .build()).size()).isEqualTo(2);

        assertThat(reportRepository.findByQuery(queryBuilder
                .includeState(false)
                .districtIds(of(-100))
                .includeAllSchools(false)
                .includeAllDistricts(true)
                .build()).size()).isEqualTo(2);
    }

    @Test
    public void itShouldFindByQueryAllSchoolsAndDistricts() {
        assertThat(reportRepository.findByQuery(queryBuilder
                .includeAllDistricts(true)
                .includeAllSchools(true)
                .build()).size()).isEqualTo(5);
    }

    @Test
    public void itShouldFindByQueryWithGender() {
        // TODO: this needs to be fixed, need to fill in missing genders
        assertThat(reportRepository.findByQuery(queryBuilder
                .includeState(false)
                .schoolIds(of(-9))
                .dimensions(of(Gender))
                .build()).size()).isEqualTo(1);
    }

    @Test
    public void itShouldFindByQueryWithEthnicity() {
        assertThat(reportRepository.findByQuery(queryBuilder
                .includeState(false)
                .districtIds(of(-99))
                .dimensions(of(Ethnicity))
                .build()).size()).isZero();

        // TODO: this needs to be fixed, need to fill in ethnicity
        assertThat(reportRepository.findByQuery(queryBuilder.
                includeState(false)
                .districtIds(of(-9))
                .dimensions(of(Ethnicity))
                .build()).size()).isEqualTo(1);

        assertThat(reportRepository.findByQuery(queryBuilder.
                includeState(true)
                .includeAllDistricts(true)
                .includeAllSchools(true)
                .dimensions(of(Ethnicity))
                .build()).size()).isEqualTo(11);
    }

    @Test
    public void itShouldFindByQueryWithMultipleValuesOfDiffParams() {
        final List<ReportRow> reportRows = reportRepository.findByQuery(queryBuilder
                .asmtGrades(of(-8, -9))
                .subjectIds(of(1, 2))
                .schoolYears(of(1999, 2000))
                .dimensions(of(Ethnicity, Gender, Overall))
                .build());

        assertThat(reportRows.size()).isEqualTo(15);
        assertThat(reportRows.stream().map(ReportRow::getOrganization).distinct().collect(toSet()))
                .usingFieldByFieldElementComparator()
                .containsOnly(new Organization(null, null, State));

        assertThat(reportRows.stream().map(ReportRow::getAssessment).distinct().collect(toSet()))
                .usingFieldByFieldElementComparator().containsExactlyInAnyOrder(
                new Assessment(-8, -8, 1),
                new Assessment(-9, -9, 2),
                new Assessment(-10, -9, 2));

        assertThat(reportRows.stream().map(ReportRow::getExamSchoolYear).filter(y -> (y == 1999)).count()).isEqualTo(9);
        assertThat(reportRows.stream().map(ReportRow::getExamSchoolYear).filter(y -> (y == 2000)).count()).isEqualTo(6);
        assertThat(reportRows.stream().map(ReportRow::getAssessment).filter(a -> (a.getSubjectId() == 1)).count()).isEqualTo(6);
        assertThat(reportRows.stream().map(ReportRow::getAssessment).filter(a -> (a.getSubjectId() == 2)).count()).isEqualTo(9);
    }
}