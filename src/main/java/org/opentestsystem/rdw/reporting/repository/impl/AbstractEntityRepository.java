package org.opentestsystem.rdw.reporting.repository.impl;

import org.opentestsystem.rdw.reporting.repository.EntityRepository;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;

import javax.validation.constraints.NotNull;
import java.util.Collection;
import java.util.Map;

import static com.google.common.collect.Maps.newHashMap;

public class AbstractEntityRepository implements EntityRepository {

	private final NamedParameterJdbcTemplate jdbcTemplate;
	private final String findAllIdsQuery;

	public AbstractEntityRepository(
		final @NotNull NamedParameterJdbcTemplate jdbcTemplate,
		final @NotNull String findAllIdsQuery) {
		this.jdbcTemplate = jdbcTemplate;
		this.findAllIdsQuery = findAllIdsQuery;
	}

	public Map<String, Long> findAllIds(Collection<String> naturalIds) {
		final Map<String, Long> idsByNaturalId = newHashMap();
		if (naturalIds != null && !naturalIds.isEmpty()) {
			jdbcTemplate.query(
				findAllIdsQuery,
				new MapSqlParameterSource("naturalIds", naturalIds),
				(row, index) -> {
					idsByNaturalId.put(row.getString("natural_id"), row.getLong("id"));
					return (Void) null;
				});
		}
		return idsByNaturalId;
	}

}
