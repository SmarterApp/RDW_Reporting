package org.opentestsystem.rdw.reporting.service.impl;

import org.opentestsystem.rdw.reporting.model.ExamReport;
import org.opentestsystem.rdw.reporting.model.ExamReportExportOptions;
import org.opentestsystem.rdw.reporting.model.PdfOptions;
import org.opentestsystem.rdw.reporting.model.Template;
import org.opentestsystem.rdw.reporting.service.ExamReportExportService;
import org.opentestsystem.rdw.reporting.service.HtmlToPdfService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;

import javax.servlet.http.HttpServletResponse;
import javax.validation.constraints.NotNull;
import java.io.IOException;

@Service
public class ExamReportExportServiceImpl implements ExamReportExportService {

    private final Template examTemplate;
    private final HtmlToPdfService htmlToPdfService;

    @Autowired
    public ExamReportExportServiceImpl(
            final @NotNull @Qualifier("examReportTemplate") Template examReportTemplate,
            final @NotNull HtmlToPdfService htmlToPdfService) {
        this.examTemplate = examReportTemplate;
        this.htmlToPdfService = htmlToPdfService;
    }

    @Override
    public void exportPDF(
            final @NotNull ExamReport report,
            final @NotNull ExamReportExportOptions options,
            final @NotNull HttpServletResponse response) throws RuntimeException {

        final byte[] html = examTemplate.render(report, options.getLocale());

        final PdfOptions pdfOptions = new PdfOptions(options.isGrayscale());
        final byte[] pdf = htmlToPdfService.createPDF(html, pdfOptions);

        // TODO make name reflect exam
        final String filename = "report.pdf";
        response.setHeader("Content-disposition", "attachment; filename=" + filename);
        response.setContentType(MediaType.APPLICATION_PDF_VALUE);
        response.setContentLength(pdf.length);
        try {
            response.getOutputStream().write(pdf);
            response.getOutputStream().flush();
        } catch (IOException exception) {
            throw new RuntimeException("Error exporting exam as PDF", exception);
        }
    }

}
