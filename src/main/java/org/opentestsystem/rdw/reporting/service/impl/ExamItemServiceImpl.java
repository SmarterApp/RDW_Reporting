package org.opentestsystem.rdw.reporting.service.impl;

import com.google.common.io.ByteStreams;
import org.apache.tomcat.util.http.fileupload.IOUtils;
import org.apache.xerces.impl.dv.util.Base64;
import org.opentestsystem.rdw.reporting.model.ExamItem;
import org.opentestsystem.rdw.reporting.model.Rubric;
import org.opentestsystem.rdw.reporting.repository.ArtifactRepository;
import org.opentestsystem.rdw.reporting.service.ExamItemService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;

import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathException;
import javax.xml.xpath.XPathFactory;
import javax.xml.xpath.XPathExpressionException;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.URLConnection;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

// TODO: Implement authorization
public class ExamItemServiceImpl implements ExamItemService {
    private ArtifactRepository artifactRepository;
    private static final Logger logger = LoggerFactory.getLogger(ExamItemServiceImpl.class);

    public ExamItemServiceImpl(ArtifactRepository artifactRepository) {
        this.artifactRepository = artifactRepository;
    }

    @Override
    public ExamItem getById(String id) {
        try {
            Document xmlDoc = getXmlDocument(id);

            XPath xPath = XPathFactory
                .newInstance()
                .newXPath();

            Node rubriclistNode = (Node) xPath
                .compile("/itemrelease/item/content/rubriclist")
                .evaluate(xmlDoc, XPathConstants.NODE);

            NodeList nodes = (NodeList) xPath.evaluate("./rubric", rubriclistNode, XPathConstants.NODESET);

            ExamItem examItem = new ExamItem()
                .builder()
                .id(id)
                .rubrics(getRubrics(xPath, nodes, id)                )
                .build();

            return examItem;
        } catch (IOException e) {
            logger.warn(e.getMessage(), e);
            throw new RuntimeException("Error reading the item xml for id: " + id);
        } catch (SAXException | XPathException | ParserConfigurationException e) {
            logger.warn(e.getMessage(), e);
            throw new RuntimeException("Error parsing the item xml for id: " + id);
        }
    }

    private Document getXmlDocument(String id) throws IOException, SAXException, ParserConfigurationException {
        DocumentBuilderFactory builder = DocumentBuilderFactory.newInstance();

        builder.setValidating(false);
        builder.setIgnoringComments(false);
        builder.setIgnoringElementContentWhitespace(true);
        builder.setNamespaceAware(true);

        InputStream fileStream = artifactRepository.getItemXml(id);
        return builder
            .newDocumentBuilder()
            .parse(fileStream);
    }

    private List<Rubric> getRubrics(XPath xPath, NodeList nodes, String id){
        return IntStream
            .range(0, nodes.getLength())
            .mapToObj(nodes::item)
            .map(node -> getRubric(xPath, node, id))
            .collect(Collectors.toList());
    }

    private Rubric getRubric(XPath xPath, Node node, String id){
        try {
            return new Rubric()
                .builder()
                .name(xPath.evaluate("./name", node))
                .template(encodeImages(xPath.evaluate("./val", node), id))
                .build();
        } catch (XPathExpressionException | IOException e) {
            logger.warn("Error while parsing rubric xml.", e);
            return new Rubric();
        }
    }

    private String encodeImages(String html, String id) throws IOException {
        String imgRegex = "<img[^>]+src\\s*=\\s*['\"]([^'\"]+)['\"][^>]*>";
        String result = html;

        Matcher matcher = Pattern.compile(imgRegex).matcher(html);

        while (matcher.find()) {
            String imgSrc = matcher.group(1);
            InputStream imageStream = artifactRepository.getArtifactFromItemDir(id, imgSrc);
            String encoding = Base64.encode(ByteStreams.toByteArray(imageStream));

            String mimeType = URLConnection.guessContentTypeFromName(imgSrc);
            result = result.replace(imgSrc, "data:" + mimeType + ";base64," + encoding);
            matcher.end();
        }

        return result;
    }
}
