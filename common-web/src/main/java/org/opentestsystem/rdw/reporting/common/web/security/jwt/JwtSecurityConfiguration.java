package org.opentestsystem.rdw.reporting.common.web.security.jwt;

import com.fasterxml.jackson.annotation.JsonTypeInfo;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.guava.GuavaModule;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.reporting.common.web.security.jackson2.UserMixin;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.jackson2.CoreJackson2Module;
import org.springframework.security.web.jackson2.WebJackson2Module;

/**
 * Configures all core consumer/producer-shared JWT components
 */
@Configuration
public class JwtSecurityConfiguration {

    @Autowired
    private ObjectMapper objectMapper;

    @Bean
    @ConfigurationProperties(prefix = "jwt")
    public JwtSettings jwtSettings() {
        return new JwtSettings();
    }

    @Bean
    public JwtService jwtService(final JwtSettings settings) {

        final ObjectMapper mapper = objectMapper.copy();
        mapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL, JsonTypeInfo.As.PROPERTY);
        mapper.registerModule(new CoreJackson2Module());
        mapper.registerModule(new WebJackson2Module());
        mapper.registerModule(new GuavaModule());
        mapper.addMixIn(User.class, UserMixin.class);

        return new DefaultJwtService(settings, mapper);
    }

}
