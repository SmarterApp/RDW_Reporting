package org.opentestsystem.rdw.reporting.common.web.security.jwt;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.jsonwebtoken.CompressionCodecs;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import org.opentestsystem.rdw.reporting.common.web.security.User;

import java.io.IOException;

public class DefaultJwtService implements JwtService {

    private static final String UserClaim = "_user";
    private final JwtSettings settings;
    private final ObjectMapper objectMapper;

    DefaultJwtService(final JwtSettings settings,
                      final ObjectMapper objectMapper) {
        this.settings = settings;
        this.objectMapper = objectMapper;
    }

    @Override
    public String encode(final User user) {
        return Jwts.builder()
                .claim(UserClaim, userToJson(user))
                .compressWith(CompressionCodecs.DEFLATE)
                .signWith(SignatureAlgorithm.HS512, settings.getSecret())
                .compact();
    }

    @Override
    public User decode(final String token) {
        return jsonToUser(
                (String) Jwts.parser()
                        .setSigningKey(settings.getSecret())
                        .parseClaimsJws(token)
                        .getBody()
                        .get(UserClaim)
        );
    }

    private String userToJson(final User user) {
        try {
            return objectMapper.writeValueAsString(user);
        } catch (final JsonProcessingException exception) {
            throw new RuntimeException(exception);
        }
    }

    private User jsonToUser(final String serializedUser) {
        try {
            return objectMapper.readValue(serializedUser, User.class);
        } catch (final IOException exception) {
            throw new RuntimeException(exception);
        }
    }

}
