package org.opentestsystem.rdw.reporting.common.web.security.jwt;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.collect.ImmutableMap;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.GroupGrant;
import org.springframework.security.core.authority.SimpleGrantedAuthority;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.districts;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.groupOf;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.permissions;

public class DefaultJwtServiceTest {

    private DefaultJwtService service;

    @Before
    public void before() {
        final JwtSettings settings = new JwtSettings();
        settings.setIssuer("issuer");
        settings.setSecret("aGVsbG90aGVyZQ==");

        this.service = new DefaultJwtService(settings, new ObjectMapper());
    }

    @Test
    public void test() {
        final User user = User.builder()
                .id("id")
                .username("username")
                .password("password")
                .firstName("first")
                .lastName("last")
                .authorities(newArrayList(new SimpleGrantedAuthority("ROLE_A")))
                .groupsById(ImmutableMap.<Long, GroupGrant>builder()
                        .put(1L, new GroupGrant(1L, 1))
                        .build()
                )
                .permissionsById(
                        permissions(groupOf(districts(10L)))
                )
                .build();

        final String serialized = service.encode(user);

        assertThat(serialized).isNotBlank();

        final User deserialized = service.decode(serialized);

        assertThat(deserialized).isEqualToComparingFieldByFieldRecursively(user);
    }


}
