package org.opentestsystem.rdw.reporting.processor.service;

import org.opentestsystem.rdw.reporting.common.model.Report;
import org.opentestsystem.rdw.reporting.common.model.ReportStatus;
import org.opentestsystem.rdw.reporting.common.report.BatchExamReportRequestHolder;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.InputStream;
import java.util.Calendar;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import static com.google.common.collect.Lists.newArrayList;
import static java.util.stream.Collectors.toMap;

/**
 * Default implementation of a ReportService
 */
@Service
public class StubReportService implements ReportService {

    private static final List<Report> reports = newArrayList(Report.builder()
                    .id(4L)
                    .label("Stub Report 4")
                    .status(ReportStatus.COMPLETED)
                    .created(new Calendar.Builder().setDate(2017, 0, 10).build().toInstant())
                    .build(),
            Report.builder()
                    .id(3L)
                    .label("Stub Report 3")
                    .status(ReportStatus.EXPIRED)
                    .created(new Calendar.Builder().setDate(2017, 0, 8).build().toInstant())
                    .build(),
            Report.builder()
                    .id(2L)
                    .label("Stub Report 2")
                    .status(ReportStatus.FAILED)
                    .created(new Calendar.Builder().setDate(2017, 0, 7).build().toInstant())
                    .build(),
            Report.builder()
                    .id(1L)
                    .label("Stub Report 1")
                    .status(ReportStatus.RUNNING)
                    .created(new Calendar.Builder().setDate(2017, 0, 5).build().toInstant())
                    .build());

    private static final Map<Long, Report> reportsById = reports.stream()
            .collect(toMap(Report::getId, report -> report));


    @Autowired
    public StubReportService() {
    }

    @Override
    public Report generateReport(final BatchExamReportRequestHolder request) {
        return reports.get(1);
    }

    @Override
    public List<Report> findAllByUserAndId(final String user, final Collection<Long> reportIds) {
        return reports;
    }

    @Override
    public InputStream getContent(final long reportId) {
        return getClass().getClassLoader().getResourceAsStream("stub-report.pdf");
    }

    @Override
    public Optional<Report> findOneById(final long reportId) {
        return Optional.ofNullable(reportsById.get(reportId));
    }

}
