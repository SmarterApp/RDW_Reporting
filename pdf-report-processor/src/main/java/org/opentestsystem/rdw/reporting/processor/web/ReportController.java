package org.opentestsystem.rdw.reporting.processor.web;

import com.amazonaws.services.s3.Headers;
import org.apache.commons.io.IOUtils;
import org.opentestsystem.rdw.reporting.common.report.BatchExamReportRequestHolder;
import org.opentestsystem.rdw.reporting.processor.model.Report;
import org.opentestsystem.rdw.reporting.processor.service.ReportService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;

import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.List;
import java.util.NoSuchElementException;
import java.util.Set;

import static com.google.common.collect.ImmutableSortedSet.of;
import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;
import static org.springframework.http.MediaType.APPLICATION_PDF_VALUE;
import static org.springframework.web.bind.annotation.RequestMethod.GET;

/**
 * This controller is responsible for providing access to Reports.
 */
@Controller
@RequestMapping("/reports")
public class ReportController {

    private final ReportService reportService;

    @Autowired
    public ReportController(final ReportService reportService) {
        this.reportService = reportService;
    }

    /**
     * Generate a new Report.
     *
     * @param requestHolder The report generation request
     * @return The new Report
     */
    @PostMapping(produces = APPLICATION_JSON_VALUE)
    @ResponseStatus(HttpStatus.ACCEPTED)
    @ResponseBody
    public Report generateReport(@RequestBody final BatchExamReportRequestHolder requestHolder) {
        return reportService.generateReport(requestHolder);
    }

    /**
     * Retrieve the list of Reports for a user, optionally filtered by id.
     *
     * @param user      The user identifier
     * @param reportIds The report ids, empty will retrieve the list of all reports for the user
     * @return The list of Reports
     */
    @GetMapping(produces = APPLICATION_JSON_VALUE)
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public List<Report> getReports(@RequestParam("user") final String user,
                                   @RequestParam(value = "id", required = false) Set<Long> reportIds) {
        if (reportIds == null) reportIds = of();

        return reportService.findAllByUserAndId(user, reportIds);
    }

    /**
     * Retrieve the report content for the given report.
     *
     * @param reportId  A report id
     * @param response  The HttpServletResponse
     * @throws IOException  If there is a problem reading/writing the response
     */
    @RequestMapping(value = "{reportId}/content", method = GET)
    public void downloadReport(@PathVariable final Long reportId,
                               final HttpServletResponse response) throws IOException {

        final Report report = reportService.findOneById(reportId)
                .orElseThrow(NoSuchElementException::new);
        try (final InputStream pdfBytes = reportService.getContent(reportId);
             final OutputStream responseOutput = response.getOutputStream()) {
            response.setStatus(200);
            response.setHeader(Headers.CONTENT_TYPE, APPLICATION_PDF_VALUE);
            response.setHeader(Headers.CONTENT_DISPOSITION, "attachment; filename=" + report.getLabel() + ".pdf");
            IOUtils.copy(pdfBytes, responseOutput);
            response.flushBuffer();
        }
    }
}
