package org.opentestsystem.rdw.reporting.processor.web;

import com.google.common.collect.ImmutableSet;
import org.opentestsystem.rdw.reporting.common.model.Report;
import org.opentestsystem.rdw.reporting.common.report.BatchExamReportRequestHolder;
import org.opentestsystem.rdw.reporting.processor.service.ReportService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.io.InputStreamResource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;

import java.io.IOException;
import java.util.List;
import java.util.NoSuchElementException;
import java.util.Set;

import static org.springframework.http.HttpHeaders.CONTENT_DISPOSITION;
import static org.springframework.http.HttpHeaders.CONTENT_TYPE;
import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;

/**
 * This controller is responsible for providing access to Reports.
 */
@Controller
@RequestMapping("/api/reports")
public class ReportController {

    private final ReportService reportService;

    @Autowired
    public ReportController(final ReportService reportService) {
        this.reportService = reportService;
    }

    /**
     * Generate a new Report.
     *
     * @param requestHolder The report generation request
     * @return The new Report
     */
    @PostMapping(produces = APPLICATION_JSON_VALUE)
    @ResponseStatus(HttpStatus.ACCEPTED)
    @ResponseBody
    public Report generateReport(@RequestBody final BatchExamReportRequestHolder requestHolder) {
        return reportService.generateReport(requestHolder);
    }

    /**
     * Retrieve the list of Reports for a user, optionally filtered by id.
     *
     * @param user      The user identifier
     * @param reportIds The report ids, empty will retrieve the list of all reports for the user
     * @return The list of Reports
     */
    @GetMapping(produces = APPLICATION_JSON_VALUE)
    @ResponseBody
    public List<Report> getReports(
            @RequestParam("user") final String user,
            @RequestParam(value = "id", required = false) Set<Long> reportIds) {
        return reportService.findAllByUserAndId(user, reportIds != null ? reportIds : ImmutableSet.of());
    }

    /**
     * Retrieve the report content for the given report.
     *
     * @param reportId A report id
     * @throws IOException If there is a problem reading/writing the response
     */
    @GetMapping(value = "{reportId}/content")
    public ResponseEntity<InputStreamResource> downloadReport(@PathVariable final Long reportId) throws IOException {

        final Report report = reportService.findOneById(reportId)
                .orElseThrow(NoSuchElementException::new);

        final InputStreamResource resource = new InputStreamResource(reportService.getContent(reportId));

        final HttpHeaders headers = new HttpHeaders();
        headers.add(CONTENT_TYPE, "application/pdf; charset=UTF-8");
        headers.add(CONTENT_DISPOSITION, "attachment; filename=" + report.getLabel() + ".pdf");

        return new ResponseEntity<>(resource, headers, HttpStatus.OK);

    }
}
