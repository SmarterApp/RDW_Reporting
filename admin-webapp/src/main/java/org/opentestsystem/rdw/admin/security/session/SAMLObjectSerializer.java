package org.opentestsystem.rdw.admin.security.session;

import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.databind.SerializerProvider;
import com.fasterxml.jackson.databind.ser.std.StdScalarSerializer;
import org.opensaml.ws.message.encoder.MessageEncodingException;
import org.opensaml.xml.XMLObject;
import org.opensaml.xml.util.XMLHelper;
import org.springframework.security.saml.parser.SAMLObject;
import org.springframework.security.saml.util.SAMLUtil;

import java.io.IOException;
import java.io.ObjectOutputStream;

/**
 * This class is responsible for serializing SAMLObject instances using
 * the built-in spring-saml serialization method.
 *
 * @see SAMLObject#writeObject(ObjectOutputStream)
 */
class SAMLObjectSerializer extends StdScalarSerializer<SAMLObject> {

    public SAMLObjectSerializer() {
        super(SAMLObject.class);
    }

    @Override
    public void serialize(final SAMLObject value, final JsonGenerator gen, final SerializerProvider provider) throws IOException {
        try {
            final XMLObject wrappedObj = value.getObject();
            final String serializedValue = XMLHelper.nodeToString(SAMLUtil.marshallMessage(wrappedObj));
            gen.writeString(serializedValue);
        } catch (final MessageEncodingException e) {
            throw new IOException("Problem serializing SAMLObject", e);
        }
    }
}