package org.opentestsystem.rdw.admin.security.session;

import com.fasterxml.jackson.core.JsonGenerator;
import com.fasterxml.jackson.databind.SerializerProvider;
import com.fasterxml.jackson.databind.ser.std.StdScalarSerializer;
import org.opensaml.ws.message.encoder.MessageEncodingException;
import org.opensaml.xml.XMLObject;
import org.opensaml.xml.util.XMLHelper;
import org.springframework.security.saml.parser.SAMLCollection;
import org.springframework.security.saml.util.SAMLUtil;

import java.io.IOException;
import java.io.ObjectOutputStream;
import java.util.List;

/**
 * This class is responsible for serializing SAMLCollection instances using
 * the built-in spring-saml serialization method.
 *
 * @see SAMLCollection#writeObject(ObjectOutputStream)
 */
class SAMLCollectionSerializer extends StdScalarSerializer<SAMLCollection> {

    public SAMLCollectionSerializer() {
        super(SAMLCollection.class);
    }

    @Override
    public void serialize(final SAMLCollection value, final JsonGenerator gen, final SerializerProvider provider) throws IOException {
        try {
            final List<XMLObject> collectionValues = value.getObject();
            gen.writeStartArray(collectionValues.size());
            for (final XMLObject collectionValue : collectionValues) {
                final String serializedValue = XMLHelper.nodeToString(SAMLUtil.marshallMessage(collectionValue));
                gen.writeString(serializedValue);
            }
            gen.writeEndArray();
        } catch (final MessageEncodingException e) {
            throw new IOException("Problem serializing SAMLCollection", e);
        }
    }
}
