package org.opentestsystem.rdw.reporting.common.jdbc;

import org.opentestsystem.rdw.reporting.common.model.ExamItem;

import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;

import static org.opentestsystem.rdw.reporting.common.jdbc.QueryUtils.getNullable;

/**
 *  Holds utility methods for mapping SQL query results to {@link ExamItem}s.
 */
public class ExamItems {

    public static ExamItem map(final ResultSet row, final String prefix) throws SQLException {
        final ExamItem.Builder builder = ExamItem.builder()
                .examId(row.getLong(prefix + "exam_id"))
                .itemId(row.getLong(prefix + "item_id"))
                .points(getNullable(row, row.getInt(prefix + "score")))
                .position(row.getInt(prefix + "position"))
                .writingTraitScores(
                        getNullable(row, row.getInt(prefix + "trait_evidence_elaboration_score")),
                        getNullable(row, row.getInt(prefix + "trait_organization_purpose_score")),
                        getNullable(row, row.getInt(prefix + "trait_conventions_score"))
                );

        if (hasColumn(row, prefix + "response")) {
            builder.response(row.getString(prefix + "response"));
        }

        return builder.build();
    }

    public static ExamItem map(final ResultSet row) throws SQLException {
        return map(row, "");
    }

    private static boolean hasColumn(final ResultSet row, final String columnName) throws SQLException {
        final ResultSetMetaData metaData = row.getMetaData();
        for (int i = 1; i <= metaData.getColumnCount(); i++) {
            final String name = metaData.getColumnName(i);
            if (columnName.equals(name)) return true;
        }
        return false;
    }
}
