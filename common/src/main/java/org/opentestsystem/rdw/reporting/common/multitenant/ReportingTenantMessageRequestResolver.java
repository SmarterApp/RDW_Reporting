package org.opentestsystem.rdw.reporting.common.multitenant;

import org.opentestsystem.rdw.multitenant.messaging.TenantMessageRequestResolver;
import org.opentestsystem.rdw.reporting.common.security.User;
import org.opentestsystem.rdw.reporting.common.stream.MessageSecurityService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.messaging.Message;

import java.util.Optional;

public class ReportingTenantMessageRequestResolver implements TenantMessageRequestResolver {
    private static final Logger logger = LoggerFactory.getLogger(ReportingTenantMessageRequestResolver.class);

    private final MessageSecurityService messageSecurityService;

    public ReportingTenantMessageRequestResolver(final MessageSecurityService messageSecurityService) {
        this.messageSecurityService = messageSecurityService;
    }

    @Override
    public Optional<String> getTenantId(final Message<?> message) {
        String tenantId = null;
        try {
            final User user = messageSecurityService.getUser(message);
            tenantId = user.getTenant().getId();
            logger.debug("Resolving user {} to tenant {} for message.", user.getUsername(), tenantId);
        } catch (Exception e) {
            logger.error("Error resolving user: ", e);
        }
        return Optional.ofNullable(tenantId);
    }

}

