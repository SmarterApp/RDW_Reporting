package org.opentestsystem.rdw.reporting.common.configuration;

import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonView;
import org.opentestsystem.rdw.multitenant.TenantKeyResolver;
import org.opentestsystem.rdw.reporting.common.model.SearchFieldPermissionLevel;
import org.opentestsystem.rdw.reporting.common.model.StudentFieldType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Stream;

import static org.opentestsystem.rdw.reporting.common.util.ObjectUtils.defaultIfNull;

public class ReportingSystemPropertiesResolver implements ReportingSystemProperties {

    private static final Logger logger = LoggerFactory.getLogger(ReportingSystemPropertiesResolver.class);

    private final TenantKeyResolver tenantKeyResolver;
    private final ReportingSystemSettings reportingSystemSettings;

    public ReportingSystemPropertiesResolver(TenantKeyResolver tenantKeyResolver,
                                             ReportingSystemSettings reportingSystemSettings) {
        this.tenantKeyResolver = tenantKeyResolver;
        this.reportingSystemSettings = reportingSystemSettings;
        logger.debug("ReportingSystemSettings {}", reportingSystemSettings);
    }

    @JsonIgnore
    protected Optional<ReportingSystemProperties> getResolvedReportingSystemProperties() {
        return tenantKeyResolver.getTenantKey()
                .flatMap(k -> Optional.ofNullable(reportingSystemSettings.getTenants().get(k)));
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getAnalyticsTrackingId() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getAnalyticsTrackingId)
                .orElse(reportingSystemSettings.getAnalyticsTrackingId());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getInterpretiveGuideUrl() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getInterpretiveGuideUrl)
                .orElse(reportingSystemSettings.getInterpretiveGuideUrl());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getAccessDeniedUrl() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getAccessDeniedUrl)
                .orElse(reportingSystemSettings.getAccessDeniedUrl());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getLandingPageUrl() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getLandingPageUrl)
                .orElse(reportingSystemSettings.getLandingPageUrl());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getIrisVendorId() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getIrisVendorId)
                .orElse(reportingSystemSettings.getIrisVendorId());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Integer getMinItemDataYear() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getMinItemDataYear)
                .orElse(reportingSystemSettings.getMinItemDataYear());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Boolean isPercentileDisplayEnabled() {
        final Optional<Boolean> resolved =
                getResolvedReportingSystemProperties().map(ReportingSystemProperties::isPercentileDisplayEnabled);
        final Optional<Boolean> fallback =
                Optional.ofNullable(reportingSystemSettings.isPercentileDisplayEnabled());
        return Stream.of(resolved, fallback)
                .filter(Optional::isPresent)
                .map(Optional::get)
                .findFirst()
                .orElse(false);
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public List<String> getReportLanguages() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getReportLanguages)
                .orElse(reportingSystemSettings.getReportLanguages());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Integer getSchoolYear() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getSchoolYear)
                .orElse(reportingSystemSettings.getSchoolYear());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public StateProperties getState() {
        return mergeStateProps(
            getResolvedReportingSystemProperties().map(ReportingSystemProperties::getState),
            reportingSystemSettings.getState());
    }

    private StateProperties mergeStateProps(
        Optional<StateProperties> optionalTenantProps, StateProperties defaultProps) {
        if(!optionalTenantProps.isPresent()) {
            return defaultProps;
        }

        final StateProperties tenantProps = optionalTenantProps.get();

        if (defaultProps == null) {
            return tenantProps;
        }

        // Merge the two structures into one using tenant overrides when present, and otherwise the system default.

        StateProperties mergedProps = new StateProperties();

        mergedProps.setCode(defaultIfNull(tenantProps.getCode(), defaultProps.getCode()));
        mergedProps.setName(defaultIfNull(tenantProps.getName(), defaultProps.getName()));

        return mergedProps;
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Boolean isTransferAccessEnabled() {
        final Optional<Boolean> resolved =
                getResolvedReportingSystemProperties().map(ReportingSystemProperties::isTransferAccessEnabled);
        final Optional<Boolean> fallback =
                Optional.ofNullable(reportingSystemSettings.isTransferAccessEnabled());
        return Stream.of(resolved, fallback)
                .filter(Optional::isPresent)
                .map(Optional::get)
                .findFirst()
                .orElse(false);
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getTranslationLocation() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getTranslationLocation)
                .orElse(reportingSystemSettings.getTranslationLocation());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public List<String> getUiLanguages() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getUiLanguages)
                .orElse(reportingSystemSettings.getUiLanguages());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public String getUserGuideUrl() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getUserGuideUrl)
                .orElse(reportingSystemSettings.getUserGuideUrl());
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public TargetReportProperties getTargetReport() {
        return mergeTargetProps(
            getResolvedReportingSystemProperties().map(ReportingSystemProperties::getTargetReport),
            reportingSystemSettings.getTargetReport());
    }

    private TargetReportProperties mergeTargetProps(Optional<TargetReportProperties> optionalTenantProps,
                                                    TargetReportProperties defaultProps) {
        if(!optionalTenantProps.isPresent()) {
            return defaultProps;
        }

        final TargetReportProperties tenantProps = optionalTenantProps.get();

        if (defaultProps == null) {
            return tenantProps;
        }

        // Merge the two structures into one using tenant overrides when present, and otherwise the system default.
        TargetReportProperties mergedProps = new TargetReportProperties();
        mergedProps.setMinNumberOfStudents(
                defaultIfNull(tenantProps.getMinNumberOfStudents(), defaultProps.getMinNumberOfStudents()));
            mergedProps.setInsufficientDataCutoff(
                defaultIfNull(tenantProps.getInsufficientDataCutoff(), defaultProps.getInsufficientDataCutoff()));

        return mergedProps;
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Map<StudentFieldType, SearchFieldPermissionLevel> getStudentFields() {
        return mergeMap(
            getResolvedReportingSystemProperties().map(ReportingSystemProperties::getStudentFields),
            reportingSystemSettings.getStudentFields());
    }

    // Returned new map with base values, supplemented with defaults for any missing from base.
    private <K, V> Map<K, V> mergeMap(Optional<Map<K, V>> optionalTenantProps, Map<K, V> defaultProps) {
        if(!optionalTenantProps.isPresent()) {
            return defaultProps;
        }

        final Map<K,V> tenantProps = optionalTenantProps.get();

        if (defaultProps == null) {
            return tenantProps;
        }

        Map<K, V> mergedProps = new HashMap<>(tenantProps);
        defaultProps.forEach(
            (key, value) -> mergedProps.merge(key, value, (v1, v2) -> v1));

        return mergedProps;
    }

    @Override
    @JsonView(ReportingSystemPropertiesJsonViews.Public.class)
    public Boolean isTenantAdministrationDisabled() {
        // ignore the tenant-level configuration
        return reportingSystemSettings.isTenantAdministrationDisabled();
    }
}
