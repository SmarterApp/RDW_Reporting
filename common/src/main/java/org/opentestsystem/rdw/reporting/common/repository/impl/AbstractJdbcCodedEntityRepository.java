package org.opentestsystem.rdw.reporting.common.repository.impl;

import com.google.common.collect.ImmutableMap;
import org.opentestsystem.rdw.reporting.common.repository.CodedEntityRepository;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;

import java.util.Map;

public abstract class AbstractJdbcCodedEntityRepository implements CodedEntityRepository {

    private final NamedParameterJdbcTemplate template;

    AbstractJdbcCodedEntityRepository(final NamedParameterJdbcTemplate template) {
        this.template = template;
    }

    public Map<String, Integer> findAllIdsByCode() {
        return template.query(getFindAllQuery(), (row) -> {
            final ImmutableMap.Builder<String, Integer> idsByCode = ImmutableMap.builder();
            while (row.next()) {
                idsByCode.put(row.getString("code"), row.getInt("id"));
            }
            return idsByCode.build();
        });
    }

    abstract protected String getFindAllQuery();

}
