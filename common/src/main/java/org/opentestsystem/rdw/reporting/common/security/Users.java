package org.opentestsystem.rdw.reporting.common.security;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;

public final class Users {
    private static final String ANONYMOUS_USER = "anonymousUser";

    private Users() {
    }

    public static User getCurrentUser() {
        final Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null) {
            throw new IllegalStateException("user not authenticated");
        }
        // TODO: By the time we get here, we should already haven an "anonymous" user object in our security context
        if (ANONYMOUS_USER.equals(authentication.getPrincipal())) {
            return User.builderExt()
                    .id(ANONYMOUS_USER)
                    .username(ANONYMOUS_USER)
                    .password(ANONYMOUS_USER)
                    .build();
        }
        if (!(authentication.getPrincipal() instanceof User)) {
            throw new ClassCastException("authentication principal must be of type " + User.class.getName());
        }
        return (User) authentication.getPrincipal();
    }

}
