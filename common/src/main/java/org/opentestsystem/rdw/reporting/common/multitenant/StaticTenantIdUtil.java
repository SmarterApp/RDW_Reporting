package org.opentestsystem.rdw.reporting.common.multitenant;

import org.opentestsystem.rdw.multitenant.TenantContextHolder;
import org.opentestsystem.rdw.reporting.common.security.Users;
import org.springframework.security.core.context.SecurityContextHolder;

import java.util.Optional;
import java.util.stream.Stream;

/**
 * Static utility methods to resolve the current tenant id
 */
public class StaticTenantIdUtil {

    public static String NO_TENANT_KEY = "NO_TENANT_KEY";

    /**
     * First checks {@code Users.getCurrentUser()} then falls back to
     * {@code SecurityContextHolder.getContext()}
     *
     * @return tenantId Option
     */
    public static Optional<String> tenantId() {
        return Stream.of(tenantIdFromSecurityContext(), tenantIdFromTenantContext())
                .filter(Optional::isPresent)
                .map(Optional::get)
                .findFirst();
    }

    /**
     * First checks {@code Users.getCurrentUser()} then falls back to
     * {@code SecurityContextHolder.getContext()}.  Returns "NO_TENANT_KEY"
     * if neither are found.
     * <p>
     * Primarily used to create cache keys.
     *
     * @return tenantId or "NO_TENANT_KEY"
     */
    public static String tenantIdKey() {
        return tenantId().orElse(NO_TENANT_KEY);
    }

    private static Optional<String> tenantIdFromSecurityContext() {
        //if there is no context then it empty
        if (SecurityContextHolder.getContext().getAuthentication() != null) {
            //during login process the stored principle is not a User, and this error is thrown
            //for tenant purposes that is an empty tenantId
            try {
                return Optional.ofNullable(Users.getCurrentUser().getTenantId());
            } catch (ClassCastException ex) {
                return Optional.empty();
            }
        }
        return Optional.empty();
    }

    private static Optional<String> tenantIdFromTenantContext() {
        return Optional.ofNullable(TenantContextHolder.getTenantId());
    }

}
