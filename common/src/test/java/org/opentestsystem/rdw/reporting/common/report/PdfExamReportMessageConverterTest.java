package org.opentestsystem.rdw.reporting.common.report;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.reporting.common.report.processor.ExamReportPdfProcessor;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.mock.http.MockHttpOutputMessage;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Matchers.any;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

public class PdfExamReportMessageConverterTest {

    private ExamReportPdfMessageConverter converter;
    private ExamReportPdfProcessor processor;

    @Before
    public void before() {
        processor = mock(ExamReportPdfProcessor.class);
        converter = new ExamReportPdfMessageConverter(processor);
    }

    @Test
    public void canWriteShouldBeTrueForPDFMediaType() throws Exception {
        assertThat(converter.canWrite(ExamReportPdfMessage.class, MediaType.APPLICATION_PDF)).isTrue();
    }

    @Test
    public void canWriteShouldBeFalseForMediaTypesOtherThanPDF() throws Exception {
        assertThat(converter.canWrite(ExamReportPdfMessage.class, MediaType.APPLICATION_JSON)).isFalse();
    }

    @Test
    public void supportsShouldAcceptPdfExamReportResponses() throws Exception {
        assertThat(converter.supports(ExamReportPdfMessage.class)).isTrue();
        assertThat(converter.supports(String.class)).isFalse();
    }

    @Test(expected = UnsupportedOperationException.class)
    public void readInternalShouldThrowException() throws Exception {
        converter.readInternal(null, null);
    }

    @Test
    public void writeInternalShouldInvokeProcessorAndWriteContentDispositionHeader() throws Exception {
        final byte[] expected = {0x11, 0x22};
        final ExamReportPdfMessage model = new ExamReportPdfMessage(null, null);
        final MockHttpOutputMessage message = new MockHttpOutputMessage();
        when(processor.process(any(AbstractExamReport.class), any(AbstractExamReportRequest.class))).thenReturn(expected);
        converter.writeInternal(model, message);
        assertThat(message.getBodyAsBytes()).isEqualTo(expected);
        assertThat(message.getHeaders().getFirst(HttpHeaders.CONTENT_DISPOSITION)).isEqualTo("attachment; filename=report.pdf");
    }

}