package org.opentestsystem.rdw.reporting.common.model.jackson;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.guava.GuavaModule;
import com.google.common.collect.ImmutableSet;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.reporting.common.model.AggregateReportFilters;
import org.opentestsystem.rdw.reporting.common.model.AggregateRequestMessage;
import org.opentestsystem.rdw.reporting.common.model.BasicAggregateReportQuery;

import java.net.URI;

import static com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES;
import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Gender;

public class AggregateReportModuleTest {

    private ObjectMapper objectMapper;

    @Before
    public void setup() {
        objectMapper = new ObjectMapper();
        objectMapper.configure(FAIL_ON_UNKNOWN_PROPERTIES, false);
        objectMapper.registerModules(new GuavaModule(), new AggregateReportModule());
    }

    @Test
    public void itShouldRoundTripAnAggregateRequestMessage() throws Exception {
        final AggregateReportFilters filters = AggregateReportFilters.builder()
                .section504Codes(ImmutableSet.of("yes"))
                .build();
        final BasicAggregateReportQuery query = BasicAggregateReportQuery.builder()
                .assessmentTypeCode("sum")
                .filters(filters)
                .dimensionTypes(ImmutableSet.of(Gender))
                .districtIds(ImmutableSet.of(123L, 456L))
                .build();
        final AggregateRequestMessage message = AggregateRequestMessage.builder()
                .id(3L)
                .aggregateQuery(query)
                .responseLocation(URI.create("/here"))
                .build();

        final String serializedMessage = objectMapper.writeValueAsString(message);
        final AggregateRequestMessage deserialized = objectMapper.readValue(serializedMessage, AggregateRequestMessage.class);

        assertThat(deserialized).isEqualToComparingFieldByFieldRecursively(message);
    }
}