package org.opentestsystem.rdw.reporting.processor.repository;

import com.google.common.collect.ImmutableMap;
import org.opentestsystem.rdw.reporting.common.jdbc.SecurityParameterProvider;
import org.opentestsystem.rdw.reporting.common.security.PermissionSource;
import org.opentestsystem.rdw.reporting.processor.model.ExportExamReportRequest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

import java.sql.PreparedStatement;
import java.util.Map;

import static org.opentestsystem.rdw.reporting.common.jdbc.QueryUtils.UNMATCHABLE_IDS;
import static org.opentestsystem.rdw.reporting.common.jdbc.QueryUtils.nullOrEmptyToDefault;

@Repository
public class JdbcExamRepository implements ExamRepository {

    private static final String ExportDestination = "::EXPORT_DESTINATION::";

    @Value("${sql.export.exams}")
    private String exportExams;

    @Value("${sql.export.hasExams}")
    private String hasExams;

    private final NamedParameterJdbcTemplate template;
    private final SecurityParameterProvider securityParameterProvider;

    @Autowired
    JdbcExamRepository(final NamedParameterJdbcTemplate template,
                       final SecurityParameterProvider securityParameterProvider) {
        this.template = template;
        this.securityParameterProvider = securityParameterProvider;
    }

    @Override
    public String export(final PermissionSource permissionSource, final ExportExamReportRequest request, final String uriLocation) {
        final boolean isDestinationS3 = uriLocation.toLowerCase().startsWith("s3");

        template.execute(
                exportExams.replace(ExportDestination, isDestinationS3 ? "S3" : ""),
                ImmutableMap.<String, Object>builder()
                        .putAll(securityParameterProvider.getSecurityParameters(permissionSource, request.isDisableTransferAccess()))
                        .putAll(getQueryParameters(request))
                        .put("export_location", uriLocation)
                        .build(),
                PreparedStatement::execute
        );

        // The SELECT INTO OUTFILE S3 feature appends a part number to the file.
        return isDestinationS3 ? uriLocation + ".part_00000" : uriLocation;
    }

    @Override
    public boolean hasExams(final PermissionSource permissionSource, final ExportExamReportRequest request) {
        return template.queryForObject(
                hasExams,
                new MapSqlParameterSource()
                        .addValues(securityParameterProvider.getSecurityParameters(permissionSource, request.isDisableTransferAccess()))
                        .addValues(getQueryParameters(request)),
                Boolean.class
        );
    }

    private Map<String, Object> getQueryParameters(final ExportExamReportRequest request) {
        final String prefix = "query_";

        return ImmutableMap.<String, Object>builder()
                .put(prefix + "district_group_ids", nullOrEmptyToDefault(request.getDistrictGroupIds(), UNMATCHABLE_IDS))
                .put(prefix + "district_ids", nullOrEmptyToDefault(request.getDistrictIds(), UNMATCHABLE_IDS))
                .put(prefix + "school_group_ids", nullOrEmptyToDefault(request.getSchoolGroupIds(), UNMATCHABLE_IDS))
                .put(prefix + "school_ids", nullOrEmptyToDefault(request.getSchoolIds(), UNMATCHABLE_IDS))
                .put("school_year", request.getSchoolYear())
                .put("disable_transfer_access", request.isDisableTransferAccess())
                .build();
    }
}
