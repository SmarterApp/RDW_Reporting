package org.opentestsystem.rdw.reporting.processor.service;

import org.opentestsystem.rdw.reporting.processor.model.Report;
import org.opentestsystem.rdw.reporting.processor.model.ExportExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.GroupExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.SchoolGradeExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.StudentExamReportRequest;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.reporting.processor.web.ReportContentResource;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;

import javax.validation.constraints.NotNull;
import java.util.List;

/**
 * Responsible for managing exam reports
 */
public interface ExamReportService {

    /**
     * Creates an individual student exam report
     *
     * @param user    the user requesting the report
     * @param request settings which shape the content of the report
     * @return the created report handle
     */
    @PreAuthorize("hasAnyAuthority('PERM_INDIVIDUAL_PII_READ', 'PERM_GROUP_PII_READ')")
    Report createReport(@NotNull User user, @NotNull StudentExamReportRequest request);

    /**
     * Creates a school grade scoped student exam report
     *
     * @param user    the user requesting the report
     * @param request settings which shape the content of the report
     * @return the created report handle
     */
    @PreAuthorize("hasAuthority('PERM_INDIVIDUAL_PII_READ')")
    Report createReport(@NotNull User user, @NotNull SchoolGradeExamReportRequest request);

    /**
     * Creates a group scoped student exam report
     *
     * @param user    the user requesting the report
     * @param request settings which shape the content of the report
     * @return the created report handle
     */
    @PreAuthorize("hasAuthority('PERM_GROUP_PII_READ') and #request.groupGrant != null")
    Report createReport(@NotNull User user, @NotNull GroupExamReportRequest request);

    /**
     * Creates an exam export report
     *
     * @param user    the user requesting the report
     * @param request filters for exam data to return
     * @return the created report handle
     */
    @PreAuthorize("hasAuthority('PERM_INDIVIDUAL_PII_READ')")
    Report createReport(@NotNull User user, @NotNull ExportExamReportRequest request);

    /**
     * Gets the user's reports
     *
     * @param user the user to get reports for
     * @return the user's reports
     */
    List<Report> getReports(@NotNull User user);

    /**
     * Gets the user's reports that match the given IDs
     *
     * @param user the user to get reports for
     * @param reportIds the IDs of the reports to get
     * @return the user's reports
     */
    List<Report> getReports(@NotNull User user, Iterable<Long> reportIds);

    /**
     * Gets the report file as a resource to be written to an http response
     *
     * @param user     the report owner
     * @param reportId the report ID
     */
    ResponseEntity<ReportContentResource> openReportContent(@NotNull final User user, final long reportId);

}