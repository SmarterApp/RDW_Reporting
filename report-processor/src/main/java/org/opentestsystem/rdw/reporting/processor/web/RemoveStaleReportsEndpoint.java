package org.opentestsystem.rdw.reporting.processor.web;

import org.opentestsystem.rdw.reporting.processor.service.ReportRemovalService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.actuate.endpoint.AbstractEndpoint;

/**
 * This actuator end-point allows the stale report task to be manually triggered.<br/>
 *
 * It does not have a stereotype annotation because it is instantiated conditionally in
 * {@link org.opentestsystem.rdw.reporting.processor.configuration.RemoveStaleReportsConfiguration}.<br/>
 */
public class RemoveStaleReportsEndpoint extends AbstractEndpoint<Boolean> {
    private static final Logger logger = LoggerFactory.getLogger(RemoveStaleReportsEndpoint.class);

    private final ReportRemovalService reportRemovalService;
    private final int maxReportLifetimeDays;

    public RemoveStaleReportsEndpoint(final ReportRemovalService reportRemovalService, final int maxReportLifetimeDays) {
        super("removeStaleReports", true, true);
        this.reportRemovalService = reportRemovalService;
        this.maxReportLifetimeDays = maxReportLifetimeDays;
    }

    @Override
    public Boolean invoke() {
        try {
            logger.info("Manual task triggered: Remove Stale Reports");
            reportRemovalService.deleteOldReports(maxReportLifetimeDays);
            return true;
        } catch (final Exception e) {
            logger.warn("Error removing stale reports", e);
            return false;
        }
    }
}
