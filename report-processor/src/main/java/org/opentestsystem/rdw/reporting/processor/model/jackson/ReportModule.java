package org.opentestsystem.rdw.reporting.processor.model.jackson;

import com.fasterxml.jackson.databind.BeanDescription;
import com.fasterxml.jackson.databind.DeserializationConfig;
import com.fasterxml.jackson.databind.JsonDeserializer;
import com.fasterxml.jackson.databind.deser.BeanDeserializerModifier;
import com.fasterxml.jackson.databind.module.SimpleModule;
import org.opentestsystem.rdw.reporting.processor.model.AbstractExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.AggregateReportRequest;

/**
 * This module registers custom Jackson handlers.
 */
public class ReportModule extends SimpleModule {

    public ReportModule() {
        addDeserializer(AbstractExamReportRequest.class, new AbstractExamReportRequestDeserializer());

        //Temporary deserializers for legacy conversion
        //TODO remove these as serialized legacy report requests no longer exist in production
        setDeserializerModifier(new BeanDeserializerModifier() {
            @Override
            public JsonDeserializer<?> modifyDeserializer(final DeserializationConfig config, final BeanDescription beanDesc, final JsonDeserializer<?> deserializer) {
                if (AggregateReportRequest.class.equals(beanDesc.getBeanClass())) {
                    return new AggregateReportRequestDeserializer(deserializer);
                }
                return deserializer;
            }
        });
    }
}
