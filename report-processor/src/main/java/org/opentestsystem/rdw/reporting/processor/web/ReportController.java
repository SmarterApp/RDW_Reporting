package org.opentestsystem.rdw.reporting.processor.web;

import com.google.common.collect.ImmutableSet;
import org.opentestsystem.rdw.reporting.common.model.Report;
import org.opentestsystem.rdw.reporting.common.report.BatchExamReportRequestHolder;
import org.opentestsystem.rdw.reporting.processor.service.ReportContentService;
import org.opentestsystem.rdw.reporting.processor.service.ReportGenerator;
import org.opentestsystem.rdw.reporting.processor.service.ReportService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;

import java.io.IOException;
import java.nio.charset.Charset;
import java.util.List;
import java.util.NoSuchElementException;
import java.util.Set;

import static org.opentestsystem.rdw.reporting.processor.util.MediaTypes.getExtension;
import static org.springframework.http.HttpHeaders.CONTENT_DISPOSITION;
import static org.springframework.http.HttpHeaders.CONTENT_TYPE;
import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;

/**
 * This controller is responsible for providing access to Reports.
 */
@Controller
@RequestMapping("/api/reports")
public class ReportController {

    private final ReportGenerator reportGenerator;
    private final ReportService reportService;
    private final ReportContentService reportContentService;

    @Autowired
    public ReportController(final ReportGenerator reportGenerator,
                            final ReportService reportService,
                            final ReportContentService reportContentService) {
        this.reportGenerator = reportGenerator;
        this.reportService = reportService;
        this.reportContentService = reportContentService;
    }

    /**
     * Generate a new Report.
     *
     * @param request The report generation request
     * @return The new Report
     */
    @PostMapping(produces = APPLICATION_JSON_VALUE)
    @ResponseStatus(HttpStatus.ACCEPTED)
    @ResponseBody
    public Report createReport(@RequestBody final BatchExamReportRequestHolder request) {
        return reportGenerator.generateReport(request);
    }

    /**
     * Retrieve the list of Reports for a user, optionally filtered by id.
     *
     * @param user      The user identifier
     * @param reportIds The report ids, empty will retrieve the list of all reports for the user
     * @return The list of Reports
     */
    @GetMapping(produces = APPLICATION_JSON_VALUE)
    @ResponseBody
    public List<Report> getReports(
            @RequestParam("user") final String user,
            @RequestParam(value = "id", required = false) final Set<Long> reportIds) {
        return reportService.findAllByUserAndId(user, reportIds != null ? reportIds : ImmutableSet.of());
    }

    /**
     * Retrieve the report content for the given report.
     *
     * @param reportId A report id
     * @throws IOException If there is a problem reading/writing the response
     */
    @GetMapping(path = "{reportId}/content")
    @ResponseBody
    public ResponseEntity<ReportContentResource> getReportContent(@PathVariable final Long reportId,
                                                                  @RequestParam("user") final String user) throws IOException {
        final Report report = reportService.findOneById(reportId)
                .orElseThrow(NoSuchElementException::new);

        // TODO: move to service/db query layer
        if (!report.getUser().equals(user)) {
            throw new NoSuchElementException();
        }

        final ReportContentResource resource = reportContentService.openContent(report);

        final MediaType mediaType = resource.getMediaType();
        final String filename = report.getLabel().replaceAll("\\s", "_") + "." + getExtension(mediaType);
        final String contentDisposition = Headers.formatContentDispositionAttachment(filename, Charset.forName("UTF-8"));

        final HttpHeaders responseHeaders = new HttpHeaders();
        responseHeaders.set(CONTENT_TYPE, mediaType.toString());
        responseHeaders.set(CONTENT_DISPOSITION, contentDisposition);

        return new ResponseEntity<>(resource, responseHeaders, HttpStatus.OK);
    }
}
