package org.opentestsystem.rdw.reporting.processor.repository;

import com.google.common.collect.ImmutableSet;
import org.junit.After;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.reporting.common.test.ITDataSourceConfiguration;
import org.opentestsystem.rdw.reporting.common.test.RepositoryIT;
import org.opentestsystem.rdw.reporting.common.report.ExamExportQueryOptions;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.junit4.SpringRunner;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.NoSuchFileException;
import java.nio.file.Paths;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.districts;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.schoolGroups;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.schools;
import static org.opentestsystem.rdw.reporting.common.test.support.PermissionScopes.statewide;

@RunWith(SpringRunner.class)
@RepositoryIT
@ContextConfiguration(classes = {ITDataSourceConfiguration.class, JdbcExamRepository.class})
@Sql(scripts = {"classpath:common-integration-test-data.sql"})
@ActiveProfiles("test")
public class JdbcExamRepositoryIT {

    private final String TestCsvFile = "/tmp/test.csv";
    private static final int HeaderRowCountOnly = 1;

    @Autowired
    private JdbcExamRepository repository;

    @Test
    public void exportByDistrictWithStatewideShouldExportDistrictExams() throws IOException {

        ExamExportQueryOptions query = ExamExportQueryOptions
                .builder()
                .districtIds(ImmutableSet.of(-10L))
                .schoolYear(1996)
                .build();

        repository.export(statewide(), query, TestCsvFile);
        int count = getTestFileLineCount();
        assertThat(count).isEqualTo(4);
    }

    @Test
    public void exportByDistrictWithNoAccessShouldNotExportDistrictExams() throws IOException {

        ExamExportQueryOptions query = ExamExportQueryOptions
                .builder()
                .districtIds(ImmutableSet.of(-10L))
                .schoolYear(1996)
                .build();

        repository.export(districts(-20L), query, TestCsvFile);
        int count = getTestFileLineCount();
        assertThat(count).isEqualTo(HeaderRowCountOnly);
    }

    @Test
    public void exportBySchoolGroupWithSchoolGroupAccessShouldExportDistrictExams() throws IOException {

        ExamExportQueryOptions query = ExamExportQueryOptions
                .builder()
                .schoolGroupIds(ImmutableSet.of(-20L))
                .schoolYear(1997)
                .build();

        repository.export(schoolGroups(-20L), query, TestCsvFile);
        int count = getTestFileLineCount();
        assertThat(count).isEqualTo(2);
    }

    @Test
    public void exportBySchoolGroupWithNotSchoolGroupAccessShouldExportDistrictExams() throws IOException {

        ExamExportQueryOptions query = ExamExportQueryOptions
                .builder()
                .schoolGroupIds(ImmutableSet.of(-20L))
                .schoolYear(1997)
                .build();

        repository.export(schoolGroups(-10L), query, TestCsvFile);
        int count = getTestFileLineCount();
        assertThat(count).isEqualTo(HeaderRowCountOnly);
    }

    @Test
    public void exportBySchoolWithSchoolAccessShouldExportDistrictExams() throws IOException {

        ExamExportQueryOptions query = ExamExportQueryOptions
                .builder()
                .schoolIds(ImmutableSet.of(-11L))
                .schoolYear(1997)
                .build();

        repository.export(schools(-11L), query, TestCsvFile);
        int count = getTestFileLineCount();
        assertThat(count).isEqualTo(2);
    }

    @Test
    public void exportBySchoolWithNotSchoolAccessShouldExportDistrictExams() throws IOException {

        ExamExportQueryOptions query = ExamExportQueryOptions
                .builder()
                .schoolIds(ImmutableSet.of(-11L))
                .schoolYear(1997)
                .build();

        repository.export(schools(-12L), query, TestCsvFile);
        int count = getTestFileLineCount();
        assertThat(count).isEqualTo(HeaderRowCountOnly);
    }



    private int getTestFileLineCount() throws IOException {
        BufferedReader reader = new BufferedReader(new FileReader(TestCsvFile));
        int count = 0;

        while (reader.readLine() != null) {
            count++;
        }

        return count;
    }

    @After
    public void CleanUp() throws IOException {
        try {
            Files.delete(Paths.get(TestCsvFile));
        }
        catch (NoSuchFileException ignore) {

        }

    }
}
