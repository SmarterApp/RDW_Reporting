package org.opentestsystem.rdw.reporting.processor.service;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.opentestsystem.rdw.reporting.common.model.ReportStatus;
import org.opentestsystem.rdw.reporting.common.model.SchoolGradePrintableReportQuery;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.reporting.processor.model.UserReport;
import org.opentestsystem.rdw.reporting.processor.web.ReportContentResource;

import java.io.ByteArrayInputStream;
import java.time.Instant;
import java.util.List;
import java.util.NoSuchElementException;
import java.util.Optional;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.anyCollection;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.when;
import static org.opentestsystem.rdw.reporting.common.util.MediaTypes.APPLICATION_PDF_UTF8;
import static org.opentestsystem.rdw.reporting.common.util.MediaTypes.APPLICATION_ZIP;

@RunWith(MockitoJUnitRunner.class)
public class DefaultExamReportServiceTest {

    @Mock
    private ReportGenerator reportGenerator;

    @Mock
    private UserReportService userReportService;

    @Mock
    private ReportContentService reportContentService;

    private DefaultExamReportService service;

    private final User user = User.builderExt()
            .id("user")
            .username("username")
            .password("password")
            .build();

    @Before
    public void before() {
        this.service = new DefaultExamReportService(reportGenerator, userReportService, reportContentService);
    }

    @Test
    public void itShouldRetrieveAListOfReportsByUser() throws Exception {
        final List<UserReport> expected = newArrayList(report(123L), report(456L));
        when(userReportService.findAllByUserAndId(eq("username"), anyCollection()))
                .thenReturn(expected);

        assertThat(service.getReports(user, newArrayList())).isEqualTo(expected);
    }

    @Test
    public void itShouldRetrieveAListOfReportsByUserAndId() throws Exception {
        final List<UserReport> expected = newArrayList(report(123L), report(456L));
        when(userReportService.findAllByUserAndId(eq("username"), anyCollection()))
                .thenReturn(expected);

        assertThat(service.getReports(user, newArrayList(123L, 456L))).isEqualTo(expected);
    }

    @Test
    public void itShouldRetrievePDFReportContents() throws Exception {
        final UserReport report = report(123L);
        final byte[] contents = "PDF CONTENTS".getBytes();
        final ReportContentResource resource = new ReportContentResource(
                () -> new ByteArrayInputStream(contents),
                (long) contents.length,
                APPLICATION_PDF_UTF8,
                report
        );

        when(userReportService.findOneById(report.getId())).thenReturn(Optional.of(report));
        when(reportContentService.openContent(eq(report))).thenAnswer((id) -> resource);

        final ReportContentResource response = service.openReportContent(user, 123);
        assertThat(response).isEqualTo(resource);
    }

    @Test
    public void itShouldRetrieveZipReportContents() throws Exception {
        final UserReport report = report(123L);
        final byte[] contents = "ZIP CONTENTS".getBytes();
        final ReportContentResource resource = new ReportContentResource(
                () -> new ByteArrayInputStream(contents),
                (long) contents.length,
                APPLICATION_ZIP,
                report
        );

        when(userReportService.findOneById(report.getId())).thenReturn(Optional.of(report));
        when(reportContentService.openContent(eq(report))).thenAnswer((id) -> resource);

        final ReportContentResource response = service.openReportContent(user, 123);
        assertThat(response).isEqualTo(resource);
    }

    @Test(expected = NoSuchElementException.class)
    public void itShouldHandleAMissingReportWhenRequestingContents() throws Exception {
        when(userReportService.findOneById(123)).thenReturn(Optional.empty());
        service.openReportContent(user, 123);
    }

    @Test(expected = NoSuchElementException.class)
    public void itShouldReturnNotFoundWhenUserDoesNotMatchReportWhenRequestingContents() throws Exception {
        final User notTheReportOwner = User.builderExt()
                .id("id")
                .username("not the report owner")
                .password("pass")
                .build();
        when(userReportService.findOneById(123)).thenReturn(Optional.of(report(123L)));
        service.openReportContent(notTheReportOwner, 123);
    }

    private UserReport report(final long id) {
        final SchoolGradePrintableReportQuery query = SchoolGradePrintableReportQuery.builder()
                .schoolId(1L)
                .gradeId(2)
                .schoolYear(1997)
                .build();

        return UserReport.builder()
                .user("username")
                .status(ReportStatus.RUNNING)
                .label("my-report")
                .created(Instant.now())
                .id(id)
                .query(query)
                .build();
    }

}
