package org.opentestsystem.rdw.reporting.processor.web.converter;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.collect.ImmutableSet;
import org.junit.runner.RunWith;
import org.mockito.junit.MockitoJUnitRunner;
import org.opentestsystem.rdw.common.model.Subject;
import org.opentestsystem.rdw.reporting.common.model.AbstractAggregateReportQuery;
import org.opentestsystem.rdw.reporting.common.model.Dimension;
import org.opentestsystem.rdw.reporting.common.model.LongitudinalReportQuery;
import org.opentestsystem.rdw.reporting.common.model.LongitudinalRow;
import org.opentestsystem.rdw.reporting.common.model.Measures;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.StudentFilters;
import org.springframework.context.MessageSource;

import java.util.Map;

import static com.google.common.collect.Maps.newHashMap;
import static org.opentestsystem.rdw.common.model.AssessmentType.ICA;
import static org.opentestsystem.rdw.common.model.Subject.MATH;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Custom;


@RunWith(MockitoJUnitRunner.class)
public class LongitudinalFilteredSubgroupReportCsvHandlerTest extends FilteredSubgroupReportCsvHandlerTest<LongitudinalRow> {
    @Override
    protected LongitudinalRow reportRow(final String subgroupKey, final Organization organization) {
        return super.reportRowBuilder(LongitudinalRow.builder(), organization)
                .dimension(Dimension.builder().type(Custom).code("subgroupA").build())
                .cohortMeasures(Measures.builder().build())
                .build();
    }

    @Override
    protected FilteredSubgroupReportCsvHandler createHandlerUnderTest(final MessageSource messageSource, final ObjectMapper objectMapper) {
        return new LongitudinalFilteredSubgroupReportCsvHandler(messageSource, objectMapper);
    }

    @Override
    protected AbstractAggregateReportQuery.Builder getQueryBuilder() {
        final Map<String, StudentFilters> subgroups = newHashMap();
        subgroups.put("overall", StudentFilters.builder()
                .build());
        subgroups.put("subgroupA", StudentFilters.builder()
                .genderCodes(ImmutableSet.of("Male"))
                .build());
        subgroups.put("subgroupB", StudentFilters.builder()
                .genderCodes(ImmutableSet.of("Female"))
                .build());

        return LongitudinalReportQuery.builder()
                .assessmentTypeCode(ICA.code())
                .subjectCodes(ImmutableSet.of(MATH.code().toLowerCase(), Subject.ELA.code().toUpperCase()))
                .toSchoolYear(2018)
                .assessmentGradeCodes(ImmutableSet.of("01", "02", "03", "04", "05"))
                .includeState(true)
                .includeAllDistricts(false)
                .subgroups(subgroups)
                .districtIds(ImmutableSet.of(1L))
                .schoolIds(ImmutableSet.of(1L));
    }

    @Override
    protected int getHeadersCount() {
        return 24;
    }
}
