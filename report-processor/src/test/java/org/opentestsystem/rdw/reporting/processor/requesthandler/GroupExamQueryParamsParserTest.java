package org.opentestsystem.rdw.reporting.processor.requesthandler;

import com.google.common.collect.ImmutableMap;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.reporting.common.codedentity.AssessmentTypeService;
import org.opentestsystem.rdw.reporting.common.codedentity.SubjectService;
import org.opentestsystem.rdw.reporting.processor.model.AbstractExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.GroupExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.ExamQueryParams;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;
import static org.opentestsystem.rdw.reporting.processor.model.ExamQueryParams.PermissionType.Group;

public class GroupExamQueryParamsParserTest {

    private AssessmentTypeService assessmentTypeService;
    private SubjectService subjectService;
    private GroupExamQueryParamsParser parser;

    @Before
    public void setup() {
        assessmentTypeService = mock(AssessmentTypeService.class);
        subjectService = mock(SubjectService.class);
        when(assessmentTypeService.getIdsByCode()).thenReturn(ImmutableMap.of("a1", 1));
        when(subjectService.getIdsByCode()).thenReturn(ImmutableMap.of("s1", 1));
        parser = new GroupExamQueryParamsParser(assessmentTypeService, subjectService);
    }

    @Test
    public void itShouldAcceptGroupExamReportRequests() {
        assertThat(parser.accept(mock(AbstractExamReportRequest.class))).isFalse();
        assertThat(parser.accept(mock(GroupExamReportRequest.class))).isTrue();
    }

    @Test
    public void itShouldCreateAnExamQueryParams() {
        final GroupExamReportRequest request = GroupExamReportRequest.builder()
                .schoolYear(1997)
                .subjectCode("s1")
                .groupId(123)
                .assessmentTypeCode("a1")
                .build();

        final ExamQueryParams expected = ExamQueryParams.builder()
                .groupId(request.getGroupId())
                .assessmentTypeCode(request.getAssessmentTypeCode())
                .assessmentTypeId(1)
                .subjectCode(request.getSubjectCode())
                .subjectId(1)
                .schoolYear(request.getSchoolYear())
                .queryPermissionType(Group)
                .build();

        assertThat(parser.parseQueryParams(request)).isEqualToComparingFieldByField(expected);
    }

}