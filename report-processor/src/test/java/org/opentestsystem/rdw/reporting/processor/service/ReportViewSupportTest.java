package org.opentestsystem.rdw.reporting.processor.service;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.common.model.AssessmentType;
import org.opentestsystem.rdw.reporting.common.model.Assessment;
import org.opentestsystem.rdw.reporting.common.model.Exam;
import org.opentestsystem.rdw.reporting.common.model.ScaleScore;
import org.opentestsystem.rdw.reporting.processor.model.ScaleScoreView;
import org.springframework.context.MessageSource;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.mock;

public class ReportViewSupportTest {

    private final Assessment simpleICA = Assessment.builder()
            .type(AssessmentType.ICA)
            .cutPoints(newArrayList(2000, 2200, 2400, 2600, 2800))
            .build();

    private final Assessment simpleIAB = Assessment.builder()
            .type(AssessmentType.IAB)
            .cutPoints(newArrayList(2000, 0, 2450, 0, 2900))
            .build();

    private final Assessment simpleIAB2 = Assessment.builder()
            .type(AssessmentType.IAB)
            .cutPoints(newArrayList(100, 0, 400, 0, 700))
            .build();


    private ReportViewSupport support;
    private MessageSource messageSource;

    @Before
    public void before() {
        this.messageSource = mock(MessageSource.class);
        this.support = new ReportViewSupport(messageSource);
    }

    @Test
    public void getLastTwoDigitsShouldReturnLastTwoDigits() throws Exception {
        assertThat(support.getLastTwoDigits(1997)).isEqualTo("97");
    }

    @Test
    public void getLastTwoDigitsShouldReturnGivenValueIfLengthIsLessThanTwo() throws Exception {
        assertThat(support.getLastTwoDigits(7)).isEqualTo("7");
    }

    @Test
    public void getLastTwoDigitsShouldReturnGivenValueIfLengthIsTwo() throws Exception {
        assertThat(support.getLastTwoDigits(17)).isEqualTo("17");
    }

    @Test
    public void getScaleScoreViewShouldEnforcePositionMinimumOfOne() throws Exception {
        assertThat(support.getScaleScoreView(exam(-100), simpleIAB).getPosition()).isEqualTo(1);
    }

    @Test
    public void getScaleScoreViewShouldEnforcePositionMaximumOf100() throws Exception {
        assertThat(support.getScaleScoreView(exam(10000), simpleIAB).getPosition()).isEqualTo(100);
    }

    @Test
    public void getScaleScoreViewShouldReturn3LevelsForIAB() throws Exception {
        assertThat(support.getScaleScoreView(exam(), simpleIAB).getLevels()).hasSize(3);
    }

    @Test
    public void getScaleScoreViewShouldReturn4LevelsForICA() throws Exception {
        assertThat(support.getScaleScoreView(exam(), simpleICA).getLevels()).hasSize(4);
    }

    @Test
    public void getScaleScoreViewShouldSetPositionCorrectlyWhenMinimum() throws Exception {
        assertThat(support.getScaleScoreView(exam(simpleIAB.getCutPoints().get(0)), simpleIAB).getPosition()).isEqualTo(1);
    }

    @Test
    public void getScaleScoreViewShouldSetPositionCorrectlyWhenMaximum() throws Exception {
        assertThat(support.getScaleScoreView(exam(simpleIAB.getCutPoints().get(4)), simpleIAB).getPosition()).isEqualTo(100);
    }

    @Test
    public void getScaleScoreViewShouldSetPositionCorrectly() throws Exception {
        assertThat(support.getScaleScoreView(exam(2400), simpleICA).getPosition()).isEqualTo(50);
    }

    @Test
    public void getScaleScoreViewShouldReturnCorrectLevelsForSimpleICA() throws Exception {
        assertThat(support.getScaleScoreView(exam(0, 0), simpleICA).getLevels())
                .usingRecursiveFieldByFieldElementComparator()
                .containsExactly(
                        level(0, 25),
                        level(25, 25),
                        level(50, 25),
                        level(75, 25)
                );
    }

    @Test
    public void getScaleScoreViewShouldReturnCorrectLevelsForSimpleIAB() throws Exception {
        assertThat(support.getScaleScoreView(exam(0, 100), simpleIAB).getLevels())
                .usingRecursiveFieldByFieldElementComparator()
                .containsExactly(
                        level(0, 33),
                        level(33, 33),
                        level(66, 34)
                );
    }

    @Test
    public void getScaleScoreViewShouldReturnCorrectLevelsForHighStdErrIAB() throws Exception {
        assertThat(support.getScaleScoreView(exam(100, 200), simpleIAB2).getLevels())
                .usingRecursiveFieldByFieldElementComparator()
                .containsExactly(
                        level(0, 1),
                        level(1, 98),
                        level(99, 1)
                );
    }

    @Test
    public void getClaimCodeComparatorShouldSortWritingLast() {
        List<String> claims = Arrays.asList("1", "1-A", "2-W", "9", "7");
        claims.sort(support.getClaimCodeComparator());

        assertThat(claims).containsExactly("1", "1-A", "9", "7", "2-W");
    }

    /*
        Support methods
     */

    private Exam exam(final int scaleScore, final double standardError) {
        return Exam.builder()
                .scaleScore(ScaleScore.builder()
                        .value(scaleScore)
                        .standardError(standardError)
                        .build()
                )
                .build();
    }

    private Exam exam(final int scaleScore) {
        return exam(scaleScore, 0);
    }

    private Exam exam() {
        return exam(0, 0);
    }

    private ScaleScoreView.Level level(final int position, final int width) {
        return new ScaleScoreView.Level(position, width);
    }

}