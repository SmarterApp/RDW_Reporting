package org.opentestsystem.rdw.reporting.processor.web.converter;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.Iterators;
import org.apache.commons.csv.CSVFormat;
import org.apache.commons.csv.CSVParser;
import org.apache.commons.csv.CSVRecord;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.junit.MockitoJUnitRunner;
import org.opentestsystem.rdw.reporting.common.model.ActiveAssessment;
import org.opentestsystem.rdw.reporting.common.model.BasicAggregateReportQuery;
import org.opentestsystem.rdw.reporting.common.model.BasicAggregateRow;
import org.opentestsystem.rdw.reporting.common.model.Dimension;
import org.opentestsystem.rdw.reporting.common.model.District;
import org.opentestsystem.rdw.reporting.common.model.Measures;
import org.opentestsystem.rdw.reporting.common.model.Organization;
import org.opentestsystem.rdw.reporting.common.model.OrganizationType;
import org.opentestsystem.rdw.reporting.common.model.ReportStatus;
import org.opentestsystem.rdw.reporting.common.model.School;
import org.opentestsystem.rdw.reporting.common.model.State;
import org.opentestsystem.rdw.reporting.common.model.StudentFilters;
import org.opentestsystem.rdw.reporting.common.test.support.ReportQueries;
import org.opentestsystem.rdw.reporting.processor.model.AggregateReportRequest;
import org.opentestsystem.rdw.reporting.processor.model.Report;
import org.opentestsystem.rdw.reporting.processor.model.SchoolGradeExamReportRequest;
import org.opentestsystem.rdw.reporting.processor.web.ReportContentResource;
import org.springframework.context.MessageSource;
import org.springframework.http.HttpHeaders;
import org.springframework.mock.http.MockHttpOutputMessage;

import java.io.ByteArrayInputStream;
import java.io.StringReader;
import java.util.List;
import java.util.Locale;
import java.util.concurrent.atomic.AtomicInteger;

import static com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES;
import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.spy;
import static org.mockito.Mockito.when;
import static org.opentestsystem.rdw.reporting.common.model.DimensionType.Overall;
import static org.opentestsystem.rdw.reporting.common.util.MediaTypes.TEXT_CSV_UTF8;
import static org.springframework.http.MediaType.APPLICATION_JSON;

@RunWith(MockitoJUnitRunner.class)
public class AggregateReportCsvHandlerTest {
    private static final AtomicInteger idGenerator = new AtomicInteger(1);

    @Mock
    private MessageSource messageSource;

    @Mock
    private ReportContentResource resource;

    private MockHttpOutputMessage outputMessage;
    private byte[] reportPayload;
    private Report report;
    private AggregateReportCsvHandler handler;

    @Before
    public void setup() throws Exception {
        final ObjectMapper objectMapper = new ObjectMapper();
        objectMapper.configure(FAIL_ON_UNKNOWN_PROPERTIES, false);
        outputMessage = new MockHttpOutputMessage();

        when(messageSource.getMessage(anyString(), any(Object[].class), any(Locale.class)))
                .thenAnswer(invocationOnMock -> invocationOnMock.getArgument(0));

        // 1 state, 3 districts, 3 schools per district => 13 rows
        final List<BasicAggregateRow> data = newArrayList(reportRow(state()));
        final List<District> districts = newArrayList(district(), district(), district());
        districts.forEach(district -> {
            data.add(reportRow(district));
            data.add(reportRow(school(district.getId())));
            data.add(reportRow(school(district.getId())));
            data.add(reportRow(school(district.getId())));
        });
        reportPayload = objectMapper.writeValueAsBytes(data);

        final BasicAggregateReportQuery query = ReportQueries.basicAggregateQuery().build();
        final AggregateReportRequest request = AggregateReportRequest.builder()
                .query(query)
                .build();
        report = spy(Report.builder()
                .status(ReportStatus.COMPLETED)
                .reportRequest(request)
                .label("my report")
                .build());
        when(resource.getReport()).thenAnswer(invocation -> report);
        when(resource.getInputStream()).thenAnswer(invocation -> new ByteArrayInputStream(reportPayload));

        handler = new AggregateReportCsvHandler(messageSource, objectMapper);
    }

    @Test
    public void itShouldHandleAggregateReportPayloads() {
        assertThat(handler.accept(resource, null)).isTrue();
    }

    @Test
    public void itShouldNotHandleAggregateReportPayloadsIfJsonIsRequested() {
        assertThat(handler.accept(resource, APPLICATION_JSON)).isFalse();
    }

    @Test
    public void itShouldOnlyHandleAggregateReportPayloads() {
        final SchoolGradeExamReportRequest request = SchoolGradeExamReportRequest.builder().build();
        when(report.getReportRequest()).thenReturn(request);
        assertThat(handler.accept(resource, null)).isFalse();
    }

    @Test
    public void itShouldWriteHeaders() throws Exception {
        handler.writeResource(resource, outputMessage);

        final HttpHeaders headers = outputMessage.getHeaders();
        assertThat(headers.getContentType()).isEqualTo(TEXT_CSV_UTF8);
        assertThat(headers.getFirst(HttpHeaders.CONTENT_DISPOSITION)).contains("my_report");
    }

    @Test
    public void itShouldWriteJsonAsCsv() throws Exception {
        handler.writeResource(resource, outputMessage);

        try (final StringReader reader = new StringReader(outputMessage.getBodyAsString())) {
            final CSVParser parser = CSVFormat.DEFAULT
                    .withFirstRecordAsHeader()
                    .parse(reader);

            assertThat(parser.getHeaderMap()).hasSize(17);
            final List<CSVRecord> rows = parser.getRecords();
            assertThat(rows).hasSize(13);
        }
    }

    @Test
    public void itShouldWriteFiltersAsAttributes() throws Exception {
        final StudentFilters filters = StudentFilters.builder()
                .genderCodes(ImmutableSet.of("Male"))
                .build();
        final BasicAggregateReportQuery query = ReportQueries.basicAggregateQuery()
                .studentFilters(filters)
                .build();
        final AggregateReportRequest request = AggregateReportRequest.builder()
                .query(query)
                .build();
        when(report.getReportRequest()).thenReturn(request);

        handler.writeResource(resource, outputMessage);

        try (final StringReader reader = new StringReader(outputMessage.getBodyAsString())) {
            final CSVParser parser = CSVFormat.DEFAULT
                    .withFirstRecordAsHeader()
                    .parse(reader);
            final List<CSVRecord> rows = parser.getRecords();
            final String attributes = Iterators.getLast(rows.get(0).iterator());
            assertThat(attributes).contains("ReportDate");
            assertThat(attributes).contains("Sex: Male");
        }
    }

    private State state() {
        return State.builder()
                .name("State")
                .build();
    }

    private District district() {
        final int districtId = idGenerator.getAndIncrement();
        return District.builder()
                .name("District " + districtId)
                .id((long) districtId)
                .build();
    }

    private School school(final long districtId) {
        final int schoolId = idGenerator.getAndIncrement();
        return School.builder()
                .organizationType(OrganizationType.School)
                .name("School " + schoolId)
                .id((long) schoolId)
                .districtId(districtId)
                .build();
    }

    private BasicAggregateRow reportRow(final Organization organization) {
        return BasicAggregateRow.builder()
                .assessment(ActiveAssessment.builder()
                        .id(123)
                        .examSchoolYear(1999)
                        .subjectCode("Math")
                        .label("An Assessment")
                        .gradeCode("03")
                        .build())
                .dimension(Dimension.builder().type(Overall).build())
                .measures(Measures.builder()
                        .avgScaleScore(2500)
                        .avgStdErr(50)
                        .level1Count(1)
                        .level2Count(2)
                        .level3Count(3)
                        .level4Count(4)
                        .build())
                .organization(organization)
                .build();
    }
}