<!-- Individual Assessment Result Container -->
<div class="assessment-result well wide-content-container">
  <div class="flex-children">
    <div class="flex-child grow">
      <span
        class="tag tag-lg {{
          colorService.getColor(getGradeIdx(assessmentExam.assessment.grade))
        }}"
      >
        <span class="label">{{
          'common.assessment-grade-short-label.' +
            assessmentExam.assessment.grade | translate
        }}</span>
        {{ assessmentExam.assessment.label }}
      </span>
    </div>
    <div class="flex-child">
      <button
        class="form-control btn btn-default pull-right"
        (click)="collapsed = !collapsed"
        angulartics2On="click"
        angularticsAction="ToggleCollapseResults"
        angularticsCategory="AssessmentResults"
      >
        {{
          'common.action.' +
            (collapsed ? 'expand-results' : 'collapse-results') | translate
        }}
        <i
          class="fa"
          [ngClass]="{
            'fa-caret-square-o-up': !collapsed,
            'fa-caret-square-o-down': collapsed
          }"
          aria-hidden="true"
        ></i>
        <span class="sr-only">{{
          'common.action.' +
            (collapsed ? 'expand-results' : 'collapse-results') | translate
        }}</span>
      </button>
    </div>
  </div>

  <div *ngIf="allowFilterBySessions" class="row mb-sm">
    <!-- Sessions -->
    <div class="col-md-12">
      <strong>{{ 'assessment-results.sessions-title' | translate }}</strong>
      <div class="flex-children">
        <a
          *ngFor="let session of sessions"
          class="reverse multi-line btn flex-child {{
            session.filter ? 'aqua' : 'gray-dark'
          }}"
          href="javascript:void(0)"
          (click)="toggleSession(session)"
          angulartics2On="click"
          angularticsAction="ToggleSession"
          angularticsCategory="AssessmentResults"
        >
          <span class="block-children">
            <strong>{{ session.date | date }}</strong>
            <small class="text-left">{{ session.id | session }}</small>
          </span>
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <average-scale-score
        [assessmentExam]="assessmentExam"
        [statistics]="statistics"
        [showValuesAsPercent]="showValuesAsPercent"
        [assessmentProvider]="assessmentProvider"
        [subjectDefinition]="subjectDefinition"
        [scoreType]="scoreType"
      ></average-scale-score>
      <div class="z-index-over-data-table mt-sm pull-right">
        <sb-radio-group
          *ngIf="scoreTypeOptions.length > 1"
          [options]="scoreTypeOptions"
          [(ngModel)]="scoreType"
          id="score-type"
          buttonGroupStyles="btn-group-xs"
          buttonStyles="btn-default"
          analyticsCategory="AssessmentResults"
          analyticsEvent="ChangeScoreView"
        ></sb-radio-group>
      </div>
    </div>
  </div>

  <div class="row mt-md" [hidden]="!showPercentileHistory">
    <div class="col-md-12">
      <div class="assessment-percentile-container">
        <assessment-percentile-history
          [percentileGroups]="percentileGroups"
        ></assessment-percentile-history>
      </div>
    </div>
  </div>

  <!-- Student Results -->
  <ng-container *ngIf="!collapsed" @fadeAnimation>
    <spinner *ngIf="!currentResultsView"></spinner>

    <div *ngIf="currentResultsView" class="row">
      <div class="col-md-12">
        <!-- Result view selector -->
        <span class="z-index-over-data-table">
          <div>
            <strong>{{
              'assessment-results.result-view-select' | translate
            }}</strong>
          </div>
          <div class="select-menu-group mb-sm mt-xs">
            <label class="sr-only">{{
              'assessment-results.select-view' | translate
            }}</label>
            <div class="btn-group" dropdown>
              <button
                dropdownToggle
                type="button"
                class="btn btn-default btn-borderless dropdown-toggle"
              >
                {{ currentResultsView.label | translate }}
                <i class="fa fa-angle-down"></i>
              </button>
              <ul *dropdownMenu class="dropdown-menu" role="menu">
                <li role="menuitem" *ngIf="resultsByStudentView.display">
                  <a
                    class="dropdown-item"
                    popover="{{
                      'assessment-results.no-results-by-item' | translate
                    }}"
                    triggers="{{
                      !resultsByStudentView.disabled
                        ? ''
                        : 'mouseenter:mouseleave'
                    }}"
                    placement="right"
                    container="body"
                    href="javascript:void(0)"
                    (click)="
                      resultsByStudentView.disabled ||
                        setCurrentView(resultsByStudentView)
                    "
                    [ngClass]="{
                      selected: currentResultsView == resultsByStudentView,
                      disabled: resultsByStudentView.disabled
                    }"
                  >
                    {{ resultsByStudentView.label | translate }}
                  </a>
                </li>
                <li role="menuitem" *ngIf="resultsByItemView.display">
                  <a
                    class="dropdown-item"
                    popover="{{
                      'assessment-results.no-results-by-item' | translate
                    }}"
                    triggers="{{
                      !resultsByItemView.disabled ? '' : 'mouseenter:mouseleave'
                    }}"
                    placement="right"
                    container="body"
                    href="javascript:void(0)"
                    (click)="
                      resultsByItemView.disabled ||
                        setCurrentView(resultsByItemView)
                    "
                    [ngClass]="{
                      selected: currentResultsView == resultsByItemView,
                      disabled: resultsByItemView.disabled
                    }"
                  >
                    {{ resultsByItemView.label | translate }}
                  </a>
                </li>
                <li role="menuitem" *ngIf="distractorAnalysisView.display">
                  <a
                    class="dropdown-item"
                    popover="{{
                      'assessment-results.no-distractor-analysis' | translate
                    }}"
                    triggers="{{
                      !distractorAnalysisView.disabled
                        ? ''
                        : 'mouseenter:mouseleave'
                    }}"
                    placement="right"
                    container="body"
                    href="javascript:void(0)"
                    (click)="
                      distractorAnalysisView.disabled ||
                        setCurrentView(distractorAnalysisView)
                    "
                    [ngClass]="{
                      selected: currentResultsView == distractorAnalysisView,
                      disabled: distractorAnalysisView.disabled
                    }"
                  >
                    {{ distractorAnalysisView.label | translate }}
                  </a>
                </li>
                <li role="menuitem" *ngIf="writingTraitScoresView.display">
                  <a
                    class="dropdown-item"
                    popover="{{
                      'assessment-results.no-writing-trait-scores' | translate
                    }}"
                    triggers="{{
                      !writingTraitScoresView.disabled
                        ? ''
                        : 'mouseenter:mouseleave'
                    }}"
                    placement="right"
                    container="body"
                    href="javascript:void(0)"
                    (click)="
                      writingTraitScoresView.disabled ||
                        setCurrentView(writingTraitScoresView)
                    "
                    [ngClass]="{
                      selected: currentResultsView == writingTraitScoresView,
                      disabled: writingTraitScoresView.disabled
                    }"
                  >
                    {{ writingTraitScoresView.label | translate }}
                  </a>
                </li>
                <li role="menuitem" *ngIf="targetReportView.display">
                  <a
                    class="dropdown-item"
                    popover="{{
                      'assessment-results.no-target-reports' | translate
                    }}"
                    triggers="{{
                      !targetReportView.disabled ? '' : 'mouseenter:mouseleave'
                    }}"
                    placement="right"
                    container="body"
                    href="javascript:void(0)"
                    (click)="
                      targetReportView.disabled ||
                        setCurrentView(targetReportView)
                    "
                    [ngClass]="{
                      selected: currentResultsView == targetReportView,
                      disabled: targetReportView.disabled
                    }"
                  >
                    {{ targetReportView.label | translate }}
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </span>

        <!-- Buttons right of view select -->
        <div class="pull-right mt-sm">
          <ul class="list-unstyled list-inline">
            <li *ngIf="assessmentExam.assessment.isIab">
              <button
                class="btn btn-primary btn-sm"
                angulartics2On="click"
                angularticsAction="InstructionalResource"
                angularticsCategory="AssessmentResults"
                [angularticsProperties]="{
                  label: assessmentExam.assessment.label
                }"
                [popover]="buttonPopover"
                popoverTitle="{{
                  'common.results.assessment.instruct-button'
                    | translate: { level: assessmentExam.assessment.label }
                }}"
                container="body"
                (click)="
                  loadInstructionalResources(assessmentExam.assessment, 0)
                "
                [outsideClick]="true"
              >
                <i class="fa fa-book"></i>
                {{ 'common.results.assessment.instruct' | translate }}
              </button>
            </li>
            <li
              *ngIf="
                percentileDisplayEnabled && assessmentExam.assessment.isIab
              "
            >
              <button
                class="btn btn-default btn-sm"
                type="button"
                (click)="onPercentileButtonClickInternal()"
              >
                {{
                  (showPercentileHistory
                    ? 'assessment-percentile-history.button.hide'
                    : 'assessment-percentile-history.button.show') | translate
                }}
              </button>
            </li>
            <li *ngIf="currentResultsView.canExport">
              <button
                class="btn btn-default btn-sm"
                [disabled]="
                  !currentExportResults ||
                  !currentExportResults.hasDataToExport()
                "
                (click)="currentExportResults.exportToCsv()"
              >
                <i class="fa fa-cloud-download"></i>
                {{ 'common.export' | translate }}
              </button>
            </li>
          </ul>
        </div>

        <ng-container *ngIf="showStudentResults">
          <results-by-student
            [exams]="exams"
            [assessment]="assessmentExam.assessment"
            [minimumItemDataYear]="minimumItemDataYear"
            [scoreType]="scoreType"
          ></results-by-student>
        </ng-container>
        <ng-container *ngIf="showItemsByPointsEarned">
          <results-by-item
            #resultsByItem
            [showValuesAsPercent]="showValuesAsPercent"
            [assessmentProvider]="assessmentProvider"
            [assessmentExporter]="assessmentExporter"
            [assessment]="assessmentExam.assessment"
            [exams]="exams"
          ></results-by-item>
        </ng-container>
        <ng-container *ngIf="showDistractorAnalysis">
          <distractor-analysis
            #distractorAnalysis
            [showValuesAsPercent]="showValuesAsPercent"
            [assessmentProvider]="assessmentProvider"
            [assessmentExporter]="assessmentExporter"
            [assessment]="assessmentExam.assessment"
            [exams]="exams"
          ></distractor-analysis>
        </ng-container>
        <ng-container *ngIf="showWritingTraitScores">
          <writing-trait-scores
            #writingTraitScores
            [showValuesAsPercent]="showValuesAsPercent"
            [assessmentProvider]="assessmentProvider"
            [assessmentExporter]="assessmentExporter"
            [assessment]="assessmentExam.assessment"
            [exams]="exams"
          ></writing-trait-scores>
        </ng-container>
        <ng-container *ngIf="showTargetReport">
          <target-report
            #targetReport
            [assessmentProvider]="assessmentProvider"
            [assessmentExporter]="assessmentExporter"
            [assessment]="assessmentExam.assessment"
            [displayedFor]="displayedFor"
            [statistics]="statistics"
            [exams]="exams"
            [studentsTested]="statistics.total"
            [filterBy]="filterBy"
            [subjectDefinition]="subjectDefinition"
          ></target-report>
        </ng-container>
      </div>
    </div>
  </ng-container>
</div>

<ng-template #buttonPopover>
  <instructional-resource-popover
    [provider]="instructionalResourceProvider"
  ></instructional-resource-popover>
</ng-template>
