<!-- modal flyweight for student reports -->
<student-report-download #menuReportDownloader
                         [lockAssessmentType]="true"
                         [lockSubject]="true"
                         [lockSchoolYear]="true"></student-report-download>

<!-- Individual Assessment Result Container -->
<div class="assessment-result well">
  <div class="mb-md">
    <!-- Top Right Buttons -->
    <div class="row">
      <div class="col-xs-10 col-sm-11">
        <div class="row">
          <div class="col-md-8 mb-sm">
            <!-- Assessment Title -->
            <span class="tag tag-lg {{colorService.getColor(getGradeIdx(assessmentExam.assessment.grade))}}">
                  <span class="label">{{assessmentExam.assessment.grade | gradeDisplay}}</span>
                  {{assessmentExam.assessment.name}}
              </span>
          </div>
          <div class="col-md-4">
              <span class="pull-right"
                    popover="{{ 'labels.menus.resources-disabled-message' | translate }}"
                    triggers="{{assessmentExam.assessment.hasResourceUrl ? '': 'mouseenter:mouseleave'}}"
                    container="body">
                <button
                  class="btn btn-success btn-xs float-none-xs"
                  angulartics2On="click"
                  angularticsEvent="InstructionalResource"
                  angularticsCategory="AssessmentResults"
                  [angularticsProperties]="{label: assessmentExam.assessment.name}"
                  [disabled]="!assessmentExam.assessment.hasResourceUrl"
                  (click)="openInstructionalResource()">
                  <i class="fa fa-list-alt"></i> {{'labels.groups.results.assessment.instruct' | translate }}
                </button>
              </span>
          </div>
        </div>
      </div>
      <div class="col-xs-2 col-sm-1">
        <button class="btn btn-default btn-sm icon-only pull-right" (click)="collapsed = !collapsed"
                angulartics2On="click" angularticsEvent="ToggleCollapseResults" angularticsCategory="AssessmentResults">
          <i class="fa font-bold" [ngClass]="{'fa-angle-down':collapsed, 'fa-angle-up':!collapsed}"></i> <span
          class="sr-only">{{'prompt.collapse' | translate}}</span>
        </button>
      </div>
    </div>

    <div class="row mb-lg">
      <!-- Sessions -->
      <div class="col-md-5">
        <div *ngIf="allowFilterBySessions">
          <p><strong>{{'labels.groups.results.assessment.sessions-title' | translate}}</strong><br/>
            {{'labels.groups.results.assessment.sessions-instruct' | translate}}</p>
          <div class="flex-children">
            <a *ngFor="let session of sessions" class="tag aqua reverse multi-line"
               [ngClass]="{'gray-dark':!session.filter}" (click)="toggleSession(session)"
               angulartics2On="click" angularticsEvent="ToggleSession" angularticsCategory="AssessmentResults">
                    <span class="block-children text-left">
                        <strong>{{session.date | date }}</strong>
                        <small>{{session.id || 'labels.groups.results.session-unknown' | translate }}</small>
                    </span>
              <span class="icon"><i class="fa" [ngClass]="{'fa-minus':session.filter, 'fa-plus': !session.filter }"></i></span>
            </a>
          </div>
        </div>
      </div>

      <!-- Aggregate Scale Score -->
      <div class="col-md-7">
        <average-scale-score [assessmentExam]="assessmentExam"
                             [statistics]="statistics"
                             [showValuesAsPercent]="showValuesAsPercent"></average-scale-score>
      </div>

    </div>

    <!-- Student Results -->
    <div *ngIf="!collapsed" @fadeAnimation>


      <div *ngIf="!showItemsByPoints">
        <h3 class="gray-darkest mb-sm">
          {{'labels.groups.results.assessment.exams.title' | translate}}

          <span class="pull-right">
            <div *ngIf="showClaimToggle" class="btn-group btn-group-xs" role="group">
              <button (click)="setOverallScoreSelected()"
                      class="btn btn-default"
                      angulartics2On="click" angularticsEvent="ViewOverallScores"
                      angularticsCategory="AssessmentResults"
                      [ngClass]="{'active': !isClaimScoreSelected}">
                {{'buttons.display-overall' | translate}}
              </button>
              <button (click)="setClaimScoreSelected()"
                      class="btn btn-default"
                      angulartics2On="click" angularticsEvent="ViewClaimScores" angularticsCategory="AssessmentResults"
                      [ngClass]="{'active': isClaimScoreSelected}">
                {{'buttons.display-claim' | translate}}
              </button>
            </div>
            <span popover="{{ 'messages.no-item-level-data' | translate }}"
                  triggers="{{ hasItemLevelData ? '': 'mouseenter:mouseleave'}}">
              <button *ngIf="assessmentExam.assessment.isInterim"
                      [disabled]="!hasItemLevelData"
                      class="btn btn-default btn-xs " (click)="viewItemsByPoints(true)">
                {{'labels.groups.results.assessment.button-items' | translate}} <i class="fa fa-chevron-right"></i>
              </button>
            </span>
          </span>
        </h3>


        <!-- Student Results Table -->
        <p-dataTable [value]="exams"
                     emptyMessage="{{'labels.groups.results.assessment.exams.empty-message' | translate}}"
                     sortField="student.lastName" tableStyleClass="table table-striped table-hover overflow"
                     expandableRows="true">
          <!-- Row Menu -->
          <p-column sortField="student.lastName"
                    header="{{'labels.groups.results.assessment.exams.cols.name' | translate}}" [sortable]="true">
            <ng-template let-exam="rowData" pTemplate="body">
              <popup-menu [item]="exam" [actions]="actions"
                          [text]="'labels.personName' | translate:exam.student"></popup-menu>
            </ng-template>
          </p-column>
          <p-column field="date" header="{{'labels.groups.results.assessment.exams.cols.date' | translate}}"
                    [sortable]="true">
            <ng-template let-exam="rowData" pTemplate="body">
              {{ exam.date | date }}
            </ng-template>
          </p-column>
          <p-column field="session" header="{{'labels.groups.results.assessment.exams.cols.session' | translate}}"
                    [sortable]="true"></p-column>
          <p-column field="enrolledGrade" header="{{'labels.groups.results.assessment.exams.cols.grade' | translate}}"
                    [sortable]="true" [hidden]="isClaimScoreSelected">
            <ng-template let-exam="rowData" pTemplate="body">
              {{ exam.enrolledGrade | gradeDisplay:'enrolled-name' }}
            </ng-template>
          </p-column>
          <p-column field="administrativeCondition" [sortable]="true" [hidden]="isClaimScoreSelected">
            <ng-template pTemplate="header">
              <span info-label title="{{'labels.groups.results.assessment.exams.cols.status' | translate}}"
                    content="{{'labels.groups.results.assessment.exams.cols.status-info' | translate}}"></span>
            </ng-template>
            <ng-template let-exam="rowData" pTemplate="body">
              <span *ngIf="exam.administrativeCondition !== 'Valid'" class="label border-only maroon">{{ 'enum.administrative-condition.' + exam.administrativeCondition | translate }}</span>
              <span *ngIf="exam.completeness == 'Partial'" class="label border-only maroon">{{ 'enum.completeness.' + exam.completeness | translate }}</span>
            </ng-template>
          </p-column>
          <p-column field="level" [sortable]="true" [hidden]="isClaimScoreSelected">
            <ng-template pTemplate="header">
              <span info-label title="{{performanceLevelHeader | translate}}"
                    content="{{performanceLevelHeaderInfo | translate}}"></span>
            </ng-template>
            <ng-template let-exam="rowData" pTemplate="body">
              {{ examLevelEnum + (exam.level ? exam.level : 'missing') | translate }}
            </ng-template>
          </p-column>
          <p-column field="score" [sortable]="true" [hidden]="isClaimScoreSelected">
            <ng-template pTemplate="header">
              <span info-label title="{{'labels.groups.results.assessment.exams.cols.score' | translate}}"
                    content="{{'labels.groups.results.assessment.exams.cols.score-info' | translate}}"></span>
            </ng-template>
            <ng-template let-exam="rowData" pTemplate="body">
              <scale-score [score]="exam.score" [standardError]="exam.standardError"></scale-score>
            </ng-template>
          </p-column>

          <!-- Claim Score columns -->
          <p-column *ngFor="let claim of claimCodes; let idx = index"
                    header="{{'enum.subject-claim-code.' + claim | translate}}"
                    field="{{'claimScores.' + idx + '.level'}}"
                    sortable="true"
                    [hidden]="!isClaimScoreSelected">
            <ng-template let-exam="rowData" pTemplate="body">
              <span *ngIf="exam.claimScores[idx].level">{{ 'enum.iab-category.full.' + exam.claimScores[idx].level.toString() | translate }}</span>
              <span *ngIf="!exam.claimScores[idx].level">-</span>
            </ng-template>
          </p-column>
        </p-dataTable>
      </div>
      <!-- Items By Points Earned -->
      <div *ngIf="showItemsByPoints">
        <h3 class="gray-darkest mb-sm">
          <span>{{'labels.groups.results.assessment.items.title' | translate}}</span>
          <button class="btn btn-info btn-xs pull-right ml-xs"
                  (click)="viewItemsByPoints(false)">
            <i class="fa fa-chevron-left"></i>
            <span>{{'labels.groups.results.assessment.button-exams' | translate}}</span>
          </button>
          <button class="btn btn-default btn-xs pull-right"
                  (click)="exportItemsByPointsEarned()">
            <i class="fa fa-bold fa-table"></i>
            <span>{{'labels.export.items-by-points-earned' | translate}}</span>
          </button>
        </h3>
        <p-dataTable #datatable [value]="filteredAssessmentItems" sortField="position"
                     tableStyleClass="table table-striped table-hover" [tableStyle]="{'table-layout':'auto'}"
                     expandableRows="true" rowExpandMode="single">
          <p-column field="position" header="{{'labels.groups.results.assessment.items.cols.number' | translate}}"
                    sortable="true">
            <ng-template let-row="rowData" let-item="rowData" pTemplate="body">
              <datatable-row-expander [datatable]="datatable" [row]="row"
                                      [text]="item.position"></datatable-row-expander>
            </ng-template>
          </p-column>

          <p-column field="claimTarget" [sortable]="true">
            <ng-template pTemplate="header">
              <span info-label title="{{'labels.groups.results.assessment.items.cols.claim' | translate}}"
                    content="{{'labels.groups.results.assessment.items.cols.claim-info-html' | translate}}"></span>
            </ng-template>
            <ng-template let-item="rowData" pTemplate="body">
              <claim-target [item]="item"></claim-target>
            </ng-template>
          </p-column>
          <p-column field="difficulty" [sortable]="true" sortField="difficultySortOrder">
            <ng-template pTemplate="header">
              <span info-label title="{{'labels.groups.results.assessment.items.cols.difficulty' | translate}}"
                    content="{{'labels.groups.results.assessment.items.cols.difficulty-info' | translate}}"></span>
            </ng-template>
            <ng-template let-item="rowData" pTemplate="body">
              {{ 'enum.difficulty.' + item.difficulty | translate }}
            </ng-template>
          </p-column>
          <p-column field="commonCoreStandardIds" sortable="true">
            <ng-template pTemplate="header">
              <span info-label title="{{'labels.groups.results.assessment.items.cols.standard' | translate}}"
                    content="{{'labels.groups.results.assessment.items.cols.standard-info-html.' + assessmentExam.assessment.subject | translate}}"></span>
            </ng-template>
            <ng-template let-standards="rowData.commonCoreStandardIds" pTemplate="body">
              <span *ngFor="let standard of standards" class="label border-only blue mr-xs">{{standard}}</span>
            </ng-template>
          </p-column>
          <p-column field="fullCredit" [sortable]="true" styleClass="level-up">
            <ng-template pTemplate="header">
              <span info-label title="{{'labels.groups.results.assessment.items.cols.full-credit' | translate}}"
                    content="{{'labels.groups.results.assessment.items.cols.full-credit-info' | translate}}"></span>
            </ng-template>
            <ng-template let-item="rowData" pTemplate="body">
              <span [hidden]="showValuesAsPercent">{{ item.fullCredit }}</span>
              <span [hidden]="!showValuesAsPercent">{{ item.fullCreditAsPercent | number:'1.0-0' }}%</span>
            </ng-template>
          </p-column>
          <p-column *ngFor="let column of pointColumns; let i = index" [field]="column.numberField"
                    header="{{'labels.groups.results.assessment.items.cols.x-points' | translate:{id: column.points} }}"
                    [sortable]="true" [styleClass]="getPointRowStyleClass(i)">
            <ng-template let-item="rowData" pTemplate="body">
              <span [hidden]="showValuesAsPercent">{{ item[column.numberField] }}</span>
              <span [hidden]="!showValuesAsPercent || item[column.percentField] == null">{{ item[column.percentField] | number:'1.0-0' }}%</span>
            </ng-template>
          </p-column>
          <ng-template let-item pTemplate="rowexpansion">
            <item-tab [item]="item"
                      [showResponse]="false"
                      [exams]="assessmentExam.exams"
                      [showItemDetails]="assessmentExam.assessment.isInterim"
            ></item-tab>
          </ng-template>
        </p-dataTable>
      </div>
    </div>
  </div>
