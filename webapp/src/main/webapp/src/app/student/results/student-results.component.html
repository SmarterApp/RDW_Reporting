<reporting-embargo-alert *hasPermission="'EMBARGO_READ'"></reporting-embargo-alert>

<ng-container *ngIf="!examHistory; else hasExamHistory">
  <div *ngIf="!examHistory" class="alert alert-danger">
    {{ 'common.messages.null-student' | translate }}
  </div>
</ng-container>

<!-- Assessments Grouped by Type and Subject -->
<ng-template #hasExamHistory>

  <page-heading *ngIf="examHistory">
    <ng-template #heading>
      <h2>{{'common.person-name' | translate:examHistory.student}}</h2> <div class="student-ssid-label">{{examHistory.student.ssid}}</div>
    </ng-template>
    <ng-template #content>
      <ul class="list-unstyled list-inline">
        <li>
          <button class="btn btn-default btn-sm"
                  [ngClass]="{disabled: exportDisabled}"
                  popover="{{'common.embargo-export-disabled' | translate}}"
                  [triggers]="exportDisabled ? 'mouseenter:mouseleave' : ''"
                  placement="left"
                  (click)="!exportDisabled && exportCsv()">
            <i class="fa fa-bold fa-table"></i> {{'common.export-csv' | translate}}
          </button>
        </li>
        <li>
          <button class="btn btn-default btn-sm"
                  (click)="reportDownloader.modal.show()">
            <i class="fa fa-cloud-download" aria-hidden="true"></i> {{'student-results.student-button-label' | translate}}
          </button>
        </li>
      </ul>

    </ng-template>
  </page-heading>

  <!-- Results Filter -->
  <student-results-filter [filterState]="filterState"
                          [filterOptions]="filterOptions"
                          (filterChange)="onFilterChange()"></student-results-filter>

  <page-heading>
    <ng-template #heading>
      <h3>{{'student-results.title' | translate}}</h3>
    </ng-template>
  </page-heading>


  <ng-container *ngFor="let assessmentType of assessmentTypes">
    <ng-container *ngFor="let subject of getSubjectsForType(assessmentType)">
      <div class="well wide-content-container">
        <span class="h3 label-group"
              [ngClass]="getAssessmentTypeColor(assessmentType)">
          <span class="label">{{'common.assessment-type.' + assessmentType + '.short-name' | translate}}</span><span class="label">{{'common.subject.' + subject + '.short-name' | translate}}</span>
        </span>
        <button class="btn btn-default btn-sm icon-only pull-right"
                (click)="toggleCollapsed(assessmentType, subject)"
                angulartics2On="click"
                angularticsEvent="ToggleCollapseResults"
                angularticsCategory="StudentHistory">
          <span class="sr-only">{{ 'common.action.collapse' | translate }}</span>
          <i class="fa fa-bold {{ isCollapsed(assessmentType, subject) ? 'fa-caret-square-o-down' : 'fa-caret-square-o-up' }}"></i>
        </button>

        <div class="mt-md"
             [hidden]="isCollapsed(assessmentType, subject)">
          <student-history-table [assessmentType]="assessmentType"
                                 [student]="examHistory.student"
                                 [minimumItemDataYear]="minimumItemDataYear"
                                 [exams]="examsByTypeAndSubject.get(assessmentType).get(subject)">
          </student-history-table>
        </div>
      </div>
    </ng-container>
  </ng-container>

  <div *ngIf="!hasResults">
    {{'student-results.empty-filtered-results-message' | translate}}
  </div>

  <span student-report-download #reportDownloader
        [title]="'student-results.create-report' | translate:examHistory.student"
        [student]="examHistory.student"
        [schoolYears]="filterState.years"
        (onShow)="initializeDownloader(reportDownloader)"></span>

</ng-template>


