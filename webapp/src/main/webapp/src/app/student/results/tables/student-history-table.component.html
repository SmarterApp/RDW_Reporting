<!-- Table Display State Toggle -->

<div class="mb-sm clearfix"></div>

<div class="card-grid">
  <div *ngFor="let studentHistoryCard of studentHistoryCards; let i = index">
    <student-assessment-card *ngIf="studentHistoryCard.exam"
                             [latestExam]="studentHistoryCard"
                             [exams]="exams"
                             (selectedAssessment)="onCardSelection($event)"></student-assessment-card>
    <div *ngIf="i % 3 === 0">
      <ng-container
        *ngTemplateOutlet="tableTemplate; context:{ hide: hideTableForIndex(i) }"></ng-container>
    </div>
  </div>
</div>


<ng-template #tableTemplate let-hide="hide">

  <div [ngClass]="{'mt-lg': !hide}">
    <div *ngIf="assessmentType !== 'iab' && !hide"
         class="btn-group btn-group-md"
         role="group">
      <button (click)="viewState = 'overall'"
              class="btn btn-default"
              angulartics2On="click" angularticsEvent="ViewOverallScores" angularticsCategory="StudentHistory"
              [ngClass]="{'active': viewState === 'overall'}">
        {{'common.buttons.display-overall' | translate}}
      </button>
      <button (click)="viewState = 'claim'"
              class="btn btn-default"
              angulartics2On="click" angularticsEvent="ViewClaimScores" angularticsCategory="StudentHistory"
              [ngClass]="{'active': viewState === 'claim'}">
        {{'common.buttons.display-claim' | translate}}
      </button>
    </div>

    <p-table *ngIf="!hide"
             [columns]="columns"
             [value]="exams"
             [autoLayout]="true"
             dataKey="exam.id"
             sortField="exam.date"
             [sortOrder]="-1"
             styleClass="table table-striped table-hover">

      <ng-template pTemplate="header"
                   let-columns>
        <tr>
          <th *ngFor="let column of columns; let columnIdx = index;"
              [pSortableColumn]="column.field"
              [hidden]="(viewState !== 'overall' && column.overall) || (viewState !== 'claim' && column.claim)"
              [ngSwitch]="column.id">

        <span *ngSwitchCase="'performance'"
              info-button
              title="{{('common.results.assessment-exam-columns.' + assessmentType + '.performance') | translate}}"
              content="{{('common.results.assessment-exam-columns.' + assessmentType + '.performance-info') | translate}}">
        </span>

            <span *ngSwitchCase="'claim'">
          {{ 'common.subject-claim-code.' + column.claim | translate }}
        </span>

            <span *ngSwitchCase="'score'"
                  info-button
                  title="{{('common.results.assessment-exam-columns.' + column.id) | translate}}"
                  content="{{('common.results.assessment-exam-columns.' + column.id + '-info') | translate}}"
                  placement="left">
        </span>

            <span *ngSwitchDefault>
          <span *ngIf="!column.commonHeader">
            {{('student-exam-history-table.columns.' + column.id) | translate}}
          </span>
          <span *ngIf="column.commonHeader"
                info-button
                title="{{('common.results.assessment-exam-columns.' + column.id) | translate}}"
                content="{{('common.results.assessment-exam-columns.' + column.id + '-info') | translate}}">
          </span>
        </span>

            <p-sortIcon [field]="column.field"></p-sortIcon>
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body"
                   let-rowData
                   let-i="rowIndex"
                   let-columns="columns">
        <tr>
          <td *ngFor="let column of columns"
              [hidden]="(viewState !== 'overall' && column.overall) || (viewState !== 'claim' && column.claim)"
              [ngSwitch]="column.id">

            <popup-menu *ngSwitchCase="'date'"
                        [item]="rowData"
                        [actions]="actions"
                        [text]="rowData.exam.date | date"></popup-menu>

            <div *ngSwitchCase="'assessment'">
              {{ rowData.assessment.label }}
            </div>

            <div *ngSwitchCase="'school-year'">
              {{ rowData.exam.schoolYear | schoolYear }}
            </div>

            <div *ngSwitchCase="'school'">
              {{ rowData.exam.school.name }}
            </div>

            <div *ngSwitchCase="'enrolled-grade'">
              {{ 'common.enrolled-grade-label.' + rowData.exam.enrolledGrade | translate}}
            </div>

            <div *ngSwitchCase="'status'">
              <span class="label border-only maroon">{{ 'common.administration-condition.' + rowData.exam.administrativeCondition | translate }}</span>
              <span *ngIf="rowData.exam.completeness == 'Partial'" class="label border-only maroon">{{ 'common.completeness.Partial' | translate }}</span>
            </div>

            <div *ngSwitchCase="'performance'">
              {{ 'common.assessment-type.' + assessmentType + '.performance-level.' + (rowData.exam.level ?
              rowData.exam.level.toString() : 'missing') + '.name' | translate }}
              <button *ngIf="assessmentType === 'iab'"
                      class="btn btn-borderless btn-xs icon-only pull-right"
                      angulartics2On="click"
                      angularticsEvent="InstructionalResource"
                      angularticsCategory="AssessmentResults"
                      [disabled]="false"
                      [popover]="buttonPopover"
                      popoverTitle="{{ 'common.results.assessment.instruct-button' | translate:{ level:(('common.assessment-type.iab.performance-level.' + (rowData.exam.level ? rowData.exam.level.toString() : 'missing')) +'.name' | translate) } }}"
                      container="body"
                      (click)="loadInstructionalResources(rowData)"
                      [outsideClick]="true"><i class="fa fa-book"></i></button>
            </div>

            <scale-score *ngSwitchCase="'score'"
                         [score]="rowData.exam.score"
                         [standardError]="rowData.exam.standardError"></scale-score>

            <div *ngSwitchCase="'claim'">
              <span *ngIf="rowData.exam.claimScores[column.index].level">{{ 'common.assessment-type.iab.performance-level.' + (rowData.exam.claimScores[column.index] ? rowData.exam.claimScores[column.index].level.toString() : 'missing') + '.name' | translate }}</span>
              <span *ngIf="!rowData.exam.claimScores[column.index].level">-</span>
            </div>

          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage" let-columns>
        <tr>
          <td [attr.colspan]="columns.length">
            {{'common.messages.no-exams-matching-criteria' | translate}}
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

</ng-template>
<ng-template #buttonPopover>
  <instructional-resource-popover [provider]="instructionalResourcesProvider"></instructional-resource-popover>
</ng-template>

