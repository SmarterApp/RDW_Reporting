<aggregate-embargo-alert *hasPermission="'EMBARGO_READ'"></aggregate-embargo-alert>

<ng-template #submitButtonTemplate>
  <button class="btn btn-success btn-sm green"
          [disabled]="submissionSubscription"
          (click)="onGenerateButtonClick()">{{'aggregate-report-form.submit' | translate}}</button>
</ng-template>

<ng-container *ngIf="accessDenied; else accessAllowed">
  <page-heading>
    <ng-template #heading>
      <h2>{{'aggregate-report-form.heading' | translate}}</h2>
    </ng-template>
  </page-heading>
  <div class="well">
    <p>{{'aggregate-report-form.access-denied-error' | translate}}</p>
  </div>
</ng-container>

<ng-template #accessAllowed>

  <div sticky marginTop="12" [style.position]="'absolute'">
    <scroll-nav [items]="[
      {
        scrollTo: organizationSection,
        text: 'aggregate-report-form.section.organization.heading' | translate
      },
      {
        scrollTo: assessmentSection,
        text: 'aggregate-report-form.section.assessment-heading' | translate
      },
      {
        scrollTo: subgroupSection,
        text: 'aggregate-report-form.section.comparative-subgroups-heading' | translate
      },
      {
        scrollTo: reviewSection,
        text: 'aggregate-report-form.section.review-heading' | translate
      },
      {
        scrollTo: previewSection,
        text: 'aggregate-report-form.section.preview-heading' | translate
      }
      ]">
      <div class="ml-sm mt-xs">
        <ng-container *ngTemplateOutlet="submitButtonTemplate"></ng-container>
      </div>
    </scroll-nav>
  </div>

  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <page-heading>
        <ng-template #heading>
          <h2>{{'aggregate-report-form.heading' | translate}}</h2>
          <p class="small gray-darkest mt-sm">{{'aggregate-report-form.subheading' | translate}}</p>
        </ng-template>
      </page-heading>
    </div>
  </div>

  <form #form [formGroup]="formGroup">

    <!-- Organization -->
    <div class="row" #organizationSection id="organizationSection">
      <div class="col-md-8 col-md-offset-2">
        <div class="well-group">
          <div class="well">
            <h3>{{'aggregate-report-form.section.organization.heading' | translate}}</h3>
            <p *ngIf="!hasDefaultSchoolOrganization" class="text-muted small">{{'aggregate-report-form.section.organization.subtext' | translate}}</p>
          </div>
          <div class="well pb-0">

            <!-- Typeahead -->
            <div *ngIf="!hasDefaultSchoolOrganization">
              <label>{{'aggregate-report-form.field.organization-label' | translate}}</label>
              <span [hidden]="!organizationTypeahead.loading"><i class="fa fa-spinner fa-pulse"></i></span>
              <organization-typeahead #organizationTypeahead
                                      [options]="organizationTypeaheadOptions"
                                      (selected)="onOrganizationTypeaheadSelect($event)"></organization-typeahead>
              <div>
                <br [hidden]="organizationTypeahead.noResults">
                <span [hidden]="!organizationTypeahead.noResults" class="small gray-darker">{{'organization-typeahead.no-matches' | translate}}</span>
              </div>
              <div class="form-group">
                <input type="hidden"
                       [(ngModel)]="organizations"
                       formControlName="organizations">
                <div *ngIf="showErrors(organizationsControl)">
                  <p *ngIf="organizationsControl.errors.invalid" class="help-block small red">{{organizationsControl.errors.invalid.messageId | translate}}</p>
                </div>
              </div>
            </div>

            <!-- Selections -->
            <div [hidden]="!settings.districts.length" class="mb-sm">
              <label>{{'aggregate-report-form.section.organization.district-list-heading' | translate}}</label>
              <editable-list-group [items]="settings.districts"
                                   [itemTemplate]="organizationListItemTemplate"
                                   (itemRemoveButtonClick)="onOrganizationListItemClose($event)"></editable-list-group>
            </div>
            <div [hidden]="!settings.schools.length" class="mb-sm">
              <label>{{'aggregate-report-form.section.organization.school-list-heading' | translate}}</label>
              <editable-list-group [items]="settings.schools"
                                   [itemTemplate]="organizationListItemTemplate"
                                   (itemRemoveButtonClick)="onOrganizationListItemClose($event)"
                                   [disabled]="hasDefaultSchoolOrganization"></editable-list-group>
            </div>

            <ng-template #organizationListItemTemplate let-item>
              {{item.name}}
            </ng-template>
            <!-- Settings -->
            <div>
              <label>{{'aggregate-report-form.section.organization.include.heading' | translate}}</label>
              <ul class="list-group list-group-sm small mb-0">
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-sm-6">
                      <label class="inline-label">
                        <input type="checkbox"
                               [disabled]="summativeFieldsDisabled"
                               [(ngModel)]="includeStateResults"
                               [ngModelOptions]="{standalone: true}"
                               (ngModelChange)="onIncludeStateResultsChange()">
                        <span class="ml-xs"
                              [ngClass]="{'text-muted': summativeFieldsDisabled}">{{'aggregate-report-form.section.organization.include.state-results' | translate}}</span>
                      </label>
                    </div>
                    <div class="col-sm-6" *ngIf="options.statewideReporter">
                      <label class="inline-label">
                        <input type="checkbox"
                               [(ngModel)]="settings.includeAllDistricts"
                               [ngModelOptions]="{standalone: true}"
                               (ngModelChange)="onIncludeAllDistrictsChange()">
                        <span class="ml-xs">{{'aggregate-report-form.section.organization.include.all-districts' | translate}}</span>
                      </label>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-sm-6">
                      <label class="inline-label">
                        <input type="checkbox"
                               [(ngModel)]="settings.includeAllSchoolsOfSelectedDistricts"
                               [ngModelOptions]="{standalone: true}"
                               (ngModelChange)="onSettingsChange()">
                        <span class="ml-xs">{{'aggregate-report-form.section.organization.include.all-schools-of-districts' | translate}}</span>
                      </label>
                    </div>
                    <div class="col-sm-6">
                      <label class="inline-label">
                        <input type="checkbox"
                               [(ngModel)]="settings.includeAllDistrictsOfSelectedSchools"
                               [ngModelOptions]="{standalone: true}"
                               (ngModelChange)="onSettingsChange()">
                        <span class="ml-xs">{{'aggregate-report-form.section.organization.include.all-districts-of-schools' | translate}}</span>
                      </label>
                    </div>
                  </div>
                </li>
              </ul>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Assessment Attributes -->
    <div class="row" #assessmentSection id="assessmentSection">
      <div class="col-md-8 col-md-offset-2">
        <div class="well-group">
          <div class="well">
            <h3>{{'aggregate-report-form.section.assessment-heading' | translate}}</h3>
          </div>
          <div class="well">
            <div class="row">
              <div class="col-md-6">
                <label>{{'aggregate-report-form.field.assessment-type-label' | translate}}</label>
              </div>
              <div class="col-md-6">
                <span class="gray-darker" *ngIf="options.assessmentTypes.length == 1">{{options.assessmentTypes[0].text}}</span>
                <sb-radio-button-group *ngIf="options.assessmentTypes.length > 1"
                                       name="assessmentType"
                                       [options]="options.assessmentTypes"
                                       [(ngModel)]="settings.assessmentType"
                                       [ngModelOptions]="{standalone: true}"
                                       (change)="onAssessmentTypeChange()"></sb-radio-button-group>
              </div>
            </div>
          </div>
          <div class="well">
            <div class="row">
              <div class="col-md-6">
                <label>{{'aggregate-report-form.field.subjects-label' | translate}}</label>
              </div>
              <div class="col-md-6">
                <sb-button-group name="subjects"
                                 analyticsEvent="FilterClick"
                                 analyticsCategory="AggregateQueryBuilder"
                                 [allOptionAnalyticsProperties]="{label: 'Subject: All'}"
                                 [options]="options.subjects"
                                 [(ngModel)]="settings.subjects"
                                 [ngModelOptions]="{standalone: true}"
                                 (change)="onSettingsChange()"></sb-button-group>
              </div>
            </div>
          </div>

          <div class="well">
            <div class="row">
              <div class="col-md-6">
                <label>{{'aggregate-report-form.field.report-type-label' | translate}}</label>
              </div>
              <div class="col-md-6">
                <sb-radio-group name="reportType"
                                [options]="options.reportTypes"
                                [(ngModel)]="settings.reportType"
                                [ngModelOptions]="{standalone: true}"
                                (change)="onReportTypeChange()"></sb-radio-group>
              </div>
            </div>
          </div>

          <div [hidden]="settings.reportType !== 'GeneralPopulation'">

            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label info-button
                         title="{{'aggregate-report-form.field.assessment-grades-label' | translate}}"
                         content="{{'aggregate-report-form.field.assessment-grades-info' | translate}}"></label>
                  <p class="small mb-0"
                     [ngClass]="showErrors(assessmentGradesControl) ? 'red' : 'gray-darker'">
                    {{'common.form-field-message.required' | translate}}
                  </p>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <sb-button-group name="assessmentGrades"
                                     formControlName="assessmentGrades"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionEnabled]="false"
                                     [options]="options.assessmentGrades"
                                     [(ngModel)]="settings.generalPopulation.assessmentGrades"
                                     (change)="onSettingsChange()"></sb-button-group>
                    <div *ngIf="showErrors(assessmentGradesControl)">
                      <p *ngIf="assessmentGradesControl.errors.notEmpty" class="help-block small red">{{assessmentGradesControl.errors.notEmpty.messageId | translate}}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label>{{'aggregate-report-form.field.school-year-label' | translate}}</label>
                  <p class="small mb-0"
                     [ngClass]="showErrors(schoolYearsControl) ? 'red' : 'gray-darker'">
                    {{'common.form-field-message.required' | translate}}
                  </p>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <sb-button-group name="schoolYears"
                                     formControlName="schoolYears"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionEnabled]="false"
                                     [options]="options.schoolYears"
                                     [(ngModel)]="settings.generalPopulation.schoolYears"
                                     (change)="onSettingsChange()"></sb-button-group>
                    <div *ngIf="showErrors(schoolYearsControl)">
                      <p *ngIf="schoolYearsControl.errors.notEmpty" class="help-block small red">{{schoolYearsControl.errors.notEmpty.messageId | translate}}</p>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div [hidden]="settings.reportType !== 'LongitudinalCohort'">

            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label>{{'aggregate-report-form.field.assessment-grade-range-label' | translate}}</label>
                  <p class="small mb-0"
                     [ngClass]="showErrors(assessmentGradeRangeControl) ? 'red' : 'gray-darker'">
                    {{'common.form-field-message.required' | translate}}
                  </p>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <sb-button-group type="range"
                                     name="assessmentGradeRange"
                                     formControlName="assessmentGradeRange"
                                     [allOptionEnabled]="false"
                                     [options]="options.assessmentGrades"
                                     [(ngModel)]="settings.longitudinalCohort.assessmentGrades"
                                     (change)="onSettingsChange()"></sb-button-group>
                    <div *ngIf="showErrors(assessmentGradeRangeControl)">
                      <p *ngIf="assessmentGradeRangeControl.errors.notEmpty" class="help-block small red">{{assessmentGradeRangeControl.errors.notEmpty.messageId | translate}}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label>{{'aggregate-report-form.field.to-school-year-label' | translate}}</label>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <sb-radio-group name="toSchoolYear"
                                    formControlName="toSchoolYear"
                                    [options]="options.schoolYears"
                                    [(ngModel)]="settings.longitudinalCohort.toSchoolYear"
                                    (change)="onSettingsChange()"></sb-radio-group>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="well" [hidden]="interimFieldsDisabled">
            <div class="row">
              <div class="col-md-6">
                <label info-button
                       title="{{'aggregate-report-form.field.interim-administration-condition-label' | translate}}"
                       content="{{'aggregate-report-form.field.interim-administration-condition-info' | translate}}"></label>
              </div>
              <div class="col-md-6">
                <sb-checkbox-group [horizontal]="true"
                                   [options]="options.interimAdministrationConditions"
                                   [(ngModel)]="settings.interimAdministrationConditions"
                                   [ngModelOptions]="{standalone: true}"
                                   name="interimAdministrationConditions"
                                   analyticsEvent="FilterClick"
                                   analyticsCategory="AggregateQueryBuilder"
                                   [allOptionAnalyticsProperties]="{label: 'Manner of Administration: All'}"
                                   (change)="onSettingsChange()"></sb-checkbox-group>
              </div>
            </div>
          </div>
          <div class="well" [hidden]="summativeFieldsDisabled">
            <div class="row">
              <div class="col-md-6">
                <label info-button
                       title="{{'aggregate-report-form.field.summative-administration-condition-label' | translate}}"
                       content="{{'aggregate-report-form.field.summative-administration-condition-info' | translate}}"></label>
              </div>
              <div class="col-md-6">
                <sb-checkbox-group [horizontal]="true"
                                   [options]="options.summativeAdministrationConditions"
                                   [(ngModel)]="settings.summativeAdministrationConditions"
                                   [ngModelOptions]="{standalone: true}"
                                   name="summativeAdministrationConditions"
                                   analyticsEvent="FilterClick"
                                   analyticsCategory="AggregateQueryBuilder"
                                   [allOptionAnalyticsProperties]="{label: 'Validity: All'}"
                                   (change)="onSettingsChange()"></sb-checkbox-group>
              </div>
            </div>
          </div>
          <div class="well">
            <div class="row">
              <div class="col-md-6">
                <label info-button
                       title="{{'common.completeness-form-control.label' | translate}}"
                       content="{{'common.completeness-form-control.info' | translate}}"></label>
              </div>
              <div class="col-md-6">
                <sb-checkbox-group [horizontal]="true"
                                   [options]="options.completenesses"
                                   [(ngModel)]="settings.completenesses"
                                   [ngModelOptions]="{standalone: true}"
                                   name="completenesses"
                                   analyticsEvent="FilterClick"
                                   analyticsCategory="AggregateQueryBuilder"
                                   [allOptionAnalyticsProperties]="{label: 'Completeness: All'}"
                                   (change)="onSettingsChange()"></sb-checkbox-group>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Query Type Tabs -->
    <div class="row" #subgroupSection>
      <div class="col-md-8 col-md-offset-2">

        <tabset>
          <tab [heading]="'aggregate-report-form.tab.subgroup-and-filter' | translate"
               [active]="settings.queryType === 'Basic'"
               (select)="onTabChange('Basic')">

            <!-- Subgroups -->
            <div class="well-group" id="subgroupSection">
              <div class="well">
                <p class="text-muted small">{{'aggregate-report-form.section.comparative-subgroups-subtext' | translate}}</p>
              </div>
              <div class="well">
                <div class="row">
                  <div class="col-md-6">
                  </div>
                  <div class="col-md-6">
                    <sb-checkbox-group [options]="options.dimensionTypes"
                                       [(ngModel)]="settings.dimensionTypes"
                                       [ngModelOptions]="{standalone: true}"
                                       name="dimensionTypes"
                                       [allOptionEnabled]="false"
                                       analyticsEvent="FilterClick"
                                       analyticsCategory="AggregateQueryBuilder"
                                       [allOptionAnalyticsProperties]="{label: 'Comparative Subgroups: All'}"
                                       (change)="onSettingsChange()"></sb-checkbox-group>
                  </div>
                </div>
              </div>
              <div class="well" #advancedFiltersSection id="advancedFiltersSection">
                <div class="flex-children">
                  <div class="flex-child grow">
                    <h3>{{'aggregate-report-form.section.subgroup-filters-heading' | translate}}</h3>
                    <p class="text-muted small">{{'aggregate-report-form.section.subgroup-filters-subtext' | translate}}</p>
                  </div>
                  <div class="flex-child">
                    <button class="form-control btn btn-sm btn-default pull-right"
                            (click)="onAdvancedFiltersExpanderButtonClick()">
                      {{'common.action.' + (showAdvancedFilters ? 'hide' : 'show') | translate}}
                      <i class="fa ml-xs"
                         [ngClass]="{'fa-caret-square-o-up': showAdvancedFilters, 'fa-caret-square-o-down': !showAdvancedFilters}"
                         aria-hidden="true"></i>
                    </button>
                  </div>
                </div>
              </div>
              <subgroup-filters *ngIf="showAdvancedFilters"
                                [options]="options.studentFilters"
                                [settings]="settings.studentFilters"
                                (changed)="onSettingsChange()"></subgroup-filters>
            </div>

          </tab>
          <tab [heading]="'aggregate-report-form.tab.custom-subgroup' | translate"
               [active]="settings.queryType === 'FilteredSubgroup'"
               (select)="onTabChange('FilteredSubgroup')">

            <div class="well-group">

              <div class="well">
                <p class="text-muted small">{{'aggregate-report-form.section.custom-subgroup.description' | translate}}</p>
              </div>

              <subgroup-filters [options]="options.studentFilters"
                                [settings]="customSubgroup"></subgroup-filters>

              <div class="well">
                <div class="clearfix">
                  <div class="pull-right">
                    <button class="btn btn-primary btn-xs"
                            [disabled]="createCustomSubgroupButtonDisabled"
                            (click)="onCreateCustomSubgroupButtonClick()">
                      <i class="fa fa-plus"></i>
                      {{'aggregate-report-form.section.custom-subgroup.add-button' | translate}}
                    </button>
                  </div>
                </div>
                <ng-container *ngIf="subgroupItems.length">
                  <label>{{'aggregate-report-form.section.custom-subgroup.list-label' | translate}}</label>
                  <editable-list-group [items]="subgroupItems"
                                       [itemTemplate]="subgroupListItemTemplate"
                                       (itemRemoveButtonClick)="onCustomSubgroupItemRemoveButtonClick($event)"></editable-list-group>
                  <ng-template #subgroupListItemTemplate let-item>
                    <subgroup [subgroup]="item.subgroup"></subgroup>
                  </ng-template>
                </ng-container>
              </div>

            </div>

          </tab>

        </tabset>
      </div>
    </div>
    <!-- Summary -->
    <div class="row"
         #reviewSection
         id="reviewSection"
         (inView)="onReviewSectionInView($event)"
         [inViewInvalidator]="reviewSectionViewInvalidator">

      <div class="col-md-8 col-md-offset-2">
        <div class="well-group">
          <div class="well">
            <h3>{{'aggregate-report-form.section.review-heading' | translate}}</h3>
            <ng-container *ngIf="formGroup.valid">
              <ng-container *ngIf="estimatedRowCount != null; else estimatedRowCountSpinner">
                <div class="flex-children">
                  <p>
                    <span class="text-muted small">{{'aggregate-report-form.estimated-row-count.label' | translate}}</span>
                    <strong class="label gray-darker">{{estimatedRowCount | number}}</strong>
                  </p>
                  <ng-container *ngIf="estimatedRowCountIsLarge">
                    <ng-container *ngTemplateOutlet="warning; context: {$implicit: ('aggregate-report-form.estimated-row-count.warning' | translate)}"></ng-container>
                  </ng-container>
                </div>
              </ng-container>
              <ng-template #estimatedRowCountSpinner>
                <p class="text-muted small">
                  {{'aggregate-report-form.estimated-row-count.loading' | translate}} <i class="fa fa-spinner fa-pulse"></i>
                </p>
              </ng-template>
            </ng-container>
          </div>
          <div class="well">
            <aggregate-report-summary *ngIf="summary"
                                      narrow="true"
                                      [summary]="summary"></aggregate-report-summary>
          </div>
          <div class="well">
            <label>{{'aggregate-report-form.field.report-name-label' | translate}}</label>
            <div class="flex-children">
              <div class="flex-child grow form-group">
                <input type="text"
                       class="form-control"
                       formControlName="reportName"
                       [(ngModel)]="settings.name"
                       required="false"
                       maxlength="255"
                       placeholder="{{'aggregate-report-form.default-report-name' | translate}}">
                <div *ngIf="showErrors(reportNameControl)">
                  <p *ngIf="reportNameControl.errors.fileName" class="help-block small red">{{reportNameControl.errors.fileName.messageId | translate}}</p>
                </div>
              </div>
              <div class="flex-child flex-child-no-label">
                <div class="ml-xs">
                  <ng-container *ngTemplateOutlet="submitButtonTemplate"></ng-container>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </form>

  <div class="row"
       #previewSection
       id="previewSection"
       (inView)="onPreviewSectionInView($event)"
       [inViewInvalidator]="previewSectionViewInvalidator">

    <div class="col-md-12 col-md-offset-2">
      <div class="well-group wide-content-container">
        <div class="well inline-headings">
          <h3>{{'aggregate-report-form.section.preview-heading' | translate}}</h3>
          <ng-container *ngIf="estimatedRowCountIsLarge">
              <ng-container *ngTemplateOutlet="warning; context: {$implicit: ('aggregate-report-form.preview' | translate)}"></ng-container>
          </ng-container>
        </div>
        <div class="well">
          <div>
            <div>
              <span class="pull-left flex-child">
                <label class="mr-xs">
                  <info-button title="{{'common.aggregate-report.column-order' | translate}}"
                               content="{{'common.aggregate-report.column-order-info' | translate}}">
                  </info-button>
                </label>
                <order-selector [items]="columnItems"
                                (itemsChange)="onColumnOrderChange($event)"></order-selector>
              </span>
              <span class="pull-right flex-child ml-xs">
                <label class="mr-xs">{{'common.value-display-type-input-label' | translate}}</label>
                <sb-radio-button-group [options]="options.valueDisplayTypes"
                                       [(ngModel)]="settings.valueDisplayType"
                                       buttonGroupStyles="btn-group-xs"
                                       buttonStyles="btn-default"
                                       analyticsCategory="AggregateQueryBuilder"
                                       analyticsEvent="Change"></sb-radio-button-group>
              </span>
              <span class="pull-right flex-child ml-xs"
                    *ngIf="currentAssessmentDefinition.performanceLevelDisplayTypes.length > 1">
                <label class="mr-xs">{{'common.performance-level-display-type-input-label' | translate}}</label>
                <sb-radio-button-group [options]="options.performanceLevelDisplayTypes"
                                       [(ngModel)]="settings.performanceLevelDisplayType"
                                       buttonGroupStyles="btn-group-xs"
                                       buttonStyles="btn-default"
                                       analyticsCategory="AggregateQueryBuilder"
                                       analyticsEvent="Change"></sb-radio-button-group>
              </span>
            </div>
            <div class="clearfix"></div>
          </div>
          <div class="mt-sm">
            <aggregate-report-table *ngIf="previewTable"
                                    [preview]="true"
                                    [table]="previewTable"
                                    [valueDisplayType]="settings.valueDisplayType"
                                    [performanceLevelDisplayType]="
                                      currentAssessmentDefinition.performanceLevelDisplayTypes.includes(settings.performanceLevelDisplayType)
                                        ? settings.performanceLevelDisplayType
                                        : currentAssessmentDefinition.performanceLevelDisplayTypes[0]"
                                    [identityColumns]="settings.columnOrder"></aggregate-report-table>
          </div>
        </div>
      </div>
    </div>
  </div>

</ng-template>

<ng-template #warning let-text>
  <span class="alert alert-warning small pt-xs pr-xs pb-xs pl-xs ml-sm">
    <i class="fa fa-exclamation-triangle"></i>
    {{text}}
  </span>
</ng-template>
