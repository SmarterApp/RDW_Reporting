<ng-container *ngIf="accessDenied">
  <page-heading>
    <ng-template #heading>
      <h2>{{'aggregate-reports.form.heading' | translate}}</h2>
    </ng-template>
  </page-heading>
  <div class="well">
    <p>{{'aggregate-reports.access-denied-error' | translate}}</p>
  </div>
</ng-container>

<div *ngIf="!accessDenied">

  <div sticky marginTop="12" [style.position]="'absolute'">
    <scroll-nav [items]="[
      {
        scrollTo: organizationSection,
        text: 'aggregate-reports.form.section.organization.heading' | translate
      },
      {
        scrollTo: assessmentSection,
        text: 'aggregate-reports.form.section.assessment.heading' | translate
      },
      {
        scrollTo: subgroupSection,
        text: 'aggregate-reports.form.section.comparative-subgroups.heading' | translate
      },
      {
        scrollTo: advancedFiltersSection,
        text: 'aggregate-reports.form.section.subgroup-filters.heading' | translate
      },
      {
        scrollTo: reportNameSection,
        text: 'aggregate-reports.form.section.report-name.heading' | translate
      },
      {
        scrollTo: reviewSection,
        text: 'aggregate-reports.form.section.review.heading' | translate
      },
      {
        scrollTo: previewSection,
        text: 'aggregate-reports.form.section.preview.heading' | translate
      }
      ]">
      <button class="btn btn-success btn-sm green ml-sm mt-xs"
              [disabled]="submissionSubscription"
              (click)="onGenerateButtonClick()">{{'aggregate-reports.form.submit' | translate}}</button>
    </scroll-nav>
  </div>

  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <page-heading>
        <ng-template #heading>
          <h2>{{'aggregate-reports.form.heading' | translate}}</h2>
          <p class="small gray-darkest mt-sm">{{'aggregate-reports.form.subheading' | translate}}</p>
        </ng-template>
      </page-heading>
    </div>
  </div>

  <form #form [formGroup]="formGroup">

    <!-- Organization -->
    <div class="row" #organizationSection id="organizationSection">
      <div class="col-md-8 col-md-offset-2">
        <div class="well-group">
          <div class="well">
            <h3>{{'aggregate-reports.form.section.organization.heading' | translate}}</h3>
            <div class="subtext">{{'aggregate-reports.form.section.organization.subtext' | translate}}</div>
          </div>
          <div class="well pb-0">

            <!-- Typeahead -->
            <div>
              <label>{{'aggregate-reports.form.field.organization.label' | translate}}</label>
              <organization-typeahead #organizationTypeahead
                                      [options]="organizationTypeaheadOptions"
                                      (selected)="onOrganizationTypeaheadSelect($event)"></organization-typeahead>
              <div class="form-group">
                <input type="hidden"
                       [(ngModel)]="organizations"
                       formControlName="organizations"
                       (ngModelChange)="onSettingsChange()">
                <div *ngIf="showErrors(organizationsControl)">
                  <p *ngIf="organizationsControl.errors.invalid" class="help-block small red">{{organizationsControl.errors.invalid.messageId | translate}}</p>
                </div>
              </div>
            </div>

            <!-- Settings -->
            <div>
              <label>{{'aggregate-reports.form.section.organization.include.heading' | translate}}</label>
              <ul class="list-group list-group-sm small mb-0">
                <li class="list-group-item">
                  <div class="row">
                    <div class="col-sm-6">
                      <label class="inline-label">
                        <input type="checkbox"
                               [(ngModel)]="settings.includeStateResults"
                               [ngModelOptions]="{standalone: true}"
                               (change)="onIncludeStateResultsChange()">
                        <span class="ml-xs">{{'aggregate-reports.form.section.organization.include.state-results' | translate}}</span>
                      </label>
                    </div>
                    <div class="col-sm-6" *ngIf="options.statewideReporter">
                      <label class="inline-label">
                        <input type="checkbox"
                               [(ngModel)]="settings.includeAllDistricts"
                               [ngModelOptions]="{standalone: true}"
                               (change)="onIncludeAllDistrictsChange()">
                        <span class="ml-xs">{{'aggregate-reports.form.section.organization.include.all-districts' | translate}}</span>
                      </label>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-sm-6">
                      <label class="inline-label">
                        <input type="checkbox"
                               [(ngModel)]="settings.includeAllSchoolsOfSelectedDistricts"
                               [ngModelOptions]="{standalone: true}">
                        <span class="ml-xs">{{'aggregate-reports.form.section.organization.include.all-schools-of-districts' | translate}}</span>
                      </label>
                    </div>
                    <div class="col-sm-6">
                      <label class="inline-label">
                        <input type="checkbox"
                               [(ngModel)]="settings.includeAllDistrictsOfSelectedSchools"
                               [ngModelOptions]="{standalone: true}">
                        <span class="ml-xs">{{'aggregate-reports.form.section.organization.include.all-districts-of-schools' | translate}}</span>
                      </label>
                    </div>
                  </div>
                </li>
              </ul>
            </div>

            <!-- Selections -->
            <div [hidden]="!settings.districts.length">
              <label>{{'aggregate-reports.form.section.organization.district-list-heading' | translate}}</label>
              <aggregate-report-organization-list [organizations]="settings.districts"
                                                  (organizationClick)="onOrganizationListItemClose($event)"></aggregate-report-organization-list>
            </div>
            <div [hidden]="!settings.schools.length">
              <label>{{'aggregate-reports.form.section.organization.school-list-heading' | translate}}</label>
              <aggregate-report-organization-list [organizations]="settings.schools"
                                                  (organizationClick)="onOrganizationListItemClose($event)"></aggregate-report-organization-list>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Assessment Attributes -->
    <div class="row" #assessmentSection id="assessmentSection">
      <div class="col-md-8 col-md-offset-2">
        <div class="well-group">
          <div class="well">
            <h3>{{'aggregate-reports.form.section.assessment.heading' | translate}}</h3>
          </div>
          <div class="well">
            <div class="row">
              <div class="col-md-6">
                <label>{{'aggregate-reports.form.field.assessment-type.label' | translate}}</label>
              </div>
              <div class="col-md-6">
                <span class="gray-darker" *ngIf="options.assessmentTypes.length == 1">{{options.assessmentTypes[0].text}}</span>
                <sb-radio-button-group *ngIf="options.assessmentTypes.length > 1"
                           name="assessmentType"
                           [options]="options.assessmentTypes"
                           [(ngModel)]="settings.assessmentType"
                           [ngModelOptions]="{standalone: true}"
                           (change)="onSettingsChange()"></sb-radio-button-group>
              </div>
            </div>
          </div>
          <div class="well">
            <div class="row">
              <div class="col-md-6">
                <label>{{'aggregate-reports.form.field.subjects.label' | translate}}</label>
              </div>
              <div class="col-md-6">
                <sb-checkbox-group [horizontal]="true"
                                   [options]="options.subjects"
                                   [(ngModel)]="settings.subjects"
                                   [ngModelOptions]="{standalone: true}"
                                   name="subjects"
                                   analyticsEvent="FilterClick"
                                   analyticsCategory="AggregateQueryBuilder"
                                   [allOptionAnalyticsProperties]="{label: 'Subject: All'}"
                                   (change)="onSettingsChange()"></sb-checkbox-group>
              </div>
            </div>
          </div>
          <div class="well">
            <div class="row">
              <div class="col-md-6">
                <label info-button
                       title="{{'aggregate-reports.form.field.assessment-grades.label' | translate}}"
                       content="{{'aggregate-reports.form.field.assessment-grades.info' | translate}}"></label>
                <p class="small mb-0"
                   [ngClass]="{'red': showErrors(assessmentGradesControl), 'gray-darker': !showErrors(assessmentGradesControl)}">
                  {{'aggregate-reports.form.required' | translate}}
                </p>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <sb-checkbox-group [horizontal]="true"
                                     [options]="options.assessmentGrades"
                                     [(ngModel)]="settings.assessmentGrades"
                                     [allOptionEnabled]="false"
                                     name="assessmentGrades"
                                     formControlName="assessmentGrades"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionAnalyticsProperties]="{label: 'Assessment Grade: All'}"
                                     (change)="onSettingsChange()"></sb-checkbox-group>
                  <div *ngIf="showErrors(assessmentGradesControl)">
                    <p *ngIf="assessmentGradesControl.errors.notEmpty" class="help-block small red">{{assessmentGradesControl.errors.notEmpty.messageId | translate}}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="well">
            <div class="row">
              <div class="col-md-6">
                <label>{{'aggregate-reports.form.field.school-year.label' | translate}}</label>
                <p class="small mb-0"
                   [ngClass]="{'red': showErrors(schoolYearsControl), 'gray-darker': !showErrors(schoolYearsControl)}">
                  {{'aggregate-reports.form.required' | translate}}
                </p>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <sb-checkbox-group [options]="options.schoolYears"
                                     [(ngModel)]="settings.schoolYears"
                                     [horizontal]="true"
                                     [allOptionEnabled]="false"
                                     formControlName="schoolYears"
                                     name="schoolYears"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionAnalyticsProperties]="{label: 'Academic Year: All'}"
                                     (change)="onSettingsChange()"></sb-checkbox-group>
                  <div *ngIf="showErrors(schoolYearsControl)">
                    <p *ngIf="schoolYearsControl.errors.notEmpty" class="help-block small red">{{schoolYearsControl.errors.notEmpty.messageId | translate}}</p>
                  </div>
                </div>

              </div>
            </div>
          </div>
          <div class="well" [hidden]="interimFieldsDisabled">
            <div class="row">
              <div class="col-md-6">
                <label info-button
                       title="{{'aggregate-reports.form.field.interim-administration-condition.label' | translate}}"
                       content="{{'aggregate-reports.form.field.interim-administration-condition.info' | translate}}"></label>
              </div>
              <div class="col-md-6">
                <sb-checkbox-group [horizontal]="true"
                                   [options]="options.interimAdministrationConditions"
                                   [(ngModel)]="settings.interimAdministrationConditions"
                                   [ngModelOptions]="{standalone: true}"
                                   name="interimAdministrationConditions"
                                   analyticsEvent="FilterClick"
                                   analyticsCategory="AggregateQueryBuilder"
                                   [allOptionAnalyticsProperties]="{label: 'Manner of Administration: All'}"
                                   (change)="onSettingsChange()"></sb-checkbox-group>
              </div>
            </div>
          </div>
          <div class="well" [hidden]="summativeFieldsDisabled">
            <div class="row">
              <div class="col-md-6">
                <label info-button
                       title="{{'aggregate-reports.form.field.summative-administration-condition.label' | translate}}"
                       content="{{'aggregate-reports.form.field.summative-administration-condition.info' | translate}}"></label>
              </div>
              <div class="col-md-6">
                <sb-checkbox-group [horizontal]="true"
                                   [options]="options.summativeAdministrationConditions"
                                   [(ngModel)]="settings.summativeAdministrationConditions"
                                   [ngModelOptions]="{standalone: true}"
                                   name="summativeAdministrationConditions"
                                   analyticsEvent="FilterClick"
                                   analyticsCategory="AggregateQueryBuilder"
                                   [allOptionAnalyticsProperties]="{label: 'Validity: All'}"
                                   (change)="onSettingsChange()"></sb-checkbox-group>
              </div>
            </div>
          </div>
          <div class="well">
            <div class="row">
              <div class="col-md-6">
                <label info-button
                       title="{{'common.completeness-form-control.label' | translate}}"
                       content="{{'common.completeness-form-control.info' | translate}}"></label>
              </div>
              <div class="col-md-6">
                <sb-checkbox-group [horizontal]="true"
                                   [options]="options.completenesses"
                                   [(ngModel)]="settings.completenesses"
                                   [ngModelOptions]="{standalone: true}"
                                   name="completenesses"
                                   analyticsEvent="FilterClick"
                                   analyticsCategory="AggregateQueryBuilder"
                                   [allOptionAnalyticsProperties]="{label: 'Completeness: All'}"
                                   (change)="onSettingsChange()"></sb-checkbox-group>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Subgroups -->
    <div class="row" #subgroupSection id="subgroupSection">
      <div class="col-md-8 col-md-offset-2">
        <div class="well-group">
          <div class="well">
            <h3>{{'aggregate-reports.form.section.comparative-subgroups.heading' | translate}}</h3>
            <div class="subtext">{{'aggregate-reports.form.section.comparative-subgroups.subtext' | translate}}</div>
          </div>
          <div class="well">
            <div class="row">
              <div class="col-md-6">
              </div>
              <div class="col-md-6">
                <sb-checkbox-group [options]="options.dimensionTypes"
                                   [(ngModel)]="settings.dimensionTypes"
                                   [ngModelOptions]="{standalone: true}"
                                   name="dimensionTypes"
                                   [allOptionEnabled]="false"
                                   analyticsEvent="FilterClick"
                                   analyticsCategory="AggregateQueryBuilder"
                                   [allOptionAnalyticsProperties]="{label: 'Comparative Subgroups: All'}"
                                   (change)="onSettingsChange()"></sb-checkbox-group>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="row" #advancedFiltersSection id="advancedFiltersSection">
      <div class="col-md-8 col-md-offset-2">
        <div class="well-group">
          <div class="well">
            <div class="row">
              <div class="col-sm-6">
                <h3>{{'aggregate-reports.form.section.subgroup-filters.heading' | translate}}</h3>
                <div class="subtext">{{'aggregate-reports.form.section.subgroup-filters.subtext' | translate}}</div>
              </div>
              <div class="col-sm-6">
                <button class="btn btn-default btn-sm icon-only pull-right"
                        (click)="onAdvancedFiltersExpanderButtonClick()">
                  <i class="fa" [ngClass]="showAdvancedFilters ? 'fa-angle-up' : 'fa-angle-down'"></i>
                </button>
              </div>
            </div>
          </div>
          <ng-container *ngIf="showAdvancedFilters">
            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label info-button
                         title="{{'aggregate-reports.form.field.gender.label' | translate}}"
                         content="{{'aggregate-reports.form.field.gender.info' | translate}}"></label>
                </div>
                <div class="col-md-6">
                  <sb-checkbox-group [horizontal]="true"
                                     [options]="options.genders"
                                     [(ngModel)]="settings.genders"
                                     [ngModelOptions]="{standalone: true}"
                                     name="genders"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionAnalyticsProperties]="{label: 'Gender: All'}"
                                     (change)="onSettingsChange()"></sb-checkbox-group>
                </div>
              </div>
            </div>
            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label info-button
                         title="{{'aggregate-reports.form.field.ethnicity.label' | translate}}"
                         content="{{'aggregate-reports.form.field.ethnicity.info' | translate}}"></label>
                </div>
                <div class="col-md-6">
                  <sb-checkbox-group [options]="options.ethnicities"
                                     [(ngModel)]="settings.ethnicities"
                                     [ngModelOptions]="{standalone: true}"
                                     name="ethnicities"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionAnalyticsProperties]="{label: 'Ethnicity: All'}"
                                     (change)="onSettingsChange()"></sb-checkbox-group>
                </div>
              </div>
            </div>
            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label info-button
                         title="{{'aggregate-reports.form.field.migrant-status.label' | translate}}"
                         content="{{'aggregate-reports.form.field.migrant-status.info' | translate}}"></label>
                </div>
                <div class="col-md-6">
                  <sb-checkbox-group [horizontal]="true"
                                     [options]="options.migrantStatuses"
                                     [(ngModel)]="settings.migrantStatuses"
                                     [ngModelOptions]="{standalone: true}"
                                     name="migrantStatuses"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionAnalyticsProperties]="{label: 'Migrant Status: All'}"
                                     (change)="onSettingsChange()"></sb-checkbox-group>
                </div>
              </div>
            </div>
            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label info-button
                         title="{{'aggregate-reports.form.field.iep.label' | translate}}"
                         content="{{'aggregate-reports.form.field.iep.info' | translate}}"></label>
                </div>
                <div class="col-md-6">
                  <sb-checkbox-group [horizontal]="true"
                                     [options]="options.individualEducationPlans"
                                     [(ngModel)]="settings.individualEducationPlans"
                                     [ngModelOptions]="{standalone: true}"
                                     name="individualEducationPlans"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionAnalyticsProperties]="{label: 'IEP: All'}"
                                     (change)="onSettingsChange()"></sb-checkbox-group>
                </div>
              </div>
            </div>
            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label info-button
                         title="{{'aggregate-reports.form.field.504.label' | translate}}"
                         content="{{'aggregate-reports.form.field.504.info' | translate}}"></label>
                </div>
                <div class="col-md-6">
                  <sb-checkbox-group [horizontal]="true"
                                     [options]="options.section504s"
                                     [(ngModel)]="settings.section504s"
                                     [ngModelOptions]="{standalone: true}"
                                     name="section504s"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionAnalyticsProperties]="{label: '504 Plan: All'}"
                                     (change)="onSettingsChange()"></sb-checkbox-group>
                </div>
              </div>
            </div>
            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label info-button
                         title="{{'aggregate-reports.form.field.limited-english-proficiency.label' | translate}}"
                         content="{{'aggregate-reports.form.field.limited-english-proficiency.info' | translate}}"></label>
                </div>
                <div class="col-md-6">
                  <sb-checkbox-group [horizontal]="true"
                                     [options]="options.limitedEnglishProficiencies"
                                     [(ngModel)]="settings.limitedEnglishProficiencies"
                                     [ngModelOptions]="{standalone: true}"
                                     name="limitedEnglishProficiencies"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionAnalyticsProperties]="{label: 'Limited English Proficiency: All'}"
                                     (change)="onSettingsChange()"></sb-checkbox-group>
                </div>
              </div>
            </div>
            <div class="well">
              <div class="row">
                <div class="col-md-6">
                  <label info-button
                         title="{{'aggregate-reports.form.field.economic-disadvantage.label' | translate}}"
                         content="{{'aggregate-reports.form.field.economic-disadvantage.info' | translate}}"></label>
                </div>
                <div class="col-md-6">
                  <sb-checkbox-group [horizontal]="true"
                                     [options]="options.economicDisadvantages"
                                     [(ngModel)]="settings.economicDisadvantages"
                                     [ngModelOptions]="{standalone: true}"
                                     name="economicDisadvantages"
                                     analyticsEvent="FilterClick"
                                     analyticsCategory="AggregateQueryBuilder"
                                     [allOptionAnalyticsProperties]="{label: 'Economic Disadvantage: All'}"
                                     (change)="onSettingsChange()"></sb-checkbox-group>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <!-- Report Name -->
    <div class="row" #reportNameSection id="reportNameSection">
      <div class="col-md-8 col-md-offset-2">
        <div class="well-group">
          <div class="well">
            <h3>{{'aggregate-reports.form.section.report-name.heading' | translate}}</h3>
          </div>
          <div class="well">
            <div class="row">
              <div class="col-md-12">
                <div class="form-group mt-sm">
                  <input type="text"
                         class="form-control"
                         formControlName="reportName"
                         [(ngModel)]="settings.name"
                         [required]="false"
                         placeholder="{{'aggregate-reports.default-report-name' | translate}}">
                  <div *ngIf="showErrors(reportNameControl)">
                    <p *ngIf="reportNameControl.errors.fileName" class="help-block small red">{{reportNameControl.errors.fileName.messageId | translate}}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </form>

  <!-- Summary -->
  <div class="row" #reviewSection id="reviewSection">
    <div class="col-md-8 col-md-offset-2">
      <div class="well-group">
        <div class="well">
          <h3>{{'aggregate-reports.form.section.review.heading' | translate}}</h3>
        </div>
        <div class="well">

          <!-- TODO add estimated row count section here -->

          <aggregate-report-summary narrow="true"
                                    [summary]="summary"></aggregate-report-summary>
        </div>
      </div>

    </div>
  </div>

  <div class="row" #previewSection id="previewSection">
    <div class="col-md-12 col-md-offset-2">
      <div class="well-group wide-content-container">
        <div class="well">
          <h3>{{'aggregate-reports.form.section.preview.heading' | translate}} </h3>
        </div>
        <div class="well">
          <div>
            <div>
              <span class="pull-left flex-child">
                <label class="mr-xs">
                  <info-button title="{{'aggregate-report.column-order' | translate}}"
                               content="{{'aggregate-report.column-order-info' | translate}}">
                  </info-button>
                </label>
                <order-selector [items]="columnItems"
                                (itemsChange)="onColumnOrderChange($event)"></order-selector>
              </span>
              <span class="pull-right flex-child ml-xs">
                <label class="mr-xs">{{'common.value-display-type-input-label' | translate}}</label>
                <sb-radio-button-group [options]="options.valueDisplayTypes"
                                       [(ngModel)]="settings.valueDisplayType"
                                       buttonGroupStyles="btn-group-xs"
                                       buttonStyles="btn-default"
                                       analyticsCategory="AggregateQueryBuilder"
                                       analyticsEvent="Change"></sb-radio-button-group>
              </span>
              <span class="pull-right flex-child ml-xs">
                <label class="mr-xs">{{'common.performance-level-display-type-input-label' | translate}}</label>
                <sb-radio-button-group [options]="options.performanceLevelDisplayTypes"
                                       [(ngModel)]="settings.performanceLevelDisplayType"
                                       buttonGroupStyles="btn-group-xs"
                                       buttonStyles="btn-default"
                                       analyticsCategory="AggregateQueryBuilder"
                                       analyticsEvent="Change"></sb-radio-button-group>
              </span>
            </div>
            <div class="clearfix"></div>
          </div>
          <div class="mt-sm">
            <div class="red label">{{ 'aggregate-reports.preview' | translate }}</div>
            <aggregate-report-table [preview]="true"
                                    [table]="previewTable"
                                    [valueDisplayType]="settings.valueDisplayType"
                                    [performanceLevelDisplayType]="settings.performanceLevelDisplayType"
                                    [columnOrdering]="settings.columnOrder"></aggregate-report-table>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
