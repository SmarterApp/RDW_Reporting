<div [ngClass]="{'disabled-table': preview}">

  <ng-container *ngIf="loading">
    <spinner></spinner>
  </ng-container>

  <p-dataTable #datatable
               [hidden]="loading"
               (onPage)="onPage($event)"
               [rowTrackBy]="rowTrackBy"
               [immutable]="false"
               [rows]="100"
               [paginator]="paginationEnabled"
               [pageLinks]="3"
               [rowsPerPageOptions]="[100, 500, 1000]"
               emptyMessage="{{'aggregate-reports.results.empty-message' | translate}}"
               tableStyleClass="table table-striped table-hover overflow">
    <p-column colId="organization"
              field="organization.name"
              [sortable]="rowSortingEnabled"
              (sortFunction)="sort($event)"
              header="{{'aggregate-reports.results.cols.organization-name' | translate}}">
      <ng-template let-col let-row="rowData" let-i="rowIndex" pTemplate="body">
        <div *ngIf="treeColumns[i] <= getColumnIndex(col)"
             class="full-cell pt-0"
             [ngClass]="{'border-top': treeColumns[i] <= getColumnIndex(col) && treeColumns[i] < columnOrdering.length - 1}">
          {{row.organization.name}}
        </div>
      </ng-template>
    </p-column>
    <p-column colId="assessmentGrade"
              field="assessmentGradeCode"
              [sortable]="rowSortingEnabled"
              (sortFunction)="sort($event)"
              header="{{'aggregate-reports.results.cols.assessment-grade' | translate}}">
      <ng-template let-col let-row="rowData" let-i="rowIndex" pTemplate="body">
        <div *ngIf="treeColumns[i] <= getColumnIndex(col)"
             class="full-cell pt-0"
             [ngClass]="{'border-top': treeColumns[i] <= getColumnIndex(col) && treeColumns[i] < columnOrdering.length - 1}">
          {{'common.grade.' + row.assessmentGradeCode + '.form-name' | translate}}
        </div>
      </ng-template>
    </p-column>
    <p-column colId="schoolYear"
              field="schoolYear"
              [sortable]="rowSortingEnabled"
              (sortFunction)="sort($event)"
              header="{{'aggregate-reports.results.cols.school-year' | translate}}">
      <ng-template let-col let-row="rowData" let-i="rowIndex" pTemplate="body">
        <div *ngIf="treeColumns[i] <= getColumnIndex(col)"
             class="full-cell pt-0"
             [ngClass]="{'border-top': treeColumns[i] <= getColumnIndex(col) && treeColumns[i] < columnOrdering.length - 1}">
          {{row.schoolYear | schoolYear}}
        </div>
      </ng-template>
    </p-column>
    <p-column colId="dimension"
              field="dimension.id"
              [sortable]="rowSortingEnabled"
              (sortFunction)="sort($event)"
              header="{{'aggregate-reports.results.cols.dimension' | translate}}">
      <ng-template let-col let-row="rowData" let-i="rowIndex" pTemplate="body">
        <div *ngIf="treeColumns[i] <= getColumnIndex(col)"
             class="full-cell pt-0"
             [ngClass]="{'border-top': treeColumns[i] <= getColumnIndex(col) && treeColumns[i] < columnOrdering.length - 1}">
          {{
            (row.dimension.includeType ? (('common.dimension.' + row.dimension.type) | translate) : '')
            + (row.dimension.includeType && row.dimension.code ? ': ' : '')
            + (row.dimension.code ? (row.dimension.codeTranslationCode | translate) : '')
          }}
        </div>
      </ng-template>
    </p-column>
    <p-column field="studentsTested"
              [sortable]="rowSortingEnabled"
              (sortFunction)="sort($event)"
              header="{{'aggregate-reports.results.cols.students-tested' | translate}}">
      <ng-template let-col let-row="rowData" let-i="rowIndex" pTemplate="body">
        <div class="full-cell pt-0"
             [ngClass]="{'border-top': treeColumns[i] < columnOrdering.length - 1}">
          {{ row.studentsTested | number }}
        </div>
      </ng-template>
    </p-column>
    <p-column header="{{'aggregate-reports.results.cols.achievement-comparison' | translate}}">
      <ng-template let-col let-row="rowData" let-i="rowIndex" pTemplate="body">
        <div class="full-cell pt-0 pb-0 pl-0 pr-0"
             [ngClass]="{'border-top': treeColumns[i] < columnOrdering.length - 1}">
          <performance-comparison *ngIf="row.studentsTested > 0"
                                  [assessmentTypeCode]="table.assessmentDefinition.typeCode"
                                  [performanceGroupingCutpoint]="table.assessmentDefinition.performanceLevelGroupingCutPoint"
                                  [groupPerformanceLevels]="groupPerformanceLevels"
                                  [performancePercentages]="row.performanceLevelByDisplayTypes[performanceLevelDisplayType].Percent"></performance-comparison>
        </div>
      </ng-template>
    </p-column>
    <p-column field="avgScaleScore"
              [sortable]="rowSortingEnabled"
              (sortFunction)="sort($event)"
              header="{{'aggregate-reports.results.cols.avg-scale-score' | translate}}">
      <ng-template let-col let-row="rowData" let-i="rowIndex" pTemplate="body">
        <div class="full-cell text-center"
             [ngClass]="{'border-top': treeColumns[i] < columnOrdering.length - 1}">
          <span *ngIf="!row.studentsTested">-</span>
          <span *ngIf="row.studentsTested">
            <scale-score [score]="row.avgScaleScore"
                         [standardError]="row.avgStdErr"></scale-score>
          </span>
        </div>
      </ng-template>
    </p-column>
    <p-column *ngFor="let level of performanceLevels; let levelIndex = index"
              [sortable]="rowSortingEnabled"
              (sortFunction)="sort($event)"
              field="{{ 'performanceLevelByDisplayTypes.' + performanceLevelDisplayType + '.' + valueDisplayType + '.' + levelIndex }}">
      <ng-template pTemplate="header">
        <div class="text-center">
          <span>{{getPerformanceLevelColumnHeaderTranslationCode(level) | translate}}</span><br>
          <span class="label"
                [ngClass]="colorService.getPerformanceLevelColorsByAssessmentTypeCode(table.assessmentDefinition.typeCode, level)">
            {{ (performanceLevelTranslationPrefix + level + '.short-name') | translate }}
          </span><br>
          <span>{{ 'aggregate-reports.results.cols.performance-level-suffix' | translate }}</span>
        </div>
      </ng-template>
      <ng-template let-col let-row="rowData" let-i="rowIndex" pTemplate="body">
        <div class="full-cell text-center"
             [ngClass]="{'border-top': treeColumns[i] < columnOrdering.length - 1}">
          <span *ngIf="!row.studentsTested">-</span>
          <span *ngIf="row.studentsTested">{{('common.value-display-type-format.' + valueDisplayType) | translate:{ value: row.performanceLevelByDisplayTypes[performanceLevelDisplayType][valueDisplayType][levelIndex] } }}</span>
        </div>
      </ng-template>
    </p-column>
  </p-dataTable>
</div>
