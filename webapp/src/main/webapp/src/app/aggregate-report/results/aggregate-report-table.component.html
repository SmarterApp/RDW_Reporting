<p-table #dataTable
         [columns]="columns"
         [rows]="rowsPerPageOptions[0]"
         [value]="table.rows"
         [rowTrackBy]="rowTrackBy"
         [paginator]="true"
         [pageLinks]="3"
         [alwaysShowPaginator]="false"
         [rowsPerPageOptions]="rowsPerPageOptions"
         (onPage)="onPage($event)"
         (sortFunction)="sort($event)"
         [sortMode]="rowSortingEnabled && 'single'"
         [customSort]="true"
         [autoLayout]="true"
         styleClass="table table-striped table-hover overflow">
  <ng-template pTemplate="header"
               let-columns>
    <tr>
      <th *ngFor="let column of columns"
          [hidden]="!column.visible"
          [pSortableColumn]="column.field"
          [pSortableColumnDisabled]="!column.sortable"
          [ngSwitch]="column.id"
          [ngClass]="{
            'wrapping': column.id !== 'achievementComparison'
              && column.id !== 'dimension'
              && column.id !== 'organization'
              && column.id !== 'claim'
              && column.id !== 'target'
          }">

        <div *ngSwitchCase="'avgScaleScore'" class="text-center">
          <div class="no-wrap">{{'aggregate-report-table.columns.avg-scale-score' | translate}}</div>
          <div class="no-wrap">{{'aggregate-report-table.columns.avg-scale-score-suffix' | translate}}</div>
        </div>

        <div *ngSwitchCase="'performanceLevel'"
             class="text-center">
          <div class="label"
               [ngClass]="column.headerColor">
            {{ column.headerKey | translate }}
          </div>
          <div>{{ 'aggregate-report-table.columns.performance-level-suffix' | translate }}</div>
        </div>

        <span *ngSwitchCase="'claim'"
              info-button
              title="{{'target-report.columns.claim' | translate}}"
              content="{{'common.info.claim' | translate}}">
        </span>

        <span *ngSwitchCase="'target'"
              info-button
              title="{{'target-report.columns.target' | translate}}"
              content="{{'common.info.target' | translate}}">
        </span>

        <span *ngSwitchCase="'studentRelativeResidualScoresLevel'"
              info-button
              title="{{'target-report.columns.' + toDash(column.id) | translate}}"
              content="{{('target-report.columns.' + toDash(column.id) + '-info') | translate}}">
        </span>

        <span *ngSwitchCase="'standardMetRelativeResidualLevel'"
              info-button
              title="{{'target-report.columns.' + toDash(column.id) | translate}}"
              content="{{('target-report.columns.' + toDash(column.id) + '-info') | translate}}">
        </span>

        <span *ngSwitchDefault>
          {{('aggregate-report-table.columns.' + toDash(column.id)) | translate}}
        </span>

        <p-sortIcon *ngIf="rowSortingEnabled && column.sortable"
                    [field]="column.field"></p-sortIcon>
      </th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body"
               let-rowData
               let-i="rowIndex"
               let-columns="columns">
    <tr>
      <td *ngFor="let column of columns; let columnIdx = index;"
          [hidden]="!column.visible">
        <div [ngSwitch]="column.id"
             class="full-cell"
             [ngClass]="{
              'pt-0': column.id === 'achievementComparison',
              'pb-0': column.id === 'achievementComparison',
              'hidden': treeColumns[i] > columnIdx,
              'border-top': treeColumns[i] <= columnIdx && treeColumns[i] < identityColumns.length - 1
             }">

          <div *ngSwitchCase="'organization'">
                <span class="label mr-xs"
                      [ngClass]="getOrganizationTypeColor(rowData.organization.type)">
                  {{('common.organization.type.' + rowData.organization.type) | translate}}
                </span>
            {{rowData.organization.name}}
          </div>

          <div *ngSwitchCase="'assessmentLabel'"
               class="label-max-width-sm"
               title="{{rowData.assessmentLabel}}">
            {{rowData.assessmentLabel}}
          </div>

          <div *ngSwitchCase="'assessmentGrade'"
               class="text-right">
            {{'common.assessment-grade.' + rowData.assessmentGradeCode | translate}}
          </div>

          <div *ngSwitchCase="'schoolYear'"
               class="text-right">
            {{rowData.schoolYear | schoolYear}}
          </div>

          <div *ngSwitchCase="'claim'"
               class="text-right">
            <span *ngIf="!preview || table.reportType !== 'Target'; else targetClaimPreview">
              {{ getClaimCodeTranslation(rowData) }}
            </span>
            <ng-template #targetClaimPreview>
              {{'aggregate-report-table.sample.claim' | translate:{code: rowData.claimCode} }}
            </ng-template>
          </div>

          <div *ngSwitchCase="'target'"
               class="text-right wrapping-max-width">
            <span *ngIf="!preview; else targetPreview">
              <strong>
                {{'common.results.assessment-item-target' | translate:{
                    target: 'subject.' + rowData.subjectCode + '.claim.' + rowData.claimCode + '.target.' + rowData.targetNaturalId + '.name' | translate
                  }
                }}
              </strong>
              {{ 'subject.' + rowData.subjectCode + '.claim.' + rowData.claimCode + '.target.' + rowData.targetNaturalId + '.description' | translate }}
            </span>
            <ng-template #targetPreview>
              <span [innerHTML]="'aggregate-report-table.sample.target' | translate:{name: rowData.targetNaturalId}"></span>
            </ng-template>
          </div>

          <div *ngSwitchCase="'dimension'"
               class="label-max-width"
               title="{{rowData.subgroup.name}}">
            <subgroup [subgroup]="rowData.subgroup"></subgroup>
          </div>

          <div *ngSwitchCase="'studentsTested'"
               class="text-right">
            {{rowData.studentsTested}}
          </div>

          <!-- TODO:ConfigurableSubjects do all claims have 3 levels? -->
          <div *ngSwitchCase="'achievementComparison'">
            <performance-level-distribution-chart
              [percentages]="rowData.performanceLevelByDisplayTypes.Separate.Percent"
              [cutPoint]="cutPoint"
              [performanceLevels]="rowData.claimCode ? 3 : null"
              [assessmentTypeCode]="assessmentTypeCode"
              [displayType]="performanceLevelDisplayType"
              [center]="center"></performance-level-distribution-chart>
          </div>

          <div *ngSwitchCase="'avgScaleScore'"
               class="text-center">
            <span *ngIf="!rowData.studentsTested">{{ "common.missing" | translate }}</span>
            <span *ngIf="rowData.studentsTested">
                  <scale-score [score]="rowData.avgScaleScore"
                               [standardError]="rowData.avgStdErr"></scale-score>
                </span>
          </div>

          <div *ngSwitchCase="'performanceLevel'"
               class="text-center">
            <span *ngIf="!rowData.studentsTested">{{ "common.missing" | translate }}</span>
            <span *ngIf="rowData.studentsTested">
              {{
                ('common.value-display-type-format.' + valueDisplayType) | translate:{
                    value: readField(rowData, column.field)
                }
              }}
            </span>
          </div>

          <div *ngSwitchCase="'studentRelativeResidualScoresLevel'"
               class="text-center">
            <span *ngIf="!rowData.studentsTested">{{ "common.missing" | translate }}</span>
            <ng-container *ngIf="rowData.studentsTested">
              <!-- pick the icon -->
              <ng-container [ngSwitch]="rowData.studentRelativeResidualScoresLevel">
                <span *ngSwitchCase="'Above'">
                  <span class="blue"><i class="fa fa-lg fa-arrow-up"></i></span>
                  {{'aggregate-report-table.target.overall.' + rowData.studentRelativeResidualScoresLevel | translate}}
                </span>
                <span *ngSwitchCase="'Near'">
                  <span class="blue">
                    <sb-icon class="fa-lg" icon="fa-equals"></sb-icon>
                  </span>
                  {{'aggregate-report-table.target.overall.' + rowData.studentRelativeResidualScoresLevel | translate}}
                </span>
                <span *ngSwitchCase="'Below'">
                  <span class="blue"><i class="fa fa-lg fa-arrow-down"></i></span>
                  {{'aggregate-report-table.target.overall.' + rowData.studentRelativeResidualScoresLevel | translate}}
                </span>
                <span *ngSwitchCase="'InsufficientData'"
                      class="label label-lg gray-light">
                  {{'aggregate-report-table.target.overall.' + rowData.studentRelativeResidualScoresLevel | translate}}
                </span>
                <span *ngSwitchDefault>
                  {{'aggregate-report-table.target.overall.' + rowData.studentRelativeResidualScoresLevel | translate}}
                </span>
              </ng-container>
            </ng-container>
          </div>

          <div *ngSwitchCase="'standardMetRelativeResidualLevel'"
               class="text-center">
            <span *ngIf="!rowData.studentsTested">{{ "common.missing" | translate }}</span>
            <ng-container *ngIf="rowData.studentsTested">
              <!-- pick the label color -->
              <!-- TODO:ConfigurableSubjects hardcoded performance level codes/colors? -->
              <span [ngSwitch]="rowData.standardMetRelativeResidualLevel">
                <span *ngSwitchCase="'Above'"
                      class="label label-lg performance-label sb-iab-green">
                  {{'aggregate-report-table.target.standard.Above' | translate}}
                </span>
                <span *ngSwitchCase="'Near'"
                      class="label label-lg performance-label sb-iab-yellow">
                  {{'aggregate-report-table.target.standard.Near' | translate}}
                </span>
                <span *ngSwitchCase="'Below'"
                      class="label label-lg performance-label sb-iab-red">
                  {{'aggregate-report-table.target.standard.Below' | translate}}
                </span>
                <span *ngSwitchCase="'InsufficientData'"
                      class="label label-lg gray-light">
                  {{'aggregate-report-table.target.standard.InsufficientData' | translate}}
                </span>
                <span *ngSwitchCase="'Excluded'">
                  {{'aggregate-report-table.target.standard.Excluded' | translate}}
                </span>
              </span>
            </ng-container>
          </div>
        </div>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="emptymessage" let-columns>
    <tr>
      <td [attr.colspan]="columns.length">
        {{'aggregate-report-table.empty-message' | translate}}
      </td>
    </tr>
  </ng-template>
</p-table>
