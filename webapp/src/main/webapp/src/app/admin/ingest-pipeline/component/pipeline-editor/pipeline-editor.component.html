<div class="toolbar">
  <h3>Assessments Pipeline</h3>

  <ng-container [ngSwitch]="selectedItem.type">
    <ng-container *ngSwitchCase="'Script'">
      <div
        class="compilation-status"
        [ngClass]="{
          compiling: compilationState === 'Compiling',
          failed: compilationState === 'Failed'
        }"
      >
        <ng-container [ngSwitch]="compilationState">
          <ng-container *ngSwitchCase="'Compiling'">
            <i class="fa fa-spinner fa-pulse"></i> Compiling
          </ng-container>
          <ng-container *ngSwitchCase="'Failed'">
            <i class="fa fa-warning"></i> Compilation Failed
          </ng-container>
        </ng-container>
      </div>

      <div [tooltip]="saveButtonDisabledTooltip">
        <button
          type="button"
          class="btn btn-primary btn-outlined"
          [ngClass]="{ disabled: !selectedItem.changed }"
          (click)="scriptUpdate.emit(selectedItem.value)"
        >
          <ng-container *ngIf="saving; else notSaving">
            <i class="fa fa-spinner fa-pulse"></i> Saving
          </ng-container>
          <ng-template #notSaving>
            <ng-container *ngIf="selectedItem.changed; else saved">
              Save Draft
            </ng-container>
            <ng-template #saved>
              Saved
            </ng-template>
          </ng-template>
        </button>
      </div>
      <div [tooltip]="testButtonDisabledTooltip">
        <button
          type="button"
          class="btn btn-success btn-outlined"
          [ngClass]="{ disabled: testButtonDisabled }"
          (click)="scriptTest.emit(selectedItem.value)"
        >
          <ng-container [ngSwitch]="testState">
            <ng-container *ngSwitchCase="'Compiling'">
              <i class="fa fa-spinner fa-pulse"></i> Compiling
            </ng-container>
            <ng-container *ngSwitchCase="'Testing'">
              <i class="fa fa-spinner fa-pulse"></i> Testing
            </ng-container>
            <ng-container *ngSwitchDefault>
              Run Tests
            </ng-container>
          </ng-container>
        </button>
      </div>
      <div [tooltip]="publishButtonDisabledTooltip">
        <button
          type="button"
          class="btn btn-primary"
          [ngClass]="{ disabled: publishButtonDisabled }"
          (click)="scriptPublish.emit(selectedItem.value)"
        >
          <ng-container [ngSwitch]="publishState">
            <ng-container *ngSwitchCase="'Compiling'">
              <i class="fa fa-spinner fa-pulse"></i> Compiling
            </ng-container>
            <ng-container *ngSwitchCase="'Testing'">
              <i class="fa fa-spinner fa-pulse"></i> Testing
            </ng-container>
            <ng-container *ngSwitchCase="'Validating'">
              <i class="fa fa-spinner fa-pulse"></i> Validating
            </ng-container>
            <ng-container *ngSwitchCase="'Publishing'">
              <i class="fa fa-spinner fa-pulse"></i> Publishing
            </ng-container>
            <ng-container *ngSwitchDefault>
              Publish
            </ng-container>
          </ng-container>
        </button>
      </div>
    </ng-container>
    <ng-container *ngSwitchCase="'Test'">
      <div [tooltip]="saveButtonDisabledTooltip">
        <button
          class="btn btn-primary btn-outlined"
          [ngClass]="{ disabled: !selectedItem.changed }"
          (click)="testUpdate.emit(selectedItem.value)"
        >
          <ng-container *ngIf="testUpdating; else testNotUpdating">
            <i class="fa fa-spinner fa-pulse"></i> Saving
          </ng-container>
          <ng-template #testNotUpdating>
            <ng-container *ngIf="selectedItem.changed; else saved">
              Save
            </ng-container>
            <ng-template #saved>
              Saved
            </ng-template>
          </ng-template>
        </button>
      </div>
      <div [tooltip]="testButtonDisabledTooltip">
        <button
          class="btn btn-success btn-outlined"
          [ngClass]="{ disabled: testButtonDisabled }"
          (click)="testRun.emit(selectedItem.value)"
        >
          <ng-container *ngIf="testing; else testNotRunning">
            <i class="fa fa-spinner fa-pulse"></i> Testing
          </ng-container>
          <ng-template #testNotRunning>
            Run Test
          </ng-template>
        </button>
      </div>
    </ng-container>
  </ng-container>
</div>

<div class="editor-container">
  <pipeline-explorer
    [items]="items"
    [selectedItem]="selectedItem"
    (itemSelected)="itemSelected.emit($event)"
    (createTestButtonClick)="testCreate.emit()"
    (deleteTestButtonClick)="testDelete.emit($event)"
  ></pipeline-explorer>

  <div>
    <ng-container *ngIf="selectedItemLoading; else itemLoaded">
      <spinner></spinner>
    </ng-container>
    <ng-template #itemLoaded>
      <ng-container [ngSwitch]="selectedItem.type">
        <ng-container *ngSwitchCase="'Script'">
          <code-editor
            [theme]="codeEditorTheme"
            [lines]="35"
            [messages]="messages"
            [language]="selectedItem.value.language"
            [(ngModel)]="selectedItem.value.body"
            (ngModelChange)="scriptChange.emit($event)"
          ></code-editor>
        </ng-container>
        <ng-container *ngSwitchCase="'Test'">
          <pipeline-test-form
            [inputType]="pipeline.inputType"
            [test]="selectedItem.value"
            (testChange)="testChange.emit(selectedItem)"
          ></pipeline-test-form>
        </ng-container>
      </ng-container>
    </ng-template>
  </div>
</div>
