package org.opentestsystem.rdw.reporting.sandbox.service.impl;

import org.opentestsystem.rdw.multitenant.Tenant;
import org.opentestsystem.rdw.multitenant.TenantContextHolder;
import org.opentestsystem.rdw.multitenant.TenantProperties;
import org.opentestsystem.rdw.reporting.sandbox.SandboxRole;
import org.opentestsystem.rdw.reporting.sandbox.repository.SandboxRoleRepository;
import org.opentestsystem.rdw.reporting.sandbox.service.SandboxRoleService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
public class DefaultSandboxRoleService implements SandboxRoleService {
    private final TenantProperties tenantProperties;
    private final SandboxRoleRepository roleRepository;

    @Autowired
    public DefaultSandboxRoleService(final TenantProperties tenantProperties,
                                     final SandboxRoleRepository roleRepository) {
        this.tenantProperties = tenantProperties;
        this.roleRepository = roleRepository;
    }

    @Override
    public Map<String, List<SandboxRole>> findAll() {
        final Map<String, List<SandboxRole>> roleMap = new HashMap<>();

        for (final Tenant tenant : tenantProperties.findSandboxes()) {
            TenantContextHolder.setTenantId(tenant.getId());
            final List<SandboxRole> roles = this.roleRepository.findAll();
            roleMap.put(tenant.getKey(), roles);
            TenantContextHolder.clear();
        }

        return roleMap;
    }
}
