package org.opentestsystem.rdw.reporting.search.exam.student;

import org.opentestsystem.rdw.reporting.common.security.PermissionScope;
import org.opentestsystem.rdw.reporting.exam.AssessmentItem;
import org.opentestsystem.rdw.reporting.exam.ExamItemScore;
import org.opentestsystem.rdw.reporting.search.assessment.AssessmentItemRepository;
import org.opentestsystem.rdw.reporting.search.exam.GroupExamItemScores;
import org.opentestsystem.rdw.reporting.security.User;
import org.springframework.stereotype.Service;

import javax.validation.constraints.NotNull;
import java.util.List;

/**
 * Default implementation of a StudentExamItemService.
 */
@Service
class DefaultStudentExamItemService implements StudentExamItemService {

    private final StudentExamItemRepository examItemRepository;
    private final AssessmentItemRepository assessmentItemRepository;

    public DefaultStudentExamItemService(final StudentExamItemRepository examItemRepository,
                                         final AssessmentItemRepository assessmentItemRepository) {
        this.examItemRepository = examItemRepository;
        this.assessmentItemRepository = assessmentItemRepository;
    }

    @Override
    public GroupExamItemScores findExamItemsForStudentExam(@NotNull final User user, final long studentId, final long examId) {
        final PermissionScope scope = user.getPermissionsById().get("INDIVIDUAL_PII_READ").getScope();
        final List<ExamItemScore> examItemScores = examItemRepository.findAllByExamId(scope, studentId, examId);
        final List<AssessmentItem> assessmentItems = assessmentItemRepository.findAllForExam(examId);
        return new GroupExamItemScores(assessmentItems, examItemScores);
    }
}
