package org.opentestsystem.rdw.reporting.security.sandbox;

import com.google.common.collect.Maps;
import org.opentestsystem.rdw.multitenant.Tenant;
import org.opentestsystem.rdw.multitenant.TenantContextHolder;
import org.opentestsystem.rdw.reporting.common.security.ReportingPermission;
import org.opentestsystem.rdw.reporting.common.security.User;
import org.opentestsystem.rdw.reporting.common.security.UserTenant;
import org.opentestsystem.rdw.reporting.sandbox.SandboxRepository;
import org.opentestsystem.rdw.reporting.sandbox.SandboxRole;
import org.opentestsystem.rdw.reporting.sandbox.SandboxRoleRepository;
import org.opentestsystem.rdw.reporting.security.authority.Authority;
import org.opentestsystem.rdw.reporting.security.authority.AuthorityService;
import org.opentestsystem.rdw.security.Permission;
import org.springframework.security.authentication.AuthenticationServiceException;
import org.springframework.security.core.userdetails.AuthenticationUserDetailsService;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;

import java.util.Map;
import java.util.Set;
import java.util.UUID;

import static java.util.stream.Collectors.toSet;
import static org.opentestsystem.rdw.reporting.common.web.security.GrantedAuthorities.toGrantedAuthorities;

class SandboxUserDetailsService implements AuthenticationUserDetailsService<SandboxAuthenticationToken> {

    private final AuthorityService authorityService;
    private final SandboxRepository sandboxRepository;
    private final SandboxRoleRepository sandboxRoleRepository;
    private final SandboxUserGroupRepository sandboxUserGroupRepository;

    SandboxUserDetailsService(
            final AuthorityService authorityService,
            final SandboxRepository sandboxRepository,
            final SandboxRoleRepository sandboxRoleRepository,
            final SandboxUserGroupRepository sandboxUserGroupRepository) {
        this.authorityService = authorityService;
        this.sandboxRepository = sandboxRepository;
        this.sandboxRoleRepository = sandboxRoleRepository;
        this.sandboxUserGroupRepository = sandboxUserGroupRepository;
    }

    @Override
    public UserDetails loadUserDetails(final SandboxAuthenticationToken token) throws UsernameNotFoundException {

        final Tenant sandbox = sandboxRepository.findByKey(token.getSandboxKey());
        TenantContextHolder.setTenantId(sandbox.getId());

        // User ID is a combination of the requested role and UUID
        final String usernameAndId = String.format(
                "%s,%s",
                token.getRole(),
                token.getUserId() != null
                    ? token.getUserId()
                    : UUID.randomUUID()
        );

        final SandboxRole role = sandboxRoleRepository.findById(token.getRole());

        // The request was tampered with or someone's saved sandbox login link is no longer valid
        if (role == null) {
            throw new AuthenticationServiceException(String.format(
                    "Sandbox role \"%s\" not found",
                    token.getRole()
            ));
        }

        final Set<Authority> authorities = authorityService.getAuthorities(role);
        final Set<Permission> permissions = authorityService.getPermissions(authorities);
        final Map<String, Permission> permissionsById = Maps.uniqueIndex(permissions, Permission::getId);
        if (permissionsById.containsKey(ReportingPermission.GroupPiiRead)) {
            sandboxUserGroupRepository.createByOrganization(
                    usernameAndId,
                    role.getOrganization().getName()
            );
        }

        TenantContextHolder.clear();

        return User.builderExt()
                .tenant(
                        UserTenant.builder()
                                .id(sandbox.getId())
                                .name(sandbox.getName())
                                .sandbox(true)
                                .logoutUrl("/logout")
                                .logoutSuccessUrl(token.getLogoutSuccessUrl())
                                .sessionRefreshUrl(token.getSessionRefreshUrl())
                                .build()
                )
                .id(usernameAndId)
                .username(usernameAndId)
                .password("N/A")
                .firstName(token.getUsername().trim())
                .lastName("")
                .permissionsById(permissionsById)
                .enabled(true)
                .credentialsNonExpired(true)
                .accountNonExpired(true)
                .accountNonLocked(true)
                .authorities(
                        toGrantedAuthorities(
                                authorities.stream().map(Authority::getRole).collect(toSet()),
                                permissions.stream().map(Permission::getId).collect(toSet())
                        )
                )
                .build();
    }

}
