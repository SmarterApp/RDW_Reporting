package org.opentestsystem.rdw.reporting.web;

import org.opentestsystem.rdw.reporting.common.export.ExamReportRequest;
import org.opentestsystem.rdw.reporting.common.export.ExportSource;
import org.opentestsystem.rdw.reporting.common.export.PdfOptions;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.cloud.stream.annotation.EnableBinding;
import org.springframework.context.annotation.Bean;
import org.springframework.integration.channel.DirectChannel;
import org.springframework.messaging.MessageChannel;
import org.springframework.messaging.MessageHeaders;
import org.springframework.messaging.support.MessageBuilder;
import org.springframework.stereotype.Service;

@Service
@EnableBinding
public class PdfExamReportExportSource implements ExportSource<ExamReportRequest<PdfOptions>> {

    private final Logger logger = LoggerFactory.getLogger(getClass());
    private MessageChannel outputChannel;

    @Autowired
    @Qualifier("sourceChannel")
    public void setOutputChannel(final MessageChannel outputChannel) {
        this.outputChannel = outputChannel;
    }

    @Override
    public void submitRequest(final ExamReportRequest<PdfOptions> request) {

        logger.info("submitting", request);

        outputChannel.send(MessageBuilder.createMessage(request, new MessageHeaders(null)));
    }

    @Bean(name = "sourceChannel")
    public MessageChannel outputChannel() {
        return new DirectChannel();
    }

}
