package org.opentestsystem.rdw.reporting.search.exam;

import com.google.common.collect.ImmutableList;
import org.opentestsystem.rdw.common.model.AssessmentType;
import org.opentestsystem.rdw.common.model.Subject;
import org.opentestsystem.rdw.reporting.exam.Assessment;

import java.sql.ResultSet;
import java.sql.SQLException;

public final class Assessments {

    private static final String[] CLAIM_CODE_COLUMN_NAMES = {
            "claim1_score_code",
            "claim2_score_code",
            "claim3_score_code",
            "claim4_score_code"
    };

    private Assessments() {
    }

    public static <A extends Assessment.Builder> A map(final ResultSet row, final A builder) throws SQLException {

        final AssessmentType type = AssessmentType.valueOf(row.getInt("type_id"));

        builder.id(row.getLong("id"))
                .name(row.getString("label"))
                .gradeId(row.getInt("grade_id"))
                .type(type)
                .subject(Subject.valueOf(row.getInt("subject_id")))
                .schoolYear(row.getInt("school_year"));

        // IABs do not have claims
        if (type != AssessmentType.IAB) {
            final ImmutableList.Builder<String> claimCodes = ImmutableList.builder();
            for (String claimCodeColumnName : CLAIM_CODE_COLUMN_NAMES) {
                final String claimCode = row.getString(claimCodeColumnName);
                if (claimCode == null) {
                    break;
                }
                claimCodes.add(claimCode);
            }
            builder.claimCodes(claimCodes.build());
        }

        return builder;
    }

}
