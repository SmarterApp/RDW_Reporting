package org.opentestsystem.rdw.reporting.report.client;

import org.opentestsystem.rdw.reporting.common.model.Report;
import org.opentestsystem.rdw.reporting.common.report.BatchExamReportRequestHolder;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.io.IOException;
import java.io.InputStream;
import java.util.List;

/**
 * This class acts as an interface to the report web service API
 */
@Service
class ReportWebServiceClient {

    private final String url;
    private final RestTemplate template;

    @Autowired
    ReportWebServiceClient(
            @Value("${app.reportservice.url}") final String url,
            @Qualifier("pdfAcceptingRestTemplate") final RestTemplate template) {
        this.url = url;
        this.template = template;
    }

    /**
     * Gets all reports associated with the user
     *
     * @param userId the user ID
     * @return all reports associated with the user
     */
    public List<Report> getReports(final String userId) {
        final ResponseEntity<List<Report>> response = template.exchange(
                "{url}/api/reports?user={userId}", HttpMethod.GET, null,
                new ParameterizedTypeReference<List<Report>>() {}, url, userId);
        return  getBodyOrThrowExceptionIfNotSuccessful(response);
    }

    /**
     * Creates a new report
     *
     * @param request the report content parameters
     * @return a handle on the new report being created
     */
    public Report createReport(final BatchExamReportRequestHolder request) {
        final ResponseEntity<Report> response = template.exchange(
                "{url}/api/reports", HttpMethod.POST, new HttpEntity<>(request), Report.class, url);
        return getBodyOrThrowExceptionIfNotSuccessful(response);
    }

    /**
     * Gets the report file input stream
     *
     * @param reportId the report ID
     * @return the report file input stream
     */
    public InputStream getReport(final long reportId) {
        final ResponseEntity<Resource> response = template.exchange(
                "{url}/api/reports/{reportId}/content", HttpMethod.GET, null, Resource.class, url, reportId);
        final Resource resource = getBodyOrThrowExceptionIfNotSuccessful(response);
        try {
            return resource.getInputStream();
        } catch (final IOException exception) {
            throw new RuntimeException("Failed getting input stream from Report Service resource", exception);
        }
    }

    private <T> T getBodyOrThrowExceptionIfNotSuccessful(final ResponseEntity<T> response) {
        if (!response.getStatusCode().is2xxSuccessful()) {
            throw new RuntimeException(String.format(
                    "Report Service responded with error \"%s: %s\"",
                    response.getStatusCode().value(), response.getStatusCode().getReasonPhrase()));
        }
        return response.getBody();
    }

}
