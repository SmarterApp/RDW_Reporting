package org.opentestsystem.rdw.reporting.exam.repository;

import com.google.common.collect.ImmutableMap;
import org.opentestsystem.rdw.reporting.assessment.Assessment;
import org.opentestsystem.rdw.reporting.exam.GroupExam;
import org.opentestsystem.rdw.reporting.security.PermissionScope;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;

import javax.validation.constraints.NotNull;
import java.util.List;
import java.util.Optional;

public abstract class AbstractJdbcGroupExamRepository implements GroupExamRepository {

    private final NamedParameterJdbcTemplate template;
    private final String findLatestQuery;

    AbstractJdbcGroupExamRepository(
            @NotNull final NamedParameterJdbcTemplate template,
            @NotNull final String findLatestQuery) {
        this.template = template;
        this.findLatestQuery = findLatestQuery;
    }

    @Override
    public Optional<GroupExam> findLatest(
            final long groupId,
            final long groupSubjectId,
            final long year,
            @NotNull final PermissionScope permissionScope) {

        final List<GroupExam> assessments = template.query(
                findLatestQuery,
                ImmutableMap.<String, Object>builder()
                        .put("year", year)
                        .put("group_id", groupId)
                        .put("group_subject_id", groupSubjectId)
                        .put("statewide", permissionScope.isStatewide())
                        .put("district_ids", permissionScope.getDistrictIds().isEmpty() ? -1 : permissionScope.getDistrictIds())
                        .put("school_ids", permissionScope.getInstitutionIds().isEmpty() ? -1 : permissionScope.getDistrictIds())
                        .build(),
                (row, index) -> new GroupExam(
                        row.getTimestamp("completed_at").toInstant(),
                        Assessment.builder()
                                .id(row.getLong("assessment_id"))
                                .name(row.getString("assessment_name"))
                                .gradeId(row.getLong("assessment_grade_id"))
                                .typeId(row.getLong("assessment_type_id"))
                                .subjectId(row.getLong("assessment_subject_id"))
                                .build()
                )
        );

        return assessments.isEmpty()
                ? Optional.empty()
                : Optional.of(assessments.get(0));
    }

}
