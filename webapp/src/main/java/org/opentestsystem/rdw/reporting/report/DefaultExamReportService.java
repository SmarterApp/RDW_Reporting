package org.opentestsystem.rdw.reporting.report;

import org.opentestsystem.rdw.reporting.common.model.Report;
import org.opentestsystem.rdw.reporting.common.report.AbstractBatchExamReportRequest;
import org.opentestsystem.rdw.reporting.common.report.BatchExamReportRequestHolder;
import org.opentestsystem.rdw.reporting.common.report.GroupExamReportRequest;
import org.opentestsystem.rdw.reporting.common.report.PrintOptions;
import org.opentestsystem.rdw.reporting.common.report.SchoolGradeExamReportRequest;
import org.opentestsystem.rdw.reporting.common.security.PermissionScope;
import org.opentestsystem.rdw.reporting.report.client.ReportWebServiceClient;
import org.opentestsystem.rdw.reporting.security.User;
import org.springframework.stereotype.Service;

import javax.servlet.http.HttpServletResponse;
import javax.validation.constraints.NotNull;
import java.io.OutputStream;
import java.util.List;

@Service
class DefaultExamReportService implements ExamReportService {

    private final ReportWebServiceClient client;

    DefaultExamReportService(final ReportWebServiceClient client) {
        this.client = client;
    }

    @Override
    public Report createReport(@NotNull final User user, @NotNull final SchoolGradeExamReportRequest request) {
        final PermissionScope permissionScope = user.getPermissionsById().get("INDIVIDUAL_PII_READ").getScope();
        return createReport(user, request, permissionScope, "REPORT_NAME");
    }

    @Override
    public Report createReport(@NotNull final User user, @NotNull final GroupExamReportRequest request) {
        final PermissionScope permissionScope = user.getPermissionsById().get("GROUP_PII_READ").getScope();
        return createReport(user, request, permissionScope, "REPORT_NAME");
    }

    @Override
    public List<Report> getReports(@NotNull final User user) {
        return client.getReports(user.getUsername());
    }

    @Override
    public void streamReport(@NotNull final User user, final long reportId, final HttpServletResponse response) {
        client.streamReport(user.getUsername(), reportId, response);
    }

    private <T extends AbstractBatchExamReportRequest<PrintOptions>> Report createReport(
            final User user, @NotNull final T request, @NotNull final PermissionScope permissionScope, final String name) {
        final BatchExamReportRequestHolder holder = new BatchExamReportRequestHolder(request, permissionScope, user.getUsername(), name);
        return client.createReport(holder);
    }

}
