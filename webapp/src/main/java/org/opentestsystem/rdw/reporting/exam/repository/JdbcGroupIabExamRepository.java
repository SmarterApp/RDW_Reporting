package org.opentestsystem.rdw.reporting.exam.repository;

import org.opentestsystem.rdw.reporting.assessment.Assessment;
import org.opentestsystem.rdw.reporting.exam.Exam;
import org.opentestsystem.rdw.reporting.exam.ScaleScore;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

import javax.validation.constraints.NotNull;
import java.sql.ResultSet;
import java.sql.SQLException;

@Repository
class JdbcGroupIabExamRepository extends AbstractJdbcGroupExamRepository<Assessment.Builder, Exam.Builder> implements GroupIabExamRepository {

    public JdbcGroupIabExamRepository(
            @NotNull final EthnicityRepository ethnicityRepository,
            @NotNull final NamedParameterJdbcTemplate template,
            @Value("${sql.group.exam.iab.findLatest}") final String findLatestQuery,
            @Value("${sql.group.assessment.iab.findAll}") final String findAllQuery,
            @Value("${sql.group.exam.iab.findAllForAssessment}") final String findAllForAssessmentQuery) {
        super(ethnicityRepository, template, findLatestQuery, findAllQuery, findAllForAssessmentQuery);
    }

    @Override
    protected Exam.Builder processRow(final Exam.Builder builder, final ResultSet row) throws SQLException {
        return builder.scaleScore(ScaleScore.builder()
                .level((Long) row.getObject("category"))
                .value((Long) row.getObject("scale_score"))
                .standardError((Double) row.getObject("scale_score_std_err"))
                .build()
        );
    }

}
