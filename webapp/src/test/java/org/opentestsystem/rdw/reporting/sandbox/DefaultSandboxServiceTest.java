package org.opentestsystem.rdw.reporting.sandbox;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.ImmutableSet;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.multitenant.Tenant;
import org.opentestsystem.rdw.multitenant.TenantProperties;
import org.opentestsystem.rdw.reporting.sandbox.service.SandboxRoleService;
import org.opentestsystem.rdw.reporting.sandbox.service.impl.DefaultSandboxService;

import java.util.*;

import static org.assertj.core.api.Assertions.assertThat;

import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;


public class DefaultSandboxServiceTest {

    private TenantProperties mockTenantProperties;
    private SandboxRoleService mockRoleService;
    private DefaultSandboxService service;

    @Before
    public void setup() {
        mockTenantProperties = mock(TenantProperties.class);
        mockRoleService = mock(SandboxRoleService.class);
        service = new DefaultSandboxService(mockTenantProperties, mockRoleService);
    }

    @Test
    public void itShouldGetSandboxes() {
        when(mockTenantProperties.findSandboxes()).thenReturn(getMockTenants());
        when(mockRoleService.findAll()).thenReturn(getMockSandboxRoles());
        Set<Sandbox> expectedSandboxSet = getMockSandboxSet();
        Optional<Sandbox> expectedCaSandbox = getSandboxFromKey(expectedSandboxSet, "ca_19091");
        Optional<SandboxRole> expectedCaRole = getRoleFromKey(expectedCaSandbox.get().getSandboxRoles(), "teacher_harborside_g4");
        Optional<Sandbox> expectedMiSandbox = getSandboxFromKey(expectedSandboxSet, "mi_42582");
        Optional<SandboxRole> expectedMiRole = getRoleFromKey(expectedMiSandbox.get().getSandboxRoles(), "district_admin_detroit");

        Set<Sandbox> sandboxes = service.getSandboxes();
        assertThat(sandboxes).isNotNull().isNotEmpty();
        assertThat(sandboxes.size()).isEqualTo(2);

        Optional<Sandbox> caSandbox = getSandboxFromKey(sandboxes, "ca_19091");
        assertThat(caSandbox.isPresent()).isTrue();
        assertThat(caSandbox.get()).isEqualToComparingFieldByFieldRecursively(expectedCaSandbox.get());

        List<SandboxRole> caRoles = caSandbox.get().getSandboxRoles();
        assertThat(caRoles).hasSameSizeAs(getMockSandboxRoles().get("ca_19091"));
        assertThat(caRoles.get(0).getId()).isEqualTo(getMockSandboxRoles().get("ca_19091").get(0).getId());

        Optional<SandboxRole> caRole = getRoleFromKey(caSandbox.get().getSandboxRoles(), "teacher_harborside_g4");
        assertThat(caRole.isPresent()).isTrue();
        assertThat(caRole.get()).isEqualToComparingFieldByField(expectedCaRole.get());

        Optional<Sandbox> miSandbox = getSandboxFromKey(sandboxes, "mi_42582");
        assertThat(miSandbox.isPresent()).isTrue();
        assertThat(miSandbox.get()).isEqualToComparingFieldByFieldRecursively(expectedMiSandbox.get());

        Optional<SandboxRole> miRole = getRoleFromKey(miSandbox.get().getSandboxRoles(), "district_admin_detroit");
        assertThat(miRole.isPresent()).isTrue();
        assertThat(miRole.get()).isEqualToComparingFieldByField(expectedMiRole.get());
    }

    /**
     * @param sandboxes collection of sandboxes to search though
     * @param key the key to search for
     * @return Return the found Sandbox for key
     */
    private Optional<Sandbox> getSandboxFromKey(final Set<Sandbox> sandboxes, String key) {
        return sandboxes.stream()
                .filter(sandbox ->
                        sandbox.getKey().equals(key)
                ).findFirst();
    }

    /**
     *
     * @param sandboxRoles collection of Roles to search through
     * @param id the id to search for
     * @return the found SandboxRole for each key
     */
    private Optional<SandboxRole> getRoleFromKey(final List<SandboxRole> sandboxRoles, String id) {
        return sandboxRoles.stream()
                .filter(sandboxRole ->
                        sandboxRole.getId().equals(id)
                ).findFirst();
    }

    private static Set<Tenant> getMockTenants() {
        Tenant mockSandbox1 = new Tenant("ca_19091", "ca_19091", "California Sandbox");
        mockSandbox1.setSandbox(true);
        Tenant mockSandbox2 = new Tenant("mi_42582", "mi_42582", "Michigan Sandbox");
        mockSandbox1.setSandbox(true);
        return ImmutableSet.of(mockSandbox1, mockSandbox2);
    }

    private static Map<String, List<SandboxRole>> getMockSandboxRoles() {
        List<SandboxRole> caRoles = getMockSandboxSet().stream()
                .filter(sandbox -> sandbox.getKey().equals("ca_19091"))
                .findFirst()
                .get()
                .getSandboxRoles();
        List<SandboxRole> miRoles = getMockSandboxSet().stream()
                .filter(sandbox -> sandbox.getKey().equals("mi_42582"))
                .findFirst()
                .get()
                .getSandboxRoles();

        return ImmutableMap.of(
                "ca_19091", caRoles,
                "mi_42582", miRoles
        );
    }

    /**
     * @return temp collection of sandboxes that is required for sandbox login
     */
    static Set<Sandbox> getMockSandboxSet() {
        List<SandboxRole> caSandboxRoles = new ArrayList<>();
        SandboxRole caSandboxRole_thg4 = SandboxRole.builder()
                .id("teacher_harborside_g4")
                .label("Teacher - Harborside - Grade 4")
                .build();
        caSandboxRoles.add(caSandboxRole_thg4);
        SandboxRole caSandboxRole_thg5 = SandboxRole.builder()
                .id("teacher_harborside_g5")
                .label("Teacher - Harborside - Grade 5")
                .build();
        caSandboxRoles.add(caSandboxRole_thg5);
        SandboxRole caSandboxRole_thg6 = SandboxRole.builder()
                .id("teacher_harborside_g5")
                .label("Teacher - Harborside - Grade 6")
                .build();
        caSandboxRoles.add(caSandboxRole_thg6);
        SandboxRole caSandboxRole_da_sw = SandboxRole.builder()
                .id("district_admin_sweetwater")
                .label("District Administrator - Sweetwater")
                .build();
        caSandboxRoles.add(caSandboxRole_da_sw);
        SandboxRole caSandboxRole_da_h = SandboxRole.builder()
                .id("district_admin_harborside")
                .label("District Administrator - Harborside")
                .build();
        caSandboxRoles.add(caSandboxRole_da_h);

        Set<Sandbox> sandboxes = new HashSet<>();
        Sandbox sandboxCa = Sandbox.builder()
                .key("ca_19091")
                .label("California Sandbox")
                .roles(caSandboxRoles)
                .build();
        sandboxes.add(sandboxCa);


        List<SandboxRole> miSandboxRoles = new ArrayList<>();
        SandboxRole miSandboxRole_tg6 = SandboxRole.builder()
                .id("teacher_rosebank_g6")
                .label("Teacher - Rosebank - Grade 6")
                .build();
        miSandboxRoles.add(miSandboxRole_tg6);
        SandboxRole miSandboxRole_tg5 = SandboxRole.builder()
                .id("teacher_rosebank_g7")
                .label("Teacher - Rosebank - Grade 7")
                .build();
        miSandboxRoles.add(miSandboxRole_tg5);
        SandboxRole miSandboxRole_tg8 = SandboxRole.builder()
                .id("teacher_rosebank_g8")
                .label("Teacher - Rosebank - Grade 8")
                .build();
        miSandboxRoles.add(miSandboxRole_tg8);
        SandboxRole miSandboxRole_da_d = SandboxRole.builder()
                .id("district_admin_detroit")
                .label("District Administrator - Detroit")
                .build();
        miSandboxRoles.add(miSandboxRole_da_d);
        SandboxRole miSandboxRole_da_l = SandboxRole.builder()
                .id("district_admin_landsing")
                .label("District Administrator - Landsing")
                .build();
        miSandboxRoles.add(miSandboxRole_da_l);
        SandboxRole miSandboxRole_da_gr = SandboxRole.builder()
                .id("school_admin_grand_rapids")
                .label("District Administrator -  Grand Rapids")
                .build();
        miSandboxRoles.add(miSandboxRole_da_gr);
        Sandbox sandboxMi = Sandbox.builder()
                .key("mi_42582")
                .label("Michigan Sandbox")
                .roles(miSandboxRoles)
                .build();
        sandboxes.add(sandboxMi);

        return sandboxes;
    }
}