package org.opentestsystem.rdw.reporting.organization;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Maps;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.ArgumentCaptor;
import org.mockito.Captor;
import org.mockito.Mock;
import org.mockito.runners.MockitoJUnitRunner;
import org.opentestsystem.rdw.reporting.common.model.OrganizationQuery;
import org.opentestsystem.rdw.reporting.common.model.OrganizationType;
import org.opentestsystem.rdw.reporting.common.repository.OrganizationRepository;
import org.opentestsystem.rdw.reporting.common.web.security.User;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.test.context.ActiveProfiles;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Matchers.eq;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;
import static org.opentestsystem.rdw.reporting.common.security.ReportingPermission.IndividualPiiRead;

@RunWith(MockitoJUnitRunner.class)
@ActiveProfiles("test")
public class DefaultOrganizationServiceTest {

    @Mock
    private OrganizationRepository repository;

    @Mock
    private User user;

    @Captor
    private ArgumentCaptor<OrganizationQuery> queryCaptor;

    private DefaultOrganizationService service;

    @Before
    public void before() {
        when(user.getPermissionsById())
                .thenReturn(ImmutableMap.of(
                        IndividualPiiRead, new Permission(IndividualPiiRead, PermissionScope.STATEWIDE)
                ));
        this.service = new DefaultOrganizationService(repository);
    }

    @Test
    public void getSchoolsShouldForwardCorrectPermission() throws Exception {
        final Permission permission = new Permission(IndividualPiiRead, PermissionScope.STATEWIDE);
        when(user.getPermissionsById()).thenReturn(Maps.uniqueIndex(newArrayList(permission), Permission::getId));

        service.getSchools(user);
        verify(repository).findAll(eq(PermissionScope.STATEWIDE), queryCaptor.capture());
        assertThat(queryCaptor.getValue().getTypes()).containsOnly(OrganizationType.School);
    }

    @Test
    public void getDistrictsShouldForwardCorrectPermission() throws Exception {
        final Permission permission = new Permission(IndividualPiiRead, PermissionScope.STATEWIDE);
        when(user.getPermissionsById()).thenReturn(Maps.uniqueIndex(newArrayList(permission), Permission::getId));

        service.getDistricts(user);
        verify(repository).findAll(eq(PermissionScope.STATEWIDE), queryCaptor.capture());
        assertThat(queryCaptor.getValue().getTypes()).containsOnly(OrganizationType.District);
    }

    @Test
    public void getSchoolGroupsShouldForwardCorrectPermission() throws Exception {
        final Permission permission = new Permission(IndividualPiiRead, PermissionScope.STATEWIDE);
        when(user.getPermissionsById()).thenReturn(Maps.uniqueIndex(newArrayList(permission), Permission::getId));

        service.getSchoolGroups(user);
        verify(repository).findAll(eq(PermissionScope.STATEWIDE), queryCaptor.capture());
        assertThat(queryCaptor.getValue().getTypes()).containsOnly(OrganizationType.SchoolGroup);
    }

    @Test
    public void getDistrictGroupsShouldForwardCorrectPermission() throws Exception {
        final Permission permission = new Permission(IndividualPiiRead, PermissionScope.STATEWIDE);
        when(user.getPermissionsById()).thenReturn(Maps.uniqueIndex(newArrayList(permission), Permission::getId));

        service.getDistrictGroups(user);
        verify(repository).findAll(eq(PermissionScope.STATEWIDE), queryCaptor.capture());
        assertThat(queryCaptor.getValue().getTypes()).containsOnly(OrganizationType.DistrictGroup);
    }

}
